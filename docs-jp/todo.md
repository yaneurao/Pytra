# TODO（未完了）

> `docs-jp/` が正（source of truth）です。`docs/` はその翻訳です。

<a href="../docs/todo.md">
  <img alt="Read in English" src="https://img.shields.io/badge/docs-English-2563EB?style=flat-square">
</a>

最終更新: 2026-02-23

## 文脈運用ルール

- 各タスクは `ID` と文脈ファイル（`docs-jp/plans/*.md`）を必須にする。
- 優先度上書きは `docs-jp/plans/instruction-template.md` 形式でチャット指示し、`todo2.md` は使わない。
- 着手前に文脈ファイルの `背景` / `非対象` / `受け入れ基準` を確認する。
- 作業中の判断は文脈ファイルの `決定ログ` へ追記する。

## P0: Runtime 起源分離（最優先）

文脈: `docs-jp/plans/p1-runtime-layout-unification.md`（`TG-P1-RUNTIME-LAYOUT`）

1. [ ] [ID: P0-RUNTIME-SEP-01] C++ runtime を「生成物」と「手書き」で上位フォルダ分離する。`src/runtime/cpp/pytra-gen/`（自動生成専用）と `src/runtime/cpp/pytra-core/`（手書き専用）を新設し、`src/runtime/cpp/pytra/` は公開 include 入口（薄いフォワーダー）に限定する。`std/`・`built_in/` の混在（`-impl` 含む）を段階解消し、CI で `pytra-gen` は `AUTO-GENERATED` 必須、`pytra-core` は禁止を強制する。

方針メモ:
- ターゲット言語の増加を前提に、runtime は「自動生成層を厚く・手書き層を薄く」を基本方針とする。意味論は可能な限り `src/pytra/` 側の正本から生成し、手書きは GC/ABI など低レベル最小層へ限定する。

## P0: type_id 継承判定・isinstance 統一（最優先）

文脈: `docs-jp/plans/p0-typeid-isinstance-dispatch.md`（`TG-P0-TYPEID-ISINSTANCE`）

1. [ ] [ID: P0-TID-01] `type_id` ベースの共通判定 API（`py_isinstance` / `py_is_subtype`）を C++/JS/TS runtime に導入し、`py2cpp` を含む各 emitter の `isinstance` lower を runtime API 経由へ統一する。target 固有の built-in 直書き分岐は段階的に縮退する。
2. [ ] [ID: P0-TID-02] `src/pytra/built_in/`（pure Python）を runtime 意味論の正本として新設し、`isinstance` / `issubclass` / `type_id` を含む target 非依存 built-in 処理をここへ段階移管する。`py2cpp.py --emit-runtime-cpp` は `src/pytra/built_in/*.py` を `src/runtime/cpp/pytra/built_in/*.{h,cpp}` へ生成できるよう拡張し、C++ 側手書き実装を最小ブート層（GC/ABI 等）へ限定する。

進捗メモ:
- C++ runtime に `PYTRA_TID_*`、`py_register_class_type`、`py_is_subtype`、`py_isinstance`、`py_issubclass` を追加し、`py2cpp` の `isinstance` 生成を `py_isinstance(..., <type_id>)` 経由へ切替した。GC 管理クラスには `PYTRA_TYPE_ID` 付与と constructor での `set_type_id(...)` を導入した。JS/TS runtime には `pyRegisterType` / `pyRegisterClassType` / `pyIsSubtype` / `pyIsInstance` を追加し、`test_cpp_runtime_type_id.py` / `test_js_ts_runtime_dispatch.py` / `test_py2cpp_codegen_issues.py` で回帰固定した。
- `py2cpp` の ref class 伝播を継承両方向に補強し、`ref` 子クラスを持つ親クラスも `ref` 化して `PYTRA_TYPE_ID` を付与するようにした。これにより `isinstance(x, Base)` と `isinstance(x, Child)` の双方が `py_isinstance(..., <Class>::PYTRA_TYPE_ID)` へ lower される。
- `py2cpp` の `isinstance` lower を拡張し、`isinstance(x, (T1, T2, ...))` を `py_isinstance(..., <type_id>)` の OR 合成へ統一した。`object` は `PYTRA_TID_OBJECT` へ map し、`test/unit/test_py2cpp_codegen_issues.py` に tuple 回帰を追加して `python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）を確認した。
- `hooks/js` emitter でも `isinstance` を `pyIsInstance(..., <type_id>)` へ lower するようにし、class 定義へ `PYTRA_TYPE_ID`（`pyRegisterClassType`）と constructor での `this[PYTRA_TYPE_ID]` 付与を追加した。dict リテラルには `[PYTRA_TYPE_ID]: PY_TYPE_MAP` を埋め込み、`py2ts`（JS preview 出力）も同一経路で `type_id` lower を共有する。
- `hooks/js` emitter の `isinstance` lower を拡張し、`isinstance(x, (T1, T2, ...))` を `pyIsInstance(..., type_id)` の OR 合成へ統一した。`object` も `PY_TYPE_OBJECT` 判定へ寄せ、`test/unit/test_py2js_smoke.py` と `test/unit/test_py2ts_smoke.py` に tuple 回帰を追加して `python3 tools/check_py2js_transpile.py` / `python3 tools/check_py2ts_transpile.py`（ともに `checked=129 ok=129 fail=0 skipped=6`）を確認した。
- `py2cpp` / `hooks/js`（`py2ts` preview 含む）で `isinstance(x, set)` が `type_id` 判定（`PYTRA_TID_SET` / `PY_TYPE_SET`）へ lower されることを回帰テストで固定した。`test/unit/test_py2cpp_codegen_issues.py`、`test/unit/test_py2js_smoke.py`、`test/unit/test_py2ts_smoke.py` を追加更新し、各 transpile チェックで回帰なしを確認した。
- `hooks/cs` emitter でも `isinstance(x, T)` を C# `is` 演算子へ lower する経路を追加した。builtin（`int/float/bool/str/list/dict`）と user class の判定を `isinstance(...)` 直呼びから縮退し、`test/unit/test_py2cs_smoke.py` に回帰テスト（builtin/class）を追加した。
- `hooks/rs` emitter でも `isinstance(x, T)` を生呼びせず lower する経路を追加した。`Any/object` は `PyAny` への `matches!`（`Int/Float/Bool/Str/List/Dict`）で判定し、静的型（builtin/class）は `get_expr_type` と class 継承表（`ClassDef.base`）で `true/false` へ縮退する。`test/unit/test_py2rs_smoke.py` に `isinstance` 回帰（Any/builtin/class 継承）を追加し、`python3 test/unit/test_py2rs_smoke.py` と `python3 tools/check_py2rs_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）を確認した。
- `hooks/cs` / `hooks/rs` の `isinstance(..., object)` を統一し、C# は `(x is object)`、Rust は `true` へ lower するようにした（Python 互換で `object` は全値を受理）。`test/unit/test_py2cs_smoke.py` と `test/unit/test_py2rs_smoke.py` に回帰を追加し、`python3 tools/check_py2cs_transpile.py` / `python3 tools/check_py2rs_transpile.py`（ともに `checked=129 ok=129 fail=0 skipped=6`）を確認した。
- `hooks/cs` / `hooks/rs` の `isinstance(x, (T1, T2, ...))` lower について、tuple 指定の回帰テストを追加した。C# は OR 連結された `is` 判定（`int/Base/dict/object`）、Rust は `Any` に対する `matches!` の OR 連結を固定化し、`python3 test/unit/test_py2cs_smoke.py`（9件成功）/ `python3 test/unit/test_py2rs_smoke.py`（16件成功）と `python3 tools/check_py2cs_transpile.py` / `python3 tools/check_py2rs_transpile.py`（ともに `checked=129 ok=129 fail=0 skipped=6`）で回帰なしを確認した。
- `hooks/cs` / `hooks/rs` で `isinstance(x, set)` lower を追加した。C# は `(x is System.Collections.ISet)` へ、Rust は `Any` 経路で `matches!(x, PyAny::Set(_))` へ lower する。Rust `PyAny` には `Set(Vec<PyAny>)` variant を追加し、truthy/string helper も対応させた。`test/unit/test_py2cs_smoke.py` / `test/unit/test_py2rs_smoke.py` の set 回帰と `python3 tools/check_py2cs_transpile.py` / `python3 tools/check_py2rs_transpile.py`（ともに `checked=129 ok=129 fail=0 skipped=6`）で回帰なしを確認した。

## P0: Iterable/Iterator 契約反映（最優先）

文脈: `docs-jp/plans/p0-iterable-runtime-protocol.md`（`TG-P0-ITER`）

1. [ ] [ID: P0-ITER-01] `docs-jp/spec/spec-iterable.md` を正本として、`EAST` trait（`iterable_trait` / `iter_mode`）・C++ runtime（`py_iter_or_raise` / `py_next_or_stop` / `py_dyn_range`）・`py2cpp` codegen 分岐（`static_fastpath` / `runtime_protocol`）を段階導入する。

進捗メモ:
- `EAST`（`src/pytra/compiler/east_parts/core.py`）で `For` ノードに `iter_mode` / `iter_source_type` / `iter_element_type` を付与し、`iter` 式にも `iterable_trait` / `iter_protocol` / `iter_element_type` を埋め込む初期実装を追加した。`list` / `dict` / `set` / `str` / `bytes` は `static_fastpath`、`object/Any` と明確な非 iterable（`int/float/bool`）は `runtime_protocol` を選ぶ。
- C++ runtime（`gc.h`, `py_runtime.h`）に `PyObj::py_iter_or_raise` / `PyObj::py_next_or_stop` hook、`py_iter_or_raise(...)` / `py_next_or_stop(...)` / `py_dyn_range(...)` API、`PyListObj` / `PyDictObj` / `PyStrObj` 向け iterator 実装（`PyListIterObj` / `PyDictKeyIterObj` / `PyStrIterObj`）を追加した。non-iterable は `TypeError` 相当（`runtime_error`）で fail-fast する。
- `py2cpp` の `emit_for_each` を `iter_mode` 分岐化し、`runtime_protocol` では `for (object ... : py_dyn_range(iterable))` を生成するようにした。tuple unpack は runtime 経路で `py_at(...)` ベースへ分岐する。
- 回帰固定として `test/unit/test_east_core.py`（`iter_mode`/trait 付与）、`test/unit/test_py2cpp_codegen_issues.py`（`py_dyn_range` と static fastpath）、`test/unit/test_cpp_runtime_iterable.py`（runtime iterable API）を追加し、`check_py2cpp_transpile` と `build_selfhost` の通過を確認した。
- C++ runtime の object iterable 経路に `set` を追加した。`PySetObj`（`PYTRA_TID_SET`）と `make_object(const set<T>&)` を導入し、`py_dyn_range(make_object(set<...>))` と `py_isinstance(make_object(set<...>), PYTRA_TID_SET)` が通るようにした。`test/unit/test_cpp_runtime_iterable.py`（set 反復の合計検証）と `test/unit/test_cpp_runtime_type_id.py`（set object の type_id 判定）で回帰を固定した。

## P0: Boxing/Unboxing 境界統一（最優先）

文脈: `docs-jp/plans/p0-boxing-boundary-unification.md`（`TG-P0-BOXING`）

1. [x] [ID: P0-BOX-01] `docs-jp/spec/spec-boxing.md` を正本として、C++ runtime（`gc.h`, `py_runtime.h`）に `py_truthy` / `py_try_len` / `obj_to_rc(_or_raise)` / 厳格変換 API（`*_or_raise`）を段階導入する。
2. [x] [ID: P0-BOX-02] `py2cpp.py` の `Any/object` 境界生成を `obj_to_rc_or_raise` 中心へ移行し、`py_obj_cast<T>(...)->...` の直接生成経路を縮退する。
3. [x] [ID: P0-BOX-03] JS/TS runtime では minify 耐性確保のため `type_id` dispatch を強制し、名前文字列依存 dispatch（`constructor.name` 等）を禁止する。
4. [x] [ID: P0-BOX-04] runtime unit / py2cpp feature / クロスターゲット検証を整備し、暗黙 `0` / `false` / `None` フォールバック経路の新規混入を防ぐ。

進捗メモ:
- `P0-BOX-01`: `gc.h` に `PyObj` の hook（`py_truthy` / `py_try_len` / `py_str`）を追加し、`py_runtime.h` で組み込み object（int/float/bool/str/list/dict）へ override 実装した。`obj_to_rc` / `obj_to_rc_or_raise`、`obj_to_int64_or_raise` / `obj_to_float64_or_raise` / `obj_to_str_or_raise` も導入した。
- `P0-BOX-02`: `src/py2cpp.py` の class field attribute fallback（`Any/unknown receiver`）で `py_obj_cast<T>(...)->...` 直生成を `obj_to_rc_or_raise<T>(..., "<Class>.<field>")->...` へ切替した。
- `P0-BOX-04`: runtime 回帰として `test/unit/test_cpp_runtime_boxing.py` を追加し、`obj_to_rc(_or_raise)` / `*_or_raise` / `py_truthy` / `py_try_len` 経路を C++ 実行で検証した。コード生成回帰として `test/unit/test_py2cpp_codegen_issues.py::test_unknown_receiver_field_access_uses_obj_to_rc_or_raise` を追加した。
- `P0-BOX-02`: 追加で `Any/object -> ref class` の主要経路（`AnnAssign` / `Assign` / `Return` / call 引数 / `Yield`）を `obj_to_rc_or_raise` 経由へ統一した。`test/unit/test_py2cpp_codegen_issues.py` に `test_any_to_refclass_{annassign,return,call_arg}_uses_obj_to_rc_or_raise` を追加し、`py2cpp.py` 側の `py_obj_cast<...>` 直生成文字列が消滅していることを確認した。
- `P0-BOX-03`: `src/js_module/py_runtime.js` と `src/ts_module/py_runtime.ts` に `PYTRA_TYPE_ID` / `PYTRA_TRUTHY` / `PYTRA_TRY_LEN` / `PYTRA_STR` を導入し、`pyTypeId` / `pyTruthy` / `pyTryLen` / `pyStr` の `type_id` dispatch を実装。`pyToString` / `pyLen` / `pyBool` / `pyIn` を当該経路へ統一した。
- `P0-BOX-04`: `test/unit/test_js_ts_runtime_dispatch.py` を追加し、`constructor.name` 非依存の静的検査と JS runtime 実行での hook dispatch（`type_id` / truthy / len / str）を検証した。合わせて `test/unit/test_cpp_runtime_boxing.py`、`test/unit/test_py2cpp_codegen_issues.py`、`test/unit/test_py2js_smoke.py`、`test/unit/test_py2ts_smoke.py` を通してクロスターゲット回帰を確認した。

## P0: Selfhost 安定化

文脈: `docs-jp/plans/p0-selfhost-stabilization.md`（`TG-P0-SH`）

1. [ ] [ID: P0-SH-04] `tools/prepare_selfhost_source.py` に残る selfhost 専用スタブ整理を継続する。
2. [x] [ID: P0-SH-05] selfhost 暴走対策として fail-fast ガードを導入し、`--guard-profile {off,default,strict}` と個別上限（`--max-ast-depth`, `--max-parse-nodes`, `--max-symbols-per-module`, `--max-scope-depth`, `--max-import-graph-nodes`, `--max-import-graph-edges`, `--max-generated-lines`）を CLI から指定可能にする。制限超過時は `input_invalid(kind=limit_exceeded, stage=...)` で早期停止する。

進捗メモ:
- `P0-SH-05` を完了。`src/pytra/compiler/transpile_cli.py::parse_py2cpp_argv` に `--guard-profile` / `--max-*` を追加し、`src/py2cpp.py` で profile（`off/default/strict`）解決・個別上限上書き・stage 別 fail-fast（`parse`: AST深さ/ノード数、`analyze`: symbol/scope/import graph、`emit`: 生成行数）を実装した。超過時は `input_invalid` の detail 行に `kind=limit_exceeded stage=<parse|analyze|emit> limit=<...> value=<...> max=<...>` を出す。回帰として `test/unit/test_py2cpp_features.py` に parse/analyze/emit の limit 超過テストと CLI parse テストを追加し、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_parse_py2cpp_argv_guard_options Py2CppFeatureTest.test_guard_limit_exceeded_in_parse_stage Py2CppFeatureTest.test_guard_limit_exceeded_in_analyze_stage Py2CppFeatureTest.test_guard_limit_exceeded_in_emit_stage`、`python3 tools/build_selfhost.py`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）を確認した。
- `P0-SH-04` の継続として `tools/prepare_selfhost_source.py` から `build_cpp_hooks` 同梱スタブを再削除し、`_patch_load_cpp_hooks_for_selfhost` を復活させて `load_cpp_hooks(...)` 内の `hooks = build_cpp_hooks()` 1行のみを `hooks = {}` へ置換する方式に統一した。これにより selfhost 専用スタブを減らしつつ、置換境界は最小（1行）で維持できる。`test/unit/test_prepare_selfhost_source.py` に `load_cpp_hooks` 置換の正常系/異常系を追加し、`python3 test/unit/test_prepare_selfhost_source.py`（7件成功）、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`python3 tools/check_transpiler_version_gate.py`（`[OK] no transpiler-related changes detected`）を確認した。
- `P0-SH-04` の継続として `tools/prepare_selfhost_source.py::_patch_code_emitter_hooks_for_selfhost` の dynamic call 無効化を、固定7文字列置換から `_call_hook` ブロック内の `return fn(...)` 行検出ベースへ変更した。これにより `_call_hook` 内の軽微な改行/空白変更に耐性を持たせつつ、無効化対象が 7 行からずれた場合は `replaced=<count>` で fail-fast する。`python3 test/unit/test_prepare_selfhost_source.py`（6件成功）、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 維持）、`python3 tools/check_transpiler_version_gate.py`（`[OK] no transpiler-related changes detected`）を確認した。
- `P0-SH-04` の継続として `tools/prepare_selfhost_source.py::_patch_code_emitter_hooks_for_selfhost` の置換境界をさらに縮小し、`_call_hook` 関数ブロック全体差し替えを廃止して `return fn(...)` 7行のみを `return None` へ無効化する方式へ変更した。`fn = self._lookup_hook(name)` や `argc` 分岐自体は正本のまま selfhost 展開される。`test/unit/test_prepare_selfhost_source.py` を更新して `_call_hook` 内で `return fn(self` が残らないことと異常系（dynamic call 行欠落）を検証し、`python3 test/unit/test_prepare_selfhost_source.py`（6件成功）、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 維持）、`python3 tools/check_transpiler_version_gate.py`（`[OK] no transpiler-related changes detected`）を確認した。
- `P0-SH-04` の継続として `tools/prepare_selfhost_source.py` から `_patch_load_cpp_hooks_for_selfhost` を削除し、`_extract_support_blocks` 側で `build_cpp_hooks() -> dict[str, Any]` の最小スタブ（`return {}`）を同梱する方式へ戻した。これにより `load_cpp_hooks(...)` の正本実装を selfhost へそのまま展開できるようになり、置換境界を `CodeEmitter._call_hook` no-op のみに維持できる。`test/unit/test_prepare_selfhost_source.py` を更新してスタブ同梱と merged source 内の `hooks = build_cpp_hooks()` 維持を検証し、`python3 test/unit/test_prepare_selfhost_source.py`（6件成功）、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 維持）、`python3 tools/check_transpiler_version_gate.py`（`[OK] no transpiler-related changes detected`）を確認した。
- `dump_codegen_options_text` の selfhost fallback は最小 `"options:\n"` スタブから、詳細行を出力する selfhost-safe 実装へ置換済み。
- `CodeEmitter.quote_string_literal` / `CodeEmitter.load_profile_with_includes` は本体側 `@staticmethod` 実装へ移行し、`tools/prepare_selfhost_source.py` 側の該当置換経路を削除済み。
- `tools/prepare_selfhost_source.py` から `dump_codegen_options_text` 置換と `main guard` 置換を削除し、正本実装を selfhost へそのまま展開する経路へ移行済み。
- `tools/prepare_selfhost_source.py` から `exception/help` 置換（`_patch_selfhost_exception_paths`）と補助関数 `is_help_requested` を削除し、CLI の正本分岐をそのまま selfhost へ展開する経路へ移行済み。
- `CodeEmitter` hooks no-op 置換は暫定で維持中（除去すると selfhost C++ で `object` callable 解決エラーが発生してビルド失敗）。
- `P0-SH-04` の継続として selfhost parser の import 誤検知（`import_modules` を `import` 文として解釈）を `src/pytra/std/re.py` の `^import\\s+(.+)$` 判定厳密化で修正し、`test/unit/test_pylib_re.py` と `test/unit/test_east_core.py::test_identifier_prefixed_with_import_is_not_import_stmt` を追加した。あわせて `src/py2cpp.py::_node_contains_call_name` の `Any` 直接 `node.get(...)` を `dict` 正規化経由へ修正し、`python3 src/py2cpp.py selfhost/py2cpp.py -o /tmp/selfhost_repro.cpp` が通過することを確認した。`python3 tools/build_selfhost.py` は C++ compile 段階で失敗し、先頭ブロッカーは `for (object ... : dict/list[str])` 由来の型不整合（`selfhost/py2cpp.cpp:3354,6074,9413` など）に更新された。
- `P0-SH-04` の継続として `src/py2cpp.py` の selfhost 不安定箇所を段階修正した。`for` 走査を selfhost-safe な形（`range(len(...))` / `items()`）へ置換し、`_analyze_import_graph` の `graph_adj[cur_key].append(dep_key)` を再代入経由へ変更、`_format_graph_list_section` の引数型を `list[str]` へ厳格化、`build_module_symbol_index` / `_module_export_table` の `Assign.targets` 取得を `_dict_any_get_dict_list` へ統一した。これにより `python3 tools/build_selfhost.py` が通過し、`python3 tools/check_py2cpp_transpile.py` は `checked=129 ok=129 fail=0 skipped=6`、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=3`（既知維持）を確認した。あわせて `src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.56.0 -> 0.57.0` へ更新し、`python3 tools/check_transpiler_version_gate.py` の通過を確認した。
- `P0-SH-04` の継続として `CodeEmitter` hook 呼び出しを `_call_hook` / `_call_hook1..6` へ集約し、selfhost 側は `tools/prepare_selfhost_source.py` で当該ヘルパ群のみ no-op 置換する構成へ変更した。従来の「hook メソッド 11 個を丸ごと置換」から置換面積を縮小し、正本の hook メソッド本体を selfhost へそのまま展開できる状態に前進した。`python3 tools/build_selfhost.py`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 維持）、`python3 tools/verify_selfhost_end_to_end.py --skip-build --cases sample/py/01_mandelbrot.py sample/py/17_monte_carlo_pi.py test/fixtures/control/if_else.py`（`failures=0`）を確認し、`src/pytra/compiler/transpiler_versions.json` の `shared` を `0.2.0 -> 0.3.0` へ更新して `python3 tools/check_transpiler_version_gate.py` を通過させた。
- `P0-SH-04` の継続として `tools/prepare_selfhost_source.py::_patch_code_emitter_hooks_for_selfhost` の置換境界をさらに縮退し、`_call_hook` 本体のみを no-op 化する方式へ変更した（`_call_hook1..6` は正本のまま selfhost へ展開）。これにより selfhost 専用スタブ文字列を削減しつつ、`python3 tools/build_selfhost.py`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 維持）、`python3 tools/check_transpiler_version_gate.py`（`[OK] no transpiler-related changes detected`）の通過を確認した。
- `P0-SH-04` の継続として selfhost 置換境界の回帰テストを追加した。`test/unit/test_prepare_selfhost_source.py` で `tools/prepare_selfhost_source.py` の変換結果を直接検証し、`_call_hook` のみ no-op 化されること、`_call_hook1..6` と `hook_on_emit_stmt` が正本実装のまま残ることを固定化した。`python3 test/unit/test_prepare_selfhost_source.py` は通過。
- `P0-SH-04` の継続として `tools/prepare_selfhost_source.py::_patch_code_emitter_hooks_for_selfhost` の失敗時挙動を厳格化した。`_call_hook` / `_call_hook1` のマーカーが見つからない場合に黙ってスキップせず `RuntimeError` を送出するよう変更し、置換失敗の見逃しを防止した。`test/unit/test_prepare_selfhost_source.py` に異常系（マーカー欠落）テストを追加し、`python3 test/unit/test_prepare_selfhost_source.py`（2件成功）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 維持）、`python3 tools/check_transpiler_version_gate.py`（`[OK] no transpiler-related changes detected`）を確認した。
- `P0-SH-04` の継続として `tools/prepare_selfhost_source.py::_extract_support_blocks` に残っていた `build_cpp_hooks` スタブを最小化し、`pass` と中間変数 `out` を削除して `return {}` のみへ整理した。回帰防止として `test/unit/test_prepare_selfhost_source.py::test_extract_support_blocks_does_not_inline_build_cpp_hooks` を追加し、`python3 test/unit/test_prepare_selfhost_source.py`（3件成功）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 維持）、`python3 tools/check_transpiler_version_gate.py`（`[OK] no transpiler-related changes detected`）を確認した。
- `P0-SH-04` の継続として `tools/prepare_selfhost_source.py::_patch_code_emitter_hooks_for_selfhost` の `_call_hook` no-op スタブをさらに最小化し、不要な `pass` を削除して `return None` のみへ整理した。`test/unit/test_prepare_selfhost_source.py` の既存検証を更新して `pass` 非存在を固定し、`python3 test/unit/test_prepare_selfhost_source.py`（3件成功）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 維持）、`python3 tools/check_transpiler_version_gate.py`（`[OK] no transpiler-related changes detected`）を確認した。
- `P0-SH-04` の継続として `build_cpp_hooks` の selfhost 専用スタブ関数自体を削除し、代わりに `tools/prepare_selfhost_source.py::_patch_load_cpp_hooks_for_selfhost` で `load_cpp_hooks(...)` を selfhost 生成時のみ `return {}` に置換する方式へ変更した。`test/unit/test_prepare_selfhost_source.py` に `load_cpp_hooks` 置換の正常系/異常系テストを追加し、`python3 test/unit/test_prepare_selfhost_source.py`（5件成功）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 維持）、`python3 tools/check_transpiler_version_gate.py`（`[OK] no transpiler-related changes detected`）を確認した。
- `P0-SH-04` の継続として `tools/prepare_selfhost_source.py::_remove_import_line` を fail-fast 化し、`CodeEmitter`/`transpile_cli`/`build_cpp_hooks` の import 行が見つからない場合は `RuntimeError` を送出するよう変更した。`test/unit/test_prepare_selfhost_source.py` に import 除去の正常系/異常系テストを追加し、`python3 test/unit/test_prepare_selfhost_source.py`（7件成功）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 維持）、`python3 tools/check_transpiler_version_gate.py`（`[OK] no transpiler-related changes detected`）を確認した。
- `P0-SH-04` の継続として `tools/prepare_selfhost_source.py::_patch_load_cpp_hooks_for_selfhost` を「関数ブロック丸ごと置換」から「`hooks = build_cpp_hooks()` の1行置換」へ縮小し、selfhost 専用パッチ境界をさらに狭めた。`test/unit/test_prepare_selfhost_source.py` の `load_cpp_hooks` 置換テストを更新し、`python3 test/unit/test_prepare_selfhost_source.py`（7件成功）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 維持）、`python3 tools/check_transpiler_version_gate.py`（`[OK] no transpiler-related changes detected`）を確認した。

## P1: CodeEmitter / Hooks 移行

文脈: `docs-jp/plans/p1-codeemitter-hooks-migration.md`（`TG-P1-CEH`）

1. [ ] [ID: P1-CEH-01] profile で表現しづらいケースだけを hooks へ移し、`py2cpp.py` 側の条件分岐を残さない状態にする。

## P1: CodeEmitter 共通ディスパッチ再設計

文脈: `docs-jp/plans/p1-codeemitter-dispatch-redesign.md`（`TG-P1-CED`）

1. [ ] [ID: P1-CED-01] `render_expr` の kind ごとに hook ポイントを追加する。
2. [ ] [ID: P1-CED-02] `emit_stmt` も kind ごとの hook ポイントへ分解する。
3. [ ] [ID: P1-CED-03] `CppEmitter` を hook 優先 + fallback の二段構成に統一する。
4. [ ] [ID: P1-CED-04] `tools/check_selfhost_cpp_diff.py` で差分ゼロを維持しながら fallback を縮退する。
5. [ ] [ID: P1-CED-05] fallback が十分に減った段階で、共通ディスパッチを `CodeEmitter` 本体へ戻す。

受け入れ基準:
1. [ ] [ID: P1-CED-AC-01] Python 実行パス: `hooks` 有効時に既存ケースのコード生成結果が不変。
2. [ ] [ID: P1-CED-AC-02] selfhost 実行パス: `mismatches=0` を維持。
3. [ ] [ID: P1-CED-AC-03] `py2cpp.py` の `render_expr` / `emit_stmt` 本体分岐が段階的に短くなる。

py2cpp / py2rs 共通化候補:
1. [ ] [ID: P1-CED-A-01] 優先 A: `If` / `While` / `ForRange` / `For` の文スケルトン生成（開閉ブロック + scope push/pop）を `CodeEmitter` へ移す。
2. [ ] [ID: P1-CED-A-02] 優先 A: `Assign` / `AnnAssign` / `AugAssign` の「宣言判定 + 代入先レンダ」共通骨格を `CodeEmitter` へ移す。
3. [ ] [ID: P1-CED-A-03] 優先 A: `Compare` / `BoolOp` / `IfExp` の式組み立てを `CodeEmitter` へ移す。
4. [ ] [ID: P1-CED-A-04] 優先 A: import 束縛テーブル読み込み（`meta.import_bindings` 反映）を `CodeEmitter` へ移す。
5. [ ] [ID: P1-CED-B-01] 優先 B: 型名正規化 + 言語型への最終写像（`normalize_type_name` 後段）を共通化する。
6. [ ] [ID: P1-CED-B-02] 優先 B: `Call` 前処理（`_prepare_call_parts` 結果の共通利用）を共通化する。
7. [ ] [ID: P1-CED-B-03] 優先 B: `Tuple` 代入の一時変数 lower を共通化する。
8. [ ] [ID: P1-CED-C-01] 優先 C: 言語別ランタイム関数へのルーティング（profile + hooks）を共通化する。
9. [ ] [ID: P1-CED-C-02] 優先 C: 文字列/配列の細かい最適化（演算子簡約・括弧削減）を共通化する。

## P1: py2cpp 縮退（行数削減）

文脈: `docs-jp/plans/p1-py2cpp-reduction.md`（`TG-P1-CPP-REDUCE`）

1. [ ] [ID: P1-CPP-REDUCE-01] `src/py2cpp.py` に残る未移行ロジックを `CodeEmitter` へ段階移管し、行数を縮退する。
2. [ ] [ID: P1-CPP-REDUCE-02] 全言語 selfhost を前提に、`py2cpp.py` への汎用 helper 新規追加を原則禁止し、必要な共通処理は `src/pytra/compiler/` へ先行抽出してから利用する運用へ移行する。

## P1: コンパイラ共通層への抽出（py2cpp 偏在解消）

文脈: `docs-jp/plans/p1-compiler-shared-extraction.md`（`TG-P1-COMP-SHARED`）

1. [ ] [ID: P1-COMP-01] import グラフ解析（`_analyze_import_graph`）を `src/pytra/compiler/` 配下の共通モジュールへ抽出する。
2. [ ] [ID: P1-COMP-02] module EAST map 構築（`build_module_east_map`）を共通 API 化し、`py2cpp.py` 以外から再利用可能にする。
3. [ ] [ID: P1-COMP-03] module symbol index / type schema 構築（`build_module_symbol_index`, `build_module_type_schema`）を共通 API 化する。
4. [ ] [ID: P1-COMP-04] deps dump（`dump_deps_text`, `dump_deps_graph_text`）を共通 API 化し、CLI 層は表示/出力だけを担当する構成にする。
5. [ ] [ID: P1-COMP-05] 共通抽出後、`py2cpp.py` は C++ 固有責務（C++ runtime/header/multi-file 出力）へ限定する。
6. [ ] [ID: P1-COMP-09] `py2cpp.py` に残る汎用 helper（例: 文字列リスト整列、module 解析補助）を `src/pytra/compiler/` へ移管し、非 C++ 各 `py2*` から同一実装を再利用できる状態にする。
7. [ ] [ID: P1-COMP-10] 「全言語 selfhost を阻害しない共通層優先」の運用ルールを整備し、`py2cpp.py` へ汎用処理が再流入しない回帰チェック（lint/静的検査または CI ルール）を追加する。
8. [ ] [ID: P1-COMP-11] `src/pytra/compiler/transpile_cli.py` の汎用 helper 群を機能グループごとに `class + @staticmethod` へ整理し、`py2cpp.py` 側 import を class 単位へ縮退する。移行時はトップレベル互換ラッパーを暫定維持し、`tools/prepare_selfhost_source.py` / `test/unit/test_prepare_selfhost_source.py` の抽出ロジックも同時更新して selfhost 回帰を防ぐ。

進捗メモ:
- `P1-COMP-09` の一部として、`src/py2cpp.py` に残っていた汎用 helper `_sort_str_list_in_place` を `src/pytra/compiler/transpile_cli.py::sort_str_list_copy` へ移管し、`py2cpp` 側は共通 helper 呼び出しへ置換した。selfhost 展開を壊さないよう `tools/prepare_selfhost_source.py` の `transpile_cli` import 除去ターゲットと support block 抽出対象へ同 helper を追加し、`test/unit/test_py2cpp_features.py` と `test/unit/test_prepare_selfhost_source.py` へ回帰を追加した。`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_sort_str_list_copy_returns_sorted_copy`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 tools/check_py2cpp_transpile.py`、`python3 tools/build_selfhost.py`、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`、`python3 tools/check_transpiler_version_gate.py` を通過させた。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた汎用 helper `_join_str_list` を `src/pytra/compiler/transpile_cli.py::join_str_list` へ移管した。`py2cpp` 側の全呼び出しを `join_str_list(...)` へ置換し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲットと support block 抽出対象へ `join_str_list` を追加した。`test/unit/test_py2cpp_features.py`（`test_join_str_list_joins_items`）と `test/unit/test_prepare_selfhost_source.py` を更新し、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_join_str_list_joins_items Py2CppFeatureTest.test_sort_str_list_copy_returns_sorted_copy`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 tools/check_py2cpp_transpile.py`、`python3 tools/build_selfhost.py`、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`、`python3 tools/check_transpiler_version_gate.py` を通過させた。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた汎用 helper `_split_infix_once` を `src/pytra/compiler/transpile_cli.py::split_infix_once` へ移管した。`py2cpp` 側の呼び出し（`_local_binding_name` / `render_expr` の `in/not in` repr 分岐 / slice 解析 / import graph issue 解析）を共通 helper へ置換し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲットと support block 抽出対象へ `split_infix_once` を追加した。`test/unit/test_py2cpp_features.py`（`test_split_infix_once_splits_first_match`）と `test/unit/test_prepare_selfhost_source.py` を更新し、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_split_infix_once_splits_first_match Py2CppFeatureTest.test_join_str_list_joins_items Py2CppFeatureTest.test_sort_str_list_copy_returns_sorted_copy`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 tools/check_py2cpp_transpile.py`、`python3 tools/build_selfhost.py`、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`、`python3 tools/check_transpiler_version_gate.py` を通過させた。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた汎用 helper `_replace_first` を `src/pytra/compiler/transpile_cli.py::replace_first` へ移管した。`py2cpp` 側の利用箇所（multi-file 出力時の include 注入・runtime include 切替）を共通 helper 呼び出しへ置換し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲットと support block 抽出対象へ `replace_first` を追加した。`test/unit/test_py2cpp_features.py`（`test_replace_first_replaces_single_match`）と `test/unit/test_prepare_selfhost_source.py` を更新し、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_replace_first_replaces_single_match Py2CppFeatureTest.test_split_infix_once_splits_first_match Py2CppFeatureTest.test_join_str_list_joins_items Py2CppFeatureTest.test_sort_str_list_copy_returns_sorted_copy`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 tools/check_py2cpp_transpile.py`、`python3 tools/build_selfhost.py`、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`、`python3 tools/check_transpiler_version_gate.py` を通過させた。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた汎用 helper `_path_parent_text` を `src/pytra/compiler/transpile_cli.py::path_parent_text` へ移管した。`py2cpp` 側の利用箇所（import graph 解析、multi-file 出力、各種出力前の親ディレクトリ解決）を共通 helper 呼び出しへ置換し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲットと support block 抽出対象へ `path_parent_text` を追加した。`test/unit/test_py2cpp_features.py`（`test_path_parent_text_returns_parent_dir`）と `test/unit/test_prepare_selfhost_source.py` を更新し、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_path_parent_text_returns_parent_dir Py2CppFeatureTest.test_replace_first_replaces_single_match Py2CppFeatureTest.test_split_infix_once_splits_first_match Py2CppFeatureTest.test_join_str_list_joins_items Py2CppFeatureTest.test_sort_str_list_copy_returns_sorted_copy`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 tools/check_py2cpp_transpile.py`、`python3 tools/build_selfhost.py`、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`、`python3 tools/check_transpiler_version_gate.py` を通過させた。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた汎用 helper `_mkdirs_for_cli` を `src/pytra/compiler/transpile_cli.py::mkdirs_for_cli` へ移管した。`py2cpp` 側の利用箇所（multi-file 出力先ディレクトリ作成、各種 `-o/--header-output/--dump-*` 出力前ディレクトリ作成）を共通 helper 呼び出しへ置換し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲットと support block 抽出対象へ `mkdirs_for_cli` を追加した。`test/unit/test_py2cpp_features.py`（`test_mkdirs_for_cli_creates_directory`）と `test/unit/test_prepare_selfhost_source.py` を更新し、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_mkdirs_for_cli_creates_directory Py2CppFeatureTest.test_path_parent_text_returns_parent_dir Py2CppFeatureTest.test_replace_first_replaces_single_match Py2CppFeatureTest.test_split_infix_once_splits_first_match Py2CppFeatureTest.test_join_str_list_joins_items Py2CppFeatureTest.test_sort_str_list_copy_returns_sorted_copy`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 tools/check_py2cpp_transpile.py`、`python3 tools/build_selfhost.py`、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`、`python3 tools/check_transpiler_version_gate.py` を通過させた。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた汎用 helper `_write_text_file` を `src/pytra/compiler/transpile_cli.py::write_text_file` へ移管した。`py2cpp` 側の利用箇所（multi-file prelude/manifest 出力、runtime/header 出力、`-o/--dump-*` 出力）を共通 helper 呼び出しへ置換し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲットと support block 抽出対象へ `write_text_file` を追加した。`test/unit/test_py2cpp_features.py`（`test_write_text_file_writes_text`）と `test/unit/test_prepare_selfhost_source.py` を更新し、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_write_text_file_writes_text Py2CppFeatureTest.test_mkdirs_for_cli_creates_directory Py2CppFeatureTest.test_path_parent_text_returns_parent_dir Py2CppFeatureTest.test_replace_first_replaces_single_match Py2CppFeatureTest.test_split_infix_once_splits_first_match Py2CppFeatureTest.test_join_str_list_joins_items Py2CppFeatureTest.test_sort_str_list_copy_returns_sorted_copy`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 tools/check_py2cpp_transpile.py`、`python3 tools/build_selfhost.py`、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`、`python3 tools/check_transpiler_version_gate.py` を通過させた。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた汎用 helper `_count_text_lines` を `src/pytra/compiler/transpile_cli.py::count_text_lines` へ移管した。`py2cpp` 側の利用箇所（guard の `max_generated_lines` 計測、multi-file prelude/header/cpp/manifest の行数集計、runtime/header 出力行数集計）を共通 helper 呼び出しへ置換し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲットと support block 抽出対象へ `count_text_lines` を追加した。`test/unit/test_py2cpp_features.py`（`test_count_text_lines_counts_newlines`）と `test/unit/test_prepare_selfhost_source.py` を更新し、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_count_text_lines_counts_newlines Py2CppFeatureTest.test_write_text_file_writes_text Py2CppFeatureTest.test_mkdirs_for_cli_creates_directory Py2CppFeatureTest.test_path_parent_text_returns_parent_dir Py2CppFeatureTest.test_replace_first_replaces_single_match Py2CppFeatureTest.test_split_infix_once_splits_first_match Py2CppFeatureTest.test_join_str_list_joins_items Py2CppFeatureTest.test_sort_str_list_copy_returns_sorted_copy`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 tools/check_py2cpp_transpile.py`、`python3 tools/build_selfhost.py`、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`、`python3 tools/check_transpiler_version_gate.py` を通過させた。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた汎用 helper `_split_ws_tokens` を `src/pytra/compiler/transpile_cli.py::split_ws_tokens` へ移管した。`py2cpp` 側の利用箇所（import エラー詳細抽出での `from/import` 行トークン化）を共通 helper 呼び出しへ置換し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲットと support block 抽出対象へ `split_ws_tokens` を追加した。`test/unit/test_py2cpp_features.py`（`test_split_ws_tokens_splits_ascii_whitespace`）と `test/unit/test_prepare_selfhost_source.py` を更新し、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_split_ws_tokens_splits_ascii_whitespace Py2CppFeatureTest.test_count_text_lines_counts_newlines Py2CppFeatureTest.test_write_text_file_writes_text Py2CppFeatureTest.test_mkdirs_for_cli_creates_directory Py2CppFeatureTest.test_path_parent_text_returns_parent_dir Py2CppFeatureTest.test_replace_first_replaces_single_match Py2CppFeatureTest.test_split_infix_once_splits_first_match Py2CppFeatureTest.test_join_str_list_joins_items Py2CppFeatureTest.test_sort_str_list_copy_returns_sorted_copy`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 tools/check_py2cpp_transpile.py`、`python3 tools/build_selfhost.py`、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`、`python3 tools/check_transpiler_version_gate.py` を通過させた。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた汎用 helper `_append_unique_non_empty` を `src/pytra/compiler/transpile_cli.py::append_unique_non_empty` へ移管した。`py2cpp` 側の利用箇所（include/module/symbol の重複排除追加、import graph 相対/欠落/edge 収集）を共通 helper 呼び出しへ置換し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲットと support block 抽出対象へ `append_unique_non_empty` を追加した。`test/unit/test_py2cpp_features.py`（`test_append_unique_non_empty_appends_once`）と `test/unit/test_prepare_selfhost_source.py` を更新し、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_append_unique_non_empty_appends_once Py2CppFeatureTest.test_split_ws_tokens_splits_ascii_whitespace Py2CppFeatureTest.test_count_text_lines_counts_newlines Py2CppFeatureTest.test_write_text_file_writes_text Py2CppFeatureTest.test_mkdirs_for_cli_creates_directory Py2CppFeatureTest.test_path_parent_text_returns_parent_dir Py2CppFeatureTest.test_replace_first_replaces_single_match Py2CppFeatureTest.test_split_infix_once_splits_first_match Py2CppFeatureTest.test_join_str_list_joins_items Py2CppFeatureTest.test_sort_str_list_copy_returns_sorted_copy`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 tools/check_py2cpp_transpile.py`、`python3 tools/build_selfhost.py`、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`、`python3 tools/check_transpiler_version_gate.py` を通過させた。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた汎用 helper `_split_top_level_csv` を `src/pytra/compiler/transpile_cli.py::split_top_level_csv` へ移管した。`py2cpp` 側の利用箇所（関数シグネチャ抽出時の引数分割、`TypeVar`/`Union` 解析時のトップレベル CSV 分割）を共通 helper 呼び出しへ置換し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲットと support block 抽出対象へ `split_top_level_csv` を追加した。`test/unit/test_py2cpp_features.py`（`test_split_top_level_csv_splits_only_top_level_commas`）と `test/unit/test_prepare_selfhost_source.py` を更新し、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_split_top_level_csv_splits_only_top_level_commas Py2CppFeatureTest.test_append_unique_non_empty_appends_once Py2CppFeatureTest.test_split_ws_tokens_splits_ascii_whitespace Py2CppFeatureTest.test_count_text_lines_counts_newlines Py2CppFeatureTest.test_write_text_file_writes_text Py2CppFeatureTest.test_mkdirs_for_cli_creates_directory Py2CppFeatureTest.test_path_parent_text_returns_parent_dir Py2CppFeatureTest.test_replace_first_replaces_single_match Py2CppFeatureTest.test_split_infix_once_splits_first_match Py2CppFeatureTest.test_join_str_list_joins_items Py2CppFeatureTest.test_sort_str_list_copy_returns_sorted_copy`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 tools/check_py2cpp_transpile.py`、`python3 tools/build_selfhost.py`、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`、`python3 tools/check_transpiler_version_gate.py` を通過させた。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた汎用 helper `_dict_str_get` を `src/pytra/compiler/transpile_cli.py::dict_str_get` へ移管した。`py2cpp` 側の利用箇所（CLI 解析結果 `dict[str, str]` の既定値付き取得）を共通 helper 呼び出しへ置換し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲットと support block 抽出対象へ `dict_str_get` を追加した。`test/unit/test_py2cpp_features.py`（`test_dict_str_get_returns_default_when_missing`）と `test/unit/test_prepare_selfhost_source.py` を更新し、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_dict_str_get_returns_default_when_missing Py2CppFeatureTest.test_split_top_level_csv_splits_only_top_level_commas Py2CppFeatureTest.test_append_unique_non_empty_appends_once Py2CppFeatureTest.test_split_ws_tokens_splits_ascii_whitespace Py2CppFeatureTest.test_count_text_lines_counts_newlines Py2CppFeatureTest.test_write_text_file_writes_text Py2CppFeatureTest.test_mkdirs_for_cli_creates_directory Py2CppFeatureTest.test_path_parent_text_returns_parent_dir Py2CppFeatureTest.test_replace_first_replaces_single_match Py2CppFeatureTest.test_split_infix_once_splits_first_match Py2CppFeatureTest.test_join_str_list_joins_items Py2CppFeatureTest.test_sort_str_list_copy_returns_sorted_copy`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 tools/check_py2cpp_transpile.py`、`python3 tools/build_selfhost.py`、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`、`python3 tools/check_transpiler_version_gate.py` を通過させた。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた汎用 helper `_looks_like_runtime_function_name` を `src/pytra/compiler/transpile_cli.py::looks_like_runtime_function_name` へ移管した。`py2cpp` 側の利用箇所（module attr call map の runtime 関数判定）を共通 helper 呼び出しへ置換し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲットと support block 抽出対象へ `looks_like_runtime_function_name` を追加した。`test/unit/test_py2cpp_features.py`（`test_looks_like_runtime_function_name`）と `test/unit/test_prepare_selfhost_source.py` を更新し、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_looks_like_runtime_function_name Py2CppFeatureTest.test_dict_str_get_returns_default_when_missing Py2CppFeatureTest.test_split_top_level_csv_splits_only_top_level_commas Py2CppFeatureTest.test_append_unique_non_empty_appends_once Py2CppFeatureTest.test_split_ws_tokens_splits_ascii_whitespace Py2CppFeatureTest.test_count_text_lines_counts_newlines Py2CppFeatureTest.test_write_text_file_writes_text Py2CppFeatureTest.test_mkdirs_for_cli_creates_directory Py2CppFeatureTest.test_path_parent_text_returns_parent_dir Py2CppFeatureTest.test_replace_first_replaces_single_match Py2CppFeatureTest.test_split_infix_once_splits_first_match Py2CppFeatureTest.test_join_str_list_joins_items Py2CppFeatureTest.test_sort_str_list_copy_returns_sorted_copy`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 tools/check_py2cpp_transpile.py`、`python3 tools/build_selfhost.py`、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`、`python3 tools/check_transpiler_version_gate.py` を通過させた。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた汎用 helper `_local_binding_name` を `src/pytra/compiler/transpile_cli.py::local_binding_name` へ移管した。`py2cpp` 側の利用箇所（import / import-from 解析でのローカル束縛名決定）を共通 helper 呼び出しへ置換し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲットと support block 抽出対象へ `local_binding_name` を追加した。`test/unit/test_py2cpp_features.py`（`test_local_binding_name_prefers_alias`）と `test/unit/test_prepare_selfhost_source.py` を更新し、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_local_binding_name_prefers_alias Py2CppFeatureTest.test_looks_like_runtime_function_name Py2CppFeatureTest.test_dict_str_get_returns_default_when_missing Py2CppFeatureTest.test_split_top_level_csv_splits_only_top_level_commas Py2CppFeatureTest.test_append_unique_non_empty_appends_once Py2CppFeatureTest.test_split_ws_tokens_splits_ascii_whitespace Py2CppFeatureTest.test_count_text_lines_counts_newlines Py2CppFeatureTest.test_write_text_file_writes_text Py2CppFeatureTest.test_mkdirs_for_cli_creates_directory Py2CppFeatureTest.test_path_parent_text_returns_parent_dir Py2CppFeatureTest.test_replace_first_replaces_single_match Py2CppFeatureTest.test_split_infix_once_splits_first_match Py2CppFeatureTest.test_join_str_list_joins_items Py2CppFeatureTest.test_sort_str_list_copy_returns_sorted_copy`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 tools/check_py2cpp_transpile.py`、`python3 tools/build_selfhost.py`、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`、`python3 tools/check_transpiler_version_gate.py` を通過させた。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた汎用 helper `_split_graph_issue_entry` を `src/pytra/compiler/transpile_cli.py::split_graph_issue_entry` へ移管した。`py2cpp` 側の利用箇所（import graph エラー詳細 `file: module` 分解）を共通 helper 呼び出しへ置換し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲットと support block 抽出対象へ `split_graph_issue_entry` を追加した。`test/unit/test_py2cpp_features.py`（`test_split_graph_issue_entry`）と `test/unit/test_prepare_selfhost_source.py` を更新し、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_split_graph_issue_entry Py2CppFeatureTest.test_local_binding_name_prefers_alias Py2CppFeatureTest.test_looks_like_runtime_function_name Py2CppFeatureTest.test_dict_str_get_returns_default_when_missing Py2CppFeatureTest.test_split_top_level_csv_splits_only_top_level_commas Py2CppFeatureTest.test_append_unique_non_empty_appends_once Py2CppFeatureTest.test_split_ws_tokens_splits_ascii_whitespace Py2CppFeatureTest.test_count_text_lines_counts_newlines Py2CppFeatureTest.test_write_text_file_writes_text Py2CppFeatureTest.test_mkdirs_for_cli_creates_directory Py2CppFeatureTest.test_path_parent_text_returns_parent_dir Py2CppFeatureTest.test_replace_first_replaces_single_match Py2CppFeatureTest.test_split_infix_once_splits_first_match Py2CppFeatureTest.test_join_str_list_joins_items Py2CppFeatureTest.test_sort_str_list_copy_returns_sorted_copy`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 tools/check_py2cpp_transpile.py`、`python3 tools/build_selfhost.py`、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`、`python3 tools/check_transpiler_version_gate.py` を通過させた。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた汎用 helper `_split_type_args` を `src/pytra/compiler/transpile_cli.py::split_type_args` へ移管した。`py2cpp` 側の利用箇所（header 型 lower での `list[...]` / `dict[...]` 型引数分割）を共通 helper 呼び出しへ置換し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲットと support block 抽出対象へ `split_type_args` を追加した。`test/unit/test_py2cpp_features.py`（`test_split_type_args_splits_bracket_nested_commas`）と `test/unit/test_prepare_selfhost_source.py` を更新し、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_split_type_args_splits_bracket_nested_commas Py2CppFeatureTest.test_split_graph_issue_entry Py2CppFeatureTest.test_local_binding_name_prefers_alias Py2CppFeatureTest.test_looks_like_runtime_function_name Py2CppFeatureTest.test_dict_str_get_returns_default_when_missing Py2CppFeatureTest.test_split_top_level_csv_splits_only_top_level_commas Py2CppFeatureTest.test_append_unique_non_empty_appends_once Py2CppFeatureTest.test_split_ws_tokens_splits_ascii_whitespace Py2CppFeatureTest.test_count_text_lines_counts_newlines Py2CppFeatureTest.test_write_text_file_writes_text Py2CppFeatureTest.test_mkdirs_for_cli_creates_directory Py2CppFeatureTest.test_path_parent_text_returns_parent_dir Py2CppFeatureTest.test_replace_first_replaces_single_match Py2CppFeatureTest.test_split_infix_once_splits_first_match Py2CppFeatureTest.test_join_str_list_joins_items Py2CppFeatureTest.test_sort_str_list_copy_returns_sorted_copy`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 tools/check_py2cpp_transpile.py`、`python3 tools/build_selfhost.py`、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`、`python3 tools/check_transpiler_version_gate.py` を通過させた。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた汎用 helper `_split_top_level_union` を `src/pytra/compiler/transpile_cli.py::split_top_level_union` へ移管した。`py2cpp` 側の利用箇所（header 型 lower での Union 解析）を共通 helper 呼び出しへ置換し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲットと support block 抽出対象へ `split_top_level_union` を追加した。`test/unit/test_py2cpp_features.py`（`test_split_top_level_union_splits_only_top_level_pipe`）と `test/unit/test_prepare_selfhost_source.py` を更新し、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_split_top_level_union_splits_only_top_level_pipe Py2CppFeatureTest.test_split_type_args_splits_bracket_nested_commas Py2CppFeatureTest.test_split_graph_issue_entry Py2CppFeatureTest.test_local_binding_name_prefers_alias Py2CppFeatureTest.test_looks_like_runtime_function_name Py2CppFeatureTest.test_dict_str_get_returns_default_when_missing Py2CppFeatureTest.test_split_top_level_csv_splits_only_top_level_commas Py2CppFeatureTest.test_append_unique_non_empty_appends_once Py2CppFeatureTest.test_split_ws_tokens_splits_ascii_whitespace Py2CppFeatureTest.test_count_text_lines_counts_newlines Py2CppFeatureTest.test_write_text_file_writes_text Py2CppFeatureTest.test_mkdirs_for_cli_creates_directory Py2CppFeatureTest.test_path_parent_text_returns_parent_dir Py2CppFeatureTest.test_replace_first_replaces_single_match Py2CppFeatureTest.test_split_infix_once_splits_first_match Py2CppFeatureTest.test_join_str_list_joins_items Py2CppFeatureTest.test_sort_str_list_copy_returns_sorted_copy`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 tools/check_py2cpp_transpile.py`、`python3 tools/build_selfhost.py`、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`、`python3 tools/check_transpiler_version_gate.py` を通過させた。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた汎用 helper `_is_pytra_module_name` を `src/pytra/compiler/transpile_cli.py::is_pytra_module_name` へ移管した。`py2cpp` 側の利用箇所（import 解決での `pytra.*` 判定）を共通 helper 呼び出しへ置換し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲットと support block 抽出対象へ `is_pytra_module_name` を追加した。`test/unit/test_py2cpp_features.py`（`test_is_pytra_module_name`）と `test/unit/test_prepare_selfhost_source.py` を更新し、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_is_pytra_module_name Py2CppFeatureTest.test_split_top_level_union_splits_only_top_level_pipe Py2CppFeatureTest.test_split_type_args_splits_bracket_nested_commas Py2CppFeatureTest.test_split_graph_issue_entry Py2CppFeatureTest.test_local_binding_name_prefers_alias Py2CppFeatureTest.test_looks_like_runtime_function_name Py2CppFeatureTest.test_dict_str_get_returns_default_when_missing Py2CppFeatureTest.test_split_top_level_csv_splits_only_top_level_commas Py2CppFeatureTest.test_append_unique_non_empty_appends_once Py2CppFeatureTest.test_split_ws_tokens_splits_ascii_whitespace Py2CppFeatureTest.test_count_text_lines_counts_newlines Py2CppFeatureTest.test_write_text_file_writes_text Py2CppFeatureTest.test_mkdirs_for_cli_creates_directory Py2CppFeatureTest.test_path_parent_text_returns_parent_dir Py2CppFeatureTest.test_replace_first_replaces_single_match Py2CppFeatureTest.test_split_infix_once_splits_first_match Py2CppFeatureTest.test_join_str_list_joins_items Py2CppFeatureTest.test_sort_str_list_copy_returns_sorted_copy`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 tools/check_py2cpp_transpile.py`、`python3 tools/build_selfhost.py`、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`、`python3 tools/check_transpiler_version_gate.py` を通過させた。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた import graph 用 helper `_path_key_for_graph` / `_rel_disp_for_graph` を `src/pytra/compiler/transpile_cli.py::{path_key_for_graph, rel_disp_for_graph}` へ移管した。`py2cpp` 側の利用箇所（`_analyze_import_graph` と from-import 診断）を共通 helper 呼び出しへ置換し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲットと support block 抽出対象へ両 helper を追加した。`test/unit/test_py2cpp_features.py`（`test_graph_path_helpers`）と `test/unit/test_prepare_selfhost_source.py` を更新し、`python3 -m py_compile src/py2cpp.py src/pytra/compiler/transpile_cli.py tools/prepare_selfhost_source.py test/unit/test_prepare_selfhost_source.py test/unit/test_py2cpp_features.py`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_graph_path_helpers Py2CppFeatureTest.test_is_pytra_module_name Py2CppFeatureTest.test_split_top_level_union_splits_only_top_level_pipe Py2CppFeatureTest.test_split_type_args_splits_bracket_nested_commas Py2CppFeatureTest.test_split_graph_issue_entry Py2CppFeatureTest.test_local_binding_name_prefers_alias Py2CppFeatureTest.test_looks_like_runtime_function_name Py2CppFeatureTest.test_dict_str_get_returns_default_when_missing Py2CppFeatureTest.test_split_top_level_csv_splits_only_top_level_commas Py2CppFeatureTest.test_append_unique_non_empty_appends_once Py2CppFeatureTest.test_split_ws_tokens_splits_ascii_whitespace Py2CppFeatureTest.test_count_text_lines_counts_newlines Py2CppFeatureTest.test_write_text_file_writes_text Py2CppFeatureTest.test_mkdirs_for_cli_creates_directory Py2CppFeatureTest.test_path_parent_text_returns_parent_dir Py2CppFeatureTest.test_replace_first_replaces_single_match Py2CppFeatureTest.test_split_infix_once_splits_first_match Py2CppFeatureTest.test_join_str_list_joins_items Py2CppFeatureTest.test_sort_str_list_copy_returns_sorted_copy`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 既知維持）、`python3 tools/check_transpiler_version_gate.py`（`shared 0.23.0 -> 0.24.0`、`cpp 0.130.0 -> 0.131.0`）を確認した。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた import graph module_id フォールバック helper `_module_name_from_path_for_graph` を `src/pytra/compiler/transpile_cli.py::module_name_from_path_for_graph` へ移管した。`py2cpp` 側の利用箇所（`_module_id_from_east_for_graph` と import graph 結果構築時の module_id 補完）を共通 helper 呼び出しへ置換し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲットと support block 抽出対象へ同 helper を追加した。`test/unit/test_py2cpp_features.py`（`test_module_name_from_path_for_graph`）と `test/unit/test_prepare_selfhost_source.py` を更新し、`python3 -m py_compile src/py2cpp.py src/pytra/compiler/transpile_cli.py tools/prepare_selfhost_source.py test/unit/test_prepare_selfhost_source.py test/unit/test_py2cpp_features.py`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_graph_path_helpers Py2CppFeatureTest.test_module_name_from_path_for_graph Py2CppFeatureTest.test_is_pytra_module_name Py2CppFeatureTest.test_split_top_level_union_splits_only_top_level_pipe Py2CppFeatureTest.test_split_type_args_splits_bracket_nested_commas Py2CppFeatureTest.test_split_graph_issue_entry Py2CppFeatureTest.test_local_binding_name_prefers_alias Py2CppFeatureTest.test_looks_like_runtime_function_name Py2CppFeatureTest.test_dict_str_get_returns_default_when_missing Py2CppFeatureTest.test_split_top_level_csv_splits_only_top_level_commas Py2CppFeatureTest.test_append_unique_non_empty_appends_once Py2CppFeatureTest.test_split_ws_tokens_splits_ascii_whitespace Py2CppFeatureTest.test_count_text_lines_counts_newlines Py2CppFeatureTest.test_write_text_file_writes_text Py2CppFeatureTest.test_mkdirs_for_cli_creates_directory Py2CppFeatureTest.test_path_parent_text_returns_parent_dir Py2CppFeatureTest.test_replace_first_replaces_single_match Py2CppFeatureTest.test_split_infix_once_splits_first_match Py2CppFeatureTest.test_join_str_list_joins_items Py2CppFeatureTest.test_sort_str_list_copy_returns_sorted_copy`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 既知維持）、`python3 tools/check_transpiler_version_gate.py`（`shared 0.24.0 -> 0.25.0`、`cpp 0.131.0 -> 0.132.0`）を確認した。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた import graph 循環検出 helper `_graph_cycle_dfs` を `src/pytra/compiler/transpile_cli.py::graph_cycle_dfs` へ移管した。`py2cpp` 側の利用箇所（`_analyze_import_graph` の循環検出）を共通 helper 呼び出しへ置換し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲットと support block 抽出対象へ同 helper を追加した。`test/unit/test_py2cpp_features.py`（`test_graph_cycle_dfs_collects_cycle`）と `test/unit/test_prepare_selfhost_source.py` を更新し、`python3 -m py_compile src/py2cpp.py src/pytra/compiler/transpile_cli.py tools/prepare_selfhost_source.py test/unit/test_prepare_selfhost_source.py test/unit/test_py2cpp_features.py`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_graph_path_helpers Py2CppFeatureTest.test_module_name_from_path_for_graph Py2CppFeatureTest.test_graph_cycle_dfs_collects_cycle Py2CppFeatureTest.test_is_pytra_module_name Py2CppFeatureTest.test_split_top_level_union_splits_only_top_level_pipe Py2CppFeatureTest.test_split_type_args_splits_bracket_nested_commas Py2CppFeatureTest.test_split_graph_issue_entry Py2CppFeatureTest.test_local_binding_name_prefers_alias Py2CppFeatureTest.test_looks_like_runtime_function_name Py2CppFeatureTest.test_dict_str_get_returns_default_when_missing Py2CppFeatureTest.test_split_top_level_csv_splits_only_top_level_commas Py2CppFeatureTest.test_append_unique_non_empty_appends_once Py2CppFeatureTest.test_split_ws_tokens_splits_ascii_whitespace Py2CppFeatureTest.test_count_text_lines_counts_newlines Py2CppFeatureTest.test_write_text_file_writes_text Py2CppFeatureTest.test_mkdirs_for_cli_creates_directory Py2CppFeatureTest.test_path_parent_text_returns_parent_dir Py2CppFeatureTest.test_replace_first_replaces_single_match Py2CppFeatureTest.test_split_infix_once_splits_first_match Py2CppFeatureTest.test_join_str_list_joins_items Py2CppFeatureTest.test_sort_str_list_copy_returns_sorted_copy`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 既知維持）、`python3 tools/check_transpiler_version_gate.py`（`shared 0.25.0 -> 0.26.0`、`cpp 0.132.0 -> 0.133.0`）を確認した。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた import graph ユーザーモジュール解決 helper `_resolve_user_module_path_for_graph` を `src/pytra/compiler/transpile_cli.py::resolve_user_module_path_for_graph` へ移管した。`py2cpp` 側の利用箇所（`_resolve_module_name_for_graph`）を共通 helper 呼び出しへ置換し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲットと support block 抽出対象へ同 helper を追加した。`test/unit/test_py2cpp_features.py`（`test_resolve_user_module_path_for_graph_prefers_package_init`）と `test/unit/test_prepare_selfhost_source.py` を更新し、`python3 -m py_compile src/py2cpp.py src/pytra/compiler/transpile_cli.py tools/prepare_selfhost_source.py test/unit/test_prepare_selfhost_source.py test/unit/test_py2cpp_features.py`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_graph_path_helpers Py2CppFeatureTest.test_module_name_from_path_for_graph Py2CppFeatureTest.test_graph_cycle_dfs_collects_cycle Py2CppFeatureTest.test_resolve_user_module_path_for_graph_prefers_package_init Py2CppFeatureTest.test_is_pytra_module_name Py2CppFeatureTest.test_split_top_level_union_splits_only_top_level_pipe Py2CppFeatureTest.test_split_type_args_splits_bracket_nested_commas Py2CppFeatureTest.test_split_graph_issue_entry Py2CppFeatureTest.test_local_binding_name_prefers_alias Py2CppFeatureTest.test_looks_like_runtime_function_name Py2CppFeatureTest.test_dict_str_get_returns_default_when_missing Py2CppFeatureTest.test_split_top_level_csv_splits_only_top_level_commas Py2CppFeatureTest.test_append_unique_non_empty_appends_once Py2CppFeatureTest.test_split_ws_tokens_splits_ascii_whitespace Py2CppFeatureTest.test_count_text_lines_counts_newlines Py2CppFeatureTest.test_write_text_file_writes_text Py2CppFeatureTest.test_mkdirs_for_cli_creates_directory Py2CppFeatureTest.test_path_parent_text_returns_parent_dir Py2CppFeatureTest.test_replace_first_replaces_single_match Py2CppFeatureTest.test_split_infix_once_splits_first_match Py2CppFeatureTest.test_join_str_list_joins_items Py2CppFeatureTest.test_sort_str_list_copy_returns_sorted_copy`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 既知維持）、`python3 tools/check_transpiler_version_gate.py`（`shared 0.26.0 -> 0.27.0`、`cpp 0.133.0 -> 0.134.0`）を確認した。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた import graph レポート整形 helper `_format_graph_list_section` を `src/pytra/compiler/transpile_cli.py::format_graph_list_section` へ移管した。`py2cpp` 側の利用箇所（`_format_import_graph_report`）を共通 helper 呼び出しへ置換し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲットと support block 抽出対象へ同 helper を追加した。`test/unit/test_py2cpp_features.py`（`test_format_graph_list_section`）と `test/unit/test_prepare_selfhost_source.py` を更新し、`python3 -m py_compile src/py2cpp.py src/pytra/compiler/transpile_cli.py tools/prepare_selfhost_source.py test/unit/test_prepare_selfhost_source.py test/unit/test_py2cpp_features.py`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_graph_path_helpers Py2CppFeatureTest.test_module_name_from_path_for_graph Py2CppFeatureTest.test_graph_cycle_dfs_collects_cycle Py2CppFeatureTest.test_resolve_user_module_path_for_graph_prefers_package_init Py2CppFeatureTest.test_format_graph_list_section Py2CppFeatureTest.test_is_pytra_module_name Py2CppFeatureTest.test_split_top_level_union_splits_only_top_level_pipe Py2CppFeatureTest.test_split_type_args_splits_bracket_nested_commas Py2CppFeatureTest.test_split_graph_issue_entry Py2CppFeatureTest.test_local_binding_name_prefers_alias Py2CppFeatureTest.test_looks_like_runtime_function_name Py2CppFeatureTest.test_dict_str_get_returns_default_when_missing Py2CppFeatureTest.test_split_top_level_csv_splits_only_top_level_commas Py2CppFeatureTest.test_append_unique_non_empty_appends_once Py2CppFeatureTest.test_split_ws_tokens_splits_ascii_whitespace Py2CppFeatureTest.test_count_text_lines_counts_newlines Py2CppFeatureTest.test_write_text_file_writes_text Py2CppFeatureTest.test_mkdirs_for_cli_creates_directory Py2CppFeatureTest.test_path_parent_text_returns_parent_dir Py2CppFeatureTest.test_replace_first_replaces_single_match Py2CppFeatureTest.test_split_infix_once_splits_first_match Py2CppFeatureTest.test_join_str_list_joins_items Py2CppFeatureTest.test_sort_str_list_copy_returns_sorted_copy`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 既知維持）、`python3 tools/check_transpiler_version_gate.py`（`shared 0.27.0 -> 0.28.0`、`cpp 0.134.0 -> 0.135.0`）を確認した。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた EAST module_id 読取 helper `_module_id_from_east_for_graph` を `src/pytra/compiler/transpile_cli.py::module_id_from_east_for_graph` へ移管した。`py2cpp` 側の利用箇所（`_module_export_table`）を共通 helper 呼び出しへ置換し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲットと support block 抽出対象へ同 helper を追加した。`test/unit/test_py2cpp_features.py`（`test_module_id_from_east_for_graph`）と `test/unit/test_prepare_selfhost_source.py` を更新し、`python3 -m py_compile src/py2cpp.py src/pytra/compiler/transpile_cli.py tools/prepare_selfhost_source.py test/unit/test_prepare_selfhost_source.py test/unit/test_py2cpp_features.py`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_graph_path_helpers Py2CppFeatureTest.test_module_name_from_path_for_graph Py2CppFeatureTest.test_module_id_from_east_for_graph Py2CppFeatureTest.test_graph_cycle_dfs_collects_cycle Py2CppFeatureTest.test_resolve_user_module_path_for_graph_prefers_package_init Py2CppFeatureTest.test_format_graph_list_section Py2CppFeatureTest.test_is_pytra_module_name Py2CppFeatureTest.test_split_top_level_union_splits_only_top_level_pipe Py2CppFeatureTest.test_split_type_args_splits_bracket_nested_commas Py2CppFeatureTest.test_split_graph_issue_entry Py2CppFeatureTest.test_local_binding_name_prefers_alias Py2CppFeatureTest.test_looks_like_runtime_function_name Py2CppFeatureTest.test_dict_str_get_returns_default_when_missing Py2CppFeatureTest.test_split_top_level_csv_splits_only_top_level_commas Py2CppFeatureTest.test_append_unique_non_empty_appends_once Py2CppFeatureTest.test_split_ws_tokens_splits_ascii_whitespace Py2CppFeatureTest.test_count_text_lines_counts_newlines Py2CppFeatureTest.test_write_text_file_writes_text Py2CppFeatureTest.test_mkdirs_for_cli_creates_directory Py2CppFeatureTest.test_path_parent_text_returns_parent_dir Py2CppFeatureTest.test_replace_first_replaces_single_match Py2CppFeatureTest.test_split_infix_once_splits_first_match Py2CppFeatureTest.test_join_str_list_joins_items Py2CppFeatureTest.test_sort_str_list_copy_returns_sorted_copy`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 既知維持）、`python3 tools/check_transpiler_version_gate.py`（`shared 0.28.0 -> 0.29.0`、`cpp 0.135.0 -> 0.136.0`）を確認した。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた import モジュール抽出 helper `_collect_import_modules` を `src/pytra/compiler/transpile_cli.py::collect_import_modules` へ移管した。`py2cpp` 側の利用箇所（`_analyze_import_graph`）を共通 helper 呼び出しへ置換し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲットと support block 抽出対象へ同 helper を追加した。`test/unit/test_py2cpp_features.py`（`test_collect_import_modules`）と `test/unit/test_prepare_selfhost_source.py` を更新し、`python3 -m py_compile src/py2cpp.py src/pytra/compiler/transpile_cli.py tools/prepare_selfhost_source.py test/unit/test_prepare_selfhost_source.py test/unit/test_py2cpp_features.py`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_graph_path_helpers Py2CppFeatureTest.test_module_name_from_path_for_graph Py2CppFeatureTest.test_module_id_from_east_for_graph Py2CppFeatureTest.test_collect_import_modules Py2CppFeatureTest.test_graph_cycle_dfs_collects_cycle Py2CppFeatureTest.test_resolve_user_module_path_for_graph_prefers_package_init Py2CppFeatureTest.test_format_graph_list_section Py2CppFeatureTest.test_is_pytra_module_name Py2CppFeatureTest.test_split_top_level_union_splits_only_top_level_pipe Py2CppFeatureTest.test_split_type_args_splits_bracket_nested_commas Py2CppFeatureTest.test_split_graph_issue_entry Py2CppFeatureTest.test_local_binding_name_prefers_alias Py2CppFeatureTest.test_looks_like_runtime_function_name Py2CppFeatureTest.test_dict_str_get_returns_default_when_missing Py2CppFeatureTest.test_split_top_level_csv_splits_only_top_level_commas Py2CppFeatureTest.test_append_unique_non_empty_appends_once Py2CppFeatureTest.test_split_ws_tokens_splits_ascii_whitespace Py2CppFeatureTest.test_count_text_lines_counts_newlines Py2CppFeatureTest.test_write_text_file_writes_text Py2CppFeatureTest.test_mkdirs_for_cli_creates_directory Py2CppFeatureTest.test_path_parent_text_returns_parent_dir Py2CppFeatureTest.test_replace_first_replaces_single_match Py2CppFeatureTest.test_split_infix_once_splits_first_match Py2CppFeatureTest.test_join_str_list_joins_items Py2CppFeatureTest.test_sort_str_list_copy_returns_sorted_copy`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 既知維持）、`python3 tools/check_transpiler_version_gate.py`（`shared 0.29.0 -> 0.30.0`、`cpp 0.136.0 -> 0.137.0`）を確認した。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた既知 non-user import 判定 helper `_is_known_non_user_import` を `src/pytra/compiler/transpile_cli.py::is_known_non_user_import` へ移管した。`py2cpp` 側の利用箇所（`_resolve_module_name_for_graph` と `resolve_module_name`）を共通 helper 呼び出しへ置換し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲットと support block 抽出対象へ同 helper を追加した。`test/unit/test_py2cpp_features.py`（`test_is_known_non_user_import`）と `test/unit/test_prepare_selfhost_source.py` を更新し、`python3 -m py_compile src/py2cpp.py src/pytra/compiler/transpile_cli.py tools/prepare_selfhost_source.py test/unit/test_prepare_selfhost_source.py test/unit/test_py2cpp_features.py`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_collect_import_modules Py2CppFeatureTest.test_is_known_non_user_import Py2CppFeatureTest.test_module_id_from_east_for_graph Py2CppFeatureTest.test_format_graph_list_section Py2CppFeatureTest.test_graph_cycle_dfs_collects_cycle Py2CppFeatureTest.test_resolve_user_module_path_for_graph_prefers_package_init`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 既知維持）、`python3 tools/check_transpiler_version_gate.py`（`shared 0.30.0 -> 0.31.0`、`cpp 0.137.0 -> 0.138.0`）を確認した。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた import graph モジュール分類 helper `_resolve_module_name_for_graph` を `src/pytra/compiler/transpile_cli.py::resolve_module_name_for_graph` へ移管した。`py2cpp` 側の利用箇所（`_analyze_import_graph`）を共通 helper 呼び出しへ置換し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲットと support block 抽出対象へ同 helper を追加した。`test/unit/test_py2cpp_features.py`（`test_resolve_module_name_for_graph`）と `test/unit/test_prepare_selfhost_source.py` を更新し、`python3 -m py_compile src/py2cpp.py src/pytra/compiler/transpile_cli.py tools/prepare_selfhost_source.py test/unit/test_prepare_selfhost_source.py test/unit/test_py2cpp_features.py`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_collect_import_modules Py2CppFeatureTest.test_is_known_non_user_import Py2CppFeatureTest.test_resolve_module_name_for_graph Py2CppFeatureTest.test_module_id_from_east_for_graph Py2CppFeatureTest.test_format_graph_list_section Py2CppFeatureTest.test_graph_cycle_dfs_collects_cycle Py2CppFeatureTest.test_resolve_user_module_path_for_graph_prefers_package_init`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 既知維持）、`python3 tools/check_transpiler_version_gate.py`（`shared 0.31.0 -> 0.32.0`、`cpp 0.138.0 -> 0.139.0`）を確認した。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた `resolve_module_name` 専用 helper `_resolve_user_module_path` を削除し、共通 helper `src/pytra/compiler/transpile_cli.py::resolve_user_module_path_for_graph` へ統一した。これにより module 解決ロジック（`<mod>/__init__.py` 優先、親ディレクトリ遡り探索）の重複を解消した。`python3 -m py_compile src/py2cpp.py src/pytra/compiler/transpiler_versions.json test/unit/test_py2cpp_features.py`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_resolve_module_name_classifies_user_pytra_and_missing Py2CppFeatureTest.test_resolve_module_name_prefers_named_package_module_over_local_flat_copy Py2CppFeatureTest.test_resolve_module_name_recognizes_std_and_utils_shims Py2CppFeatureTest.test_analyze_import_graph_resolves_from_importer_directory`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 既知維持）、`python3 tools/check_transpiler_version_gate.py`（`cpp 0.139.0 -> 0.140.0`）を確認した。
- `P1-COMP-09` の継続として、`src/py2cpp.py::resolve_module_name` 自体の分類分岐を `src/pytra/compiler/transpile_cli.py::resolve_module_name_for_graph` 呼び出しへ一本化した。`py2cpp` 側は `status/module_id/path` の整形（`path` は `Path | None` へ変換）だけを担当する構成へ縮退し、`relative/pytra/user/known/missing` 判定ロジックの重複を解消した。`python3 -m py_compile src/py2cpp.py src/pytra/compiler/transpiler_versions.json test/unit/test_py2cpp_features.py`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_resolve_module_name_classifies_user_pytra_and_missing Py2CppFeatureTest.test_resolve_module_name_prefers_named_package_module_over_local_flat_copy Py2CppFeatureTest.test_resolve_module_name_recognizes_std_and_utils_shims Py2CppFeatureTest.test_analyze_import_graph_resolves_from_importer_directory`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 既知維持）、`python3 tools/check_transpiler_version_gate.py`（`cpp 0.140.0 -> 0.141.0`）を確認した。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた runtime module 存在判定 helper `_python_module_exists_under` を `src/pytra/compiler/transpile_cli.py::python_module_exists_under` へ移管した。`py2cpp` 側の利用箇所（`_normalize_runtime_module_name`, `_module_name_to_cpp_include`）を共通 helper 呼び出しへ置換し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲット・support block 抽出対象・`test/unit/test_prepare_selfhost_source.py` の期待値を更新した。`test/unit/test_py2cpp_features.py` には `test_python_module_exists_under_detects_py_and_package` を追加し、`python3 -m py_compile src/py2cpp.py src/pytra/compiler/transpile_cli.py tools/prepare_selfhost_source.py test/unit/test_prepare_selfhost_source.py test/unit/test_py2cpp_features.py`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_python_module_exists_under_detects_py_and_package Py2CppFeatureTest.test_resolve_module_name_classifies_user_pytra_and_missing Py2CppFeatureTest.test_resolve_module_name_prefers_named_package_module_over_local_flat_copy Py2CppFeatureTest.test_resolve_module_name_recognizes_std_and_utils_shims Py2CppFeatureTest.test_analyze_import_graph_resolves_from_importer_directory`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 既知維持）、`python3 tools/check_transpiler_version_gate.py`（`shared 0.32.0 -> 0.33.0`, `cpp 0.141.0 -> 0.142.0`）を確認した。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた user error 整形 helper（`_make_user_error`, `_parse_user_error`）を `src/pytra/compiler/transpile_cli.py::{make_user_error, parse_user_error}` へ移管した。`py2cpp` 側のすべての呼び出しを共通 helper へ置換し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲット・support block 抽出対象、および `test/unit/test_prepare_selfhost_source.py` の期待値を更新した。`test/unit/test_py2cpp_features.py` には `test_make_and_parse_user_error_roundtrip` / `test_parse_user_error_non_tagged_text` を追加し、`python3 -m py_compile src/py2cpp.py src/pytra/compiler/transpile_cli.py tools/prepare_selfhost_source.py test/unit/test_prepare_selfhost_source.py test/unit/test_py2cpp_features.py`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_make_and_parse_user_error_roundtrip Py2CppFeatureTest.test_parse_user_error_non_tagged_text Py2CppFeatureTest.test_python_module_exists_under_detects_py_and_package Py2CppFeatureTest.test_resolve_module_name_classifies_user_pytra_and_missing Py2CppFeatureTest.test_resolve_module_name_prefers_named_package_module_over_local_flat_copy Py2CppFeatureTest.test_resolve_module_name_recognizes_std_and_utils_shims Py2CppFeatureTest.test_analyze_import_graph_resolves_from_importer_directory`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 既知維持）、`python3 tools/check_transpiler_version_gate.py`（`shared 0.33.0 -> 0.34.0`, `cpp 0.142.0 -> 0.143.0`）を確認した。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた import 診断 helper `_first_import_detail_line` を `src/pytra/compiler/transpile_cli.py::first_import_detail_line` へ移管した。`py2cpp` 側の wildcard/relative import エラー経路を共通 helper 呼び出しへ置換し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲット・support block 抽出対象、および `test/unit/test_prepare_selfhost_source.py` の期待値を更新した。`test/unit/test_py2cpp_features.py` には `test_first_import_detail_line_extracts_wildcard_and_relative` / `test_first_import_detail_line_fallback` を追加し、`python3 -m py_compile src/py2cpp.py src/pytra/compiler/transpile_cli.py tools/prepare_selfhost_source.py test/unit/test_prepare_selfhost_source.py test/unit/test_py2cpp_features.py`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_make_and_parse_user_error_roundtrip Py2CppFeatureTest.test_parse_user_error_non_tagged_text Py2CppFeatureTest.test_first_import_detail_line_extracts_wildcard_and_relative Py2CppFeatureTest.test_first_import_detail_line_fallback Py2CppFeatureTest.test_python_module_exists_under_detects_py_and_package Py2CppFeatureTest.test_resolve_module_name_classifies_user_pytra_and_missing Py2CppFeatureTest.test_resolve_module_name_prefers_named_package_module_over_local_flat_copy Py2CppFeatureTest.test_resolve_module_name_recognizes_std_and_utils_shims Py2CppFeatureTest.test_analyze_import_graph_resolves_from_importer_directory`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 既知維持）、`python3 tools/check_transpiler_version_gate.py`（`shared 0.34.0 -> 0.35.0`, `cpp 0.143.0 -> 0.144.0`）を確認した。
- `P1-COMP-09` の継続として、`src/py2cpp.py` の multi-file module_id 補助 helper（`_module_name_from_path`, `_module_id_from_east`）を削除し、既存の共通 helper `src/pytra/compiler/transpile_cli.py::module_id_from_east_for_graph` へ統一した。`_write_multi_file_cpp` 内の module_id 解決を共通 helper 呼び出しへ置換し、`python3 -m py_compile src/py2cpp.py src/pytra/compiler/transpiler_versions.json test/unit/test_py2cpp_features.py`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_module_id_from_east_for_graph Py2CppFeatureTest.test_build_module_east_map_sets_module_id_from_import_name Py2CppFeatureTest.test_multi_file_from_import_alias_uses_fully_qualified_symbol Py2CppFeatureTest.test_cli_multi_file_generates_out_include_src Py2CppFeatureTest.test_make_and_parse_user_error_roundtrip Py2CppFeatureTest.test_parse_user_error_non_tagged_text Py2CppFeatureTest.test_first_import_detail_line_extracts_wildcard_and_relative Py2CppFeatureTest.test_first_import_detail_line_fallback`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 既知維持）、`python3 tools/check_transpiler_version_gate.py`（`cpp 0.144.0 -> 0.145.0`）を確認した。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた EAST meta 正規化 helper（`_meta_import_bindings`, `_meta_qualified_symbol_refs`）を `src/pytra/compiler/transpile_cli.py::{meta_import_bindings, meta_qualified_symbol_refs}` へ移管した。`py2cpp` 側の利用箇所（`dump_deps_text`, `build_module_symbol_index`）を共通 helper 呼び出しへ統一し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲット・support block 抽出対象・`test/unit/test_prepare_selfhost_source.py` の期待値を更新した。`test/unit/test_py2cpp_features.py` では `test_east_meta_import_bindings_is_emitted` を共通 helper 検証へ拡張し、`python3 -m py_compile src/py2cpp.py src/pytra/compiler/transpile_cli.py tools/prepare_selfhost_source.py test/unit/test_prepare_selfhost_source.py test/unit/test_py2cpp_features.py`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_east_meta_import_bindings_is_emitted Py2CppFeatureTest.test_make_and_parse_user_error_roundtrip Py2CppFeatureTest.test_parse_user_error_non_tagged_text Py2CppFeatureTest.test_first_import_detail_line_extracts_wildcard_and_relative Py2CppFeatureTest.test_first_import_detail_line_fallback Py2CppFeatureTest.test_module_id_from_east_for_graph Py2CppFeatureTest.test_build_module_east_map_sets_module_id_from_import_name Py2CppFeatureTest.test_multi_file_from_import_alias_uses_fully_qualified_symbol Py2CppFeatureTest.test_cli_multi_file_generates_out_include_src`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功、既知 warning のみ）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 既知維持）、`python3 tools/check_transpiler_version_gate.py`（`shared 0.35.0 -> 0.36.0`, `cpp 0.145.0 -> 0.146.0`）を確認した。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた multi-file ラベル helper（`_sanitize_module_label`, `_module_rel_label`）を `src/pytra/compiler/transpile_cli.py::{sanitize_module_label, module_rel_label}` へ移管した。`py2cpp` 側の利用箇所（`_write_multi_file_cpp` の module label / include guard 生成）を共通 helper 呼び出しへ統一し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲット・support block 抽出対象・`test/unit/test_prepare_selfhost_source.py` の期待値を更新した。`test/unit/test_py2cpp_features.py` には `test_sanitize_module_label` / `test_module_rel_label` を追加し、`python3 -m py_compile src/py2cpp.py src/pytra/compiler/transpile_cli.py tools/prepare_selfhost_source.py test/unit/test_prepare_selfhost_source.py test/unit/test_py2cpp_features.py`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_sanitize_module_label Py2CppFeatureTest.test_module_rel_label Py2CppFeatureTest.test_module_id_from_east_for_graph Py2CppFeatureTest.test_multi_file_from_import_alias_uses_fully_qualified_symbol Py2CppFeatureTest.test_cli_multi_file_generates_out_include_src`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功、既知 warning のみ）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 既知維持）、`python3 tools/check_transpiler_version_gate.py`（`shared 0.36.0 -> 0.37.0`, `cpp 0.146.0 -> 0.147.0`）を確認した。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた include 挿入 helper `_inject_after_includes_block` を `src/pytra/compiler/transpile_cli.py::inject_after_includes_block` へ移管した。`py2cpp` 側の利用箇所（`_write_multi_file_cpp` の forward declare 注入）を共通 helper 呼び出しへ統一し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲット・support block 抽出対象・`test/unit/test_prepare_selfhost_source.py` の期待値を更新した。`test/unit/test_py2cpp_features.py` には `test_inject_after_includes_block` を追加し、`python3 -m py_compile src/py2cpp.py src/pytra/compiler/transpile_cli.py tools/prepare_selfhost_source.py test/unit/test_prepare_selfhost_source.py test/unit/test_py2cpp_features.py`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_inject_after_includes_block Py2CppFeatureTest.test_replace_first_replaces_single_match Py2CppFeatureTest.test_sanitize_module_label Py2CppFeatureTest.test_module_rel_label Py2CppFeatureTest.test_multi_file_from_import_alias_uses_fully_qualified_symbol Py2CppFeatureTest.test_cli_multi_file_generates_out_include_src`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功、既知 warning のみ）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 既知維持）、`python3 tools/check_transpiler_version_gate.py`（`shared 0.37.0 -> 0.38.0`, `cpp 0.147.0 -> 0.148.0`）を確認した。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた `dict[str, Any]` 文字列取得 helper `_dict_any_get_str` を `src/pytra/compiler/transpile_cli.py::dict_any_get_str` へ移管した。`py2cpp` 側の利用箇所（AST/meta 参照、import graph 解析、multi-file 生成、error 解析など）を共通 helper 呼び出しへ統一し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲット・support block 抽出対象・`test/unit/test_prepare_selfhost_source.py` の期待値を更新した。`test/unit/test_py2cpp_features.py` には `test_dict_any_get_str_returns_default_for_non_str` を追加し、`python3 -m py_compile src/py2cpp.py src/pytra/compiler/transpile_cli.py tools/prepare_selfhost_source.py test/unit/test_prepare_selfhost_source.py test/unit/test_py2cpp_features.py`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_dict_any_get_str_returns_default_for_non_str Py2CppFeatureTest.test_dict_str_get_returns_default_when_missing Py2CppFeatureTest.test_inject_after_includes_block Py2CppFeatureTest.test_multi_file_from_import_alias_uses_fully_qualified_symbol Py2CppFeatureTest.test_cli_multi_file_generates_out_include_src`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功、既知 warning のみ）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 既知維持）、`python3 tools/check_transpiler_version_gate.py`（`shared 0.38.0 -> 0.39.0`, `cpp 0.148.0 -> 0.149.0`）を確認した。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた `kind` 取得 helper `_dict_any_kind` を `src/pytra/compiler/transpile_cli.py::dict_any_kind` へ移管した。`py2cpp` 側の利用箇所（target/stmt kind 判定、AST payload 分岐、module schema 収集など）を共通 helper 呼び出しへ統一し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲット・support block 抽出対象・`test/unit/test_prepare_selfhost_source.py` の期待値を更新した。`test/unit/test_py2cpp_features.py` には `test_dict_any_kind` を追加し、`python3 -m py_compile src/py2cpp.py src/pytra/compiler/transpile_cli.py tools/prepare_selfhost_source.py test/unit/test_prepare_selfhost_source.py test/unit/test_py2cpp_features.py`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_dict_any_get_str_returns_default_for_non_str Py2CppFeatureTest.test_dict_any_kind Py2CppFeatureTest.test_dict_str_get_returns_default_when_missing Py2CppFeatureTest.test_inject_after_includes_block Py2CppFeatureTest.test_multi_file_from_import_alias_uses_fully_qualified_symbol Py2CppFeatureTest.test_cli_multi_file_generates_out_include_src`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功、既知 warning のみ）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 既知維持）、`python3 tools/check_transpiler_version_gate.py`（`shared 0.39.0 -> 0.40.0`, `cpp 0.149.0 -> 0.150.0`）を確認した。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた `list[str]` 抽出 helper `_dict_any_get_str_list` を `src/pytra/compiler/transpile_cli.py::dict_any_get_str_list` へ移管した。`py2cpp` 側の利用箇所（guard の import graph ノード/エッジ数、import graph report/validation、error details 取得）を共通 helper 呼び出しへ統一し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲット・support block 抽出対象・`test/unit/test_prepare_selfhost_source.py` の期待値を更新した。`test/unit/test_py2cpp_features.py` には `test_dict_any_get_str_list_filters_non_str` を追加し、`python3 -m py_compile src/py2cpp.py src/pytra/compiler/transpile_cli.py tools/prepare_selfhost_source.py test/unit/test_prepare_selfhost_source.py test/unit/test_py2cpp_features.py`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_dict_any_get_str_returns_default_for_non_str Py2CppFeatureTest.test_dict_any_kind Py2CppFeatureTest.test_dict_any_get_str_list_filters_non_str Py2CppFeatureTest.test_dict_str_get_returns_default_when_missing Py2CppFeatureTest.test_multi_file_from_import_alias_uses_fully_qualified_symbol Py2CppFeatureTest.test_cli_multi_file_generates_out_include_src`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功、既知 warning のみ）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 既知維持）、`python3 tools/check_transpiler_version_gate.py`（`shared 0.40.0 -> 0.41.0`, `cpp 0.150.0 -> 0.151.0`）を確認した。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた `list[Any]` 抽出 helper `_dict_any_get_list` を `src/pytra/compiler/transpile_cli.py::dict_any_get_list` へ移管した。`py2cpp` 側の利用箇所（`arg_order` 読取や dict-list 正規化前段）を共通 helper 呼び出しへ統一し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲット・support block 抽出対象・`test/unit/test_prepare_selfhost_source.py` の期待値を更新した。`test/unit/test_py2cpp_features.py` には `test_dict_any_get_list_returns_empty_for_non_list` を追加し、`python3 -m py_compile src/py2cpp.py src/pytra/compiler/transpile_cli.py tools/prepare_selfhost_source.py test/unit/test_prepare_selfhost_source.py test/unit/test_py2cpp_features.py`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_dict_any_get_list_returns_empty_for_non_list Py2CppFeatureTest.test_dict_any_get_str_list_filters_non_str Py2CppFeatureTest.test_dict_any_kind Py2CppFeatureTest.test_dict_any_get_str_returns_default_for_non_str Py2CppFeatureTest.test_dict_str_get_returns_default_when_missing`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功、既知 warning のみ）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 既知維持）、`python3 tools/check_transpiler_version_gate.py`（`shared 0.41.0 -> 0.42.0`, `cpp 0.151.0 -> 0.152.0`）を確認した。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた `dict[str, Any]` 取得 helper `_dict_any_get_dict` を `src/pytra/compiler/transpile_cli.py::dict_any_get_dict` へ移管した。`py2cpp` 側の利用箇所（meta/import/type schema/target などの dict 正規化）を共通 helper 呼び出しへ統一し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲット・support block 抽出対象・`test/unit/test_prepare_selfhost_source.py` の期待値を更新した。`test/unit/test_py2cpp_features.py` には `test_dict_any_get_dict_returns_empty_for_non_dict` を追加し、`python3 -m py_compile src/py2cpp.py src/pytra/compiler/transpile_cli.py tools/prepare_selfhost_source.py test/unit/test_prepare_selfhost_source.py test/unit/test_py2cpp_features.py`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_dict_any_get_dict_returns_empty_for_non_dict Py2CppFeatureTest.test_dict_any_get_list_returns_empty_for_non_list Py2CppFeatureTest.test_dict_any_get_str_list_filters_non_str Py2CppFeatureTest.test_dict_any_kind Py2CppFeatureTest.test_dict_any_get_str_returns_default_for_non_str Py2CppFeatureTest.test_dict_str_get_returns_default_when_missing`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功、既知 warning のみ）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 既知維持）、`python3 tools/check_transpiler_version_gate.py`（`shared 0.42.0 -> 0.43.0`, `cpp 0.152.0 -> 0.153.0`）を確認した。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた `list[dict[str, Any]]` 取得 helper `_dict_any_get_dict_list` を `src/pytra/compiler/transpile_cli.py::dict_any_get_dict_list` へ移管した。`py2cpp` 側の利用箇所（stmt/body/handlers/cases/items/names などの dict list 正規化）を共通 helper 呼び出しへ統一し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲット・support block 抽出対象・`test/unit/test_prepare_selfhost_source.py` の期待値を更新した。`test/unit/test_py2cpp_features.py` には `test_dict_any_get_dict_list_filters_non_dict` を追加し、`python3 -m py_compile src/py2cpp.py src/pytra/compiler/transpile_cli.py tools/prepare_selfhost_source.py test/unit/test_prepare_selfhost_source.py test/unit/test_py2cpp_features.py`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_dict_any_get_dict_list_filters_non_dict Py2CppFeatureTest.test_dict_any_get_dict_returns_empty_for_non_dict Py2CppFeatureTest.test_dict_any_get_list_returns_empty_for_non_list Py2CppFeatureTest.test_dict_any_get_str_list_filters_non_str Py2CppFeatureTest.test_dict_any_kind Py2CppFeatureTest.test_dict_any_get_str_returns_default_for_non_str Py2CppFeatureTest.test_dict_str_get_returns_default_when_missing`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功、既知 warning のみ）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 既知維持）、`python3 tools/check_transpiler_version_gate.py`（`shared 0.43.0 -> 0.44.0`, `cpp 0.153.0 -> 0.154.0`）を確認した。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた汎用 getter `_dict_any_get` を `src/pytra/compiler/transpile_cli.py::dict_any_get` へ移管した。`py2cpp` 側の利用箇所（`func`/`ok`/`east` の payload 読取）を共通 helper 呼び出しへ統一し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲット・support block 抽出対象・`test/unit/test_prepare_selfhost_source.py` の期待値を更新した。`test/unit/test_py2cpp_features.py` には `test_dict_any_get_returns_none_for_missing` を追加し、`python3 -m py_compile src/py2cpp.py src/pytra/compiler/transpile_cli.py tools/prepare_selfhost_source.py test/unit/test_prepare_selfhost_source.py test/unit/test_py2cpp_features.py`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_dict_any_get_returns_none_for_missing Py2CppFeatureTest.test_dict_any_get_dict_list_filters_non_dict Py2CppFeatureTest.test_dict_any_get_dict_returns_empty_for_non_dict Py2CppFeatureTest.test_dict_any_get_list_returns_empty_for_non_list Py2CppFeatureTest.test_dict_any_get_str_list_filters_non_str Py2CppFeatureTest.test_dict_any_kind Py2CppFeatureTest.test_dict_any_get_str_returns_default_for_non_str Py2CppFeatureTest.test_dict_str_get_returns_default_when_missing`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功、既知 warning のみ）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 既知維持）、`python3 tools/check_transpiler_version_gate.py`（`shared 0.44.0 -> 0.45.0`, `cpp 0.154.0 -> 0.155.0`）を確認した。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた Assign 正規化 helper `_assign_targets` を `src/pytra/compiler/transpile_cli.py::assign_targets` へ移管した。`py2cpp` 側の `Assign/AnnAssign` 代入先抽出で共通 helper 呼び出しへ統一し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲット・support block 抽出対象・`test/unit/test_prepare_selfhost_source.py` の期待値を更新した。`test/unit/test_py2cpp_features.py` には `test_assign_targets_prefers_targets_then_target` を追加し、`python3 -m py_compile src/py2cpp.py src/pytra/compiler/transpile_cli.py tools/prepare_selfhost_source.py test/unit/test_prepare_selfhost_source.py test/unit/test_py2cpp_features.py`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_assign_targets_prefers_targets_then_target Py2CppFeatureTest.test_dict_any_get_returns_none_for_missing Py2CppFeatureTest.test_dict_any_get_dict_list_filters_non_dict Py2CppFeatureTest.test_dict_any_get_dict_returns_empty_for_non_dict Py2CppFeatureTest.test_dict_any_get_list_returns_empty_for_non_list Py2CppFeatureTest.test_dict_any_get_str_list_filters_non_str Py2CppFeatureTest.test_dict_any_kind Py2CppFeatureTest.test_dict_any_get_str_returns_default_for_non_str Py2CppFeatureTest.test_dict_str_get_returns_default_when_missing`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功、既知 warning のみ）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 既知維持）、`python3 tools/check_transpiler_version_gate.py`（`shared 0.45.0 -> 0.46.0`, `cpp 0.155.0 -> 0.156.0`）を確認した。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた Name target 判定 helper `_name_target_id` を `src/pytra/compiler/transpile_cli.py::name_target_id` へ移管した。`py2cpp` 側の `Assign/AnnAssign` 代入名抽出（`_stmt_target_name`, `_stmt_assigned_names`）は共通 helper 呼び出しへ統一し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲット・support block 抽出対象・`test/unit/test_prepare_selfhost_source.py` の期待値を更新した。`test/unit/test_py2cpp_features.py` には `test_name_target_id_returns_name_only` を追加し、`python3 -m py_compile src/py2cpp.py src/pytra/compiler/transpile_cli.py tools/prepare_selfhost_source.py test/unit/test_prepare_selfhost_source.py test/unit/test_py2cpp_features.py`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_name_target_id_returns_name_only Py2CppFeatureTest.test_assign_targets_prefers_targets_then_target Py2CppFeatureTest.test_dict_any_get_returns_none_for_missing Py2CppFeatureTest.test_dict_any_get_dict_list_filters_non_dict Py2CppFeatureTest.test_dict_any_get_dict_returns_empty_for_non_dict Py2CppFeatureTest.test_dict_any_get_list_returns_empty_for_non_list Py2CppFeatureTest.test_dict_any_get_str_list_filters_non_str Py2CppFeatureTest.test_dict_any_kind Py2CppFeatureTest.test_dict_any_get_str_returns_default_for_non_str Py2CppFeatureTest.test_dict_str_get_returns_default_when_missing`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功、既知 warning のみ）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 既知維持）、`python3 tools/check_transpiler_version_gate.py`（`shared 0.46.0 -> 0.47.0`, `cpp 0.156.0 -> 0.157.0`）を確認した。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた statement target helper `_stmt_target_name` を `src/pytra/compiler/transpile_cli.py::stmt_target_name` へ移管した。`py2cpp` 側の `AnnAssign` 代入名抽出と `global` 収集側の target 参照は共通 helper 呼び出しへ統一し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲット・support block 抽出対象・`test/unit/test_prepare_selfhost_source.py` の期待値を更新した。`test/unit/test_py2cpp_features.py` には `test_stmt_target_name_reads_target_field` を追加し、`python3 -m py_compile src/py2cpp.py src/pytra/compiler/transpile_cli.py tools/prepare_selfhost_source.py test/unit/test_prepare_selfhost_source.py test/unit/test_py2cpp_features.py`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_stmt_target_name_reads_target_field Py2CppFeatureTest.test_name_target_id_returns_name_only Py2CppFeatureTest.test_assign_targets_prefers_targets_then_target Py2CppFeatureTest.test_dict_any_get_returns_none_for_missing Py2CppFeatureTest.test_dict_any_get_dict_list_filters_non_dict Py2CppFeatureTest.test_dict_any_get_dict_returns_empty_for_non_dict Py2CppFeatureTest.test_dict_any_get_list_returns_empty_for_non_list Py2CppFeatureTest.test_dict_any_get_str_list_filters_non_str Py2CppFeatureTest.test_dict_any_kind Py2CppFeatureTest.test_dict_any_get_str_returns_default_for_non_str Py2CppFeatureTest.test_dict_str_get_returns_default_when_missing`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功、既知 warning のみ）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 既知維持）、`python3 tools/check_transpiler_version_gate.py`（`shared 0.47.0 -> 0.48.0`, `cpp 0.157.0 -> 0.158.0`）を確認した。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた statement assign helper `_stmt_assigned_names` を `src/pytra/compiler/transpile_cli.py::stmt_assigned_names` へ移管した。`py2cpp` 側の `Assign/AnnAssign` 代入名抽出（シンボル収集・module export 検証）を共通 helper 呼び出しへ統一し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲット・support block 抽出対象・`test/unit/test_prepare_selfhost_source.py` の期待値を更新した。`test/unit/test_py2cpp_features.py` には `test_stmt_assigned_names_collects_assign_and_annassign` を追加し、`python3 -m py_compile src/py2cpp.py src/pytra/compiler/transpile_cli.py tools/prepare_selfhost_source.py test/unit/test_prepare_selfhost_source.py test/unit/test_py2cpp_features.py`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_stmt_assigned_names_collects_assign_and_annassign Py2CppFeatureTest.test_stmt_target_name_reads_target_field Py2CppFeatureTest.test_name_target_id_returns_name_only Py2CppFeatureTest.test_assign_targets_prefers_targets_then_target Py2CppFeatureTest.test_dict_any_get_returns_none_for_missing Py2CppFeatureTest.test_dict_any_get_dict_list_filters_non_dict Py2CppFeatureTest.test_dict_any_get_dict_returns_empty_for_non_dict Py2CppFeatureTest.test_dict_any_get_list_returns_empty_for_non_list Py2CppFeatureTest.test_dict_any_get_str_list_filters_non_str Py2CppFeatureTest.test_dict_any_kind Py2CppFeatureTest.test_dict_any_get_str_returns_default_for_non_str Py2CppFeatureTest.test_dict_str_get_returns_default_when_missing`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功、既知 warning のみ）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 既知維持）、`python3 tools/check_transpiler_version_gate.py`（`shared 0.48.0 -> 0.49.0`, `cpp 0.158.0 -> 0.159.0`）を確認した。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた child statement list helper `_stmt_child_stmt_lists` を `src/pytra/compiler/transpile_cli.py::stmt_child_stmt_lists` へ移管した。`py2cpp` 側の parse/analyze 指標計測（`_stmt_list_parse_metrics`, `_collect_symbols_from_stmt_list`, `_stmt_list_scope_depth`）で共通 helper 呼び出しへ統一し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲット・support block 抽出対象・`test/unit/test_prepare_selfhost_source.py` の期待値を更新した。`test/unit/test_py2cpp_features.py` には `test_stmt_child_stmt_lists_extracts_nested_blocks` を追加し、`python3 -m py_compile src/py2cpp.py src/pytra/compiler/transpile_cli.py tools/prepare_selfhost_source.py test/unit/test_prepare_selfhost_source.py test/unit/test_py2cpp_features.py`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_stmt_child_stmt_lists_extracts_nested_blocks Py2CppFeatureTest.test_stmt_assigned_names_collects_assign_and_annassign Py2CppFeatureTest.test_stmt_target_name_reads_target_field Py2CppFeatureTest.test_name_target_id_returns_name_only`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功、既知 warning のみ）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 既知維持）、`python3 tools/check_transpiler_version_gate.py`（`shared 0.49.0 -> 0.50.0`, `cpp 0.159.0 -> 0.160.0`）を確認した。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた target 束縛名抽出 helper `_collect_store_names_from_target` を `src/pytra/compiler/transpile_cli.py::collect_store_names_from_target` へ移管した。`py2cpp` 側の `For/With` 束縛名収集で共通 helper 呼び出しへ統一し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲット・support block 抽出対象・`test/unit/test_prepare_selfhost_source.py` の期待値を更新した。`test/unit/test_py2cpp_features.py` には `test_collect_store_names_from_target_extracts_nested_names` を追加し、`python3 -m py_compile src/py2cpp.py src/pytra/compiler/transpile_cli.py tools/prepare_selfhost_source.py test/unit/test_prepare_selfhost_source.py test/unit/test_py2cpp_features.py`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_collect_store_names_from_target_extracts_nested_names Py2CppFeatureTest.test_stmt_child_stmt_lists_extracts_nested_blocks Py2CppFeatureTest.test_stmt_assigned_names_collects_assign_and_annassign Py2CppFeatureTest.test_stmt_target_name_reads_target_field Py2CppFeatureTest.test_name_target_id_returns_name_only`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功、既知 warning のみ）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 既知維持）、`python3 tools/check_transpiler_version_gate.py`（`shared 0.50.0 -> 0.51.0`, `cpp 0.160.0 -> 0.161.0`）を確認した。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた parse 指標計測 helper `_stmt_list_parse_metrics` を `src/pytra/compiler/transpile_cli.py::stmt_list_parse_metrics` へ移管した。`py2cpp` 側の `module` parse 指標計測（`_module_parse_metrics`）は共通 helper 呼び出しへ統一し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲット・support block 抽出対象・`test/unit/test_prepare_selfhost_source.py` の期待値を更新した。`test/unit/test_py2cpp_features.py` には `test_stmt_list_parse_metrics_counts_nodes_and_depth` を追加し、`python3 -m py_compile src/py2cpp.py src/pytra/compiler/transpile_cli.py tools/prepare_selfhost_source.py test/unit/test_prepare_selfhost_source.py test/unit/test_py2cpp_features.py`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_stmt_list_parse_metrics_counts_nodes_and_depth Py2CppFeatureTest.test_collect_store_names_from_target_extracts_nested_names Py2CppFeatureTest.test_stmt_child_stmt_lists_extracts_nested_blocks Py2CppFeatureTest.test_stmt_assigned_names_collects_assign_and_annassign Py2CppFeatureTest.test_stmt_target_name_reads_target_field Py2CppFeatureTest.test_name_target_id_returns_name_only`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功、既知 warning のみ）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 既知維持）、`python3 tools/check_transpiler_version_gate.py`（`shared 0.51.0 -> 0.52.0`, `cpp 0.161.0 -> 0.162.0`）を確認した。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた scope 深さ計測 helper `_stmt_list_scope_depth` を `src/pytra/compiler/transpile_cli.py::stmt_list_scope_depth` へ移管した。`py2cpp` 側の `module` analyze 指標計測（`_module_analyze_metrics`）は共通 helper 呼び出し（`stmt_list_scope_depth(body, 0, SCOPE_NESTING_KINDS)`）へ統一し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲット・support block 抽出対象・`test/unit/test_prepare_selfhost_source.py` の期待値を更新した。`test/unit/test_py2cpp_features.py` には `test_stmt_list_scope_depth_counts_nesting` を追加し、`python3 -m py_compile src/py2cpp.py src/pytra/compiler/transpile_cli.py tools/prepare_selfhost_source.py test/unit/test_prepare_selfhost_source.py test/unit/test_py2cpp_features.py`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_stmt_list_scope_depth_counts_nesting Py2CppFeatureTest.test_stmt_list_parse_metrics_counts_nodes_and_depth Py2CppFeatureTest.test_collect_store_names_from_target_extracts_nested_names Py2CppFeatureTest.test_stmt_child_stmt_lists_extracts_nested_blocks Py2CppFeatureTest.test_stmt_assigned_names_collects_assign_and_annassign Py2CppFeatureTest.test_stmt_target_name_reads_target_field Py2CppFeatureTest.test_name_target_id_returns_name_only`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功、既知 warning のみ）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 既知維持）、`python3 tools/check_transpiler_version_gate.py`（`shared 0.52.0 -> 0.53.0`, `cpp 0.162.0 -> 0.163.0`）を確認した。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた module parse 指標 helper `_module_parse_metrics` を `src/pytra/compiler/transpile_cli.py::module_parse_metrics` へ移管した。`py2cpp` 側の parse ガード検証（`_check_parse_stage_guards`）は共通 helper 呼び出しへ統一し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲット・support block 抽出対象・`test/unit/test_prepare_selfhost_source.py` の期待値を更新した。`test/unit/test_py2cpp_features.py` には `test_module_parse_metrics_counts_nodes_and_depth` を追加し、`python3 -m py_compile src/py2cpp.py src/pytra/compiler/transpile_cli.py tools/prepare_selfhost_source.py test/unit/test_prepare_selfhost_source.py test/unit/test_py2cpp_features.py`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_module_parse_metrics_counts_nodes_and_depth Py2CppFeatureTest.test_stmt_list_scope_depth_counts_nesting Py2CppFeatureTest.test_stmt_list_parse_metrics_counts_nodes_and_depth Py2CppFeatureTest.test_collect_store_names_from_target_extracts_nested_names Py2CppFeatureTest.test_stmt_child_stmt_lists_extracts_nested_blocks Py2CppFeatureTest.test_stmt_assigned_names_collects_assign_and_annassign Py2CppFeatureTest.test_stmt_target_name_reads_target_field Py2CppFeatureTest.test_name_target_id_returns_name_only`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功、既知 warning のみ）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 既知維持）、`python3 tools/check_transpiler_version_gate.py`（`shared 0.53.0 -> 0.54.0`, `cpp 0.163.0 -> 0.164.0`）を確認した。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた statement 束縛名抽出 helper `_collect_symbols_from_stmt` を `src/pytra/compiler/transpile_cli.py::collect_symbols_from_stmt` へ移管した。`py2cpp` 側の statement list 収集（`_collect_symbols_from_stmt_list`）は共通 helper 呼び出しへ統一し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲット・support block 抽出対象・`test/unit/test_prepare_selfhost_source.py` の期待値を更新した。`test/unit/test_py2cpp_features.py` には `test_collect_symbols_from_stmt_handles_major_kinds` を追加し、`python3 -m py_compile src/py2cpp.py src/pytra/compiler/transpile_cli.py tools/prepare_selfhost_source.py test/unit/test_prepare_selfhost_source.py test/unit/test_py2cpp_features.py`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_collect_symbols_from_stmt_handles_major_kinds Py2CppFeatureTest.test_module_parse_metrics_counts_nodes_and_depth Py2CppFeatureTest.test_stmt_list_scope_depth_counts_nesting Py2CppFeatureTest.test_stmt_list_parse_metrics_counts_nodes_and_depth Py2CppFeatureTest.test_collect_store_names_from_target_extracts_nested_names Py2CppFeatureTest.test_stmt_child_stmt_lists_extracts_nested_blocks Py2CppFeatureTest.test_stmt_assigned_names_collects_assign_and_annassign Py2CppFeatureTest.test_stmt_target_name_reads_target_field Py2CppFeatureTest.test_name_target_id_returns_name_only`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功、既知 warning のみ）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 既知維持）、`python3 tools/check_transpiler_version_gate.py`（`shared 0.54.0 -> 0.55.0`, `cpp 0.164.0 -> 0.165.0`）を確認した。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた statement list 束縛名収集 helper `_collect_symbols_from_stmt_list` を `src/pytra/compiler/transpile_cli.py::collect_symbols_from_stmt_list` へ移管した。`py2cpp` 側の analyze 指標計測（`_module_analyze_metrics`）は共通 helper 呼び出しへ統一し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲット・support block 抽出対象・`test/unit/test_prepare_selfhost_source.py` の期待値を更新した。`test/unit/test_py2cpp_features.py` には `test_collect_symbols_from_stmt_list_walks_nested_blocks` を追加し、`python3 -m py_compile src/py2cpp.py src/pytra/compiler/transpile_cli.py tools/prepare_selfhost_source.py test/unit/test_prepare_selfhost_source.py test/unit/test_py2cpp_features.py`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_collect_symbols_from_stmt_list_walks_nested_blocks Py2CppFeatureTest.test_collect_symbols_from_stmt_handles_major_kinds Py2CppFeatureTest.test_module_parse_metrics_counts_nodes_and_depth Py2CppFeatureTest.test_stmt_list_scope_depth_counts_nesting Py2CppFeatureTest.test_stmt_list_parse_metrics_counts_nodes_and_depth Py2CppFeatureTest.test_collect_store_names_from_target_extracts_nested_names Py2CppFeatureTest.test_stmt_child_stmt_lists_extracts_nested_blocks Py2CppFeatureTest.test_stmt_assigned_names_collects_assign_and_annassign Py2CppFeatureTest.test_stmt_target_name_reads_target_field Py2CppFeatureTest.test_name_target_id_returns_name_only`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功、既知 warning のみ）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 既知維持）、`python3 tools/check_transpiler_version_gate.py`（`shared 0.55.0 -> 0.56.0`, `cpp 0.165.0 -> 0.166.0`）を確認した。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた module analyze 指標 helper `_module_analyze_metrics` を `src/pytra/compiler/transpile_cli.py::module_analyze_metrics` へ移管した。`py2cpp` 側の analyze ガード検証（`_check_analyze_stage_guards`）は共通 helper 呼び出し（`module_analyze_metrics(east, SCOPE_NESTING_KINDS)`）へ統一し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲット・support block 抽出対象・`test/unit/test_prepare_selfhost_source.py` の期待値を更新した。`test/unit/test_py2cpp_features.py` には `test_module_analyze_metrics_counts_symbols_and_scope` を追加し、`python3 -m py_compile src/py2cpp.py src/pytra/compiler/transpile_cli.py tools/prepare_selfhost_source.py test/unit/test_prepare_selfhost_source.py test/unit/test_py2cpp_features.py`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_module_analyze_metrics_counts_symbols_and_scope Py2CppFeatureTest.test_collect_symbols_from_stmt_list_walks_nested_blocks Py2CppFeatureTest.test_collect_symbols_from_stmt_handles_major_kinds Py2CppFeatureTest.test_module_parse_metrics_counts_nodes_and_depth Py2CppFeatureTest.test_stmt_list_scope_depth_counts_nesting Py2CppFeatureTest.test_stmt_list_parse_metrics_counts_nodes_and_depth Py2CppFeatureTest.test_collect_store_names_from_target_extracts_nested_names Py2CppFeatureTest.test_stmt_child_stmt_lists_extracts_nested_blocks Py2CppFeatureTest.test_stmt_assigned_names_collects_assign_and_annassign Py2CppFeatureTest.test_stmt_target_name_reads_target_field Py2CppFeatureTest.test_name_target_id_returns_name_only`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功、既知 warning のみ）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 既知維持）、`python3 tools/check_transpiler_version_gate.py`（`shared 0.56.0 -> 0.57.0`, `cpp 0.166.0 -> 0.167.0`）を確認した。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた guard module map 選択 helper `_select_guard_module_map` を `src/pytra/compiler/transpile_cli.py::select_guard_module_map` へ移管した。`py2cpp` 側の guard 評価前段（`_transpile_to_cpp_with_map`）は共通 helper 呼び出しへ統一し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲット・support block 抽出対象・`test/unit/test_prepare_selfhost_source.py` の期待値を更新した。`test/unit/test_py2cpp_features.py` には `test_select_guard_module_map_uses_cache_then_input_key` を追加し、`python3 -m py_compile src/py2cpp.py src/pytra/compiler/transpile_cli.py tools/prepare_selfhost_source.py test/unit/test_prepare_selfhost_source.py test/unit/test_py2cpp_features.py`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_select_guard_module_map_uses_cache_then_input_key Py2CppFeatureTest.test_module_analyze_metrics_counts_symbols_and_scope Py2CppFeatureTest.test_collect_symbols_from_stmt_list_walks_nested_blocks Py2CppFeatureTest.test_collect_symbols_from_stmt_handles_major_kinds Py2CppFeatureTest.test_module_parse_metrics_counts_nodes_and_depth Py2CppFeatureTest.test_stmt_list_scope_depth_counts_nesting Py2CppFeatureTest.test_stmt_list_parse_metrics_counts_nodes_and_depth Py2CppFeatureTest.test_collect_store_names_from_target_extracts_nested_names Py2CppFeatureTest.test_stmt_child_stmt_lists_extracts_nested_blocks Py2CppFeatureTest.test_stmt_assigned_names_collects_assign_and_annassign Py2CppFeatureTest.test_stmt_target_name_reads_target_field Py2CppFeatureTest.test_name_target_id_returns_name_only`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功、既知 warning のみ）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 既知維持）、`python3 tools/check_transpiler_version_gate.py`（`shared 0.57.0 -> 0.58.0`, `cpp 0.167.0 -> 0.168.0`）を確認した。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた import 束縛登録 helper（`_set_import_module_binding`, `_set_import_symbol_binding`, `_set_import_symbol_binding_and_module_set`）を `src/pytra/compiler/transpile_cli.py::{set_import_module_binding,set_import_symbol_binding,set_import_symbol_binding_and_module_set}` へ移管した。`py2cpp` 側の import バインディング構築は共通 helper 呼び出しへ統一し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲット・support block 抽出対象・`test/unit/test_prepare_selfhost_source.py` の期待値を更新した。`test/unit/test_py2cpp_features.py` には `test_set_import_binding_helpers` を追加し、`python3 -m py_compile src/py2cpp.py src/pytra/compiler/transpile_cli.py tools/prepare_selfhost_source.py test/unit/test_prepare_selfhost_source.py test/unit/test_py2cpp_features.py`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_set_import_binding_helpers Py2CppFeatureTest.test_select_guard_module_map_uses_cache_then_input_key Py2CppFeatureTest.test_module_analyze_metrics_counts_symbols_and_scope Py2CppFeatureTest.test_collect_symbols_from_stmt_list_walks_nested_blocks Py2CppFeatureTest.test_collect_symbols_from_stmt_handles_major_kinds Py2CppFeatureTest.test_module_parse_metrics_counts_nodes_and_depth Py2CppFeatureTest.test_stmt_list_scope_depth_counts_nesting Py2CppFeatureTest.test_stmt_list_parse_metrics_counts_nodes_and_depth Py2CppFeatureTest.test_collect_store_names_from_target_extracts_nested_names Py2CppFeatureTest.test_stmt_child_stmt_lists_extracts_nested_blocks Py2CppFeatureTest.test_stmt_assigned_names_collects_assign_and_annassign Py2CppFeatureTest.test_stmt_target_name_reads_target_field Py2CppFeatureTest.test_name_target_id_returns_name_only`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功、既知 warning のみ）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 既知維持）、`python3 tools/check_transpiler_version_gate.py`（`shared 0.58.0 -> 0.59.0`, `cpp 0.168.0 -> 0.169.0`）を確認した。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた関数シグネチャ抽出 helper（`_normalize_param_annotation`, `_extract_function_signatures_from_python_source`, `_extract_function_arg_types_from_python_source`）を `src/pytra/compiler/transpile_cli.py::{normalize_param_annotation,extract_function_signatures_from_python_source,extract_function_arg_types_from_python_source}` へ移管した。`py2cpp` 側の runtime module 関数引数型推定（`_module_function_arg_types`）は共通 helper 呼び出しへ統一し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲット・support block 抽出対象・`test/unit/test_prepare_selfhost_source.py` の期待値を更新した。`test/unit/test_py2cpp_features.py` には `test_normalize_param_annotation_coarse_types` / `test_extract_function_signatures_from_python_source_parses_defs` / `test_extract_function_arg_types_from_python_source` を追加し、`python3 -m py_compile src/py2cpp.py src/pytra/compiler/transpile_cli.py tools/prepare_selfhost_source.py test/unit/test_prepare_selfhost_source.py test/unit/test_py2cpp_features.py`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_extract_function_arg_types_from_python_source Py2CppFeatureTest.test_extract_function_signatures_from_python_source_parses_defs Py2CppFeatureTest.test_normalize_param_annotation_coarse_types Py2CppFeatureTest.test_set_import_binding_helpers Py2CppFeatureTest.test_select_guard_module_map_uses_cache_then_input_key Py2CppFeatureTest.test_module_analyze_metrics_counts_symbols_and_scope Py2CppFeatureTest.test_collect_symbols_from_stmt_list_walks_nested_blocks Py2CppFeatureTest.test_collect_symbols_from_stmt_handles_major_kinds Py2CppFeatureTest.test_module_parse_metrics_counts_nodes_and_depth Py2CppFeatureTest.test_stmt_list_scope_depth_counts_nesting Py2CppFeatureTest.test_stmt_list_parse_metrics_counts_nodes_and_depth Py2CppFeatureTest.test_collect_store_names_from_target_extracts_nested_names Py2CppFeatureTest.test_stmt_child_stmt_lists_extracts_nested_blocks Py2CppFeatureTest.test_stmt_assigned_names_collects_assign_and_annassign Py2CppFeatureTest.test_stmt_target_name_reads_target_field Py2CppFeatureTest.test_name_target_id_returns_name_only`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功、既知 warning のみ）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 既知維持）、`python3 tools/check_transpiler_version_gate.py`（`shared 0.59.0 -> 0.60.0`, `cpp 0.169.0 -> 0.170.0`）を確認した。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた guard 値パース helper（`_parse_guard_limit_or_raise`）を `src/pytra/compiler/transpile_cli.py::parse_guard_limit_or_raise` へ移管した。`py2cpp` 側の guard 上限解決（`_resolve_guard_limits`）は共通 helper 呼び出しへ統一し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲット・support block 抽出対象・`test/unit/test_prepare_selfhost_source.py` の期待値を更新した。`test/unit/test_py2cpp_features.py` には `test_parse_guard_limit_or_raise` を追加し、`python3 -m py_compile src/py2cpp.py src/pytra/compiler/transpile_cli.py tools/prepare_selfhost_source.py test/unit/test_prepare_selfhost_source.py test/unit/test_py2cpp_features.py`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_parse_guard_limit_or_raise Py2CppFeatureTest.test_parse_py2cpp_argv_guard_options Py2CppFeatureTest.test_guard_limit_exceeded_in_parse_stage Py2CppFeatureTest.test_guard_limit_exceeded_in_analyze_stage Py2CppFeatureTest.test_guard_limit_exceeded_in_emit_stage`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功、既知 warning のみ）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 既知維持）、`python3 tools/check_transpiler_version_gate.py`（`shared 0.60.0 -> 0.61.0`, `cpp 0.170.0 -> 0.171.0`）を確認した。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた guard profile 上限初期化 helper（`_guard_profile_base_limits`）を `src/pytra/compiler/transpile_cli.py::guard_profile_base_limits` へ移管した。`py2cpp` 側の guard 上限解決（`_resolve_guard_limits`）は共通 helper 呼び出しへ統一し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲット・support block 抽出対象・`test/unit/test_prepare_selfhost_source.py` の期待値を更新した。`test/unit/test_py2cpp_features.py` には `test_guard_profile_base_limits` を追加し、`python3 -m py_compile src/py2cpp.py src/pytra/compiler/transpile_cli.py tools/prepare_selfhost_source.py test/unit/test_prepare_selfhost_source.py test/unit/test_py2cpp_features.py`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_guard_profile_base_limits Py2CppFeatureTest.test_parse_guard_limit_or_raise Py2CppFeatureTest.test_parse_py2cpp_argv_guard_options Py2CppFeatureTest.test_guard_limit_exceeded_in_parse_stage Py2CppFeatureTest.test_guard_limit_exceeded_in_analyze_stage Py2CppFeatureTest.test_guard_limit_exceeded_in_emit_stage`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功、既知 warning のみ）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 既知維持）、`python3 tools/check_transpiler_version_gate.py`（`shared 0.61.0 -> 0.62.0`, `cpp 0.171.0 -> 0.172.0`）を確認した。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた guard 上限解決 helper（`_resolve_guard_limits`）を `src/pytra/compiler/transpile_cli.py::resolve_guard_limits` へ移管した。`py2cpp` 側の CLI 解析後 guard 設定解決は共通 helper 呼び出しへ統一し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲット・support block 抽出対象・`test/unit/test_prepare_selfhost_source.py` の期待値を更新した。`test/unit/test_py2cpp_features.py` には `test_resolve_guard_limits` を追加し、`python3 -m py_compile src/py2cpp.py src/pytra/compiler/transpile_cli.py tools/prepare_selfhost_source.py test/unit/test_prepare_selfhost_source.py test/unit/test_py2cpp_features.py`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_resolve_guard_limits Py2CppFeatureTest.test_guard_profile_base_limits Py2CppFeatureTest.test_parse_guard_limit_or_raise Py2CppFeatureTest.test_parse_py2cpp_argv_guard_options Py2CppFeatureTest.test_guard_limit_exceeded_in_parse_stage Py2CppFeatureTest.test_guard_limit_exceeded_in_analyze_stage Py2CppFeatureTest.test_guard_limit_exceeded_in_emit_stage`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功、既知 warning のみ）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 既知維持）、`python3 tools/check_transpiler_version_gate.py`（`shared 0.62.0 -> 0.63.0`, `cpp 0.172.0 -> 0.173.0`）を確認した。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた guard 例外生成/上限判定 helper（`_raise_guard_limit_exceeded`, `_check_guard_limit`）を `src/pytra/compiler/transpile_cli.py::{raise_guard_limit_exceeded,check_guard_limit}` へ移管した。`py2cpp` 側の parse/analyze/emit ガード判定は共通 helper 呼び出しへ統一し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲット・support block 抽出対象・`test/unit/test_prepare_selfhost_source.py` の期待値を更新した。`test/unit/test_py2cpp_features.py` には `test_raise_guard_limit_exceeded_formats_user_error` / `test_check_guard_limit_raises_only_on_exceeded` を追加し、`python3 -m py_compile src/py2cpp.py src/pytra/compiler/transpile_cli.py tools/prepare_selfhost_source.py test/unit/test_prepare_selfhost_source.py test/unit/test_py2cpp_features.py`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_raise_guard_limit_exceeded_formats_user_error Py2CppFeatureTest.test_check_guard_limit_raises_only_on_exceeded Py2CppFeatureTest.test_resolve_guard_limits Py2CppFeatureTest.test_guard_profile_base_limits Py2CppFeatureTest.test_parse_guard_limit_or_raise Py2CppFeatureTest.test_parse_py2cpp_argv_guard_options Py2CppFeatureTest.test_guard_limit_exceeded_in_parse_stage Py2CppFeatureTest.test_guard_limit_exceeded_in_analyze_stage Py2CppFeatureTest.test_guard_limit_exceeded_in_emit_stage`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功、既知 warning のみ）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 既知維持）、`python3 tools/check_transpiler_version_gate.py`（`shared 0.63.0 -> 0.64.0`, `cpp 0.173.0 -> 0.174.0`）を確認した。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた parse/analyze ステージ guard 集約 helper（`_check_parse_stage_guards`, `_check_analyze_stage_guards`）を `src/pytra/compiler/transpile_cli.py::{check_parse_stage_guards,check_analyze_stage_guards}` へ移管した。`py2cpp` 側の main 処理は共通 helper 呼び出し（`check_analyze_stage_guards(..., SCOPE_NESTING_KINDS)`）へ統一し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲット・support block 抽出順（`check_guard_limit` より後置）・`test/unit/test_prepare_selfhost_source.py` の期待値を更新した。`test/unit/test_py2cpp_features.py` には `test_check_parse_stage_guards_validates_depth_and_total_nodes` / `test_check_analyze_stage_guards_validates_module_and_graph_limits` を追加し、`python3 -m py_compile src/py2cpp.py src/pytra/compiler/transpile_cli.py tools/prepare_selfhost_source.py test/unit/test_prepare_selfhost_source.py test/unit/test_py2cpp_features.py`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_check_parse_stage_guards_validates_depth_and_total_nodes Py2CppFeatureTest.test_check_analyze_stage_guards_validates_module_and_graph_limits Py2CppFeatureTest.test_raise_guard_limit_exceeded_formats_user_error Py2CppFeatureTest.test_check_guard_limit_raises_only_on_exceeded Py2CppFeatureTest.test_resolve_guard_limits Py2CppFeatureTest.test_guard_profile_base_limits Py2CppFeatureTest.test_parse_guard_limit_or_raise Py2CppFeatureTest.test_parse_py2cpp_argv_guard_options Py2CppFeatureTest.test_guard_limit_exceeded_in_parse_stage Py2CppFeatureTest.test_guard_limit_exceeded_in_analyze_stage Py2CppFeatureTest.test_guard_limit_exceeded_in_emit_stage`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功、既知 warning のみ）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 既知維持）、`python3 tools/check_transpiler_version_gate.py`（`shared 0.64.0 -> 0.65.0`, `cpp 0.174.0 -> 0.175.0`）を確認した。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた `from-import` 公開シンボル検証 helper（`_module_export_table`, `_validate_from_import_symbols_or_raise`）を `src/pytra/compiler/transpile_cli.py::{module_export_table,validate_from_import_symbols_or_raise}` へ移管した。`py2cpp` 側の `build_module_east_map` は共通 helper 呼び出しへ統一し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲット・support block 抽出対象・`test/unit/test_prepare_selfhost_source.py` の期待値を更新した。`test/unit/test_py2cpp_features.py` には `test_module_export_table_collects_public_symbols` / `test_validate_from_import_symbols_or_raise` を追加し、`python3 -m py_compile src/py2cpp.py src/pytra/compiler/transpile_cli.py tools/prepare_selfhost_source.py test/unit/test_prepare_selfhost_source.py test/unit/test_py2cpp_features.py`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_module_export_table_collects_public_symbols Py2CppFeatureTest.test_validate_from_import_symbols_or_raise Py2CppFeatureTest.test_check_parse_stage_guards_validates_depth_and_total_nodes Py2CppFeatureTest.test_check_analyze_stage_guards_validates_module_and_graph_limits Py2CppFeatureTest.test_guard_limit_exceeded_in_parse_stage Py2CppFeatureTest.test_guard_limit_exceeded_in_analyze_stage Py2CppFeatureTest.test_guard_limit_exceeded_in_emit_stage`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功、既知 warning のみ）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 既知維持）、`python3 tools/check_transpiler_version_gate.py`（`shared 0.65.0 -> 0.66.0`, `cpp 0.175.0 -> 0.176.0`）を確認した。
- `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた import graph レポート/検証 helper（`_format_import_graph_report`, `_validate_import_graph_or_raise`）を `src/pytra/compiler/transpile_cli.py::{format_import_graph_report,validate_import_graph_or_raise}` へ移管した。`py2cpp` 側の呼び出し（`build_module_east_map`, `dump_deps_graph_text`, `main` の import graph 検証）を共通 helper 呼び出しへ統一し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲット・support block 抽出対象・`test/unit/test_prepare_selfhost_source.py` の期待値を更新した。`test/unit/test_py2cpp_features.py` には `test_format_import_graph_report` / `test_validate_import_graph_or_raise` を追加し、`python3 -m py_compile src/py2cpp.py src/pytra/compiler/transpile_cli.py tools/prepare_selfhost_source.py test/unit/test_prepare_selfhost_source.py test/unit/test_py2cpp_features.py`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_format_import_graph_report Py2CppFeatureTest.test_validate_import_graph_or_raise Py2CppFeatureTest.test_module_export_table_collects_public_symbols Py2CppFeatureTest.test_validate_from_import_symbols_or_raise Py2CppFeatureTest.test_check_parse_stage_guards_validates_depth_and_total_nodes Py2CppFeatureTest.test_check_analyze_stage_guards_validates_module_and_graph_limits Py2CppFeatureTest.test_guard_limit_exceeded_in_parse_stage Py2CppFeatureTest.test_guard_limit_exceeded_in_analyze_stage Py2CppFeatureTest.test_guard_limit_exceeded_in_emit_stage`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功、既知 warning のみ）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 既知維持）、`python3 tools/check_transpiler_version_gate.py`（`shared 0.66.0 -> 0.67.0`, `cpp 0.176.0 -> 0.177.0`）を確認した。
- `P1-COMP-04` / `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた deps dump helper（`dump_deps_text`）を `src/pytra/compiler/transpile_cli.py::dump_deps_text` へ移管した。`py2cpp` 側は共通 helper import 呼び出しへ統一し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲットと support block 抽出対象へ `dump_deps_text` を追加した。初回は support block 抽出順の都合で selfhost C++ が前方宣言不足エラーになったため、抽出順を `meta_import_bindings` 後ろへ移動して解消した。`python3 -m py_compile src/py2cpp.py src/pytra/compiler/transpile_cli.py tools/prepare_selfhost_source.py test/unit/test_prepare_selfhost_source.py test/unit/test_py2cpp_features.py`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_dump_deps_text_lists_modules_and_symbols Py2CppFeatureTest.test_dump_deps_graph_and_build_map_are_consistent Py2CppFeatureTest.test_format_import_graph_report Py2CppFeatureTest.test_validate_import_graph_or_raise`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功、既知 warning のみ）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 既知維持）、`python3 tools/check_transpiler_version_gate.py`（`shared 0.67.0 -> 0.68.0`, `cpp 0.177.0 -> 0.178.0`）を確認した。
- `P1-COMP-01` / `P1-COMP-09` の継続として、`src/py2cpp.py::_analyze_import_graph` に残っていた予約名衝突収集（`pytra.py`, `pytra/__init__.py`）を `src/pytra/compiler/transpile_cli.py::collect_reserved_import_conflicts` へ移管した。`py2cpp` 側は新 helper 呼び出しへ置換し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲットと support block 抽出対象、`test/unit/test_prepare_selfhost_source.py` の期待値を更新した。`test/unit/test_py2cpp_features.py` には `test_collect_reserved_import_conflicts` を追加し、`python3 -m py_compile src/py2cpp.py src/pytra/compiler/transpile_cli.py tools/prepare_selfhost_source.py test/unit/test_prepare_selfhost_source.py test/unit/test_py2cpp_features.py`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_collect_reserved_import_conflicts Py2CppFeatureTest.test_python_module_exists_under_detects_py_and_package Py2CppFeatureTest.test_dump_deps_text_lists_modules_and_symbols Py2CppFeatureTest.test_dump_deps_graph_and_build_map_are_consistent`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功、既知 warning のみ）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 既知維持）、`python3 tools/check_transpiler_version_gate.py`（`shared 0.68.0 -> 0.69.0`, `cpp 0.178.0 -> 0.179.0`）を確認した。
- `P1-COMP-01` / `P1-COMP-09` の継続として、`src/py2cpp.py::_analyze_import_graph` 末尾に残っていた `user_module_files` 生成（`visited_order` ソート + `key_to_path` 逆引き）を `src/pytra/compiler/transpile_cli.py::collect_user_module_files_for_graph` へ移管した。`py2cpp` 側は新 helper 呼び出しへ置換し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲットと support block 抽出対象、`test/unit/test_prepare_selfhost_source.py` の期待値を更新した。`test/unit/test_py2cpp_features.py` には `test_collect_user_module_files_for_graph` を追加し、`python3 -m py_compile src/py2cpp.py src/pytra/compiler/transpile_cli.py tools/prepare_selfhost_source.py test/unit/test_prepare_selfhost_source.py test/unit/test_py2cpp_features.py`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_collect_user_module_files_for_graph Py2CppFeatureTest.test_collect_reserved_import_conflicts Py2CppFeatureTest.test_dump_deps_graph_and_build_map_are_consistent`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功、既知 warning のみ）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 既知維持）、`python3 tools/check_transpiler_version_gate.py`（`shared 0.69.0 -> 0.70.0`, `cpp 0.179.0 -> 0.180.0`）を確認した。
- `P1-COMP-03` / `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた module type schema 構築（`build_module_type_schema`）を `src/pytra/compiler/transpile_cli.py::build_module_type_schema` へ移管した。`py2cpp` 側は共通 helper 参照へ統一し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲット・support block 抽出対象・`test/unit/test_prepare_selfhost_source.py` の期待値を更新した。`test/unit/test_py2cpp_features.py` には `test_build_module_type_schema_helper_contains_function_and_class_types` を追加し、`python3 -m py_compile src/py2cpp.py src/pytra/compiler/transpile_cli.py tools/prepare_selfhost_source.py test/unit/test_prepare_selfhost_source.py test/unit/test_py2cpp_features.py`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_build_module_type_schema_helper_contains_function_and_class_types Py2CppFeatureTest.test_build_module_type_schema_contains_function_and_class_types Py2CppFeatureTest.test_collect_user_module_files_for_graph`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功、既知 warning のみ）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 既知維持）、`python3 tools/check_transpiler_version_gate.py`（`shared 0.70.0 -> 0.71.0`, `cpp 0.180.0 -> 0.181.0`）を確認した。
- `P1-COMP-03` / `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた module symbol index 構築（`build_module_symbol_index`）を `src/pytra/compiler/transpile_cli.py::build_module_symbol_index` へ移管した。`py2cpp` 側は共通 helper 参照へ統一し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲット・support block 抽出対象（依存関数より後順に調整）・`test/unit/test_prepare_selfhost_source.py` の期待値を更新した。`test/unit/test_py2cpp_features.py` には `test_build_module_symbol_index_helper_contains_defs_and_import_aliases` を追加し、`python3 -m py_compile src/py2cpp.py src/pytra/compiler/transpile_cli.py tools/prepare_selfhost_source.py test/unit/test_prepare_selfhost_source.py test/unit/test_py2cpp_features.py`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_build_module_symbol_index_helper_contains_defs_and_import_aliases Py2CppFeatureTest.test_build_module_symbol_index_contains_defs_and_import_aliases Py2CppFeatureTest.test_build_module_type_schema_helper_contains_function_and_class_types`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功、既知 warning のみ）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 既知維持）、`python3 tools/check_transpiler_version_gate.py`（`shared 0.71.0 -> 0.72.0`, `cpp 0.181.0 -> 0.182.0`）を確認した。
- `P1-COMP-02` / `P1-COMP-09` の継続として、`src/py2cpp.py::build_module_east_map` の本体ロジック（解析結果からの EAST map 構築と `module_id` 反映）を `src/pytra/compiler/transpile_cli.py::build_module_east_map_from_analysis` へ移管した。`py2cpp` 側は `load_east` 済み map の組み立てと helper 呼び出しに限定し、selfhost C++ での前方参照回帰を避けるため `tools/prepare_selfhost_source.py` の support block 抽出順を `validate_*` 後へ調整した。`test/unit/test_py2cpp_features.py` には `test_build_module_east_map_from_analysis_sets_module_id` を追加し、`python3 -m py_compile src/py2cpp.py src/pytra/compiler/transpile_cli.py tools/prepare_selfhost_source.py test/unit/test_prepare_selfhost_source.py test/unit/test_py2cpp_features.py`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_build_module_east_map_from_analysis_sets_module_id Py2CppFeatureTest.test_build_module_east_map_collects_entry_and_user_deps Py2CppFeatureTest.test_build_module_symbol_index_helper_contains_defs_and_import_aliases`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功、既知 warning のみ）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 既知維持）、`python3 tools/check_transpiler_version_gate.py`（`shared 0.72.0 -> 0.73.0`, `cpp 0.182.0 -> 0.183.0`）を確認した。
- `P1-COMP-01` / `P1-COMP-09` の継続として、`src/py2cpp.py::_analyze_import_graph` の末尾整形（循環検出・`user_module_files` 組み立て・戻り値 dict 生成）を `src/pytra/compiler/transpile_cli.py::finalize_import_graph_analysis` へ移管した。`py2cpp` 側は `finalize_import_graph_analysis(...)` 呼び出しへ統一し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲットと support block 抽出対象へ同 helper を追加した。`test/unit/test_py2cpp_features.py` には `test_finalize_import_graph_analysis_collects_cycle_and_files` を追加し、`python3 -m py_compile src/py2cpp.py src/pytra/compiler/transpile_cli.py tools/prepare_selfhost_source.py test/unit/test_prepare_selfhost_source.py test/unit/test_py2cpp_features.py`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_finalize_import_graph_analysis_collects_cycle_and_files Py2CppFeatureTest.test_build_module_east_map_from_analysis_sets_module_id Py2CppFeatureTest.test_build_module_east_map_collects_entry_and_user_deps`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功、既知 warning のみ）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 既知維持）、`python3 tools/check_transpiler_version_gate.py`（`shared 0.73.0 -> 0.74.0`, `cpp 0.183.0 -> 0.184.0`）を確認した。
- `P1-COMP-04` / `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた module 名解決 helper（`resolve_module_name`）を `src/pytra/compiler/transpile_cli.py::resolve_module_name` へ移管した。`py2cpp` 側はローカル定義を削除して共通 helper import へ統一し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲットと support block 抽出対象へ同 helper を追加した。`test/unit/test_py2cpp_features.py` には `test_resolve_module_name_helper_classifies_user_pytra_and_missing` を追加し、`python3 -m py_compile src/py2cpp.py src/pytra/compiler/transpile_cli.py tools/prepare_selfhost_source.py test/unit/test_prepare_selfhost_source.py test/unit/test_py2cpp_features.py`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_resolve_module_name_helper_classifies_user_pytra_and_missing Py2CppFeatureTest.test_resolve_module_name_classifies_user_pytra_and_missing Py2CppFeatureTest.test_resolve_module_name_prefers_named_package_module_over_local_flat_copy Py2CppFeatureTest.test_resolve_module_name_recognizes_std_and_utils_shims`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功、既知 warning のみ）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 既知維持）、`python3 tools/check_transpiler_version_gate.py`（`shared 0.74.0 -> 0.75.0`, `cpp 0.184.0 -> 0.185.0`）を確認した。
- `P1-COMP-04` / `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた `load_east` 本体を `src/pytra/compiler/transpile_cli.py::load_east_document` へ移管した。`py2cpp` 側の `load_east(...)` は wrapper（`load_east_document(...)` 呼び出し）へ縮退し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲットと support block 抽出対象へ `load_east_document` を追加した。`test/unit/test_py2cpp_features.py` には `test_load_east_document_helper_accepts_json_wrapper_and_module` を追加し、`python3 -m py_compile src/py2cpp.py src/pytra/compiler/transpile_cli.py tools/prepare_selfhost_source.py test/unit/test_prepare_selfhost_source.py test/unit/test_py2cpp_features.py`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_load_east_document_helper_accepts_json_wrapper_and_module Py2CppFeatureTest.test_resolve_module_name_helper_classifies_user_pytra_and_missing Py2CppFeatureTest.test_resolve_module_name_classifies_user_pytra_and_missing Py2CppFeatureTest.test_resolve_module_name_prefers_named_package_module_over_local_flat_copy Py2CppFeatureTest.test_resolve_module_name_recognizes_std_and_utils_shims`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功、既知 warning のみ）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 既知維持）、`python3 tools/check_transpiler_version_gate.py`（`shared 0.75.0 -> 0.76.0`, `cpp 0.185.0 -> 0.186.0`）を確認した。
- `P1-COMP-04` / `P1-COMP-09` の継続として、`src/py2cpp.py` に残っていた `print_user_error` を `src/pytra/compiler/transpile_cli.py::print_user_error` へ移管した。`py2cpp` 側はローカル定義を削除して共通 helper import へ統一し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の import 除去ターゲットと support block 抽出対象へ `print_user_error` を追加した。`test/unit/test_py2cpp_features.py` には `test_print_user_error_helper_writes_classified_message` を追加し、`python3 -m py_compile src/py2cpp.py src/pytra/compiler/transpile_cli.py tools/prepare_selfhost_source.py test/unit/test_prepare_selfhost_source.py test/unit/test_py2cpp_features.py`、`python3 test/unit/test_prepare_selfhost_source.py`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_make_and_parse_user_error_roundtrip Py2CppFeatureTest.test_parse_user_error_non_tagged_text Py2CppFeatureTest.test_print_user_error_helper_writes_classified_message Py2CppFeatureTest.test_load_east_document_helper_accepts_json_wrapper_and_module`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功、既知 warning のみ）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 既知維持）、`python3 tools/check_transpiler_version_gate.py`（`shared 0.76.0 -> 0.77.0`, `cpp 0.186.0 -> 0.187.0`）を確認した。
- `P1-COMP-08` の Phase 1 着手として、`src/py2rs.py::load_east` を `src/pytra/compiler/transpile_cli.py::load_east_document` 経由へ切り替えた。`.txt` 入力の互換エラー（`input must be .py or .json`）と invalid JSON root の互換エラー（`EAST json root must be object`）は維持しつつ、`{'ok': true, 'east': {...}}` 形式の wrapper EAST JSON も受理する。`test/unit/test_py2rs_smoke.py` に wrapper 回帰を追加し、`python3 test/unit/test_py2rs_smoke.py`、`python3 test/unit/test_error_classification_cross_lang.py`、`python3 tools/check_py2rs_transpile.py` で回帰なしを確認した。
- `P1-COMP-08` の Phase 2 として、`src/py2cs.py` / `src/py2js.py` / `src/py2ts.py` の `load_east` を `src/pytra/compiler/transpile_cli.py::load_east_document_compat` 経由へ統一した。これにより `.txt` 入力と invalid JSON root の既存エラー文言互換（`input must be .py or .json` / `EAST json root must be object`）を維持したまま、Phase 1 と同様に wrapper EAST JSON（`{'ok': true, 'east': {...}}`）を受理する。`test/unit/test_error_classification_cross_lang.py` に Phase 2 対象（cs/js/ts）の wrapper 受理回帰を追加し、`python3 test/unit/test_error_classification_cross_lang.py`、`python3 tools/check_py2cs_transpile.py`、`python3 tools/check_py2js_transpile.py`、`python3 tools/check_py2ts_transpile.py` で回帰なしを確認した。
- `P1-COMP-08` の Phase 3 として、`src/py2go.py` / `src/py2java.py` / `src/py2swift.py` / `src/py2kotlin.py` の `load_east` を `src/pytra/compiler/transpile_cli.py::load_east_document_compat` 経由へ統一した。Phase 2 と同様にエラー文言互換（`input must be .py or .json` / `EAST json root must be object`）を維持しつつ、wrapper EAST JSON（`{'ok': true, 'east': {...}}`）受理を拡張する。`test/unit/test_error_classification_cross_lang.py` に Phase 3 対象（go/java/swift/kotlin）の wrapper 回帰を追加し、`python3 test/unit/test_error_classification_cross_lang.py`、`python3 tools/check_py2go_transpile.py`、`python3 tools/check_py2java_transpile.py`、`python3 tools/check_py2swift_transpile.py`、`python3 tools/check_py2kotlin_transpile.py` で回帰なしを確認した。
- `P1-COMP-08` の Phase 4 縮退として、`src/py2rs.py::load_east` の独自互換ロジック（`parse_user_error` / `dict_any_get_str` を使う分岐）を削除し、`src/pytra/compiler/transpile_cli.py::load_east_document_compat` へ一本化した。これにより非 C++ 各 CLI の loader 経路は同一 helper に揃い、旧経路の重複実装をさらに縮退できる。`python3 test/unit/test_py2rs_smoke.py`、`python3 test/unit/test_error_classification_cross_lang.py`、`python3 tools/check_py2rs_transpile.py` で回帰なしを確認した。

## P1: 多言語ランタイム配置統一

文脈: `docs-jp/plans/p1-runtime-layout-unification.md`（`TG-P1-RUNTIME-LAYOUT`）

目的: ランタイム配置を言語間で統一し、責務混在と重複実装を防ぐ。

1. [ ] [ID: P1-RUNTIME-01] Rust ランタイムを `src/rs_module/` から `src/runtime/rs/pytra/` へ段階移行し、`src/runtime/cpp/pytra/` と同等の責務分割（`built_in/`, `std/`, `utils/`, `compiler/`）に揃える。
2. [ ] [ID: P1-RUNTIME-02] `py2rs.py` / Rust hooks のランタイム解決パスを `src/runtime/rs/pytra/` 基準へ更新する。
3. [ ] [ID: P1-RUNTIME-03] `src/rs_module/` の既存参照を洗い出し、互換レイヤを経由して最終的に廃止する。
5. [ ] [ID: P1-RUNTIME-05] 各言語トランスパイラ（`py2cs.py`, `py2js.py`, `py2ts.py`, `py2go.py`, `py2java.py`, `py2kotlin.py`, `py2swift.py`）と hooks のランタイム解決パスを `src/runtime/<lang>/pytra/` 基準へ統一する。

## P1: 多言語出力品質（`sample/cpp` 水準）

文脈: `docs-jp/plans/p1-multilang-output-quality.md`（`TG-P1-MULTILANG-QUALITY`）

1. [ ] [ID: P1-MQ-01] `sample/{rs,cs,js,ts,go,java,swift,kotlin}` の生成品質を計測し、`sample/cpp` 比での差分（過剰 `mut` / 括弧 / cast / clone / 未使用 import）を定量化する。
2. [ ] [ID: P1-MQ-02] 各言語 emitter/hooks/profile に段階的改善を入れ、`sample/cpp` と同等の可読性水準へ引き上げる。
3. [ ] [ID: P1-MQ-03] 多言語の出力品質回帰を防ぐ検査（品質指標 + transpile/smoke）を整備する。
4. [ ] [ID: P1-MQ-04] 非 C++ 各言語（`rs/cs/js/ts/go/java/swift/kotlin`）で、`py2<lang>.py` の selfhost 可否（自己変換した生成物で `sample/py` を再変換できるか）を検証し、言語別ステータスを記録する。
5. [ ] [ID: P1-MQ-05] 非 C++ 各言語で、生成物による再自己変換（多段 selfhost）が成立するかを検証し、失敗要因を分類する。
6. [ ] [ID: P1-MQ-06] 非 C++ 言語の selfhost / 多段 selfhost 検証を定期実行できるチェック導線（手順またはスクリプト）を整備する。
7. [ ] [ID: P1-MQ-07] `sample/` 生成物はタイムスタンプ埋め込みなしで管理し、CI で再生成差分ゼロ（常に最新）を必須化する。

## P2: Any/object 境界整理

文脈: `docs-jp/plans/p2-any-object-boundary.md`（`TG-P2-ANY-OBJ`）

1. [ ] [ID: P2-ANY-01] `CodeEmitter` の `Any/dict` 境界を selfhost でも安定する実装へ段階移行する。
2. [ ] [ID: P2-ANY-02] `cpp_type` と式描画で `object` へのフォールバックを最小化する。
3. [ ] [ID: P2-ANY-03] `Any -> object` が必要な経路と不要な経路を分離し、過剰な `make_object(...)` 挿入を削減する。
4. [ ] [ID: P2-ANY-04] `py_dict_get_default` / `dict_get_node` の既定値が `object` 必須化している箇所を整理する。
5. [ ] [ID: P2-ANY-05] `py2cpp.py` で既定値に `nullopt` を渡している箇所を洗い出し、型別既定値へ置換する。
6. [ ] [ID: P2-ANY-06] selfhost 変換で `std::any` を通る経路を記録・列挙し、段階的に除去する。
7. [ ] [ID: P2-ANY-07] 影響上位3関数単位でパッチを分けて改善し、毎回 `check_py2cpp_transpile.py` を実行する。

## P2: microgpt 変換互換性

文脈: `docs-jp/plans/p2-microgpt-compatibility.md`（`TG-P2-MICROGPT-COMPAT`）

1. [x] [ID: P2-MGPT-01] self_hosted parser の型注釈必須制約（`name: Type`）について、仕様維持するか、無注釈引数の受理/推論を拡張するかを決め、選択した方針を実装へ反映する。
2. [x] [ID: P2-MGPT-02] `pytra.std.random` と `src/runtime/cpp/pytra/std/random.*` に `choices` / `gauss` / `shuffle` を追加し、`py2cpp` 生成コードがコンパイル可能な状態にする。
3. [x] [ID: P2-MGPT-03] `microgpt` 相当入力（最小再現 fixture でも可）で transpile -> C++ 構文チェックまで回す検証導線を追加する。
4. [x] [ID: P2-MGPT-04] （低優先）`work/tmp/microgpt-20260222-lite.py` を `py2cpp.py` で変換し、生成 C++ のコンパイル（`g++ -std=c++20 -I src -I src/runtime/cpp`）が通る状態にする。

進捗メモ:
- `P2-MGPT-01`: 当時方針を「型注釈必須の仕様維持」に確定。`src/pytra/compiler/east_parts/core.py` で無注釈引数（`def f(x): ...`）の拒否を専用メッセージ（`requires type annotation`）で明示し、`test/fixtures/signature/ng_untyped_param.py` + `test/unit/test_self_hosted_signature.py::test_reject_untyped_parameter` を追加した（この方針は後続の `P3-MSP-04` で `unknown` 受理へ更新）。
- `P2-MGPT-02`: `src/pytra/std/random.py` へ `choices/gauss/shuffle` を追加し、`python3 src/py2cpp.py src/pytra/std/random.py --emit-runtime-cpp` で `src/runtime/cpp/pytra/std/random.*` を更新。`test/fixtures/stdlib/random_timeit_traceback_extended.py` と `test/unit/test_py2cpp_features.py` に runtime 検証を追加し、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_random_timeit_traceback_extended_runtime` で通過を確認。
- `P2-MGPT-03`: `test/fixtures/microgpt/microgpt_compat_min.py`（型注釈付き最小 microgpt 相当ケース）を追加し、`test/unit/test_py2cpp_features.py` に `test_microgpt_compat_min_syntax_check` を追加。`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_microgpt_compat_min_syntax_check` で transpile -> `g++ -fsyntax-only` の導線が通ることを確認。
- `P2-MGPT-04`: `work/tmp/microgpt-20260222-lite.py` を self_hosted parser 制約に合わせて `microgpt-lite`（dataset -> vocab -> training -> sampling）構成へ再整理し、`random.choices` / `random.gauss` / `random.shuffle` を維持したまま `python3 src/py2cpp.py work/tmp/microgpt-20260222-lite.py -o work/out/microgpt-20260222.cpp` と `g++ -std=c++20 -I src -I src/runtime/cpp -fsyntax-only work/out/microgpt-20260222.cpp` の通過を確認。

## P3: microgpt 原本保全（低優先）

文脈: `docs-jp/plans/p3-microgpt-source-preservation.md`（`TG-P3-MICROGPT-SOURCE-PRESERVATION`）

1. [x] [ID: P3-MSP-01] `archive/exec-extracted-20260222.log` で抽出した原本改変項目（型注釈追加、内包/zip 展開、I/O 置換、アルゴリズム簡略化）を、parser/emitter/runtime の責務へ再分類する。
2. [x] [ID: P3-MSP-02] `materials/refs/microgpt/microgpt-20260222.py` を無改変で `py2cpp` に入力したときの失敗要因を再現・列挙し、改変で迂回していた箇所を実装タスクへ置き換える。
3. [ ] [ID: P3-MSP-03] `work/tmp/microgpt-20260222-lite.py` 依存を縮退し、原本 `materials/refs/microgpt/microgpt-20260222.py` で transpile -> `g++ -fsyntax-only` が通る回帰導線を整備する。
4. [x] [ID: P3-MSP-04] parser: 無注釈引数（`def f(x): ...`）と class 内 1 行メソッド定義（`def f(...): return ...`）の受理方針を再検討し、原本改変なしで読める範囲を拡張する。
5. [x] [ID: P3-MSP-05] parser: top-level `for` / tuple 同時代入 / 複数 `for` 内包の受理・lower を段階対応し、原本スクリプト構造を維持して EAST 化できるようにする。
6. [x] [ID: P3-MSP-06] EAST/emitter: 内包内 `range(...)` の lower 不整合（`unexpected raw range Call in EAST`）を解消する。
7. [x] [ID: P3-MSP-07] EAST/emitter: `zip` / 内包経由で `object receiver` エラーへ落ちる型崩れ経路を再現し、型解決を安定化する。
8. [x] [ID: P3-MSP-08] runtime/std: `open` 反復、`list.index`、`random.shuffle(list[str])` など原本依存 API の互換差分を整理し、どのレイヤで吸収するかを確定する。
9. [x] [ID: P3-MSP-09] 回帰導線: 原本 `materials/refs/microgpt/microgpt-20260222.py` を固定入力として、`py2cpp` 失敗要因の再発を検知する手順またはテストを追加する。

進捗メモ:
- `P3-MSP-01`: `archive/exec-extracted-20260222.log`（2026-02-23 00:03〜00:13）と `materials/refs/microgpt/microgpt-20260222.py` vs `work/tmp/microgpt-20260222-lite.py` の差分を照合し、改変 7 項目を parser / emitter / runtime の責務へ再分類した。入力側改変を再発させないため、各項目を実装側で吸収する方針を `docs-jp/plans/p3-microgpt-source-preservation.md` に明記。
- `P3-MSP-02`: `python3 src/py2cpp.py materials/refs/microgpt/microgpt-20260222.py -o work/out/msp2-microgpt.cpp` で先頭エラー（無注釈引数）を再現し、`archive/exec-extracted-20260222.log` の追跡と合わせて失敗要因 A〜F（parser 構文、EAST lower、型崩れ、runtime 互換）を列挙。改変で迂回していた論点を `P3-MSP-04`〜`P3-MSP-09` へ分解して TODO 化。
- `P3-MSP-04`: `src/pytra/compiler/east_parts/core.py` で無注釈引数を `unknown` として受理し、`def ...: return ...` 形式の inline 定義を top-level / nested / class method で受理するよう拡張した。`python3 test/unit/test_self_hosted_signature.py`（7件成功）と `python3 tools/check_microgpt_original_py2cpp_regression.py --expect-stage any-known` を実行し、原本 `microgpt` の失敗ステージが `A`（無注釈引数）から `C`（top-level/lower ギャップ）へ進んだことを確認した。
- `P3-MSP-05`: `src/pytra/compiler/east_parts/core.py` で top-level `if` / `for` の受理を追加し、block 内 `import` / `from ... import ...`、top-level tuple 同時代入、list comprehension の複数 `for` 句を受理するよう拡張した。`python3 test/unit/test_self_hosted_signature.py`（11件成功）と `/tmp/msp5_*` 最小再現（top-level `if` / `for` / tuple 同時代入 / 複数 `for` 内包）で通過を確認し、`python3 tools/check_microgpt_original_py2cpp_regression.py --expect-stage any-known` で失敗先頭が `line 15` から `line 80`（lambda 既定値）へ前進したことを確認した。
- `P3-MSP-06`: `src/py2cpp.py` に `range(...)` Name-call 専用 lower（`_render_range_name_call`）を追加し、`raw == "range"` での即時例外を廃止して `py_range(start, stop, step)` へ変換する経路を実装した（位置引数 1/2/3 と主要 keyword 形を対応）。`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_random_choices_range_call_lowers_to_py_range`、`python3 tools/check_microgpt_original_py2cpp_regression.py --expect-stage any-known`、`python3 tools/check_py2cpp_transpile.py` を実行し、`stage` は `C`（lambda 既定値）維持で `D` へ後退しないことを確認した。
- `P3-MSP-07`: `src/pytra/compiler/east_parts/core.py` で `zip(...)` の戻り型推論（`list[tuple[...]]`）、`for a, b in iter` の tuple target 型束縛、括弧なし tuple target の受理を追加し、`lambda` 既定値・generator tuple target・f-string format spec・list/listcomp 連結の parser gap も段階解消した。`src/py2cpp.py::_emit_target_unpack` では未知型を `object` へ固定せず `unknown` 維持に変更し、`zip` 経由の過剰 `object receiver` 化を抑止。`python3 test/unit/test_self_hosted_signature.py`（16件成功）、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_random_choices_range_call_lowers_to_py_range Py2CppFeatureTest.test_lambda_default_arg_emits_cpp_default Py2CppFeatureTest.test_zip_tuple_unpack_does_not_force_object_receiver`、`python3 tools/check_microgpt_original_py2cpp_regression.py --expect-stage any-known`、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）を確認し、原本 `microgpt` の失敗が transpile 段階（`C/E`）から syntax-check 段階 `F` へ前進した。
- `P3-MSP-08`: `/tmp/msp8_*` の最小再現で `open` 既定 mode 未補完、`PyFile` 反復未対応、`list.index` 未実装、`random.shuffle(list[str])` の `list<int64>` 固定束縛を確認し、吸収レイヤを `docs-jp/plans/p3-microgpt-source-preservation.md` に確定した。`random.choices(range(...))` は `unexpected raw range Call in EAST` を再現し、runtime/std ではなく `P3-MSP-06`（EAST lower）対象と分離した。
- `P3-MSP-09`: `tools/check_microgpt_original_py2cpp_regression.py` を追加し、原本 `materials/refs/microgpt/microgpt-20260222.py` 固定入力の transpile/syntax-check 結果を `stage=A..F|SUCCESS` で分類する回帰導線を整備した。`python3 tools/check_microgpt_original_py2cpp_regression.py --expect-stage any-known` で実行可能。
- `P3-MSP-03` の継続として `src/py2cpp.py` で module top-level 実行文を `__pytra_module_init()` へ分離し、`main` 冒頭で一度だけ呼ぶ初期化経路へ変更した。合わせて `src/runtime/cpp/pytra/built_in/io.*` の `PyFile` 反復（`begin/end`）+ `open(path)` overload、`src/runtime/cpp/pytra/built_in/list.h` の `list.index`、`src/runtime/cpp/pytra/std/random.h` の `shuffle(list<T>&)` テンプレートを追加し、`src/py2cpp.py::_coerce_param_signature_default` で `object/Any` 引数既定値の `make_object(...)` 補完を導入した。さらに `src/pytra/compiler/east_parts/core.py` へ無注釈関数の戻り値推定（`return <expr>`）を追加して `void` 返却不整合を縮退した。追加で `IfExp` の定数条件畳み込み、class 内 object 属性の `py_obj_cast` 経路、class 左辺算術の dunder lower、class method 呼び出し引数の `object` 強制 boxing、runtime `object` 四則演算 overload（`py_runtime.h`）と `math.log/exp(object)` overload（`math.*`）を実装し、`python3 tools/check_microgpt_original_py2cpp_regression.py --expect-stage any-known` の `stage=F` 先頭エラーを `std::make_tuple` 既定値不整合 → `Value::__add__` → `Value::__rtruediv__` へ段階的に前進させた（`python3 test/unit/test_self_hosted_signature.py`、`python3 test/unit/test_py2cpp_features.py ...3tests`、`python3 tools/check_py2cpp_transpile.py` は通過）。
- `P3-MSP-03` の継続として `stage=F` 先頭にあった `begin/end` 未解決・`zip/sum` 未定義・再帰ローカル関数の `use before deduction` を段階縮退した。`src/runtime/cpp/pytra/built_in/py_runtime.h` に ADL 用 `pytra::gc::begin/end` ブリッジと `zip`/`sum` 最小実装を追加し、`src/py2cpp.py` ではローカル関数シグネチャ登録、再帰ローカル関数の `std::function` 出力、`*this` 引数の object 化、`list/set` 内包の `object` 要素 boxing を追加した。`python3 test/unit/test_self_hosted_signature.py`（16件成功）、`python3 test/unit/test_py2cpp_features.py ...3tests`（成功）、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）を確認し、原本 `microgpt` の compile 先頭は `begin/end` 系から `softmax/gpt` 周辺（`val.data`/`object` 添字/`py_slice` 曖昧）へ前進した。`python3 tools/build_selfhost.py` は既知の selfhost parser 制約（`unsupported import clause`）で未通過。

## P3: Pythonic 記法戻し（低優先）

文脈: `docs-jp/plans/p3-pythonic-restoration.md`（`TG-P3-PYTHONIC`）

### `src/py2cpp.py`

1. [ ] [ID: P3-PY-01] `while i < len(xs)` + 手動インデックス更新を `for x in xs` / `for i, x in enumerate(xs)` へ戻す。
2. [x] [ID: P3-PY-02] `text[0:1] == "x"` のような1文字比較を、selfhost 要件を満たす範囲で `text.startswith("x")` へ戻す。
3. [ ] [ID: P3-PY-03] 空 dict/list 初期化後の逐次代入（`out = {}; out["k"] = v`）を、型崩れしない箇所から辞書リテラルへ戻す。
4. [ ] [ID: P3-PY-04] 三項演算子を回避している箇所（`if ...: a=x else: a=y`）を、selfhost 側対応後に式形式へ戻す。
5. [ ] [ID: P3-PY-05] import 解析の一時変数展開（`obj = ...; s = any_to_str(obj)`）を、型安全が確保できる箇所から簡潔化する。

進捗メモ:
- `P3-PY-05` の継続として `src/py2cpp.py` の import 束縛分岐を簡潔化し、`CppEmitter._emit_noop_stmt` の `names` 取得を分岐外へ共通化、`asname` fallback 判定を truthy 形式へ統一した。あわせて `CppEmitter._seed_import_maps_from_meta` は `has_refs = bool(refs)` を導入して `binding_kind == "symbol"` 分岐の条件を `not has_refs` へ明示化した。`python3 tools/check_py2cpp_transpile.py`（`checked=131 ok=131 fail=0 skipped=6`）を確認し、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=3 skipped=0`（既知維持）だった。`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.229.0 -> 0.230.0` へ更新した。
- `P3-PY-05` の継続として `src/py2cpp.py::CppEmitter._emit_noop_stmt` の `Import` 分岐で `local_name != ""` の事前チェックを削除し、`set_import_module_binding` の `module_id` ガードへ一本化した。`python3 tools/check_py2cpp_transpile.py`（`checked=131 ok=131 fail=0 skipped=6`）を確認し、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=3 skipped=0`（既知維持）だった。`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.228.0 -> 0.229.0` へ更新した。
- `P3-PY-05` の継続として `src/py2cpp.py` の import 解析分岐をさらに縮退し、`CppEmitter._collect_import_cpp_includes` の canonical/fallback 両経路で symbol 名の空判定を helper（`_append_runtime_symbol_include`）へ委譲、`CppEmitter._seed_import_maps_from_meta` では `if refs:` 包みを削除して `refs` 直接走査へ統一した。`python3 tools/check_py2cpp_transpile.py`（`checked=131 ok=131 fail=0 skipped=6`）を確認し、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=3 skipped=0`（既知維持）だった。`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.227.0 -> 0.228.0` へ更新した。
- `P3-PY-05` の継続として `src/py2cpp.py::CppEmitter._seed_import_maps_from_meta` の canonical import 反映ループで、`module_id/export_name/local_name` 一時変数展開を縮退し、`set_import_module_binding` / `set_import_symbol_binding_and_module_set` へ `dict_str_get(...)` を直接渡す形へ統一した。`python3 tools/check_py2cpp_transpile.py`（`checked=131 ok=131 fail=0 skipped=6`）を確認し、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=3 skipped=0`（既知維持）だった。`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.226.0 -> 0.227.0` へ更新した。
- `P3-PY-05` の継続として `src/py2cpp.py::CppEmitter._append_runtime_symbol_include` を追加し、`_collect_import_cpp_includes` の canonical / fallback 両経路に散在していた runtime symbol include 追加処理（prefix 判定 + include 解決 + unique append）を helper 呼び出しへ統一した。`python3 tools/check_py2cpp_transpile.py`（`checked=131 ok=131 fail=0 skipped=6`）を確認し、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=3 skipped=0`（既知維持）だった。`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.225.0 -> 0.226.0` へ更新した。
- `P3-PY-05` の継続として `src/py2cpp.py::CppEmitter._emit_noop_stmt` の import 束縛更新を簡潔化し、`Import` は `local_name = asname or _last_dotted_name(name)`、`ImportFrom` は `local_name = asname or name` を1回計算して `set_import_*` 呼び出しを単一路線に統一した。`python3 tools/check_py2cpp_transpile.py`（`checked=131 ok=131 fail=0 skipped=6`）を確認し、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=3 skipped=0`（既知維持）だった。`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.224.0 -> 0.225.0` へ更新した。
- `P3-PY-05` の継続として import 束縛の空文字ガード重複を削減し、`src/py2cpp.py::CppEmitter._collect_import_cpp_includes` から `if module_id != ""` を除去、`CppEmitter._seed_import_maps_from_meta` の `binding_kind == "symbol"` 分岐から `export_name != ""` を除去、`CppEmitter._emit_noop_stmt` の `Import/ImportFrom` で `name/mod` 空文字チェックを helper 側（`set_import_*`）へ委譲した。`python3 tools/check_py2cpp_transpile.py`（`checked=131 ok=131 fail=0 skipped=6`）を確認し、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=3 skipped=0`（既知維持）だった。`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.223.0 -> 0.224.0` へ更新した。
- `P3-PY-05` の継続として `src/py2cpp.py::CppEmitter._seed_import_maps_from_meta` の canonical import 分岐で `len(bindings)` / `len(refs)` 判定を真偽値判定（`if bindings`, `if refs`, `and not refs`）へ統一した。`python3 tools/check_py2cpp_transpile.py`（`checked=131 ok=131 fail=0 skipped=6`）を確認し、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=3 skipped=0`（既知維持）だった。`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.222.0 -> 0.223.0` へ更新した。
- `P3-PY-05` の継続として `src/py2cpp.py::CppEmitter._runtime_symbol_module_prefix` を追加し、`_collect_import_cpp_includes` の canonical / fallback 両分岐に残っていた `pytra.std` / `pytra.utils` prefix 判定ロジックを helper 経由へ統一した。`python3 tools/check_py2cpp_transpile.py`（`checked=131 ok=131 fail=0 skipped=6`）を確認し、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=3 skipped=0`（既知維持）だった。`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.221.0 -> 0.222.0` へ更新した。
- `P3-PY-05` の継続として `src/py2cpp.py::CppEmitter._seed_import_maps_from_meta` の canonical import 適用で、`meta_qualified_symbol_refs/meta_import_bindings` が既に正規化済みであることを前提に重複していた空文字バリデーション分岐（`if module_id != "" ...` / `if module_id == "" or local_name == ""`）を削除した。`python3 tools/check_py2cpp_transpile.py`（`checked=131 ok=131 fail=0 skipped=6`）を確認し、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=3 skipped=0`（既知維持）だった。`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.220.0 -> 0.221.0` へ更新した。
- `P3-PY-05` の継続として import 解析系の分岐を簡潔化し、`src/py2cpp.py::CppEmitter._collect_import_cpp_includes` の `if len(bindings) > 0` を `if bindings` へ、`CppEmitter._seed_import_maps_from_meta` の legacy fallback 判定 `if len(self.import_symbols/modules) == 0` を `if not self.import_symbols/modules` へ統一した。`python3 tools/check_py2cpp_transpile.py`（`checked=131 ok=131 fail=0 skipped=6`）を確認し、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=3 skipped=0`（既知維持）だった。`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.219.0 -> 0.220.0` へ更新した。
- `P3-PY-05` の継続として `src/py2cpp.py::CppEmitter._collect_import_cpp_includes` の canonical import_binding 分岐でも `pytra.std` / `pytra.utils` の symbol include 追加処理を `runtime_prefix` 経由へ統一した。`python3 tools/check_py2cpp_transpile.py`（`checked=131 ok=131 fail=0 skipped=6`）を確認し、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=3 skipped=0`（既知維持）だった。`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.218.0 -> 0.219.0` へ更新した。
- `P3-PY-05` の継続として `src/py2cpp.py` の import `names` 正規化をさらに縮退し、`CppEmitter._import_entries_for_stmt` を削除して `self._dict_stmt_list(stmt.get("names"))` へ一本化した（`_collect_import_cpp_includes` / `_emit_noop_stmt` の両方）。`python3 tools/check_py2cpp_transpile.py`（`checked=131 ok=131 fail=0 skipped=6`）を確認し、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=3 skipped=0`（既知維持）だった。`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.217.0 -> 0.218.0` へ更新した。
- `P3-PY-05` の継続として `src/py2cpp.py::CppEmitter._seed_import_maps_from_meta` の canonical import メタ読取を `dict_any_get_dict_list(..., "qualified_symbol_refs"/"import_bindings")` から `meta_qualified_symbol_refs(self.doc)` / `meta_import_bindings(self.doc)` へ統一し、ループ内のキー読取も `dict_str_get(...)` へ寄せた。`python3 tools/check_py2cpp_transpile.py`（`checked=131 ok=131 fail=0 skipped=6`）を確認し、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=3 skipped=0`（既知維持）だった。`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.216.0 -> 0.217.0` へ更新した。
- `P3-PY-05` の継続として `src/py2cpp.py::CppEmitter._collect_import_cpp_includes` の `ImportFrom` 分岐で重複していた `pytra.std` / `pytra.utils` の symbol include 追加処理を `runtime_prefix` 経由の単一ループへ統合した。`python3 tools/check_py2cpp_transpile.py`（`checked=131 ok=131 fail=0 skipped=6`）を確認し、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=3 skipped=0`（既知維持）だった。`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.215.0 -> 0.216.0` へ更新した。
- `P3-PY-05` の継続として import `names` 正規化 helper を `src/py2cpp.py::CppEmitter._import_entries_for_stmt` としてクラスメソッド化し、`_emit_noop_stmt` と `_collect_import_cpp_includes` で共有する構成へ整理した。`python3 tools/check_py2cpp_transpile.py`（`checked=131 ok=131 fail=0 skipped=6`）を確認し、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=3 skipped=0`（既知維持）だった。`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.214.0 -> 0.215.0` へ更新した。
- `P3-PY-05` の継続として `src/py2cpp.py::CppEmitter._emit_noop_stmt` の `Import/ImportFrom` で重複していた `names` 正規化（`_dict_stmt_list` 失敗時の `any_to_list` fallback）をローカル helper `_import_entries_for_stmt` へ共通化した。`python3 tools/check_py2cpp_transpile.py`（`checked=131 ok=131 fail=0 skipped=6`）を確認し、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=3 skipped=0`（既知維持）だった。`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.213.0 -> 0.214.0` へ更新した。
- `P3-PY-05` の継続として `src/py2cpp.py::_write_multi_file_cpp` の import 依存モジュール収集ループを `items()` から `values()` 走査へ整理し、未使用 alias 変数（`_alias_any`）を削除した。`python3 tools/check_py2cpp_transpile.py`（`checked=131 ok=131 fail=0 skipped=6`）を確認し、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=3 skipped=0`（既知維持）だった。`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.212.0 -> 0.213.0` へ更新した。
- `P3-PY-05` の継続として `src/py2cpp.py::CppEmitter._collect_import_cpp_includes` の canonical import binding 読取を `self._dict_stmt_list(meta.get("import_bindings"))` から `dict_any_get_dict_list(meta, "import_bindings")` へ統一し、`_seed_legacy_import_symbols_from_meta` では `module_id/symbol` 一時変数を削減して helper 呼び出しへ直接渡す形に整理した。`python3 tools/check_py2cpp_transpile.py`（`checked=131 ok=131 fail=0 skipped=6`）を確認し、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=3 skipped=0`（既知維持）だった。`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.211.0 -> 0.212.0` へ更新した。
- `P3-PY-05` の継続として `src/py2cpp.py::_write_multi_file_cpp` の import 依存モジュール抽出で、`module_id = ... if isinstance(...)` と `sym = ...` の一時変数展開を縮退し、`import_modules` は条件付き直接追加、`import_symbols` は `dict_any_get_str(self.any_to_dict_or_empty(sym_obj), "module")` 経由へ統一した。`python3 tools/check_py2cpp_transpile.py`（`checked=131 ok=131 fail=0 skipped=6`）を確認し、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=3 skipped=0`（既知維持）だった。`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.210.0 -> 0.211.0` へ更新した。
- `P3-PY-05` の継続として `src/py2cpp.py::CppEmitter._seed_import_maps_from_meta` と `CppEmitter.transpile` の `meta` 読取で、`any_to_dict_or_empty(self.doc.get("meta"))` を `dict_any_get_dict(self.doc, "meta")` へ統一した。`python3 tools/check_py2cpp_transpile.py`（`checked=131 ok=131 fail=0 skipped=6`）を確認し、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=3 skipped=0`（既知維持）だった。`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.209.0 -> 0.210.0` へ更新した。
- `P3-PY-05` の継続として `src/py2cpp.py::CppEmitter._seed_legacy_import_symbols_from_meta` / `_seed_legacy_import_modules_from_meta` の legacy import メタ読取で、`any_to_dict_or_empty(meta.get(...))` 展開を `dict_any_get_dict(meta, "...")` へ統一した。`python3 tools/check_py2cpp_transpile.py`（`checked=131 ok=131 fail=0 skipped=6`）を確認し、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=3 skipped=0`（既知維持）だった。`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.208.0 -> 0.209.0` へ更新した。
- `P3-PY-05` の継続として `src/py2cpp.py::CppEmitter._seed_import_maps_from_meta` の canonical import メタ読取で、`self.any_to_dict_list(meta.get(...))` 展開を `dict_any_get_dict_list(meta, "...")` へ統一した。`python3 tools/check_py2cpp_transpile.py`（`checked=131 ok=131 fail=0 skipped=6`）を確認し、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=3 skipped=0`（既知維持）だった。`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.207.0 -> 0.208.0` へ更新した。
- `P3-PY-05` の継続として `src/py2cpp.py::CppEmitter._seed_legacy_import_modules_from_meta` の legacy import module 束縛で中間変数 `module_id` を削除し、`set_import_module_binding(..., self.any_to_str(module_id_any))` へ直接渡す形に簡潔化した。`python3 tools/check_py2cpp_transpile.py`（`checked=131 ok=131 fail=0 skipped=6`）を確認し、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=3 skipped=0`（既知維持）だった。`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.206.0 -> 0.207.0` へ更新した。
- `P3-PY-05` の継続として `src/py2cpp.py` の import 参照エラー判定経路（`_render_attribute_expr` 内）で、`base_name = any_to_str(base_node.get("id"))` を `dict_any_get_str(base_node, "id")` へ統一した。`python3 tools/check_py2cpp_transpile.py`（`checked=131 ok=131 fail=0 skipped=6`）を確認し、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=3 skipped=0`（既知維持）だった。`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.205.0 -> 0.206.0` へ更新した。
- `P3-PY-05` の継続として `src/py2cpp.py::_make_missing_symbol_import_error` の `source_path` 読取を整理し、`src_obj = ...; isinstance(...)` 展開を `dict_any_get_str(self.doc, "source_path", "(input)")` + 空文字 fallback へ統一した。`python3 tools/check_py2cpp_transpile.py`（`checked=131 ok=131 fail=0 skipped=6`）を確認し、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=3 skipped=0`（既知維持）だった。`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.204.0 -> 0.205.0` へ更新した。
- `P3-PY-05` の継続として `src/py2cpp.py::_render_call_name_or_attr` の `Call(Name)` 分岐で、`raw = any_to_str(fn.get("id"))` を `dict_any_get_str(fn, "id")` へ統一した。`python3 tools/check_py2cpp_transpile.py`（`checked=131 ok=131 fail=0 skipped=6`）を確認し、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=3 skipped=0`（既知維持）だった。`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.203.0 -> 0.204.0` へ更新した。
- `P3-PY-05` の継続として `src/py2cpp.py::_is_reexport_assign` の import 再エクスポート判定を整理し、`any_to_str(value.get("id"))` / `any_to_str(owner.get("id"))` 展開を `dict_any_get_str(...)` へ統一、`owner` 抽出も `dict_any_get_dict(...)` へ寄せた。`python3 tools/check_py2cpp_transpile.py`（`checked=131 ok=131 fail=0 skipped=6`）を確認し、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=3 skipped=0`（既知維持）だった。`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.202.0 -> 0.203.0` へ更新した。
- `P3-PY-05` の継続として `src/py2cpp.py` の `Call(Name)` import 解決経路を簡潔化し、`_resolve_or_render_imported_symbol_name_call` の `mapped_runtime` 文字列化を条件式代入へ統一、`_render_call_name_or_attr` では `resolved[0]/resolved[1]` 展開を tuple 受け取りへ縮退した。`python3 tools/check_py2cpp_transpile.py`（`checked=131 ok=131 fail=0 skipped=6`）を確認し、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=3 skipped=0`（既知維持）だった。`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.201.0 -> 0.202.0` へ更新した。
- `P3-PY-05` の継続として `src/py2cpp.py::CppEmitter._resolve_or_render_imported_symbol_name_call` の import シンボル解決で、`resolved["module"/"name"] if ...` 展開を `dict_str_get(...)` へ統一した。`python3 tools/check_py2cpp_transpile.py`（`checked=131 ok=131 fail=0 skipped=6`）を確認し、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=3 skipped=0`（既知維持）だった。`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.200.0 -> 0.201.0` へ更新した。
- `P3-PY-05` の継続として `src/py2cpp.py::CppEmitter._emit_noop_stmt` の import 束縛更新（`Import` / `ImportFrom`）を整理し、`any_to_str(ent.get(...))` / `any_to_str(stmt.get("module"))` 展開を `dict_any_get_str(...)` へ統一した。`python3 tools/check_py2cpp_transpile.py`（`checked=131 ok=131 fail=0 skipped=6`）を確認し、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=3 skipped=0`（既知維持）だった。`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.199.0 -> 0.200.0` へ更新した。
- `P3-PY-05` の継続として `src/py2cpp.py::CppEmitter._collect_import_cpp_includes` の import 読取（`meta.import_bindings` / `Import` / `ImportFrom`）を整理し、`any_to_str(item.get(...))` 展開を `dict_any_get_str(...)` へ統一した。`python3 tools/check_py2cpp_transpile.py`（`checked=131 ok=131 fail=0 skipped=6`）を確認し、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=3 skipped=0`（既知維持）だった。`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.198.0 -> 0.199.0` へ更新した。
- `P3-PY-05` の継続として `src/py2cpp.py::CppEmitter._seed_import_maps_from_meta` の canonical import 読取（`qualified_symbol_refs` / `import_bindings`）を整理し、`any_to_str(item.get(...))` 展開を `dict_any_get_str(...)` へ統一した。`python3 tools/check_py2cpp_transpile.py`（`checked=131 ok=131 fail=0 skipped=6`）を確認し、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=3 skipped=0`（既知維持）だった。`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.197.0 -> 0.198.0` へ更新した。
- `P3-PY-05` の継続として `src/py2cpp.py::CppEmitter._seed_legacy_import_symbols_from_meta` / `_seed_legacy_import_modules_from_meta` の legacy import 読取を整理し、`sym.get(...)+any_to_str(...)` 展開を `dict_any_get_str(...)` + `module_id/symbol` 正規化へ統一した。`python3 tools/check_py2cpp_transpile.py`（`checked=131 ok=131 fail=0 skipped=6`）を確認し、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=3 skipped=0`（既知維持）だった。`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.196.0 -> 0.197.0` へ更新した。
- `P3-PY-05` の継続として `src/py2cpp.py::_write_multi_file_cpp` の import 依存モジュール抽出を整理し、`import_modules` 側の `module_id_obj` 判定を `module_id` 正規化へ統一、`import_symbols` 側も `sym_obj` 直参照を `sym` + `dict_any_get_str(sym, "module")` 経路へ縮退した。`python3 tools/check_py2cpp_transpile.py`（`checked=131 ok=131 fail=0 skipped=6`）を確認し、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=3 skipped=0`（既知維持）だった。`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.195.0 -> 0.196.0` へ更新した。
- `P3-PY-05` の継続として `src/py2cpp.py::_analyze_import_graph` の user module 解決で、`dep_file = Path("")` 初期化 + `str(dep_file) == ""` 判定を `dep_txt == ""` 早期判定へ整理し、edge 追加時の `cur_adj` 一時変数も `graph_adj[cur_key].append(dep_key)` へ縮退した。`python3 tools/check_py2cpp_transpile.py`（`checked=131 ok=131 fail=0 skipped=6`）を確認し、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=3 skipped=0`（既知維持）だった。`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.194.0 -> 0.195.0` へ更新した。
- `P3-PY-05` の継続として `src/py2cpp.py::_write_multi_file_cpp` の module 走査で未使用値 `_east_obj` を廃止し（`for mod_key in module_east_map`）、依存 module namespace 解決（`module_ns_map`）も `in` + 添字参照から `get(..., "")` へ統一した。`python3 tools/check_py2cpp_transpile.py`（`checked=131 ok=131 fail=0 skipped=6`）を確認し、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=3 skipped=0`（既知維持）だった。`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.193.0 -> 0.194.0` へ更新した。
- `P3-PY-05` の継続として `src/py2cpp.py::_write_multi_file_cpp` の依存モジュール解決で、`module_name_by_key` 線形探索を `module_key_by_name` 辞書へ置換した（同一 `mod_name` は最初の module key を保持）。`python3 tools/check_py2cpp_transpile.py`（`checked=131 ok=131 fail=0 skipped=6`）を確認し、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=3 skipped=0`（既知維持）だった。`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.192.0 -> 0.193.0` へ更新した。
- `P3-PY-05` の継続として `src/py2cpp.py::_write_multi_file_cpp` の import 依存モジュール抽出で、`mod_name` 一時変数と `dict_any_get_str(...)` 再呼び出しを削減し、`import_modules/import_symbols` の `items()` 値側（`module_id_obj`）を直接判定する経路へ整理した。`python3 tools/check_py2cpp_transpile.py`（`checked=131 ok=131 fail=0 skipped=6`）を確認し、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=3 skipped=0`（既知維持）だった。`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.191.0 -> 0.192.0` へ更新した。
- `P3-PY-05` の継続として `src/py2cpp.py::_write_multi_file_cpp` の forward 宣言生成で、`funcs.items()` 走査時の `dict_any_get_dict(funcs, fn_name)` 再lookupを削減し、`fn_sig_obj` 直接利用へ整理した（非文字列 key は早期 `continue`）。`python3 tools/check_py2cpp_transpile.py`（`checked=131 ok=131 fail=0 skipped=6`）を確認し、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=3 skipped=0`（既知維持）だった。`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.190.0 -> 0.191.0` へ更新した。
- `P3-PY-05` の継続として `src/py2cpp.py::_write_multi_file_cpp` の依存モジュール前方宣言解決で、`module_east_map.items()` 走査（値破棄 `_ = p2`）を廃止し、`module_name_by_key.items()` 直接走査へ整理した。`python3 tools/check_py2cpp_transpile.py`（`checked=131 ok=131 fail=0 skipped=6`）を確認し、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=3 skipped=0`（既知維持）だった。`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.189.0 -> 0.190.0` へ更新した。
- `P3-PY-05` の継続として `src/py2cpp.py::_write_multi_file_cpp` の import メタ読取で、`import_modules` / `import_symbols` の再lookup（`dict_any_get_*`）と alias 一時変数依存を縮退し、`items()` の値側（`module_id_obj` / `sym_obj`）から直接 `mod_name` を抽出する経路へ整理した。`python3 tools/check_py2cpp_transpile.py`（`checked=131 ok=131 fail=0 skipped=6`）を確認し、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=3 skipped=0`（既知維持）だった。`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.188.0 -> 0.189.0` へ更新した。
- `P3-PY-05` の継続として `src/py2cpp.py::CppEmitter._seed_import_maps_from_meta` に残っていた legacy import 読み取り重複を `_seed_legacy_import_symbols_from_meta` / `_seed_legacy_import_modules_from_meta` へ抽出し、`module_id_obj` / `sym_obj` の一時変数展開を縮退した。`python3 tools/check_py2cpp_transpile.py`（`checked=131 ok=131 fail=0 skipped=6`）を確認し、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=3 skipped=0`（既知維持）だった。`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.187.0 -> 0.188.0` へ更新した。
- `P3-PY-05` の継続として `src/py2cpp.py::_validate_import_graph_or_raise` の `relative_imports` / `missing_modules` 解析で重複していた `file_part/mod_part` 展開を `_split_graph_issue_entry` helper へ共通化した。`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）と `python3 tools/build_selfhost.py`（成功）を確認し、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=3 skipped=0`（既知維持）だった。`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.106.0 -> 0.107.0` へ更新し、`python3 tools/check_transpiler_version_gate.py`（`[OK] transpiler version bump gate passed`）を通過させた。
- `P3-PY-05` の継続として `src/py2cpp.py::_analyze_import_graph` に残っていた `relative_imports` / `missing_modules` / `edges` 収集時の重複分岐（`not in seen` + `add` + `append`）を、既存 helper `_append_unique_non_empty` 呼び出しへ統一した。`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）と `python3 tools/build_selfhost.py`（成功）を確認し、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=3 skipped=0`（既知維持）だった。`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.105.0 -> 0.106.0` へ更新し、`python3 tools/check_transpiler_version_gate.py`（`[OK] transpiler version bump gate passed`）を通過させた。
- `P3-PY-05` の継続として `src/py2cpp.py::CppEmitter._collect_import_cpp_includes` に残っていた include 追加の重複分岐（`inc/sym_inc` の空文字 + 重複判定）を、既存 helper `_append_unique_non_empty` 呼び出しへ統一した。`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）と `python3 tools/build_selfhost.py`（成功）を確認し、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=3 skipped=0`（既知維持）だった。`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.104.0 -> 0.105.0` へ更新し、`python3 tools/check_transpiler_version_gate.py`（`[OK] transpiler version bump gate passed`）を通過させた。
- `P3-PY-05` の継続として `src/py2cpp.py` に `_append_unique_non_empty` helper を追加し、`dump_deps_text` と `_collect_import_modules` に散在していた「空文字除外 + 重複除外 + append」分岐を共通化した。これにより import module/symbol ラベル収集の重複条件分岐を縮退した。`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）と `python3 tools/build_selfhost.py`（成功）を確認し、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=3 skipped=0`（既知維持）だった。`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.103.0 -> 0.104.0` へ更新し、`python3 tools/check_transpiler_version_gate.py`（`[OK] transpiler version bump gate passed`）を通過させた。
- `P3-PY-05` の継続として `src/py2cpp.py::build_module_symbol_index` の legacy import fallback で `module_id` / `symbol` 一時変数展開を縮退し、`_set_import_module_binding` / `_set_import_symbol_binding` へ `_dict_any_get_str(...)` 直接渡しへ整理した。`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）と `python3 tools/build_selfhost.py`（成功）を確認し、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=3 skipped=0`（既知維持）だった。`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.102.0 -> 0.103.0` へ更新し、`python3 tools/check_transpiler_version_gate.py`（`[OK] transpiler version bump gate passed`）を通過させた。
- `P3-PY-01` の継続として `src/py2cpp.py::CppEmitter._fallback_tuple_target_names_from_repr` の `parts` 走査を index ベース（`for j in range(len(parts))`）から直接反復（`for nm in parts`）へ戻した。文字列本体の文字走査（`for k in range(len(nm))`）は selfhost 安定性を優先して維持した。`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）と `python3 tools/build_selfhost.py`（成功）を確認し、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=3 skipped=0`（既知維持）だった。`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.101.0 -> 0.102.0` へ更新し、`python3 tools/check_transpiler_version_gate.py`（`[OK] transpiler version bump gate passed`）を通過させた。
- `P3-PY-05` の継続として `src/py2cpp.py::dump_deps_text` と `build_module_symbol_index` の import binding 読取で、`ent["module_id"]` などを一時変数へ展開していた経路を縮退し、`_set_import_module_binding` / `_set_import_symbol_binding` 呼び出しを含めて直接参照中心に整理した。`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）と `python3 tools/build_selfhost.py`（成功）を確認し、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=3 skipped=0`（既知維持）だった。`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.100.0 -> 0.101.0` へ更新し、`python3 tools/check_transpiler_version_gate.py`（`[OK] transpiler version bump gate passed`）を通過させた。
- `P3-PY-01` の継続として `src/py2cpp.py::_extract_function_arg_types_from_python_source` で `fn_names` 一時配列を作って index 走査していた経路を廃止し、`sigs.items()` の直接反復へ戻した。以前見送った `list[str]` 直接反復とは別経路（`dict` 反復）として適用し、selfhost 型崩れを回避した。`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）と `python3 tools/build_selfhost.py`（成功）を確認し、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=3 skipped=0`（既知維持）だった。`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.99.0 -> 0.100.0` へ更新し、`python3 tools/check_transpiler_version_gate.py`（`[OK] transpiler version bump gate passed`）を通過させた。
- `P3-PY-05` の継続として `src/py2cpp.py::CppEmitter._emit_noop_stmt` の `Import` / `ImportFrom` 分岐で重複していた import 束縛更新（`import_modules` 代入、`import_symbols` 代入 + `import_symbol_modules` 登録）を `_set_import_module_binding` / `_set_import_symbol_binding_and_module_set` へ統一した。`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）と `python3 tools/build_selfhost.py`（成功）を確認し、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=3 skipped=0`（既知維持）だった。`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.98.0 -> 0.99.0` へ更新し、`python3 tools/check_transpiler_version_gate.py`（`[OK] transpiler version bump gate passed`）を通過させた。
- `P3-PY-05` の継続として `src/py2cpp.py` に `_set_import_symbol_binding_and_module_set` helper を追加し、`CppEmitter._seed_import_maps_from_meta` の canonical/legacy import symbol 束縛で重複していた `import_symbols` 代入 + `import_symbol_modules` 登録を共通化した。あわせて同メソッドの module alias 束縛も `_set_import_module_binding` へ寄せた。初版は helper 内の helper 呼び出しで selfhost C++ の `const` 推論回帰（`dict&` へ束縛不可）を誘発したため、helper 本体を直接代入に修正して解消した。`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）と `python3 tools/build_selfhost.py`（成功）を確認し、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=3 skipped=0`（既知維持）だった。`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.97.0 -> 0.98.0` へ更新し、`python3 tools/check_transpiler_version_gate.py`（`[OK] transpiler version bump gate passed`）を通過させた。
- `P3-PY-05` の継続として `src/py2cpp.py` に `_set_import_module_binding` / `_set_import_symbol_binding` helper を追加し、`build_module_symbol_index` の import alias 構築（`import_bindings` / `qualified_symbol_refs` / legacy meta）で重複していた map 代入を共通化した。`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）と `python3 tools/build_selfhost.py`（成功）を確認し、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=3 skipped=0`（既知維持）だった。`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.96.0 -> 0.97.0` へ更新し、`python3 tools/check_transpiler_version_gate.py`（`[OK] transpiler version bump gate passed`）を通過させた。
- `P3-PY-05` の継続として `src/py2cpp.py` に `_stmt_assigned_names` helper を追加し、`_module_export_table` と `build_module_symbol_index` の `Assign/AnnAssign` 名抽出重複を共通化した。`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）と `python3 tools/build_selfhost.py`（成功）を確認し、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=3 skipped=0`（既知維持）だった。`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.95.0 -> 0.96.0` へ更新し、`python3 tools/check_transpiler_version_gate.py`（`[OK] transpiler version bump gate passed`）を通過させた。
- `P3-PY-05` の継続として `src/py2cpp.py` に `_stmt_target_name` helper を追加し、`build_cpp_header_from_east`、`_module_export_table`、`build_module_symbol_index` の `target` 由来 `Name` 抽出重複を共通化した。`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）と `python3 tools/build_selfhost.py`（成功）を確認し、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=3 skipped=0`（既知維持）だった。`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.94.0 -> 0.95.0` へ更新し、`python3 tools/check_transpiler_version_gate.py`（`[OK] transpiler version bump gate passed`）を通過させた。
- `P3-PY-05` の継続として `src/py2cpp.py` に `_name_target_id` helper を追加し、`_module_export_table` と `build_module_symbol_index` の `Assign/AnnAssign` で重複していた `Name` 判定 + `id` 抽出を共通化した。`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）と `python3 tools/build_selfhost.py`（成功）を確認し、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=3 skipped=0`（既知維持）だった。`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.93.0 -> 0.94.0` へ更新し、`python3 tools/check_transpiler_version_gate.py`（`[OK] transpiler version bump gate passed`）を通過させた。
- `P3-PY-05` の継続として `src/py2cpp.py` に `_assign_targets` helper を追加し、`_module_export_table` と `build_module_symbol_index` の `Assign` 読取で重複していた `targets/target` fallback 展開を共通化した。`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）と `python3 tools/build_selfhost.py`（成功）を確認し、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=3 skipped=0`（既知維持）だった。`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.92.0 -> 0.93.0` へ更新し、`python3 tools/check_transpiler_version_gate.py`（`[OK] transpiler version bump gate passed`）を通過させた。
- `P3-PY-01` の継続として `src/py2cpp.py::_sort_str_list_in_place` の `items` コピー走査を index ベース（`for i in range(len(items))`）から直接反復（`for item in items`）へ戻した。対象は型注釈済み `list[str]` 引数に限定し、既知の `string` 直接反復不安定域は触れていない。`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 維持）を確認し、`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.91.0 -> 0.92.0` へ更新して `python3 tools/check_transpiler_version_gate.py`（`[OK] transpiler version bump gate passed`）を通過させた。
- `P3-PY-01` の継続として `src/py2cpp.py::_collect_import_cpp_includes` の `bindings` 走査を index ベース（`for i in range(len(bindings))`）から直接反復（`for item in bindings`）へ戻した。`list[str]/string` 反復で selfhost 型崩れが起きる既知領域は避け、`_dict_stmt_list(...)` で正規化済みの `list[dict]` のみを対象にした。`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 維持）を確認し、`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.90.0 -> 0.91.0` へ更新して `python3 tools/check_transpiler_version_gate.py`（`[OK] transpiler version bump gate passed`）を通過させた。
- `P3-PY-01` の継続として `src/py2cpp.py::_seed_import_maps_from_meta` の `refs/bindings` 走査を index ベース（`for i in range(len(...))`）から直接反復（`for ref_item in refs` / `for item in bindings`）へ戻した。`list[str]` / `string` 反復で selfhost 型崩れが起きる既知領域は避け、`any_to_dict_list(...)` で正規化済みの `list[dict]` だけを対象にした。`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 維持）を確認し、`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.89.0 -> 0.90.0` へ更新して `python3 tools/check_transpiler_version_gate.py`（`[OK] transpiler version bump gate passed`）を通過させた。
- `P3-PY-01` の継続として `src/py2cpp.py::transpile`（class method 収集部）の `arg_order` 走査を index ベース（`for ai in range(len(arg_order))`）から直接反復（`for raw_n in arg_order`）へ戻した。`list[str]/list[dict]` の既知不安定域は避け、`list[Any]` 由来の箇所だけを対象にした。`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 維持）を確認し、`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.88.0 -> 0.89.0` へ更新して `python3 tools/check_transpiler_version_gate.py`（`[OK] transpiler version bump gate passed`）を通過させた。
- `P3-PY-01` の継続として `src/py2cpp.py::render_minmax` と `src/py2cpp.py::_collect_assigned_name_types` の `list[Any]` 添字走査（`for i in range(len(...))`）を直接反復へ戻した。`list[str]/list[dict]` で selfhost 型崩れが出る既知領域は避け、`arg_nodes_safe` / `elements` のみを対象にした。`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 維持）を確認し、`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.87.0 -> 0.88.0` へ更新して `python3 tools/check_transpiler_version_gate.py`（`[OK] transpiler version bump gate passed`）を通過させた。
- `P3-PY-01` の継続として `src/py2cpp.py::_mark_mutated_param_from_target`、`src/py2cpp.py::_render_param_default_expr`、`src/py2cpp.py::_emit_noop_stmt` の `list[Any]` 添字走査（`for i in range(len(...))`）を直接反復へ戻した。`list[str]/list[dict]` で selfhost 型崩れが出る既知領域は避け、`any_to_list` / `any_dict_get_list` 由来のループだけを対象にした。`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 維持）を確認し、`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.86.0 -> 0.87.0` へ更新して `python3 tools/check_transpiler_version_gate.py`（`[OK] transpiler version bump gate passed`）を通過させた。
- `P3-PY-01` の継続として `src/py2cpp.py::_resolve_user_module_path_for_graph` と `src/py2cpp.py::_resolve_user_module_path` の `candidates` 走査を index ベース（`for i in range(len(...))`）から直接反復（`for path_txt, rank in candidates`）へ戻した。あわせて `src/py2cpp.py::_extract_function_arg_types_from_python_source` の直接反復化も試したが、selfhost C++ で `str -> object` 変換エラーを誘発したため取り下げ、selfhost 安定優先で見送った。`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 維持）を確認し、`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.85.0 -> 0.86.0` へ更新して `python3 tools/check_transpiler_version_gate.py`（`[OK] transpiler version bump gate passed`）を通過させた。
- `P3-PY-01` の継続として `src/py2cpp.py::_class_method_sig` と `src/py2cpp.py::_class_method_name_sig` の `candidates` 走査を index ベース（`for i in range(len(...))`）から直接反復へ戻した。`CppEmitter.transpile` の `module_defs` 直接反復も併せて試したが selfhost C++ で `dict -> object` 変換エラーが発生したため取り下げ、selfhost 安定優先で見送った。`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 維持）を確認し、`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.84.0 -> 0.85.0` へ更新して `python3 tools/check_transpiler_version_gate.py`（`[OK] transpiler version bump gate passed`）を通過させた。
- `P3-PY-01` の継続として `src/py2cpp.py::_analyze_import_graph` の `mods/graph_keys/keys/visited_order` 走査を index ベース（`for i in range(len(...))`）から直接反復へ戻した。`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 維持）を確認し、`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.83.0 -> 0.84.0` へ更新して `python3 tools/check_transpiler_version_gate.py`（`[OK] transpiler version bump gate passed`）を通過させた。
- `P3-PY-01` の継続として `src/py2cpp.py::dump_deps_text` の import binding 走査と `modules/symbols` 出力走査を index ベース（`for i in range(len(...))`）から直接反復へ戻した。`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 維持）を確認し、`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.82.0 -> 0.83.0` へ更新して `python3 tools/check_transpiler_version_gate.py`（`[OK] transpiler version bump gate passed`）を通過させた。
- `P3-PY-01` の継続として `src/py2cpp.py::_module_export_table` と `src/py2cpp.py::_validate_from_import_symbols_or_raise` の `body`/`names` 走査を index ベース（`for i in range(len(...))`）から直接反復へ戻した。`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 維持）を確認し、`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.81.0 -> 0.82.0` へ更新して `python3 tools/check_transpiler_version_gate.py`（`[OK] transpiler version bump gate passed`）を通過させた。
- `P3-PY-01` の継続として `src/py2cpp.py::_header_render_default_expr` と `src/py2cpp.py::build_cpp_header_from_east` の反復処理（`body`/`arg_order`/`includes`/`class_lines`/`var_lines`/`fn_lines`）を index ベース（`for i in range(len(...))`）から直接反復へ戻した。`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 維持）を確認し、`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.80.0 -> 0.81.0` へ更新して `python3 tools/check_transpiler_version_gate.py`（`[OK] transpiler version bump gate passed`）を通過させた。
- `P3-PY-01`/`P3-PY-04` の継続として `src/py2cpp.py::build_module_type_schema` と `src/py2cpp.py::_write_multi_file_cpp` の反復処理を index ベース（`for i in range(len(...))`）から直接反復（`for x in ...`）へ戻し、`label`/`target_mod_name` の if 代入を条件式へ統一した。`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 維持）を確認し、`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.79.0 -> 0.80.0` へ更新して `python3 tools/check_transpiler_version_gate.py`（`[OK] transpiler version bump gate passed`）を通過させた。
- `P3-PY-05` の継続として `src/py2cpp.py::build_module_symbol_index`（legacy import fallback）と `src/py2cpp.py::_write_multi_file_cpp`（import meta 走査）で `dict(...)` 直コピーと緩い要素読取を削減し、`_dict_any_get_str(...)` / `_dict_any_get_dict(...)` ベースの key/値正規化へ統一した。`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3 skipped=0` 維持）を確認し、`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.78.0 -> 0.79.0` へ更新して `python3 tools/check_transpiler_version_gate.py`（`[OK] transpiler version bump gate passed`）を通過させた。
- `P3-PY-05` の継続として `src/py2cpp.py` の 2 関数（`_header_render_default_expr`、`build_cpp_header_from_east`）で `obj -> isinstance -> 代入` 展開をさらに縮退し、`_dict_any_get_dict_list` / `_dict_any_get_str` / `_dict_any_get_dict` へ統一した。`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 維持）を確認し、`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.77.0 -> 0.78.0` へ更新して `python3 tools/check_transpiler_version_gate.py`（`[OK] transpiler version bump gate passed`）を通過させた。
- `P3-PY-05` の継続として `src/py2cpp.py` の 2 関数（`_header_render_default_expr`、`build_cpp_header_from_east`）で `obj -> isinstance -> 代入` 展開を helper（`_dict_any_get_list` / `_dict_any_get_dict_list` / `_dict_any_get_dict`）経由へ統一した。`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 維持）を確認し、`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.76.0 -> 0.77.0` へ更新して `python3 tools/check_transpiler_version_gate.py`（`[OK] transpiler version bump gate passed`）を通過させた。
- `P3-PY-04` の継続として `src/py2cpp.py` の 3 関数（`_emit_local_function_stmt`、`emit_for_each`、`render_expr` の `dict` 推論分岐）で if/else 代入を条件式へ戻した。`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 維持）を確認し、`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.75.0 -> 0.76.0` へ更新して `python3 tools/check_transpiler_version_gate.py`（`[OK] transpiler version bump gate passed`）を通過させた。
- `P3-PY-04` の継続として `src/py2cpp.py` の 3 関数（`_python_module_exists_under`、`_module_tail_to_cpp_header_path`、`_runtime_cpp_header_exists_for_module`）で if 連鎖代入を条件式へ戻した。`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 維持）を確認し、`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.74.0 -> 0.75.0` へ更新して `python3 tools/check_transpiler_version_gate.py`（`[OK] transpiler version bump gate passed`）を通過させた。
- `P3-PY-04` の継続として `src/py2cpp.py` の 3 関数（`_render_repr_expr`、`render_expr`、`transpile_cli`）で if 連鎖代入を条件式へ戻した。`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 維持）を確認し、`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.73.0 -> 0.74.0` へ更新して `python3 tools/check_transpiler_version_gate.py`（`[OK] transpiler version bump gate passed`）を通過させた。
- `P3-PY-04` の継続として `src/py2cpp.py` の 3 関数（`_module_name_from_path_for_graph`、`_module_id_from_east_for_graph`、`_module_name_from_path`）で if 連鎖代入を条件式へ戻した。`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 維持）を確認し、`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.72.0 -> 0.73.0` へ更新して `python3 tools/check_transpiler_version_gate.py`（`[OK] transpiler version bump gate passed`）を通過させた。
- `P3-PY-04` の継続として `src/py2cpp.py` の 3 関数（`_resolve_user_module_path_for_graph`、`_sanitize_module_label`、`_resolve_user_module_path`）で if 連鎖代入を条件式へ戻した。`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 維持）を確認し、`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.71.0 -> 0.72.0` へ更新して `python3 tools/check_transpiler_version_gate.py`（`[OK] transpiler version bump gate passed`）を通過させた。
- `P3-PY-04` の継続として `src/py2cpp.py` の 3 関数（`_predeclare_if_join_names`、`_emit_annassign_stmt`、`render_expr` の `ListComp/RangeExpr` 分岐）で if 連鎖代入を条件式へ戻した。`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 維持）を確認し、`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.70.0 -> 0.71.0` へ更新して `python3 tools/check_transpiler_version_gate.py`（`[OK] transpiler version bump gate passed`）を通過させた。
- `P3-PY-04` の継続として `src/py2cpp.py` の 3 関数（`_emit_local_function_stmt`、`_emit_target_unpack`、`emit_function`）で if 連鎖代入を条件式へ戻した。`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 維持）を確認し、`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.69.0 -> 0.70.0` へ更新して `python3 tools/check_transpiler_version_gate.py`（`[OK] transpiler version bump gate passed`）を通過させた。
- `P3-PY-04` の継続として `src/py2cpp.py` の 3 関数（`_emit_if_stmt`、`_emit_while_stmt`、`build_module_east_map`）で if 連鎖代入を条件式へ戻した。`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 維持）を確認し、`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.68.0 -> 0.69.0` へ更新して `python3 tools/check_transpiler_version_gate.py`（`[OK] transpiler version bump gate passed`）を通過させた。
- `P3-PY-04` の継続として `src/py2cpp.py` の 3 関数（`_infer_module_global_decl_type`、`_emit_annassign_stmt`、`_emit_augassign_stmt`）で if 連鎖代入を条件式へ戻した。`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 維持）を確認し、`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.67.0 -> 0.68.0` へ更新して `python3 tools/check_transpiler_version_gate.py`（`[OK] transpiler version bump gate passed`）を通過させた。
- `P3-PY-05` の継続として `src/py2cpp.py::_module_export_table` と `build_module_symbol_index` の Assign/AnnAssign 読取で `obj -> isinstance -> 代入` 展開を削減し、`_dict_any_get_dict(...)` / `_dict_any_get_dict_list(...)` 前提の経路へ統一した。`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 維持）を確認し、`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.66.0 -> 0.67.0` へ更新して `python3 tools/check_transpiler_version_gate.py`（`[OK] transpiler version bump gate passed`）を通過させた。
- `P3-PY-03` の継続として `src/py2cpp.py::load_cpp_profile` の fallback 経路を整理し、`out = {}; out["syntax"] = {}` 形の段階代入を廃止して `{"syntax": {}}` を直接返す形へ変更した。`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 維持）を確認し、`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.65.0 -> 0.66.0` へ更新して `python3 tools/check_transpiler_version_gate.py`（`[OK] transpiler version bump gate passed`）を通過させた。
- `P3-PY-04` の継続として `src/py2cpp.py` の 3 関数（`render_boolop`、`emit_for_range`、list comprehension の `RangeExpr` 分岐）で if/else 代入を条件式へ戻した。`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 維持）を確認し、`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.64.0 -> 0.65.0` へ更新して `python3 tools/check_transpiler_version_gate.py`（`[OK] transpiler version bump gate passed`）を通過させた。
- `P3-PY-04` の継続として `src/py2cpp.py` の 3 箇所（`load_east` の `east_any` 選択、`emit_function` の `param_txt` 選択、`build_cpp_header_from_east` の `param_txt` 選択）で if/else 代入を条件式へ戻した。`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 維持）を確認し、`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.63.0 -> 0.64.0` へ更新して `python3 tools/check_transpiler_version_gate.py`（`[OK] transpiler version bump gate passed`）を通過させた。
- `P3-PY-04` の継続として `src/py2cpp.py` の 3 箇所（tuple unpack の `decl_t_txt` 選択、CLI の `east_module` 選択、multi-file 分岐の `module_east_map` 選択）で if/else 代入を条件式へ戻した。`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 維持）を確認し、`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.62.0 -> 0.63.0` へ更新して `python3 tools/check_transpiler_version_gate.py`（`[OK] transpiler version bump gate passed`）を通過させた。
- `P3-PY-04` の継続として `src/py2cpp.py` の 3 箇所（`emit_for_range` の `tgt_ty_txt` 選択、`_rel_disp_for_graph` の `base_prefix` 構築、multi-file header 宣言生成部の `ret_cpp` 選択）で if/else 代入を条件式へ戻した。`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 維持）を確認し、`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.61.0 -> 0.62.0` へ更新して `python3 tools/check_transpiler_version_gate.py`（`[OK] transpiler version bump gate passed`）を通過させた。
- `P3-PY-01` の継続として `src/py2cpp.py` の 2 関数（`_split_top_level_infix_text`、`_replace_all_text`）で外側 `while` を `for range + skip_until` へ置換し、可変ステップ（`i += m`）を維持した。`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 維持）を確認し、`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.60.0 -> 0.61.0` へ更新して `python3 tools/check_transpiler_version_gate.py`（`[OK] transpiler version bump gate passed`）を通過させた。
- `P3-PY-01` の継続として `src/py2cpp.py` の 2 箇所（`CppEmitter._split_call_repr` の括弧深さ走査、`CppEmitter._replace_all_text` の一致判定内側ループ）で `while` を `for range` へ置換した。`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 維持）を確認し、`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.59.0 -> 0.60.0` へ更新して `python3 tools/check_transpiler_version_gate.py`（`[OK] transpiler version bump gate passed`）を通過させた。
- `P3-PY-01` の継続として `src/py2cpp.py` の 2 関数（`_sort_str_list_in_place`、`_graph_cycle_dfs`）で逆順 `while` 走査を `for range` へ置換した。`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 維持）を確認し、`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.58.0 -> 0.59.0` へ更新して `python3 tools/check_transpiler_version_gate.py`（`[OK] transpiler version bump gate passed`）を通過させた。
- `P3-PY-01` の継続として `src/py2cpp.py` の 3 関数（`CppEmitter.is_declared`、`CppEmitter.render_boolop`、`CppEmitter.render_expr` の `Dict` 分岐 entries 補完）で `while` 走査を `for range` へ置換した。`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 維持）を確認し、`src/pytra/compiler/transpiler_versions.json` の `cpp` を `0.57.0 -> 0.58.0` へ更新して `python3 tools/check_transpiler_version_gate.py`（`[OK] transpiler version bump gate passed`）を通過させた。
- `P3-PY-05` の継続として `src/py2cpp.py::_write_multi_file_cpp` の module EAST 読取（`mod_key` 走査、`east_obj0/east_obj` 取得）で `module_east_map.get(...)+isinstance(..., dict)` 展開を `_dict_any_get_dict(...)` ベースへ統一し、一時変数を簡潔化した。`python3 test/unit/test_self_hosted_signature.py`（16件成功）、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_random_choices_range_call_lowers_to_py_range Py2CppFeatureTest.test_lambda_default_arg_emits_cpp_default Py2CppFeatureTest.test_zip_tuple_unpack_does_not_force_object_receiver`（3件成功）、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/check_microgpt_original_py2cpp_regression.py --expect-stage any-known`（`stage=F` 維持）を確認した。`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `selfhost/py2cpp.out` 不在で未実施となり、`python3 tools/build_selfhost.py` は既知の selfhost parser 制約（`unsupported import clause: _modules: dict[str at 635:0`）で失敗した。
- `P3-PY-05` の継続として `src/py2cpp.py::_write_multi_file_cpp` の import symbol/type schema 読取で `sym_obj` / `sig_obj` / `arg_order_obj` の一時展開を `_dict_any_get_dict(...)` / `_dict_any_get_list(...)` へ統一し、`funcs` 走査も key 先行へ寄せた。`python3 test/unit/test_self_hosted_signature.py`（16件成功）、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_random_choices_range_call_lowers_to_py_range Py2CppFeatureTest.test_lambda_default_arg_emits_cpp_default Py2CppFeatureTest.test_zip_tuple_unpack_does_not_force_object_receiver`（3件成功）、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/check_microgpt_original_py2cpp_regression.py --expect-stage any-known`（`stage=F` 維持）を確認した。`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `selfhost/py2cpp.out` 不在で未実施となり、`python3 tools/build_selfhost.py` は既知の selfhost parser 制約（`unsupported import clause: _modules: dict[str at 635:0`）で失敗した。
- `P3-PY-05` の継続として `src/py2cpp.py::_analyze_import_graph` の user module 辺追加で `cur_adj_obj` + `isinstance(..., list)` 展開を削減し、`graph_adj[cur_key].append(dep_key)` へ簡潔化した。`python3 test/unit/test_self_hosted_signature.py`（16件成功）、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_random_choices_range_call_lowers_to_py_range Py2CppFeatureTest.test_lambda_default_arg_emits_cpp_default Py2CppFeatureTest.test_zip_tuple_unpack_does_not_force_object_receiver`（3件成功）、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/check_microgpt_original_py2cpp_regression.py --expect-stage any-known`（`stage=F` 維持）を確認した。`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `selfhost/py2cpp.out` 不在で未実施となり、`python3 tools/build_selfhost.py` は既知の selfhost parser 制約（`unsupported import clause: _modules: dict[str at 635:0`）で失敗した。
- `P3-PY-05` の継続として `src/py2cpp.py::_meta_import_bindings` と `_meta_qualified_symbol_refs` の import meta 読取で `item_obj` + `isinstance(..., dict)` 展開を `_dict_any_get_dict_list(...)` へ統一した。`python3 test/unit/test_self_hosted_signature.py`（16件成功）、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_random_choices_range_call_lowers_to_py_range Py2CppFeatureTest.test_lambda_default_arg_emits_cpp_default Py2CppFeatureTest.test_zip_tuple_unpack_does_not_force_object_receiver`（3件成功）、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/check_microgpt_original_py2cpp_regression.py --expect-stage any-known`（`stage=F` 維持）を確認した。`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `selfhost/py2cpp.out` 不在で未実施となり、`python3 tools/build_selfhost.py` は既知の selfhost parser 制約（`unsupported import clause: _modules: dict[str at 635:0`）で失敗した。
- `P3-PY-05` の継続として `src/py2cpp.py::build_module_symbol_index` と `build_module_type_schema` の import graph 読取で `body/targets/import_modules/import_symbols/arg_types/arg_order/field_types` の `*_obj` + `isinstance(..., list/dict)` 展開を `_dict_any_get_dict_list(...)` / `_dict_any_get_list(...)` / `_dict_any_get_dict(...)` へ統一した。`python3 test/unit/test_self_hosted_signature.py`（16件成功）、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_random_choices_range_call_lowers_to_py_range Py2CppFeatureTest.test_lambda_default_arg_emits_cpp_default Py2CppFeatureTest.test_zip_tuple_unpack_does_not_force_object_receiver`（3件成功）、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/check_microgpt_original_py2cpp_regression.py --expect-stage any-known`（`stage=F` 維持）を確認した。`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `selfhost/py2cpp.out` 不在で未実施となり、`python3 tools/build_selfhost.py` は既知の selfhost parser 制約（`unsupported import clause: _modules: dict[str at 635:0`）で失敗した。
- `P3-PY-05` の継続として `src/py2cpp.py::build_module_east_map`、`_module_export_table`、`_validate_from_import_symbols_or_raise` の import graph 読取で `*_obj` + `isinstance(..., list/dict)` 展開を `_dict_any_get_str_list(...)` / `_dict_any_get_dict_list(...)` / `_dict_any_get_list(...)` / `_dict_any_get_dict(...)` へ統一した。`python3 test/unit/test_self_hosted_signature.py`（16件成功）、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_random_choices_range_call_lowers_to_py_range Py2CppFeatureTest.test_lambda_default_arg_emits_cpp_default Py2CppFeatureTest.test_zip_tuple_unpack_does_not_force_object_receiver`（3件成功）、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/check_microgpt_original_py2cpp_regression.py --expect-stage any-known`（`stage=F` 維持）を確認した。`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `selfhost/py2cpp.out` 不在で未実施となり、事前の `python3 tools/build_selfhost.py` は既知の selfhost parser 制約（`unsupported import clause: _modules: dict[str at 635:0`）で失敗した。
- `P3-PY-05` の継続として `src/py2cpp.py::_format_import_graph_report` と `_validate_import_graph_or_raise` の import graph 読取で `*_obj` + `isinstance(..., list)` 展開を `_dict_any_get_str_list(...)` ベースへ統一し、`relative/missing` の `file: module` 分解は `_split_infix_once(...)` へ寄せた。`python3 test/unit/test_self_hosted_signature.py`（16件成功）、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_random_choices_range_call_lowers_to_py_range Py2CppFeatureTest.test_lambda_default_arg_emits_cpp_default Py2CppFeatureTest.test_zip_tuple_unpack_does_not_force_object_receiver`（3件成功）、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/check_microgpt_original_py2cpp_regression.py --expect-stage any-known`（`stage=F` 維持）を確認した。
- `P3-PY-05` の継続として `src/py2cpp.py` に `_dict_any_get_dict_list(...)` を追加し、`dump_deps_text` / `_collect_import_modules` の import `names` 読取で `*_obj` 一時変数展開と `isinstance(..., list)` 分岐を helper 経由へ統一した。`python3 test/unit/test_self_hosted_signature.py`（16件成功）、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_random_choices_range_call_lowers_to_py_range Py2CppFeatureTest.test_lambda_default_arg_emits_cpp_default Py2CppFeatureTest.test_zip_tuple_unpack_does_not_force_object_receiver`（3件成功）、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/check_microgpt_original_py2cpp_regression.py --expect-stage any-known`（`stage=F` 維持）を確認した。
- `P3-PY-05` の継続として `src/py2cpp.py` に `_dict_any_get_list(...)` を追加し、`load_cpp_module_attr_call_map` / `_meta_import_bindings` / `_meta_qualified_symbol_refs` の import メタ読取で `*_obj` 一時変数展開を削減した。`python3 test/unit/test_self_hosted_signature.py`（16件成功）、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_random_choices_range_call_lowers_to_py_range Py2CppFeatureTest.test_lambda_default_arg_emits_cpp_default Py2CppFeatureTest.test_zip_tuple_unpack_does_not_force_object_receiver`（3件成功）、`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`python3 tools/check_microgpt_original_py2cpp_regression.py --expect-stage any-known`（`stage=F` 維持）を確認した。
- `P3-PY-05` の継続として `src/py2cpp.py::_module_id_from_east_for_graph`、`_module_id_from_east`、`build_module_symbol_index` の `meta` 抽出を `_dict_any_get_dict(...)` へ統一し、`obj -> isinstance -> 代入` 展開を削減した。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_transpiler_version_gate.py`（`cpp 0.53.0 -> 0.54.0`）を確認した。
- `P3-PY-05` の継続として `src/py2cpp.py::_meta_import_bindings`、`_meta_qualified_symbol_refs`、`build_module_east_map` の `meta` 抽出で `obj -> isinstance -> 代入` 展開を `_dict_any_get_dict(...)` へ統一した。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_transpiler_version_gate.py`（`cpp 0.52.0 -> 0.53.0`）を確認した。
- `P3-PY-05` の継続として `src/py2cpp.py` に `_dict_any_get_dict(...)` を追加し、`_write_multi_file_cpp` の `meta/import_modules/import_symbols/functions/arg_types` 読取で `obj -> isinstance -> 代入` の一時展開を削減した。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_transpiler_version_gate.py`（`cpp 0.51.0 -> 0.52.0`）を確認した。
- `P3-PY-01` の継続として `src/py2cpp.py::_graph_cycle_dfs` の `stack` 走査（`nodes` 構築）を index `while` から `for range` へ置換した（外側の `nxts` 走査は回帰履歴のため維持）。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_transpiler_version_gate.py`（`cpp 0.50.0 -> 0.51.0`）を確認した。
- `P3-PY-01` の継続として `src/py2cpp.py::_graph_cycle_dfs` の外側 `nxts` 走査を `while i < len(nxts)` から `for nxt in nxts` へ置換した。`python3 tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）と `python3 tools/check_transpiler_version_gate.py`（`cpp 0.54.0 -> 0.55.0`）は通過。`python3 tools/build_selfhost.py` は既知の selfhost parser 制約（`unsupported import clause: _modules: dict[str`）で失敗し、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `selfhost/py2cpp.out` 不在で未実施。
- `P3-PY-05` の継続として `src/py2cpp.py::_analyze_import_graph` の `resolved["path"]` 抽出を `_dict_any_get_str(...)` に統一し、`obj -> isinstance -> 代入` 展開を削減した。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_transpiler_version_gate.py`（`cpp 0.49.0 -> 0.50.0`）を確認した。
- `P3-PY-05` の継続として `src/py2cpp.py::_write_multi_file_cpp` の import symbol 解析で `sym["module"]` / `sig["return_type"]` / `arg_types[an]` 読取を `_dict_any_get_str(...)` に統一し、`obj -> isinstance -> 代入` 展開を簡潔化した。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_transpiler_version_gate.py`（`cpp 0.48.0 -> 0.49.0`）を確認した。
- `P3-PY-05` の継続として `src/py2cpp.py::_module_id_from_east_for_graph` と `_module_id_from_east` の `meta.module_id` 抽出を `_dict_any_get_str(...)` に統一し、`obj -> isinstance -> 代入` 展開を削減した。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_transpiler_version_gate.py`（`cpp 0.47.0 -> 0.48.0`）を確認した。
- `P3-PY-05` の継続として `src/py2cpp.py::build_module_east_map` と `build_module_type_schema` で `module_id/name/return_type` 抽出を `_dict_any_get_str(...)` へ統一し、`obj -> isinstance -> 代入` の一時変数展開を削減した。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_transpiler_version_gate.py`（`cpp 0.46.0 -> 0.47.0`）を確認した。
- `P3-PY-05` の継続として `src/py2cpp.py::_collect_import_modules` と `_validate_from_import_symbols_or_raise` の module/name 抽出で `obj -> isinstance -> 代入` の展開を `_dict_any_get_str(...)` 呼び出しへ統一し、一時変数を削減した。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_transpiler_version_gate.py`（`cpp 0.45.0 -> 0.46.0`）を確認した。
- `P3-PY-05` の継続として `src/py2cpp.py::_meta_import_bindings` / `_meta_qualified_symbol_refs` の `module_id/export_name/local_name/binding_kind/symbol` 抽出で、`*_obj` + 手動 `isinstance` 展開を `_dict_any_get_str(...)` へ統一し一時変数を簡潔化した。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_transpiler_version_gate.py`（`cpp 0.44.0 -> 0.45.0`）を確認した。
- `P3-PY-05` の継続として `src/py2cpp.py::dump_deps_text`（Import/ImportFrom の module/symbol/alias 読取）で `*_obj` からの手動 `isinstance` 展開を `_dict_any_get_str(...)` 呼び出しへ置換し、一時変数を簡潔化した。最初に三項演算子での簡略化を試したが selfhost C++ で `object` と文字列リテラルの型不一致回帰が出たため取り下げ、selfhost-safe 版へ差し替えた。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_transpiler_version_gate.py`（`cpp 0.43.0 -> 0.44.0`）を確認した。
- `P3-PY-05` の継続として `src/py2cpp.py::build_module_symbol_index`（`import_bindings` 未使用時の fallback）で `import_modules_obj2` / `import_symbols_obj2` の一時変数を削減し、`import_modules` / `import_symbols` への条件式代入へ簡潔化した。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_transpiler_version_gate.py`（`cpp 0.42.0 -> 0.43.0`）を確認した。
- `P3-PY-01` の継続として `src/py2cpp.py::_graph_cycle_dfs` の `nodes` 走査（`disp_nodes` 構築）を index `while` から `for range` へ置換した（index 参照は維持）。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_transpiler_version_gate.py`（`cpp 0.41.0 -> 0.42.0`）を確認した。
- `P3-PY-01` の継続として `src/py2cpp.py::CppEmitter._fallback_tuple_target_names_from_repr` の `repr_txt` 文字走査を index `while` から `for range` へ置換した（文字取得は `repr_txt[i:i+1]` を維持）。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_transpiler_version_gate.py`（`cpp 0.40.0 -> 0.41.0`）を確認した。
- `P3-PY-01` の継続として `src/py2cpp.py::_extract_function_signatures_from_python_source` の `lines` 走査（外側）と複数行 `def` 連結（内側）を index `while` から `for range` へ置換し、行スキップ制御は `skip_until` で維持した。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_transpiler_version_gate.py`（`cpp 0.39.0 -> 0.40.0`）を確認した。
- `P3-PY-01` の継続として `src/py2cpp.py::CppEmitter._render_repr_expr`（比較連鎖の `pair_parts` 組み立て）の index `while` を `for range` へ置換した（index 参照は維持）。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_transpiler_version_gate.py`（`cpp 0.38.0 -> 0.39.0`）を確認した。
- `P3-PY-01` の継続として `src/py2cpp.py::CppEmitter._collect_assigned_name_types`（Tuple 要素走査）、`CppEmitter._emit_noop_stmt`（Import/ImportFrom の `raw_names` 走査）、`CppEmitter.emit_assign`（`fallback_names` 走査）の index `while` を `for range` へ置換した（index 参照は維持）。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_transpiler_version_gate.py`（`cpp 0.37.0 -> 0.38.0`）を確認した。
- `P3-PY-01` の継続として `src/py2cpp.py::CppEmitter.transpile`（`arg_order` 走査）と `CppEmitter.render_minmax`（`arg_nodes_safe` 走査）の index `while` を `for range` へ置換した（index 参照は維持）。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_transpiler_version_gate.py`（`cpp 0.36.0 -> 0.37.0`）を確認した。
- `P3-PY-01` の継続として `src/py2cpp.py::CppEmitter._mark_mutated_param_from_target` と `CppEmitter._render_param_default_expr` の `Tuple elements` 走査を index `while` から `for range` へ置換した（index 参照は維持）。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_transpiler_version_gate.py`（`cpp 0.35.0 -> 0.36.0`）を確認した。
- `P3-PY-01` の継続として `src/py2cpp.py::CppEmitter._collect_import_cpp_includes` と `CppEmitter._seed_import_maps_from_meta` の `bindings/refs` 走査を index `while` から `for range` へ置換した（index 参照は維持）。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_transpiler_version_gate.py`（`cpp 0.34.0 -> 0.35.0`）を確認した。
- `P3-PY-01` の継続として `src/py2cpp.py::_header_guard_from_path` の `src` 走査と `_header_allows_none_default` の `parts` 走査を index `while` から `for range` へ置換した（index 参照は維持）。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_transpiler_version_gate.py`（`cpp 0.33.0 -> 0.34.0`）を確認した。
- `P3-PY-01` の継続として `src/py2cpp.py::_sort_str_list_in_place` の `items/out` 走査と `_header_render_default_expr`（Tuple 分岐）の `elements` 走査を index `while` から `for range` へ置換した（index 参照は維持）。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_transpiler_version_gate.py`（`cpp 0.32.0 -> 0.33.0`）を確認した。
- `P3-PY-01` の継続として `src/py2cpp.py::build_module_symbol_index` の `body_obj` 走査を index `while` から `for range` へ置換した（index 参照は維持）。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_transpiler_version_gate.py`（`cpp 0.31.0 -> 0.32.0`）を確認した。
- `P3-PY-01` の継続として `src/py2cpp.py::_resolve_user_module_path_for_graph` の `candidates` 走査と `_analyze_import_graph` の `mods` 走査を index `while` から `for range` へ置換した（index 参照は維持）。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_transpiler_version_gate.py`（`cpp 0.30.0 -> 0.31.0`）を確認した。
- `P3-PY-01` の継続として `src/py2cpp.py::dump_deps_text` の `body_obj` / `import_bindings` / `body` / `Import.names` 走査を index `while` から `for range` へ置換した（index 参照は維持）。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_transpiler_version_gate.py`（`cpp 0.29.0 -> 0.30.0`）を確認した。
- `P3-PY-01` の継続として `src/py2cpp.py::build_cpp_header_from_east` の `body_obj` / `body` / `arg_order` / `includes` / `class_lines` / `var_lines` / `fn_lines` 走査と、`_resolve_user_module_path` の `candidates` 走査を index `while` から `for range` へ置換した（index 参照は維持）。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_transpiler_version_gate.py`（`cpp 0.28.0 -> 0.29.0`）を確認した。
- `P3-PY-01` の継続として `src/py2cpp.py::_write_multi_file_cpp` の `files`（2箇所）と `arg_order` 走査を index `while` から `for range` へ置換した（index 参照は維持）。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_transpiler_version_gate.py`（`cpp 0.27.0 -> 0.28.0`）を確認した。
- `P3-PY-01` の継続として `src/py2cpp.py::build_module_east_map` と `build_module_type_schema` の `files` / `body_obj` / `body` 走査を index `while` から `for range` へ置換した（index 参照は維持）。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_transpiler_version_gate.py`（`cpp 0.26.0 -> 0.27.0`）を確認した。
- `P3-PY-01` の継続として `src/py2cpp.py::_module_export_table` と `_validate_from_import_symbols_or_raise` の `body` / `targets` / `names` 走査を index `while` から `for range` へ置換した（index 参照は維持）。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_transpiler_version_gate.py`（`cpp 0.25.0 -> 0.26.0`）を確認した。
- `P3-PY-01` の継続として `src/py2cpp.py::_validate_import_graph_or_raise` の `reserved` / `relative` / `missing` / `cycles` 走査を index `while` から `for range` へ置換した（index 参照は維持）。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_transpiler_version_gate.py`（`cpp 0.24.0 -> 0.25.0`）を確認した。
- `P3-PY-01` の一部として `src/py2cpp.py::_sanitize_module_label` の手動インデックス `while` を `for ch in s` へ置換した。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）と `python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）を確認。
- `P3-PY-01` の継続として `src/py2cpp.py::_path_parent_text`（区切り探索）と `_make_user_error`（details 結合）の `while` ループを `for` ベースへ置換した。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）と `python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）を確認。
- `P3-PY-01` の継続として `src/py2cpp.py::_module_tail_to_cpp_header_path`、`_parse_user_error`、`_header_guard_from_path` の手動インデックス走査を `for` ベースへ置換した。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）と `python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）を確認。
- `P3-PY-01` の継続として `src/py2cpp.py::_split_infix_once` の手動インデックス探索を `str.find` + スライスへ置換し、同一 API（`(left, right, found)`）を維持した。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）と `python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）を確認。
- `P3-PY-01` の継続として `src/py2cpp.py::_split_ws_tokens` と `_first_import_detail_line` の手動 index 走査を `for` ベースへ置換した。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）と `python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）を確認。
- `P3-PY-01` の継続として `src/py2cpp.py::_split_top_level_csv`、`_extract_function_signatures_from_python_source`（params 展開部）、`_extract_function_arg_types_from_python_source` の index `while` を `for` ベースへ置換した。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）と `python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）を確認。
- `P3-PY-01` の継続として `src/py2cpp.py::cpp_string_lit`、`_split_type_args`、`_split_top_level_union` の index `while` を `for` ベースへ置換した。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）と `python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）を確認。
- `P3-PY-01` の継続として `src/py2cpp.py::_sort_str_list_in_place`、`CppEmitter.build`（`self.lines` 結合）、`_render_append_like` の index `while` を `for` ベースへ置換した。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）と `python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）を確認。
- `P3-PY-01` の継続として `src/py2cpp.py::_coerce_args_for_module_function` と `_coerce_py_assert_args` の `args` 走査を `while` + 手動インデックスから `for enumerate` へ置換した。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）と `python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）を確認。
- `P3-PY-01` の継続として `src/py2cpp.py::_collect_mutated_params`（引数名収集）と `_allows_none_default`（union 走査）の `while` を `for` ベースへ置換した。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_transpiler_version_gate.py`（`cpp 0.13.0 -> 0.14.0`）を確認した。
- `P3-PY-01` の継続として `src/py2cpp.py::_meta_import_bindings`、`_meta_qualified_symbol_refs`、`build_module_symbol_index` の index `while` を段階的に `for` へ置換した（`build_module_symbol_index` の `body_obj` 事前正規化のみ selfhost C++ の `begin/end` 解決回帰回避のため `while` 維持）。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_transpiler_version_gate.py`（`cpp 0.15.0 -> 0.16.0`）を確認した。
- `P3-PY-01` の継続として `src/py2cpp.py::_runtime_output_rel_tail`（`module_tail` 走査）と `_header_cpp_type_from_east`（union/tuple 走査）の index `while` を `for` ベースへ置換した。`_header_allows_none_default` も同様に試行したが selfhost C++ で `list[str]` 走査が `object` 推論される回帰を確認したため当該箇所は `while` に戻した。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_transpiler_version_gate.py`（`cpp 0.17.0 -> 0.18.0`）を確認した。
- `P3-PY-01` の継続として `src/py2cpp.py::emit_function`（`arg_names` 走査）と `_merge_args_with_kw_by_name`（`args`/`arg_names` 走査）の index `while` を `for` / `enumerate` ベースへ置換した。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_transpiler_version_gate.py`（`cpp 0.18.0 -> 0.19.0`）を確認した。
- `P3-PY-01` の継続として `src/py2cpp.py::_class_method_sig` と `_class_method_name_sig` の `candidates` 走査を `while` から `for i in range(len(candidates))` へ置換した（要素型推論回帰を避けるため index ベースを維持）。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_transpiler_version_gate.py`（`cpp 0.19.0 -> 0.20.0`）を確認した。
- `P3-PY-01` の継続として `src/py2cpp.py::_fallback_tuple_target_names_from_repr` の `parts`/`nm` 走査を index `while` から `for range` ベースへ置換した（`repr_txt` の文字走査は selfhost 安定のため `while` を維持）。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_transpiler_version_gate.py`（`cpp 0.20.0 -> 0.21.0`）を確認した。
- `P3-PY-01` の継続として `src/py2cpp.py::_first_import_detail_line`、`_extract_function_signatures_from_python_source`（閉じ括弧探索）、`_extract_function_arg_types_from_python_source` の index `while` を `for range` ベースへ置換した。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_transpiler_version_gate.py`（`cpp 0.21.0 -> 0.22.0`）を確認した。
- `P3-PY-01` の継続として `src/py2cpp.py::dump_deps_text`（`names/modules/symbols` 走査）と `_collect_import_modules`（`body_obj/names_obj` 走査）の index `while` を `for range` ベースへ置換した。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_transpiler_version_gate.py`（`cpp 0.22.0 -> 0.23.0`）を確認した。
- `P3-PY-01` の継続として `src/py2cpp.py::_analyze_import_graph`（`graph_keys/keys/visited_order` 走査）、`_format_graph_list_section`（`items` 走査）、`_format_import_graph_report`（`edges` 走査）の index `while` を `for range` ベースへ置換した。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_transpiler_version_gate.py`（`cpp 0.23.0 -> 0.24.0`）を確認した。
- `P3-PY-05` の一部として `src/py2cpp.py::_meta_import_bindings`、`_meta_qualified_symbol_refs`、`build_module_symbol_index` の import メタ読取で `meta` / `binds` / `refs` / `import_*_obj2` の一時変数展開を条件式代入へ簡潔化した。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_transpiler_version_gate.py`（`cpp 0.14.0 -> 0.15.0`）を確認した。
- `P3-PY-05` の継続として `src/py2cpp.py::_render_isinstance_name_call` の `rhs` 一時変数初期化（`if len(arg_nodes) > 1`）を条件式代入へ簡潔化した。合わせて `_analyze_import_graph` / `build_module_east_map` の同系簡略化も試行したが selfhost C++ で型回帰（`east_cur` 未宣言・`meta["module_id"]` 代入型不一致）が出たため当該2箇所は元の実装へ戻した。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_transpiler_version_gate.py`（`cpp 0.16.0 -> 0.17.0`）を確認した。
- `P3-PY-03` の一部として `src/py2cpp.py::_parse_user_error`、`CppEmitter._prepare_call_parts`、`_resolve_module_name_for_graph` の段階的 dict 構築を辞書リテラル返却へ置換した。selfhost 互換維持のため `_first_import_detail_line` / `_extract_function_arg_types_from_python_source` / `_header_guard_from_path` は `for` を `while` ベースへ戻し、`_sort_str_list_in_place` はソート済みコピー返却 + 呼び出し側再代入へ調整した。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_transpiler_version_gate.py`（`cpp 0.1.0 -> 0.2.0`）を確認した。
- `P3-PY-03` の継続として `src/py2cpp.py::load_cpp_hooks`、`_analyze_import_graph`（戻り値整形部）、`resolve_module_name` の dict 段階構築を辞書リテラル返却へ置換した。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_transpiler_version_gate.py`（`cpp 0.2.0 -> 0.3.0`）を確認した。
- `P3-PY-03` の継続として `src/py2cpp.py::build_module_symbol_index` の `import_symbols` 要素生成（`module/name`）と module index 返却組み立て（`functions/classes/variables/import_*`）を辞書リテラル化した。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_transpiler_version_gate.py`（`cpp 0.3.0 -> 0.4.0`）を確認した。
- `P3-PY-03` の継続として `src/py2cpp.py::CppEmitter._seed_import_maps_from_meta` の symbol import エントリ生成（`module/name`）4箇所を辞書リテラル化した。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_transpiler_version_gate.py`（`cpp 0.4.0 -> 0.5.0`）を確認した。
- `P3-PY-03` の継続として `src/py2cpp.py::_extract_function_signatures_from_python_source`、`_meta_import_bindings`、`_meta_qualified_symbol_refs` の固定キー辞書組み立てを辞書リテラル化した。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_transpiler_version_gate.py`（`cpp 0.5.0 -> 0.6.0`）を確認した。
- `P3-PY-03` の継続として `src/py2cpp.py::CppEmitter._emit_noop_stmt`（`ImportFrom` 分岐）の import symbol エントリ生成2箇所（`module/name`）を辞書リテラル化した。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_transpiler_version_gate.py`（`cpp 0.6.0 -> 0.7.0`）を確認した。
- `P3-PY-03` の継続として `src/py2cpp.py::build_module_type_schema` の `ClassDef` 側 schema 組み立て（`field_types`）と module schema 返却組み立て（`functions/classes`）を辞書リテラル化した（`FunctionDef` 側は selfhost 安定を優先して段階代入のまま維持）。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_transpiler_version_gate.py`（`cpp 0.7.0 -> 0.8.0`）を確認した。
- `P3-PY-03` の継続として `src/py2cpp.py::_write_multi_file_cpp` の manifest module エントリ組み立て（`module/label/header/source/is_entry`）を辞書リテラル化した。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_transpiler_version_gate.py`（`cpp 0.8.0 -> 0.9.0`）を確認した。
- `P3-PY-03` の継続として `src/py2cpp.py::_write_multi_file_cpp` の manifest 初期組み立て（`entry/include_dir/src_dir`）を辞書リテラル化した。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_transpiler_version_gate.py`（`cpp 0.9.0 -> 0.10.0`）を確認した。
- `P3-PY-03` の継続として `src/py2cpp.py::_write_multi_file_cpp` の manifest 終端組み立て（`modules` 追加と戻り値 `manifest` パス付与）を辞書リテラル化し、`manifest[...]` の段階代入を削減した。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_transpiler_version_gate.py`（`cpp 0.10.0 -> 0.11.0`）を確認した。
- `P3-PY-03` の継続として `src/py2cpp.py::emit_for_each` の `RangeExpr` 分岐で擬似 `ForRange` ノード（`target/target_type/start/stop/step/range_mode/body/orelse`）の段階代入を辞書リテラル化した。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_transpiler_version_gate.py`（`cpp 0.11.0 -> 0.12.0`）を確認した。
- `P3-PY-03` の継続として `src/py2cpp.py::emit_assign`（`pseudo_target`/`rec`）、`render_expr`（`Dict` 分岐の `entries`）、`build_module_type_schema`（`fn_ent`）の固定キー辞書の段階代入を辞書リテラル化した。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`python3 tools/build_selfhost.py`（成功）、`python3 tools/check_transpiler_version_gate.py`（`cpp 0.12.0 -> 0.13.0`）を確認した。
- `P3-PY-02` の一部として `src/py2cpp.py` の `_render_set_literal_repr` で `[:1]` / `[-1:]` 比較を `startswith` / `endswith` へ戻し、同等挙動を維持した。
- `P3-PY-02` の継続として `src/py2cpp.py::_emit_target_unpack` の `list[` / `set[` / `tuple[` / `dict[` 判定をスライス比較から `startswith` / `endswith` へ置換した。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）と `python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）を確認。
- `P3-PY-02` 周辺の整理として `src/py2cpp.py` のクラス名推定2箇所（`_cpp_type_text`, `_header_cpp_type_from_east`）で `leaf[:1]` 判定を空文字チェック + `leaf[0]` 参照へ統一し、可読性を維持したままスライス依存を削減した。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）と `python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）を確認。
- `src/py2cpp.py` で `[:1]` / `[-1:]` / `[0:1]` などの1文字スライス比較パターンが検出ゼロになったため、`P3-PY-02` を完了扱いに更新した。

### `src/pytra/compiler/east_parts/code_emitter.py`

1. [x] [ID: P3-CE-01] `split_*` / `normalize_type_name` 周辺の index ループを段階的に `for` ベースへ戻す。
2. [x] [ID: P3-CE-02] `any_*` 系ヘルパで重複する `None`/空文字判定を共通小関数へ集約する。
3. [x] [ID: P3-CE-03] `_emit_trivia_items` の directive 処理分岐を小関数に分割する。
4. [x] [ID: P3-CE-04] `hook_on_*` 系で同型の呼び出しパターンを汎用ヘルパ化し、重複を減らす。

進捗メモ:
- `P3-CE-01` の一部として `src/pytra/compiler/east_parts/code_emitter.py` の `escape_string_for_literal`、`render_compare_chain_common`、`load_import_bindings_from_meta` を `for` ベースへ置換した。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）と `python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）を確認。
- `P3-CE-01` の継続として `CodeEmitter.load_profile_with_includes` の include 収集/展開ループ（`j/i`）を `for` ベースへ置換した。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）と `python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）を確認。
- `P3-CE-02` の一部として `src/pytra/compiler/east_parts/code_emitter.py` に `_is_empty_dynamic_text` を追加し、`any_dict_get_str` / `any_to_str` / `get_expr_type` / `_node_kind_from_dict` の重複した空値判定を共通化した。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）と `python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）を確認。
- `P3-CE-03` の一部として `src/pytra/compiler/east_parts/code_emitter.py` の `_emit_trivia_items` から directive/blank 処理を `_handle_comment_trivia_directive`、`_emit_passthrough_directive_line`、`_emit_blank_trivia_item` へ分離した。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）と `python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）を確認。
- `P3-CE-04` の一部として `src/pytra/compiler/east_parts/code_emitter.py` に `_lookup_hook` を追加し、`hook_on_emit_stmt` / `hook_on_emit_stmt_kind` / `hook_on_render_expr_kind` / `hook_on_render_expr_leaf` の hook 取得ロジック重複を削減した。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）と `python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）を確認。
- `P3-CE-04` の継続として `hook_on_stmt_omit_braces` / `hook_on_for_range_mode` / `hook_on_render_call` も `_lookup_hook` 経由へ統一した。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）と `python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）を確認。
- `src/pytra/compiler/east_parts/code_emitter.py` で `hook_on_*` の `if \"on_*\" in self.hooks` パターンが検出ゼロになったため、`P3-CE-04` を完了扱いに更新した。`P3-CE-03` も `_emit_trivia_items` の directive 分岐分割が完了したため完了扱いに更新した。
- `P3-CE-02` の継続として `render_name_ref` / `attr_name` に残っていた空値判定を `_is_empty_dynamic_text` へ統一し、`code_emitter.py` 内の `{\"\", \"None\", \"{}\", \"[]\"}` 直接判定を helper 定義箇所のみに集約したため、`P3-CE-02` を完了扱いに更新した。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）と `python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）を確認。
- `P3-CE-01` の継続として `render_constant_common`（bytes repr 引用符探索）の index `while` を `for enumerate` へ置換し、`code_emitter.py` から index 走査の `while i/j/k < len(...)` パターンが検出ゼロになったため、`P3-CE-01` を完了扱いに更新した。`python3 tools/check_py2cpp_transpile.py`（`checked=117 ok=117 fail=0 skipped=5`）と `python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）を確認。

### 作業ルール

1. [ ] [ID: P3-RULE-01] 1パッチで戻す範囲は 1〜3 関数に保つ。
2. [ ] [ID: P3-RULE-02] 各パッチで `python3 tools/check_py2cpp_transpile.py` を実行する。
3. [ ] [ID: P3-RULE-03] 各パッチで `python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` を実行する。
4. [ ] [ID: P3-RULE-04] 回帰が出た場合は「可読性改善より selfhost 安定」を優先する。

## P3: spec 草案整理（低優先）

文脈: `docs-jp/plans/p3-spec-drafts.md`（`TG-P3-SPEC-DRAFTS`）

1. [x] [ID: P3-SD-01] `docs-jp/spec/spec-make.md` の仕様案を実装現状と照合し、採用する項目を既存仕様へ段階移管する。
2. [x] [ID: P3-SD-02] `docs-jp/spec/spec-template.md` の仕様案を実装現状と照合し、採用/保留/非採用の区分を明確化する。

進捗メモ:
- `P3-SD-01`: `spec-make.md` と実装実体（`src/pytra/compiler/transpile_cli.py`, `src/py2cpp.py`, `tools/build_multi_cpp.py`）を照合し、採用済みの multi-file `manifest.json` 契約と build 導線を `docs-jp/spec/spec-dev.md` / `docs-jp/spec/spec-tools.md` へ移管した。未実装の `./pytra --build` / `src/pytra/cli.py` / `tools/gen_makefile_from_manifest.py` は草案維持として `docs-jp/spec/spec-make.md` と `docs-jp/plans/p3-spec-drafts.md` に明記した。
- `P3-SD-02`: `spec-template.md` と実装実体（`src/pytra/std/typing.py`, `src/pytra/compiler/east_parts/core.py`, `src/pytra/compiler/east_parts/code_emitter.py`）を照合し、採用/保留/非採用を区分した。採用項目は `TypeVar` 最小 shim のみとして `docs-jp/spec/spec-pylib-modules.md` へ移管し、`spec-template.md` の「採用」断定表現は「候補」へ修正した。

## P3: サンプル実行時間の再計測とREADME更新（低優先）

文脈: `docs-jp/plans/p3-sample-benchmark-refresh.md`（`TG-P3-SAMPLE-BENCHMARK`）

1. [ ] [ID: P3-SB-01] サンプルコード変更（実行時間変化）、サンプル番号再編（04/15/17/18）、サンプル数増加（01〜18）を反映するため、全ターゲット言語（Python/C++/Rust/C#/JS/TS/Go/Java/Swift/Kotlin）で実行時間を再計測し、トップページの `readme.md` / `readme-jp.md` の比較表を同一データで更新する。

## メモ

- このファイルは未完了タスクのみを保持します。
- 完了済みタスクは `docs-jp/todo-history/index.md` 経由で履歴へ移動します。
- `docs-jp/todo-history/index.md` は索引のみを保持し、履歴本文は `docs-jp/todo-history/YYYYMMDD.md` に日付単位で保存します。
