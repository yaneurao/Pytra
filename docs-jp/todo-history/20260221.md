# TODO履歴（2026-02-21）

<a href="../../docs/todo-history/20260221.md">
  <img alt="Read in English" src="https://img.shields.io/badge/docs-English-2563EB?style=flat-square">
</a>

## 2026-02-21 完了: CodeEmitter / Hooks 移管タスク一式（docs-jp/todo.md から移管）

1. [x] P1 `CodeEmitter / Hooks` 移管（hook 注入・helper 抽出・profile/hook 優先化）を完了。
2. [x] P1 `py2cpp` 縮退（`render_expr/emit_stmt/Call` 分岐の helper 化・重複削減）を完了。
3. [x] P2 Any/object 境界の整理（過剰 boxing 抑制・既定値型整理・`std::any` 依存縮退）を完了。
4. [x] P3 低優先の可読性改善（Python らしい記述への戻し）を完了。
5. [x] 共通ディスパッチ再設計の最終段として、`on_render_expr_leaf` / `on_render_expr_complex` / `on_emit_stmt_kind` の注入点拡張を完了。
   - [x] `JoinedStr/Lambda` を complex hook 経路へ追加。
   - [x] `Expr/Return/Import/ImportFrom/Pass/Break/Continue` を stmt-kind hook 先行処理へ追加。
   - [x] selfhost 差分検証（`mismatches=0`）を維持。

## 2026-02-21 完了: selfhost スタブ整理（multi-file 完了）

1. [x] `tools/prepare_selfhost_source.py` の selfhost 専用スタブ整理（P0）を完了した。
   - [x] `load_cpp_hooks` スタブを除去し、`build_cpp_hooks` の selfhost 最小実装（空 dict）を support block へ追加した。
   - [x] import-graph 系スタブ（`_analyze_import_graph`）を除去し、実装側を selfhost-safe に置換した。
   - [x] `_extract_function_arg_types_from_python_source` スタブを除去し、本実装を selfhost-safe に修正した。
   - [x] multi-file 系スタブ（`_write_multi_file_cpp`）を除去し、`tools/prepare_selfhost_source.py` 側の置換処理自体も削除した。
2. [x] `_write_multi_file_cpp` の selfhost 崩れを修正した。
   - [x] `_inject_after_includes` をトップレベル helper（`_inject_after_includes_block`）へ分離した。
   - [x] `prelude_txt` / `hdr_text` の multi-line 連結を段階的 `+=` に置換した。
   - [x] `dict.keys()` / dict 値アクセス由来の `object` 化を避けるため、`items()` の型付き収集 + 明示 `if` 代入へ置換した。
   - [x] manifest 生成を `append(dict literal)` から明示エントリ構築に置換し、`json.dumps` 呼び出し前の boxing 崩れを回避した。
   - [x] `Path.mkdir` / `Path.write_text` 呼び出しを selfhost-safe helper（`_mkdirs_for_cli` / `_write_text_file`）へ統一した。
3. [x] 回帰検証を green で確認した。
   - [x] `python3 tools/build_selfhost.py`
   - [x] `python3 tools/build_selfhost_stage2.py --skip-stage1-build`
   - [x] `python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`
   - [x] `python3 tools/check_selfhost_stage2_cpp_diff.py --skip-build --mode allow-not-implemented`
   - [x] `python3 tools/check_py2cpp_transpile.py`（`checked=108 ok=108 fail=0 skipped=5`）

## 2026-02-21 完了: selfhost stage2 実行導線と差分検証の安定化

1. [x] selfhost `.py` 経路の段階回復を完了した。
   - [x] `tools/build_selfhost.py` から手動 `main()` パッチ処理を削除し、生成コードそのままで `selfhost/py2cpp.out` を生成できるようにした。
   - [x] `tools/prepare_selfhost_source.py` の末尾 main-guard 置換を調整し、`selfhost/py2cpp.py` から `main()` 呼び出しが保持されるようにした。
2. [x] 2段自己変換バイナリ（`selfhost/py2cpp_stage2.out`）の最小実行パスを安定化した。
   - [x] `tools/build_selfhost_stage2.py` を追加し、`selfhost -> selfhost_selfhost` のビルド導線を自動化した。
   - [x] `python3 tools/verify_selfhost_end_to_end.py --skip-build --selfhost-bin selfhost/py2cpp_stage2.out` で `failures=0` を確認した。
3. [x] 2段自己変換バイナリの出力差分（`make_object` 揺れ）を解消した。
   - [x] `src/py2cpp.py` に `_coerce_py_assert_args` を追加し、`py_assert_*` 呼び出しで object 引数 boxing を経路依存なく統一した。
   - [x] `python3 tools/check_selfhost_stage2_cpp_diff.py --skip-build --mode allow-not-implemented` で `mismatches=0 skipped=0` を確認した。
4. [x] `selfhost_selfhost` 向けの自動差分検証導線を追加した。
   - [x] `tools/check_selfhost_stage2_cpp_diff.py` を追加（`check_selfhost_cpp_diff.py` ラッパ）。
   - [x] `tools/run_local_ci.py` に stage2 差分検証ステップを追加した。
5. [x] selfhost 差分検証の失敗時にトレースバックで落ちないよう改善した。
   - [x] `tools/check_selfhost_cpp_diff.py` で「selfhost 出力ファイル未生成」を `FAIL selfhost` として扱うガードを追加した。
6. [x] `run_local_ci.py` の selfhost 差分チェック対象を既定ケース（8件）へ拡張した。
   - [x] `tools/check_selfhost_cpp_diff.py` の `--cases` 指定を外し、既定ケースで実行するようにした。
   - [x] `tools/check_selfhost_stage2_cpp_diff.py` も同様に既定ケースで実行するようにした。
7. [x] `tools/prepare_selfhost_source.py` の `load_cpp_profile` スタブを解除した。
   - [x] `src/py2cpp.py` の `load_cpp_profile()` を selfhost で壊れない形（`raw_obj` 先行宣言）へ調整した。
   - [x] `python3 tools/build_selfhost.py` / `python3 tools/build_selfhost_stage2.py --skip-stage1-build` / 差分チェック2系統で回帰なしを確認した。
8. [x] `tools/prepare_selfhost_source.py` の `load_cpp_module_attr_call_map` スタブを解除した。
   - [x] `src/py2cpp.py` の `load_cpp_module_attr_call_map()` シグネチャを `dict[str, Any]` 既定値形式に揃え、selfhost 2段変換で `optional.get` 崩れを回避した。
   - [x] `python3 tools/build_selfhost.py` / `python3 tools/build_selfhost_stage2.py --skip-stage1-build` / 差分チェック2系統で回帰なしを確認した。
9. [x] `tools/prepare_selfhost_source.py` の import メタ系スタブを解除した。
   - [x] `_meta_import_bindings` / `_meta_qualified_symbol_refs` / `dump_deps_text` / `_collect_import_modules` の selfhost スタブ置換を削除した。
   - [x] `src/py2cpp.py` 側で `object -> str` の三項演算子を明示 `if` 代入へ置換し、stage2 C++ の型崩れを解消した。
   - [x] `python3 tools/build_selfhost.py` / `python3 tools/build_selfhost_stage2.py --skip-stage1-build` / 差分チェック2系統で回帰なしを確認した。

## 2026-02-21 完了: selfhost スタブ整理（追加）

1. [x] `build_cpp_header_from_east` で使用するヘッダ補助関数の selfhost 崩れを解消した。
   - [x] `src/py2cpp.py` の `_header_cpp_type_from_east` を `None` 既定値依存から外し、set 引数を必須化した。
   - [x] `src/py2cpp.py` の `_header_guard_from_path` を文字列入力化し、`Path -> str` 変換時の overload 曖昧性を回避した。
2. [x] `tools/prepare_selfhost_source.py` で以下スタブを除去した。
   - [x] `_resolve_user_module_path`
   - [x] `_module_name_from_path`
   - [x] `build_module_symbol_index`
   - [x] `build_module_type_schema`
   - [x] `build_cpp_header_from_east`
   - [x] `build_module_east_map`
3. [x] selfhost 安全化のために import 解決補助実装を修正した。
   - [x] `src/py2cpp.py` の `_resolve_user_module_path` を `Path | None` から「未解決は `Path(\"\")`」に変更した。
   - [x] `src/py2cpp.py` の `_resolve_user_module_path` で `Path / "..."` 依存を外し、文字列結合 + `Path(...)` へ変更した。
   - [x] `src/py2cpp.py` の `_module_export_table` / `_validate_from_import_symbols_or_raise` を `list[dict]` 固定 + helper 経由参照へ置換した。
   - [x] `src/py2cpp.py` の `build_module_east_map` で `entry_path.parent` 依存を外し、`Path(_path_parent_text(...))` へ置換した。
4. [x] `build_module_symbol_index` / `build_module_type_schema` を selfhost 安全な代入形式へリライトした。
   - [x] 三項演算子・dict リテラル初期化を明示代入へ置換した。
   - [x] `dict.get(...)` の直接参照を `_dict_any_get_str` など補助関数経由に寄せた。
5. [x] 回帰検証を実施した。
   - [x] `python3 tools/build_selfhost.py`
   - [x] `python3 tools/build_selfhost_stage2.py --skip-stage1-build`
   - [x] `python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`
   - [x] `python3 tools/check_selfhost_stage2_cpp_diff.py --skip-build --mode allow-not-implemented`
   - [x] `python3 tools/check_py2cpp_transpile.py`（`checked=108 ok=108 fail=0 skipped=5`）

## 2026-02-21 完了: selfhost スタブ整理（load_cpp_hooks）

1. [x] `tools/prepare_selfhost_source.py` から `load_cpp_hooks` 専用スタブを削除した。
   - [x] `support_blocks` に `build_cpp_hooks()` の selfhost 最小実装（空 dict 返却）を追加し、`load_cpp_hooks` が未定義参照にならないようにした。
2. [x] import-graph 補助の selfhost 安全化を部分適用した。
   - [x] `src/py2cpp.py` の `_graph_cycle_dfs` で `list + list` 連結を明示 append へ置換した。
   - [x] `src/py2cpp.py` の `_validate_import_graph_or_raise` で `str.find` 前に明示 `str(...)` 変換を入れ、object 型崩れを回避した。
   - [x] `tools/prepare_selfhost_source.py` で `_format_import_graph_report` のスタブ置換を除去し、selfhost 側で実実装を使うようにした（`_format_graph_list_section` は同時に同梱）。
   - [x] `tools/prepare_selfhost_source.py` から `_analyze_import_graph` スタブ置換を除去した。
   - [x] `src/py2cpp.py` の `_analyze_import_graph` を selfhost-safe にリライト（`resolve_module_name` 依存除去、`set/dict` 走査の型崩れ回避）。
3. [x] `tools/prepare_selfhost_source.py` で `_extract_function_arg_types_from_python_source` スタブを除去した。
   - [x] `src/py2cpp.py` の `_extract_function_signatures_from_python_source` を selfhost 変換で壊れにくい実装へ修正（変数衝突回避、明示初期化）。
   - [x] `src/py2cpp.py` の `_extract_function_arg_types_from_python_source` を `dict.keys()` 反復の型崩れに耐える形へ修正。
4. [x] multi-file スタブ除去の前段として parser 非対応要素を整理した。
   - [x] `src/py2cpp.py` の `_write_multi_file_cpp` 内ネスト関数 `_inject_after_includes` をトップレベル helper (`_inject_after_includes_block`) へ移動した。
   - [x] `src/py2cpp.py` の `prelude_txt` / `hdr_text` を multi-line literal 連結から逐次 `+=` へ変更した。
5. [x] 回帰検証を実施した。
   - [x] `python3 tools/build_selfhost.py`
   - [x] `python3 tools/build_selfhost_stage2.py --skip-stage1-build`
   - [x] `python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`
   - [x] `python3 tools/check_selfhost_stage2_cpp_diff.py --skip-build --mode allow-not-implemented`
   - [x] `python3 tools/check_py2cpp_transpile.py`（`checked=108 ok=108 fail=0 skipped=5`）

## 2026-02-21 完了: selfhost 直変換 Compare 崩れ補正

1. [x] selfhost 直変換で `in/not in` 比較が生の `k in d` へ崩れる回帰を修正した。
   - [x] `src/py2cpp.py` に `repr` 由来の式補正（`in/not in`, `len`, `isinstance`, `slice`, `and/or/not`）を追加した。
   - [x] `src/py2cpp.py` の `runtime_owner` 欠落補正を追加し、`py_replace` / `std::filesystem::exists` などの owner 引数脱落を復旧した。
2. [x] selfhost 差分検証を再度 green 化した。
   - [x] `python3 tools/check_selfhost_cpp_diff.py --selfhost-driver direct` で `mismatches=0` を確認。
3. [x] 通常トランスパイルの回帰確認を実施した。
   - [x] `python3 tools/check_py2cpp_transpile.py` で `checked=108 ok=108 fail=0 skipped=5` を確認。
4. [x] selfhost 2段自己変換の先頭エラー群（`len(...)` 未解決）を解消する下地を追加した。
   - [x] `src/runtime/cpp/pytra/built_in/py_runtime.h` に `len(...) -> py_len(...)` 互換エイリアスを追加した。
   - [x] `src/runtime/cpp/pytra/built_in/py_runtime.h` に `object` と `std::nullopt` の比較演算子を追加した。

## 2026-02-21 完了: selfhost 2段自己変換の先頭クラスタ解消

1. [x] 2段自己変換の先頭エラー群（連鎖比較 / slice / `or/not/in` 生残り）を解消した。
   - [x] `src/pytra/compiler/east_parts/code_emitter.py` で selfhost 崩れしやすい判定式（chain compare, `t[:N]`）を `startswith` / 明示比較へ置換した。
   - [x] `src/py2cpp.py` に `render_cond` 上書きと repr 補正強化（chain compare, `is True/False`, slice）を追加した。
2. [x] `selfhost/py2cpp.out` が生成する `selfhost_selfhost.cpp` の `g++` コンパイルを green 化した。
   - [x] `dict.get(..., "literal")` 崩れを避けるため、`src/py2cpp.py` の `dict[str, Any]` 参照を `_dict_any_get_*` 系へ寄せた。
   - [x] `list.sort()` 崩れを避けるため、`src/py2cpp.py` に `_sort_str_list_in_place` を追加し、`sort()` 呼び出しを置換した。
   - [x] `src/runtime/cpp/pytra/built_in/list.h` に `list.sort()` を追加した。
3. [x] selfhost 実行時クラッシュ要因を縮退した。
   - [x] `src/runtime/cpp/pytra/built_in/dict.h` の `dict.get(key)` を Python 互換（missing で既定値返却）へ調整した。

## 2026-02-21 完了: selfhost 直変換の型正規化回帰修正

1. [x] selfhost 直変換で `list[int]` が `list<int>` と出力される回帰を修正した。
   - [x] `src/pytra/compiler/east_parts/core.py` の `_sh_ann_to_type` から正規表現依存を除去し、汎用のブラケット分解ロジックへ置換した。
   - [x] `src/runtime/cpp/pytra/compiler/east_parts/core.cpp` の同ロジックも同期修正した（`re` マッチ不要化）。
   - [x] `tools/prepare_selfhost_source.py` で `_normalize_param_annotation` の selfhost 専用 no-op 置換を削除し、本実装を使うようにした。
2. [x] selfhost 差分検証を green 化した。
   - [x] `python3 tools/check_selfhost_cpp_diff.py --selfhost-driver direct` で `mismatches=0` を確認。
3. [x] selfhost E2E 検証を追加・確認した。
   - [x] `tools/verify_selfhost_end_to_end.py` を追加（`.py -> selfhost変換 -> C++コンパイル -> 実行 -> Python標準出力比較`）。
   - [x] `python3 tools/verify_selfhost_end_to_end.py --skip-build` で `failures=0` を確認。
4. [x] selfhost 直変換で `sep.join(items)` が `py_join(items)` に崩れる回帰を修正した。
   - [x] `src/pytra/compiler/east_parts/core.py` / `src/runtime/cpp/pytra/compiler/east_parts/core.cpp` で `runtime_owner` を保持するようにした。
   - [x] `src/py2cpp.py` の `runtime_call == "py_join"` 分岐で `runtime_owner` を優先利用するようにした。
   - [x] `test/fixtures/core/str_join_method.py` を追加し、`tools/check_selfhost_cpp_diff.py` / `tools/verify_selfhost_end_to_end.py` の既定ケースへ組み込んだ。

## 2026-02-21 完了: py2cpp Call 分岐の hook 移管

1. [x] `dict.get/list.* / set.*` 呼び出し解決を `src/py2cpp.py` の直書き分岐から `src/hooks/cpp/hooks/cpp_hooks.py` の runtime-call hook 側へ移し、`py2cpp.py` のハードコードを削減した。

## 2026-02-21 完了: パススルー記法

1. [x] トランスパイル時パススルー記法（`# Pytra::cpp` / `# Pytra::pass`）の仕様化と最小実装を完了した。
   - [x] 仕様: 適用位置、インデント維持、複数ブロック連結、既存 docstring コメント変換との優先順位を `docs-jp/spec-east.md` に明記。
   - [x] 実装: EAST 保持形式（`leading_trivia` の comment text 利用）を定義し、C++ エミッタでそのまま展開できる最小経路を追加した。
   - [x] 受け入れ条件: 最小 fixture（`test/fixtures/core/pass_through_comment.py`）で Python 実行に影響を与えず、C++ 出力に意図した行が入ることを unit test で確認。

## 移管: 2026-02-21（todo.md 再整理前スナップショット）

> 再整理前の docs-jp/todo.md 原本を退避。完了済みタスクの履歴を保持するために移管。

# TODO（未完了のみ）
