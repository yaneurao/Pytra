# TASK GROUP: TG-P1-COMP-SHARED

最終更新: 2026-02-23

関連 TODO:
- `docs-jp/todo.md` の `ID: P1-COMP-01` 〜 `P1-COMP-10`

背景:
- import グラフ解析や module index 構築など全言語共通処理が `py2cpp.py` に偏在している。
- 将来的な目標は「全言語で selfhost 可能な変換能力」であり、特定言語実装（`py2cpp.py`）への汎用処理偏在は拡張時のボトルネックになる。

目的:
- 共通解析を `src/pytra/compiler/` の API へ抽出し、各 `py2*` CLI で再利用可能にする。
- `py2cpp.py` は C++ 固有責務へ限定し、他言語 selfhost 導線でも再利用できる共通実装を優先する。

対象:
- import グラフ解析
- module EAST map / symbol index / type schema 構築
- deps dump API
- `CodeEmitter` と parser の責務境界明文化

非対象:
- 言語固有のコード生成最適化
- runtime 出力形式の変更

受け入れ基準:
- 共通解析 API が `py2cpp` 以外から利用可能
- `py2cpp.py` は C++ 固有責務中心に縮退
- 境界定義（CodeEmitter / parser / compiler共通層）が文書化される
- `py2cpp.py` 由来の汎用 helper が `src/pytra/compiler/` へ移管され、少なくとも 1 つ以上の非 C++ `py2*` で再利用される
- 新規の汎用処理は `py2cpp.py` ではなく共通層へ追加する運用ルールが定義され、回帰チェックで担保される

確認コマンド:
- `python3 tools/check_py2cpp_transpile.py`
- `python3 test/unit/test_py2cpp_features.py`

`P1-COMP-08` 移行計画（他言語 CLI の共通解析 API 採用）:

1. Phase 0（API 固定化）
   - `src/pytra/compiler/` に共通解析 API の入口を定義する。
   - 最低限の提供単位は `import_graph` / `module_east_map` / `symbol_index` / `type_schema` / `deps_dump` とする。
   - CLI から見える戻り値型（dict スキーマ）を固定し、`py2cpp` 実装を参照実装として扱う。
2. Phase 1（`py2rs.py` 先行適用）
   - `py2rs.py` から `py2cpp.py` 固有 helper 直呼びを禁止し、共通 API 経由で module 解析結果を受け取る。
   - 既存出力との差分を `tools/check_py2rs_transpile.py` で確認する。
3. Phase 2（`py2cs.py` / `py2js.py` / `py2ts.py` へ展開）
   - 3 言語の CLI で同一 API を使い、import 解決の前段を共通化する。
   - `meta.import_bindings` 利用前の解析処理（FS 依存部分）を共通層へ移す。
4. Phase 3（preview 言語 `py2go.py` / `py2java.py` / `py2swift.py` / `py2kotlin.py` へ展開）
   - 失敗時の診断形式（解析失敗 / 変換失敗）を共通化し、言語別 CLI は表示責務に限定する。
   - 各 `tools/check_py2<lang>_transpile.py` が同一前処理 API を使う状態まで寄せる。
5. Phase 4（旧経路の縮退）
   - `py2cpp.py` を含む各 CLI から重複した project 解析コードを削除する。
   - 共通 API 層に回帰テストを追加し、CLI 層は配線テスト中心へ移行する。

完了条件:
- 非 C++ の各 CLI が、project 解析を `src/pytra/compiler/` 共通 API 経由で実行する。
- `py2cpp.py` 側に残る project 解析実装は C++ 固有補助を除き撤去される。
- 既存の transpile チェック（`tools/check_py2*.py`）が回帰なく通過する。

決定ログ:
- 2026-02-22: 初版作成。
- 2026-02-22: `P1-COMP-06` / `P1-COMP-07` として、`docs-jp/spec/spec-dev.md` に `CodeEmitter`・EAST parser・compiler共通層の責務境界を明文化した。
- 2026-02-22: `P1-COMP-08` として、`py2rs.py` を起点に他言語 CLI へ共通解析 API を段階適用する 5 フェーズ移行計画を追加した。
- 2026-02-23: 全言語 selfhost を長期目標として再確認し、`py2cpp.py` への汎用 helper 集積を抑制する方針を `P1-COMP-09` / `P1-COMP-10` として追加した。
- 2026-02-23: `P1-COMP-09` の小パッチとして、`src/py2cpp.py` の文字列リスト整列 helper を `src/pytra/compiler/transpile_cli.py::sort_str_list_copy` へ移管した。selfhost 展開で同 helper が欠落しないよう `tools/prepare_selfhost_source.py` の `transpile_cli` import 除去対象と support block 抽出名リストを更新し、`test/unit/test_prepare_selfhost_source.py` / `test/unit/test_py2cpp_features.py` で回帰を固定した。
- 2026-02-23: `P1-COMP-09` の継続として、`src/py2cpp.py` の区切り結合 helper `_join_str_list` も `src/pytra/compiler/transpile_cli.py::join_str_list` へ移管した。`py2cpp` 内の呼び出しを共通 helper へ統一し、selfhost 用 `tools/prepare_selfhost_source.py` の `transpile_cli` import 除去ターゲットと support block 抽出対象へ `join_str_list` を追加した。`test/unit/test_prepare_selfhost_source.py` と `test/unit/test_py2cpp_features.py` の回帰を更新して固定した。
- 2026-02-23: `P1-COMP-09` の継続として、`src/py2cpp.py` の区切り分割 helper `_split_infix_once` も `src/pytra/compiler/transpile_cli.py::split_infix_once` へ移管した。`py2cpp` 側の呼び出しを共通 helper 経由へ統一し、selfhost 用 `tools/prepare_selfhost_source.py` の `transpile_cli` import 除去ターゲットと support block 抽出対象へ `split_infix_once` を追加した。`test/unit/test_prepare_selfhost_source.py` と `test/unit/test_py2cpp_features.py` の回帰を更新して固定した。
- 2026-02-23: `P1-COMP-09` の継続として、`src/py2cpp.py` の単発文字列置換 helper `_replace_first` も `src/pytra/compiler/transpile_cli.py::replace_first` へ移管した。`py2cpp` 側の include 注入系処理は共通 helper 呼び出しへ統一し、selfhost 用 `tools/prepare_selfhost_source.py` の `transpile_cli` import 除去ターゲットと support block 抽出対象へ `replace_first` を追加した。`test/unit/test_prepare_selfhost_source.py` と `test/unit/test_py2cpp_features.py` の回帰を更新して固定した。
- 2026-02-23: `P1-COMP-09` の継続として、`src/py2cpp.py` の親ディレクトリ解決 helper `_path_parent_text` も `src/pytra/compiler/transpile_cli.py::path_parent_text` へ移管した。`py2cpp` 側の呼び出し（import graph / multi-file 出力 / CLI 出力先の親ディレクトリ解決）を共通 helper 経由へ統一し、selfhost 用 `tools/prepare_selfhost_source.py` の `transpile_cli` import 除去ターゲットと support block 抽出対象へ `path_parent_text` を追加した。`test/unit/test_prepare_selfhost_source.py` と `test/unit/test_py2cpp_features.py` の回帰を更新して固定した。
- 2026-02-23: `P1-COMP-09` の継続として、`src/py2cpp.py` のディレクトリ生成 helper `_mkdirs_for_cli` も `src/pytra/compiler/transpile_cli.py::mkdirs_for_cli` へ移管した。`py2cpp` 側の出力前ディレクトリ作成処理を共通 helper 経由へ統一し、selfhost 用 `tools/prepare_selfhost_source.py` の `transpile_cli` import 除去ターゲットと support block 抽出対象へ `mkdirs_for_cli` を追加した。`test/unit/test_prepare_selfhost_source.py` と `test/unit/test_py2cpp_features.py` の回帰を更新して固定した。
- 2026-02-23: `P1-COMP-09` の継続として、`src/py2cpp.py` のテキスト書き出し helper `_write_text_file` も `src/pytra/compiler/transpile_cli.py::write_text_file` へ移管した。`py2cpp` 側の出力処理（multi-file prelude/manifest、runtime/header、`-o/--dump-*`）を共通 helper 経由へ統一し、selfhost 用 `tools/prepare_selfhost_source.py` の `transpile_cli` import 除去ターゲットと support block 抽出対象へ `write_text_file` を追加した。`test/unit/test_prepare_selfhost_source.py` と `test/unit/test_py2cpp_features.py` の回帰を更新して固定した。
- 2026-02-23: `P1-COMP-09` の継続として、`src/py2cpp.py` の行数集計 helper `_count_text_lines` も `src/pytra/compiler/transpile_cli.py::count_text_lines` へ移管した。`py2cpp` 側の `max_generated_lines` ガード集計を共通 helper 経由へ統一し、selfhost 用 `tools/prepare_selfhost_source.py` の `transpile_cli` import 除去ターゲットと support block 抽出対象へ `count_text_lines` を追加した。`test/unit/test_prepare_selfhost_source.py` と `test/unit/test_py2cpp_features.py` の回帰を更新して固定した。
- 2026-02-23: `P1-COMP-09` の継続として、`src/py2cpp.py` の空白トークン分割 helper `_split_ws_tokens` も `src/pytra/compiler/transpile_cli.py::split_ws_tokens` へ移管した。`py2cpp` 側の import エラー詳細抽出（`from/import` 行トークン化）を共通 helper 経由へ統一し、selfhost 用 `tools/prepare_selfhost_source.py` の `transpile_cli` import 除去ターゲットと support block 抽出対象へ `split_ws_tokens` を追加した。`test/unit/test_prepare_selfhost_source.py` と `test/unit/test_py2cpp_features.py` の回帰を更新して固定した。
- 2026-02-23: `P1-COMP-09` の継続として、`src/py2cpp.py` の重複排除追加 helper `_append_unique_non_empty` も `src/pytra/compiler/transpile_cli.py::append_unique_non_empty` へ移管した。`py2cpp` 側の include/module/symbol/import graph 収集で同 helper 呼び出しを共通 helper 経由へ統一し、selfhost 用 `tools/prepare_selfhost_source.py` の `transpile_cli` import 除去ターゲットと support block 抽出対象へ `append_unique_non_empty` を追加した。`test/unit/test_prepare_selfhost_source.py` と `test/unit/test_py2cpp_features.py` の回帰を更新して固定した。
- 2026-02-23: `P1-COMP-09` の継続として、`src/py2cpp.py` のトップレベル CSV 分割 helper `_split_top_level_csv` も `src/pytra/compiler/transpile_cli.py::split_top_level_csv` へ移管した。`py2cpp` 側の関数シグネチャ抽出・`TypeVar`/`Union` 解析で同 helper 呼び出しを共通 helper 経由へ統一し、selfhost 用 `tools/prepare_selfhost_source.py` の `transpile_cli` import 除去ターゲットと support block 抽出対象へ `split_top_level_csv` を追加した。`test/unit/test_prepare_selfhost_source.py` と `test/unit/test_py2cpp_features.py` の回帰を更新して固定した。
- 2026-02-23: `P1-COMP-09` の継続として、`src/py2cpp.py` の辞書既定値取得 helper `_dict_str_get` も `src/pytra/compiler/transpile_cli.py::dict_str_get` へ移管した。`py2cpp` 側の CLI 解析結果 `dict[str, str]` 読取を共通 helper 経由へ統一し、selfhost 用 `tools/prepare_selfhost_source.py` の `transpile_cli` import 除去ターゲットと support block 抽出対象へ `dict_str_get` を追加した。`test/unit/test_prepare_selfhost_source.py` と `test/unit/test_py2cpp_features.py` の回帰を更新して固定した。
- 2026-02-23: `P1-COMP-09` の継続として、`src/py2cpp.py` の runtime 関数名判定 helper `_looks_like_runtime_function_name` も `src/pytra/compiler/transpile_cli.py::looks_like_runtime_function_name` へ移管した。`py2cpp` 側の module attr call map 判定を共通 helper 経由へ統一し、selfhost 用 `tools/prepare_selfhost_source.py` の `transpile_cli` import 除去ターゲットと support block 抽出対象へ `looks_like_runtime_function_name` を追加した。`test/unit/test_prepare_selfhost_source.py` と `test/unit/test_py2cpp_features.py` の回帰を更新して固定した。
- 2026-02-23: `P1-COMP-09` の継続として、`src/py2cpp.py` の import ローカル束縛名 helper `_local_binding_name` も `src/pytra/compiler/transpile_cli.py::local_binding_name` へ移管した。`py2cpp` 側の import/import-from 解析を共通 helper 経由へ統一し、selfhost 用 `tools/prepare_selfhost_source.py` の `transpile_cli` import 除去ターゲットと support block 抽出対象へ `local_binding_name` を追加した。`test/unit/test_prepare_selfhost_source.py` と `test/unit/test_py2cpp_features.py` の回帰を更新して固定した。
- 2026-02-23: `P1-COMP-09` の継続として、`src/py2cpp.py` の import graph issue 分解 helper `_split_graph_issue_entry` も `src/pytra/compiler/transpile_cli.py::split_graph_issue_entry` へ移管した。`py2cpp` 側の `file: module` 解析を共通 helper 経由へ統一し、selfhost 用 `tools/prepare_selfhost_source.py` の `transpile_cli` import 除去ターゲットと support block 抽出対象へ `split_graph_issue_entry` を追加した。`test/unit/test_prepare_selfhost_source.py` と `test/unit/test_py2cpp_features.py` の回帰を更新して固定した。
- 2026-02-23: `P1-COMP-09` の継続として、`src/py2cpp.py` の型引数分割 helper `_split_type_args` も `src/pytra/compiler/transpile_cli.py::split_type_args` へ移管した。`py2cpp` 側の header 型 lower（`list[...]` / `dict[...]`）を共通 helper 経由へ統一し、selfhost 用 `tools/prepare_selfhost_source.py` の `transpile_cli` import 除去ターゲットと support block 抽出対象へ `split_type_args` を追加した。`test/unit/test_prepare_selfhost_source.py` と `test/unit/test_py2cpp_features.py` の回帰を更新して固定した。
- 2026-02-23: `P1-COMP-09` の継続として、`src/py2cpp.py` の Union 分割 helper `_split_top_level_union` も `src/pytra/compiler/transpile_cli.py::split_top_level_union` へ移管した。`py2cpp` 側の header 型 lower（Union 解析）を共通 helper 経由へ統一し、selfhost 用 `tools/prepare_selfhost_source.py` の `transpile_cli` import 除去ターゲットと support block 抽出対象へ `split_top_level_union` を追加した。`test/unit/test_prepare_selfhost_source.py` と `test/unit/test_py2cpp_features.py` の回帰を更新して固定した。
- 2026-02-23: `P1-COMP-09` の継続として、`src/py2cpp.py` の `pytra.*` 判定 helper `_is_pytra_module_name` も `src/pytra/compiler/transpile_cli.py::is_pytra_module_name` へ移管した。`py2cpp` 側の import 解決判定を共通 helper 経由へ統一し、selfhost 用 `tools/prepare_selfhost_source.py` の `transpile_cli` import 除去ターゲットと support block 抽出対象へ `is_pytra_module_name` を追加した。`test/unit/test_prepare_selfhost_source.py` と `test/unit/test_py2cpp_features.py` の回帰を更新して固定した。
- 2026-02-23: `P1-COMP-09` の継続として、`src/py2cpp.py` の import graph パス helper `_path_key_for_graph` / `_rel_disp_for_graph` も `src/pytra/compiler/transpile_cli.py::{path_key_for_graph, rel_disp_for_graph}` へ移管した。`py2cpp` 側の呼び出し（`_analyze_import_graph` と from-import 診断）を共通 helper 経由へ統一し、selfhost 用 `tools/prepare_selfhost_source.py` の `transpile_cli` import 除去ターゲットと support block 抽出対象へ両 helper を追加した。`test/unit/test_prepare_selfhost_source.py` と `test/unit/test_py2cpp_features.py` の回帰を更新して固定した。
- 2026-02-23: `P1-COMP-09` の継続として、`src/py2cpp.py` の import graph module_id フォールバック helper `_module_name_from_path_for_graph` も `src/pytra/compiler/transpile_cli.py::module_name_from_path_for_graph` へ移管した。`py2cpp` 側の呼び出し（`_module_id_from_east_for_graph` と import graph module_id 補完）を共通 helper 経由へ統一し、selfhost 用 `tools/prepare_selfhost_source.py` の `transpile_cli` import 除去ターゲットと support block 抽出対象へ同 helper を追加した。`test/unit/test_prepare_selfhost_source.py` と `test/unit/test_py2cpp_features.py` の回帰を更新して固定した。
- 2026-02-23: `P1-COMP-09` の継続として、`src/py2cpp.py` の import graph 循環検出 helper `_graph_cycle_dfs` も `src/pytra/compiler/transpile_cli.py::graph_cycle_dfs` へ移管した。`py2cpp` 側の呼び出し（`_analyze_import_graph` の循環検出）を共通 helper 経由へ統一し、selfhost 用 `tools/prepare_selfhost_source.py` の `transpile_cli` import 除去ターゲットと support block 抽出対象へ同 helper を追加した。`test/unit/test_prepare_selfhost_source.py` と `test/unit/test_py2cpp_features.py` の回帰を更新して固定した。
- 2026-02-23: `P1-COMP-09` の継続として、`src/py2cpp.py` の import graph ユーザーモジュール解決 helper `_resolve_user_module_path_for_graph` も `src/pytra/compiler/transpile_cli.py::resolve_user_module_path_for_graph` へ移管した。`py2cpp` 側の呼び出し（`_resolve_module_name_for_graph`）を共通 helper 経由へ統一し、selfhost 用 `tools/prepare_selfhost_source.py` の `transpile_cli` import 除去ターゲットと support block 抽出対象へ同 helper を追加した。`test/unit/test_prepare_selfhost_source.py` と `test/unit/test_py2cpp_features.py` の回帰を更新して固定した。
- 2026-02-23: `P1-COMP-09` の継続として、`src/py2cpp.py` の import graph レポート整形 helper `_format_graph_list_section` も `src/pytra/compiler/transpile_cli.py::format_graph_list_section` へ移管した。`py2cpp` 側の呼び出し（`_format_import_graph_report`）を共通 helper 経由へ統一し、selfhost 用 `tools/prepare_selfhost_source.py` の `transpile_cli` import 除去ターゲットと support block 抽出対象へ同 helper を追加した。`test/unit/test_prepare_selfhost_source.py` と `test/unit/test_py2cpp_features.py` の回帰を更新して固定した。
- 2026-02-23: `P1-COMP-09` の継続として、`src/py2cpp.py` の EAST module_id 読取 helper `_module_id_from_east_for_graph` も `src/pytra/compiler/transpile_cli.py::module_id_from_east_for_graph` へ移管した。`py2cpp` 側の呼び出し（`_module_export_table`）を共通 helper 経由へ統一し、selfhost 用 `tools/prepare_selfhost_source.py` の `transpile_cli` import 除去ターゲットと support block 抽出対象へ同 helper を追加した。`test/unit/test_prepare_selfhost_source.py` と `test/unit/test_py2cpp_features.py` の回帰を更新して固定した。
- 2026-02-23: `P1-COMP-09` の継続として、`src/py2cpp.py` の import モジュール抽出 helper `_collect_import_modules` も `src/pytra/compiler/transpile_cli.py::collect_import_modules` へ移管した。`py2cpp` 側の呼び出し（`_analyze_import_graph`）を共通 helper 経由へ統一し、selfhost 用 `tools/prepare_selfhost_source.py` の `transpile_cli` import 除去ターゲットと support block 抽出対象へ同 helper を追加した。`test/unit/test_prepare_selfhost_source.py` と `test/unit/test_py2cpp_features.py` の回帰を更新して固定した。
- 2026-02-23: `P1-COMP-09` の継続として、`src/py2cpp.py` の既知 non-user import 判定 helper `_is_known_non_user_import` を `src/pytra/compiler/transpile_cli.py::is_known_non_user_import` へ移管した。`py2cpp` 側の呼び出し（`_resolve_module_name_for_graph` と `resolve_module_name`）を共通 helper 経由へ統一し、selfhost 用 `tools/prepare_selfhost_source.py` の `transpile_cli` import 除去ターゲットと support block 抽出対象へ同 helper を追加した。`test/unit/test_prepare_selfhost_source.py` と `test/unit/test_py2cpp_features.py` の回帰を更新して固定した。
- 2026-02-23: `P1-COMP-09` の継続として、`src/py2cpp.py` の import graph モジュール分類 helper `_resolve_module_name_for_graph` も `src/pytra/compiler/transpile_cli.py::resolve_module_name_for_graph` へ移管した。`py2cpp` 側の呼び出し（`_analyze_import_graph`）を共通 helper 経由へ統一し、selfhost 用 `tools/prepare_selfhost_source.py` の `transpile_cli` import 除去ターゲットと support block 抽出対象へ同 helper を追加した。`test/unit/test_prepare_selfhost_source.py` と `test/unit/test_py2cpp_features.py` の回帰を更新して固定した。
- 2026-02-23: `P1-COMP-09` の継続として、`src/py2cpp.py` の `resolve_module_name` 専用 helper `_resolve_user_module_path` を削除し、共通 helper `src/pytra/compiler/transpile_cli.py::resolve_user_module_path_for_graph` へ一本化した。これにより module 解決ロジック（`<mod>/__init__.py` 優先・親ディレクトリ遡り探索）の重複実装を解消した。`test/unit/test_py2cpp_features.py` の resolve/import graph 系回帰（4件）と `tools/check_py2cpp_transpile.py` / `tools/build_selfhost.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）/ `tools/check_transpiler_version_gate.py`（`cpp 0.139.0 -> 0.140.0`）で確認した。
- 2026-02-23: `P1-COMP-09` の継続として、`src/py2cpp.py::resolve_module_name` の分類処理を `src/pytra/compiler/transpile_cli.py::resolve_module_name_for_graph` 呼び出しへ統一した。`py2cpp` 側は `status/module_id/path` の整形のみを担当し、`relative/pytra/user/known/missing` 判定の重複を解消した。`test/unit/test_py2cpp_features.py` の resolve/import graph 系回帰（4件）、`tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`tools/build_selfhost.py`（成功）、`tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`tools/check_transpiler_version_gate.py`（`cpp 0.140.0 -> 0.141.0`）で確認した。
- 2026-02-23: `P1-COMP-09` の継続として、`src/py2cpp.py` の runtime module 存在判定 helper `_python_module_exists_under` を `src/pytra/compiler/transpile_cli.py::python_module_exists_under` へ移管した。`py2cpp` 側の利用箇所（`_normalize_runtime_module_name`, `_module_name_to_cpp_include`）を共通 helper 経由へ統一し、selfhost 用 `tools/prepare_selfhost_source.py` の `transpile_cli` import 除去ターゲットと support block 抽出対象へ同 helper を追加した。`test/unit/test_prepare_selfhost_source.py` と `test/unit/test_py2cpp_features.py` に回帰（`test_python_module_exists_under_detects_py_and_package`）を追加し、`tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`tools/build_selfhost.py`（成功）、`tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`tools/check_transpiler_version_gate.py`（`shared 0.32.0 -> 0.33.0`, `cpp 0.141.0 -> 0.142.0`）で確認した。
- 2026-02-23: `P1-COMP-09` の継続として、`src/py2cpp.py` の user error 整形 helper（`_make_user_error`, `_parse_user_error`）を `src/pytra/compiler/transpile_cli.py::{make_user_error, parse_user_error}` へ移管した。`py2cpp` 側の呼び出しを共通 helper 経由へ統一し、selfhost 用 `tools/prepare_selfhost_source.py` の `transpile_cli` import 除去ターゲットと support block 抽出対象へ両 helper を追加した。`test/unit/test_prepare_selfhost_source.py` の期待値更新と `test/unit/test_py2cpp_features.py` の回帰（`test_make_and_parse_user_error_roundtrip`, `test_parse_user_error_non_tagged_text`）を追加し、`tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`tools/build_selfhost.py`（成功）、`tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`tools/check_transpiler_version_gate.py`（`shared 0.33.0 -> 0.34.0`, `cpp 0.142.0 -> 0.143.0`）で確認した。
- 2026-02-23: `P1-COMP-09` の継続として、`src/py2cpp.py` の import 診断 helper `_first_import_detail_line` を `src/pytra/compiler/transpile_cli.py::first_import_detail_line` へ移管した。`py2cpp` 側の wildcard/relative import 診断を共通 helper 経由へ統一し、selfhost 用 `tools/prepare_selfhost_source.py` の `transpile_cli` import 除去ターゲットと support block 抽出対象へ同 helper を追加した。`test/unit/test_prepare_selfhost_source.py` の期待値更新と `test/unit/test_py2cpp_features.py` の回帰（`test_first_import_detail_line_extracts_wildcard_and_relative`, `test_first_import_detail_line_fallback`）を追加し、`tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`tools/build_selfhost.py`（成功）、`tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`tools/check_transpiler_version_gate.py`（`shared 0.34.0 -> 0.35.0`, `cpp 0.143.0 -> 0.144.0`）で確認した。
- 2026-02-23: `P1-COMP-09` の継続として、`src/py2cpp.py` の multi-file module_id 補助 helper（`_module_name_from_path`, `_module_id_from_east`）を削除し、`src/pytra/compiler/transpile_cli.py::module_id_from_east_for_graph` へ統一した。`_write_multi_file_cpp` の module_id 解決は共通 helper 経由に置換し、`test/unit/test_py2cpp_features.py` の multi-file 回帰（`test_module_id_from_east_for_graph`, `test_build_module_east_map_sets_module_id_from_import_name`, `test_multi_file_from_import_alias_uses_fully_qualified_symbol`, `test_cli_multi_file_generates_out_include_src`）と既存回帰、`tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`tools/build_selfhost.py`（成功）、`tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`tools/check_transpiler_version_gate.py`（`cpp 0.144.0 -> 0.145.0`）で確認した。
- 2026-02-23: `P1-COMP-09` の継続として、`src/py2cpp.py` の EAST meta 正規化 helper（`_meta_import_bindings`, `_meta_qualified_symbol_refs`）を `src/pytra/compiler/transpile_cli.py::{meta_import_bindings, meta_qualified_symbol_refs}` へ移管した。`py2cpp` 側の利用箇所（`dump_deps_text`, `build_module_symbol_index`）を共通 helper 経由へ統一し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の `transpile_cli` import 除去ターゲットと support block 抽出対象、`test/unit/test_prepare_selfhost_source.py` の期待値を更新した。`test/unit/test_py2cpp_features.py` では `test_east_meta_import_bindings_is_emitted` を共通 helper 検証へ拡張し、`tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`tools/build_selfhost.py`（成功、既知 warning のみ）、`tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`tools/check_transpiler_version_gate.py`（`shared 0.35.0 -> 0.36.0`, `cpp 0.145.0 -> 0.146.0`）で回帰なしを確認した。
- 2026-02-23: `P1-COMP-09` の継続として、`src/py2cpp.py` の multi-file ラベル helper（`_sanitize_module_label`, `_module_rel_label`）を `src/pytra/compiler/transpile_cli.py::{sanitize_module_label, module_rel_label}` へ移管した。`py2cpp` 側の利用箇所（`_write_multi_file_cpp` の module label / include guard 生成）を共通 helper 経由へ統一し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の `transpile_cli` import 除去ターゲットと support block 抽出対象、`test/unit/test_prepare_selfhost_source.py` の期待値を更新した。`test/unit/test_py2cpp_features.py` には `test_sanitize_module_label` / `test_module_rel_label` を追加し、`tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`tools/build_selfhost.py`（成功、既知 warning のみ）、`tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`tools/check_transpiler_version_gate.py`（`shared 0.36.0 -> 0.37.0`, `cpp 0.146.0 -> 0.147.0`）で回帰なしを確認した。
- 2026-02-23: `P1-COMP-09` の継続として、`src/py2cpp.py` の include 挿入 helper（`_inject_after_includes_block`）を `src/pytra/compiler/transpile_cli.py::inject_after_includes_block` へ移管した。`py2cpp` 側の利用箇所（`_write_multi_file_cpp` の forward declare 注入）を共通 helper 経由へ統一し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の `transpile_cli` import 除去ターゲットと support block 抽出対象、`test/unit/test_prepare_selfhost_source.py` の期待値を更新した。`test/unit/test_py2cpp_features.py` には `test_inject_after_includes_block` を追加し、`tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`tools/build_selfhost.py`（成功、既知 warning のみ）、`tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`tools/check_transpiler_version_gate.py`（`shared 0.37.0 -> 0.38.0`, `cpp 0.147.0 -> 0.148.0`）で回帰なしを確認した。
- 2026-02-23: `P1-COMP-09` の継続として、`src/py2cpp.py` の `dict[str, Any]` 文字列取得 helper（`_dict_any_get_str`）を `src/pytra/compiler/transpile_cli.py::dict_any_get_str` へ移管した。`py2cpp` 側の利用箇所（AST/meta 参照、import graph 解析、multi-file 生成、error 解析など）を共通 helper 経由へ統一し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の `transpile_cli` import 除去ターゲットと support block 抽出対象、`test/unit/test_prepare_selfhost_source.py` の期待値を更新した。`test/unit/test_py2cpp_features.py` には `test_dict_any_get_str_returns_default_for_non_str` を追加し、`tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`tools/build_selfhost.py`（成功、既知 warning のみ）、`tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`tools/check_transpiler_version_gate.py`（`shared 0.38.0 -> 0.39.0`, `cpp 0.148.0 -> 0.149.0`）で回帰なしを確認した。
- 2026-02-23: `P1-COMP-09` の継続として、`src/py2cpp.py` の `kind` 取得 helper（`_dict_any_kind`）を `src/pytra/compiler/transpile_cli.py::dict_any_kind` へ移管した。`py2cpp` 側の利用箇所（target/stmt kind 判定、AST payload 分岐、module schema 収集など）を共通 helper 経由へ統一し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の `transpile_cli` import 除去ターゲットと support block 抽出対象、`test/unit/test_prepare_selfhost_source.py` の期待値を更新した。`test/unit/test_py2cpp_features.py` には `test_dict_any_kind` を追加し、`tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`tools/build_selfhost.py`（成功、既知 warning のみ）、`tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`tools/check_transpiler_version_gate.py`（`shared 0.39.0 -> 0.40.0`, `cpp 0.149.0 -> 0.150.0`）で回帰なしを確認した。
- 2026-02-23: `P1-COMP-09` の継続として、`src/py2cpp.py` の `list[str]` 抽出 helper（`_dict_any_get_str_list`）を `src/pytra/compiler/transpile_cli.py::dict_any_get_str_list` へ移管した。`py2cpp` 側の利用箇所（guard の import graph ノード/エッジ数、import graph report/validation、error details 取得）を共通 helper 経由へ統一し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の `transpile_cli` import 除去ターゲットと support block 抽出対象、`test/unit/test_prepare_selfhost_source.py` の期待値を更新した。`test/unit/test_py2cpp_features.py` には `test_dict_any_get_str_list_filters_non_str` を追加し、`tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`tools/build_selfhost.py`（成功、既知 warning のみ）、`tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`tools/check_transpiler_version_gate.py`（`shared 0.40.0 -> 0.41.0`, `cpp 0.150.0 -> 0.151.0`）で回帰なしを確認した。
- 2026-02-23: `P1-COMP-09` の継続として、`src/py2cpp.py` の `list[Any]` 抽出 helper（`_dict_any_get_list`）を `src/pytra/compiler/transpile_cli.py::dict_any_get_list` へ移管した。`py2cpp` 側の利用箇所（`arg_order` 読取や dict-list 正規化前段）を共通 helper 経由へ統一し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の `transpile_cli` import 除去ターゲットと support block 抽出対象、`test/unit/test_prepare_selfhost_source.py` の期待値を更新した。`test/unit/test_py2cpp_features.py` には `test_dict_any_get_list_returns_empty_for_non_list` を追加し、`tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`tools/build_selfhost.py`（成功、既知 warning のみ）、`tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`tools/check_transpiler_version_gate.py`（`shared 0.41.0 -> 0.42.0`, `cpp 0.151.0 -> 0.152.0`）で回帰なしを確認した。
- 2026-02-23: `P1-COMP-09` の継続として、`src/py2cpp.py` の `dict[str, Any]` 取得 helper（`_dict_any_get_dict`）を `src/pytra/compiler/transpile_cli.py::dict_any_get_dict` へ移管した。`py2cpp` 側の利用箇所（meta/import/type schema/target などの dict 正規化）を共通 helper 経由へ統一し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の `transpile_cli` import 除去ターゲットと support block 抽出対象、`test/unit/test_prepare_selfhost_source.py` の期待値を更新した。`test/unit/test_py2cpp_features.py` には `test_dict_any_get_dict_returns_empty_for_non_dict` を追加し、`tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`tools/build_selfhost.py`（成功、既知 warning のみ）、`tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`tools/check_transpiler_version_gate.py`（`shared 0.42.0 -> 0.43.0`, `cpp 0.152.0 -> 0.153.0`）で回帰なしを確認した。
- 2026-02-23: `P1-COMP-09` の継続として、`src/py2cpp.py` の `list[dict[str, Any]]` 取得 helper（`_dict_any_get_dict_list`）を `src/pytra/compiler/transpile_cli.py::dict_any_get_dict_list` へ移管した。`py2cpp` 側の利用箇所（stmt/body/handlers/cases/items/names などの dict list 正規化）を共通 helper 経由へ統一し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の `transpile_cli` import 除去ターゲットと support block 抽出対象、`test/unit/test_prepare_selfhost_source.py` の期待値を更新した。`test/unit/test_py2cpp_features.py` には `test_dict_any_get_dict_list_filters_non_dict` を追加し、`tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`tools/build_selfhost.py`（成功、既知 warning のみ）、`tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`tools/check_transpiler_version_gate.py`（`shared 0.43.0 -> 0.44.0`, `cpp 0.153.0 -> 0.154.0`）で回帰なしを確認した。
- 2026-02-23: `P1-COMP-09` の継続として、`src/py2cpp.py` の汎用 getter（`_dict_any_get`）を `src/pytra/compiler/transpile_cli.py::dict_any_get` へ移管した。`py2cpp` 側の利用箇所（`func`/`ok`/`east` の payload 読取）を共通 helper 経由へ統一し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の `transpile_cli` import 除去ターゲットと support block 抽出対象、`test/unit/test_prepare_selfhost_source.py` の期待値を更新した。`test/unit/test_py2cpp_features.py` には `test_dict_any_get_returns_none_for_missing` を追加し、`tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`tools/build_selfhost.py`（成功、既知 warning のみ）、`tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`tools/check_transpiler_version_gate.py`（`shared 0.44.0 -> 0.45.0`, `cpp 0.154.0 -> 0.155.0`）で回帰なしを確認した。
- 2026-02-23: `P1-COMP-09` の継続として、`src/py2cpp.py` の Assign 正規化 helper（`_assign_targets`）を `src/pytra/compiler/transpile_cli.py::assign_targets` へ移管した。`py2cpp` 側の `Assign/AnnAssign` 代入先抽出で共通 helper 経由へ統一し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の `transpile_cli` import 除去ターゲットと support block 抽出対象、`test/unit/test_prepare_selfhost_source.py` の期待値を更新した。`test/unit/test_py2cpp_features.py` には `test_assign_targets_prefers_targets_then_target` を追加し、`tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`tools/build_selfhost.py`（成功、既知 warning のみ）、`tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`tools/check_transpiler_version_gate.py`（`shared 0.45.0 -> 0.46.0`, `cpp 0.155.0 -> 0.156.0`）で回帰なしを確認した。
- 2026-02-23: `P1-COMP-09` の継続として、`src/py2cpp.py` の Name target 判定 helper（`_name_target_id`）を `src/pytra/compiler/transpile_cli.py::name_target_id` へ移管した。`py2cpp` 側の `Assign/AnnAssign` 代入名抽出（`_stmt_target_name`, `_stmt_assigned_names`）は共通 helper 経由へ統一し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の `transpile_cli` import 除去ターゲットと support block 抽出対象、`test/unit/test_prepare_selfhost_source.py` の期待値を更新した。`test/unit/test_py2cpp_features.py` には `test_name_target_id_returns_name_only` を追加し、`tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`tools/build_selfhost.py`（成功、既知 warning のみ）、`tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`tools/check_transpiler_version_gate.py`（`shared 0.46.0 -> 0.47.0`, `cpp 0.156.0 -> 0.157.0`）で回帰なしを確認した。
- 2026-02-23: `P1-COMP-09` の継続として、`src/py2cpp.py` の statement target helper（`_stmt_target_name`）を `src/pytra/compiler/transpile_cli.py::stmt_target_name` へ移管した。`py2cpp` 側の `AnnAssign` 代入名抽出と `global` 収集側の target 参照は共通 helper 経由へ統一し、selfhost 展開で欠落しないよう `tools/prepare_selfhost_source.py` の `transpile_cli` import 除去ターゲットと support block 抽出対象、`test/unit/test_prepare_selfhost_source.py` の期待値を更新した。`test/unit/test_py2cpp_features.py` には `test_stmt_target_name_reads_target_field` を追加し、`tools/check_py2cpp_transpile.py`（`checked=129 ok=129 fail=0 skipped=6`）、`tools/build_selfhost.py`（成功、既知 warning のみ）、`tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知維持）、`tools/check_transpiler_version_gate.py`（`shared 0.47.0 -> 0.48.0`, `cpp 0.157.0 -> 0.158.0`）で回帰なしを確認した。
