# TASK GROUP: TG-P1-CED

最終更新: 2026-02-23

関連 TODO:
- `docs-ja/todo.md` の `ID: P1-CED-*`

背景:
- selfhost で static 束縛前提が強く、共通化時に派生実装へ到達しない経路が発生する。

目的:
- `render_expr` / `emit_stmt` を hook 主体に再設計し、共通化と selfhost 安定を両立する。

対象:
- kind 単位の hook 注入
- CppEmitter の hook 優先 + fallback 2段構成
- fallback の段階削減
- py2cpp/py2rs の共通化候補整理

非対象:
- 一括での全面 rewrite

受け入れ基準:
- hooks 有効時の生成結果が既存と一致
- selfhost diff で `mismatches=0`
- `py2cpp.py` 本体分岐が段階的に短縮

確認コマンド:
- `python3 tools/check_selfhost_cpp_diff.py`
- `python3 tools/check_py2cpp_transpile.py`
- `python3 test/unit/test_code_emitter.py`
- `python3 test/unit/test_py2cpp_features.py`

サブタスク実行順（todo 同期）:
1. `P1-CED-01-S1`: `CodeEmitter` へ kind 専用 hook 名（`on_render_expr_<kind>`）の解決 API を追加し、`py2cpp` `render_expr` から呼び出せるようにする。
2. `P1-CED-01-S2`: 非 C++ emitter（`rs/cs/js/ts`）へ同一の kind 専用 hook 呼び出しを適用する。
3. `P1-CED-01-S3`: kind 専用 hook の登録規約を hooks/profile ドキュメントへ反映し、selfhost 回帰で挙動を固定する。

決定ログ:
- 2026-02-22: 初版作成。
- 2026-02-23: [ID: P1-CED-01-S1] として `CodeEmitter` に `hook_on_render_expr_kind_specific()` と kind 正規化（`Name` -> `on_render_expr_name`, `IfExp` -> `on_render_expr_if_exp`）を追加し、`py2cpp` `render_expr` の優先順を「kind専用hook -> 既存 `on_render_expr_kind`」へ変更した。`python3 test/unit/test_code_emitter.py`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_render_expr_kind_specific_hook_precedes_generic_kind_hook Py2CppFeatureTest.test_emit_stmt_fallback_works_when_dynamic_hooks_disabled Py2CppFeatureTest.test_emit_stmt_dispatch_table_handles_continue_and_unknown`、`python3 test/unit/test_cpp_hooks.py`、`python3 tools/check_py2cpp_transpile.py` で回帰を確認する。
- 2026-02-23: [ID: P1-CED-01-S2] として `js/cs/rs` emitter の `render_expr` 先頭へ `hook_on_render_expr_kind_specific()` 呼び出しを追加し、kind 専用 hook の優先順を `py2cpp` と揃えた。`ts` は専用 emitter 未実装のため `transpile_to_js()` 経由で同一経路を使うことを `test_py2ts_smoke.py::test_ts_preview_uses_js_transpile_pipeline` で固定した。`python3 test/unit/test_py2js_smoke.py Py2JsSmokeTest.test_render_expr_kind_specific_hook_precedes_leaf_hook`、`python3 test/unit/test_py2cs_smoke.py Py2CsSmokeTest.test_render_expr_kind_specific_hook_precedes_leaf_hook`、`python3 test/unit/test_py2rs_smoke.py Py2RsSmokeTest.test_render_expr_kind_specific_hook_precedes_leaf_hook`、`python3 test/unit/test_py2ts_smoke.py Py2TsSmokeTest.test_ts_preview_uses_js_transpile_pipeline`、`python3 tools/check_py2js_transpile.py`、`python3 tools/check_py2cs_transpile.py`、`python3 tools/check_py2rs_transpile.py`、`python3 tools/check_py2ts_transpile.py` で回帰なしを確認した。
- 2026-02-23: [ID: P1-CED-01-S3] として hooks/profile ドキュメントへ kind 専用 hook 規約を反映した。`docs-ja/spec/spec-language-profile.md` に `on_render_expr_<kind>` の命名規則（CamelCase -> snake_case）と `render_expr` の優先順位（kind専用 -> kind汎用 -> leaf/complex -> 既定実装）を追記し、`docs-ja/spec/spec-dev.md` に同規約と TS（JS経由）適用を明記した。selfhost 回帰は `python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知基線）で確認した。
- 2026-02-23: [ID: P1-CED-02] として `CodeEmitter.hook_on_emit_stmt_kind` を「`on_emit_stmt_<kind>`（kind専用） -> `on_emit_stmt_kind`（汎用）」順へ変更し、`on_emit_stmt_return` のような文 kind 専用 hook を共通基底で評価できるようにした。`python3 test/unit/test_code_emitter.py`（`test_stmt_kind_hook_name_normalization` 含む）、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_emit_stmt_kind_specific_hook_precedes_generic_and_fallback Py2CppFeatureTest.test_emit_stmt_fallback_works_when_dynamic_hooks_disabled Py2CppFeatureTest.test_emit_stmt_dispatch_table_handles_continue_and_unknown`、`python3 test/unit/test_cpp_hooks.py`、`python3 tools/check_py2cpp_transpile.py`、`python3 tools/check_py2js_transpile.py`、`python3 tools/check_py2cs_transpile.py`、`python3 tools/check_py2rs_transpile.py`、`python3 tools/check_py2ts_transpile.py`、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知基線）で回帰を確認した。
- 2026-02-23: [ID: P1-CED-03] として `CppEmitter.hook_on_render_expr_kind` を override し、`render_expr` 入口の hook 判定を「`on_render_expr_<kind>`（kind専用） -> `on_render_expr_kind`（汎用） -> `on_render_expr_leaf`/`on_render_expr_complex`」へ集約した。`CppEmitter.render_expr` 本体は kind ごとの fallback 描画に専任化し、hook 分岐重複を除去した。`python3 test/unit/test_code_emitter.py`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_render_expr_kind_specific_hook_precedes_generic_kind_hook Py2CppFeatureTest.test_render_expr_leaf_hook_applies_via_hook_on_render_expr_kind Py2CppFeatureTest.test_render_expr_complex_hook_applies_via_hook_on_render_expr_kind Py2CppFeatureTest.test_emit_stmt_kind_specific_hook_precedes_generic_and_fallback Py2CppFeatureTest.test_emit_stmt_fallback_works_when_dynamic_hooks_disabled Py2CppFeatureTest.test_emit_stmt_dispatch_table_handles_continue_and_unknown`、`python3 test/unit/test_cpp_hooks.py`、`python3 tools/check_py2cpp_transpile.py`、`python3 tools/check_py2js_transpile.py`、`python3 tools/check_py2cs_transpile.py`、`python3 tools/check_py2rs_transpile.py`、`python3 tools/check_py2ts_transpile.py`、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=3` 既知基線）で回帰を確認した。
- 2026-02-24: [ID: P1-CED-04] `hooks/cpp` の未登録 fallback ヘルパー（`on_for_range_mode`, `on_render_object_method`, `on_render_binop`, `on_render_expr_kind` と未使用 `_render_owner_expr`）を削除し、`build_cpp_hooks()` が実際に使う hook だけへ縮退した。対応して `test/unit/test_cpp_hooks.py` の未登録 helper 単体テストを整理し、`python3 -m unittest discover -s test/unit -p 'test_cpp_hooks.py'` / `python3 tools/check_py2cpp_transpile.py` / `python3 tools/build_selfhost.py` / `python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` を通過（`mismatches=0` 維持）したため `P1-CED-04` を完了扱いに更新した。
- 2026-02-24: [ID: P1-CED-04] `build_cpp_hooks()` から `on_emit_stmt_kind` 登録を削除し、文 kind の既定描画は `CppEmitter` core fallback のみを正本化した。`on_emit_stmt_kind` 関数自体は互換のため残しつつ、実運用経路から外して fallback 面積を縮退。`python3 -m unittest discover -s test/unit -p 'test_cpp_hooks.py'` / `python3 tools/check_py2cpp_transpile.py` / `python3 tools/build_selfhost.py` / `python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` を通過し、`mismatches=0` を維持した。
- 2026-02-24: [ID: P1-CED-04] 未使用化した `on_emit_stmt_kind` 関数と対応テスト（`test_on_emit_stmt_kind_*`）を削除し、C++ hooks モジュールから dead fallback 経路を撤去した。`python3 -m unittest discover -s test/unit -p 'test_cpp_hooks.py'` / `python3 tools/check_py2cpp_transpile.py` / `python3 tools/build_selfhost.py` / `python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` を通過し、`mismatches=0` 維持を確認した。
- 2026-02-24: [ID: P1-CED-05] `hook_on_emit_stmt_kind` / `hook_on_render_expr_kind` の解決順序を `CodeEmitter` 基底へ集約し、`CppEmitter` 側 override（同名2メソッド）を削除して共通ディスパッチへ戻した。`CodeEmitter` に `_emit_stmt_kind_fallback` の既定フック（基底は `False`）を追加し、C++ の fallback は既存 `_emit_stmt_kind_fallback` をそのまま利用する形へ統一。回帰として `python3 test/unit/test_code_emitter.py CodeEmitterTest.test_hook_invocation_helpers CodeEmitterTest.test_hook_invocation_helpers_with_dict_hooks CodeEmitterTest.test_emit_stmt_kind_fallback_path_in_base`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_emit_stmt_fallback_works_when_dynamic_hooks_disabled Py2CppFeatureTest.test_emit_stmt_dispatch_table_handles_continue_and_unknown Py2CppFeatureTest.test_render_expr_kind_specific_hook_precedes_generic_kind_hook Py2CppFeatureTest.test_render_expr_generic_kind_hook_applies_when_specific_missing Py2CppFeatureTest.test_render_expr_leaf_hook_applies_via_hook_on_render_expr_kind Py2CppFeatureTest.test_render_expr_complex_hook_applies_via_hook_on_render_expr_kind Py2CppFeatureTest.test_emit_stmt_kind_specific_hook_precedes_generic_and_fallback Py2CppFeatureTest.test_emit_stmt_generic_kind_hook_applies_before_cpp_fallback`、`python3 tools/check_py2cpp_transpile.py`、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=0`）を確認した。
- 2026-02-24: [ID: P1-CED-A-01] `If/While` の文スケルトン（開閉ブロック + scope push/pop）を `CodeEmitter` へ抽出し、`emit_if_stmt_skeleton` / `emit_while_stmt_skeleton` を追加。`js/rs/cs` emitter の `_emit_if`/`_emit_while` と `py2cpp` の `_emit_while_stmt` を新ヘルパー経由へ置換し、制御文骨格の重複を縮退した。`ForRange/For` は未移行。検証として `python3 -m unittest discover -s test/unit -p 'test_code_emitter.py'`、`python3 tools/check_py2cpp_transpile.py`、`python3 tools/check_py2rs_transpile.py`、`python3 tools/check_py2cs_transpile.py`、`python3 tools/check_py2js_transpile.py`、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=0`）を通過した。
- 2026-02-24: [ID: P1-CED-A-01] `ForRange/For` の開閉ブロック + scope push/pop も `CodeEmitter` の共通ヘルパーへ寄せた。`emit_scoped_block_with_tail_lines` を追加し、`rs` の `ForRange`（末尾インクリメント付き while）を共通化、`js/cs/rs` の `ForRange/For` と `py2cpp` の `ForRange` および `For`（非 tuple unpack 経路）を `emit_scoped_block` 経由へ置換。`py2cpp` `If` の通常 brace 経路も `emit_if_stmt_skeleton` へ置換し、P1-CED-A-01 の対象4種を共通層へ移行した。検証として `python3 -m unittest discover -s test/unit -p 'test_code_emitter.py'`、`python3 tools/check_py2cpp_transpile.py`、`python3 tools/check_py2rs_transpile.py`、`python3 tools/check_py2cs_transpile.py`、`python3 tools/check_py2js_transpile.py`、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=0`）を通過した。
- 2026-02-24: [ID: P1-CED-A-02] `Assign/AnnAssign/AugAssign` の共通骨格として `CodeEmitter` に `primary_assign_target`（`target`/`targets[0]` 解決）、`should_declare_name_binding`（宣言判定）、`render_augassign_basic`（target/value/op 解決）を追加。`js/cs/rs` emitter の該当メソッドで共通ヘルパーを利用する形に置換し、代入系の重複を段階縮退した。検証として `python3 -m unittest discover -s test/unit -p 'test_code_emitter.py'`、`python3 tools/check_py2cpp_transpile.py`、`python3 tools/check_py2rs_transpile.py`、`python3 tools/check_py2cs_transpile.py`、`python3 tools/check_py2js_transpile.py`、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`（`mismatches=0`）を通過した。
- 2026-02-24: [ID: P1-CED-A-02] `CodeEmitter` に `stmt_declare_flag`（bool/int 両対応）を追加し、宣言判定ヘルパーを selfhost 互換へ更新。`py2cpp` でも `primary_assign_target` / `should_declare_name_binding` を `Assign`/`AnnAssign`/`AugAssign` に適用して代入先レンダと宣言判定の共通骨格を統一した。`python3 -m unittest discover -s test/unit -p 'test_code_emitter.py'`、`python3 tools/check_py2cpp_transpile.py`、`python3 tools/check_py2rs_transpile.py`、`python3 tools/check_py2cs_transpile.py`、`python3 tools/check_py2js_transpile.py`、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` を再通過（`mismatches=0`）。
- 2026-02-24: [ID: P1-CED-A-03] IfExp の式組み立てを `CodeEmitter.render_ifexp_common` へ抽出し、`CodeEmitter._render_ifexp_expr` と `py2cpp` 側 override の重複を縮退した。`py2cpp` は既存の bool 定数折りたたみ（`True/False`, `true/false`）を保ったまま共通 helper を利用する構成へ変更。`python3 -m unittest discover -s test/unit -p 'test_code_emitter.py'`、`python3 tools/check_py2cpp_transpile.py`、`python3 tools/check_py2rs_transpile.py`、`python3 tools/check_py2cs_transpile.py`、`python3 tools/check_py2js_transpile.py`、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` を通過（`mismatches=0`）。
- 2026-02-24: [ID: P1-CED-A-03] BoolOp/Compare の連結組み立ても共通層へ寄せた。`CodeEmitter` に `render_boolop_chain_common` と `render_compare_chain_from_rendered` を追加し、`py2cpp` の BoolOp（bool 演算経路）と Compare（通常比較チェーン経路）を helper 経由へ切り替えた。`py2cpp` 側の `in/not in`・`is/is not`・文字比較最適化の特例分岐は維持し、非特例の式組み立てのみを共通化した。`python3 -m unittest discover -s test/unit -p 'test_code_emitter.py'`、`python3 test/unit/test_py2cpp_features.py Py2CppFeatureTest.test_ifexp_renders_cpp_ternary Py2CppFeatureTest.test_boolop_value_select_runtime`、`python3 tools/check_py2cpp_transpile.py`、`python3 tools/check_py2rs_transpile.py`、`python3 tools/check_py2cs_transpile.py`、`python3 tools/check_py2js_transpile.py`、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` を通過（`mismatches=0`）。
- 2026-02-24: P1-CED-A-04 は実装済みとしてクローズ。`CodeEmitter.load_import_bindings_from_meta()` が `meta.import_bindings`（+ legacy `import_modules`/`import_symbols`/`qualified_symbol_refs`）を正規化し、`py2cpp` は `_seed_import_maps_from_meta()` で同 API を利用していることを確認した。
- 2026-02-24: [ID: P1-CED-B-01] `normalize_type_name` 後段の型写像骨格を `CodeEmitter` へ抽出した。`load_type_map`（profile `types`/`types.types` 読み込み）、`normalize_type_and_lookup_map`（正規化 + 直接写像）、`split_union_non_none`（Union 分解）、`type_generic_args`（generic 引数抽出）を追加し、`py2cpp._cpp_type_text` と `RustEmitter._rust_type` を共通 helper 経由へ置換。`JsEmitter`/`CSharpEmitter` の `type_map` 初期化も `load_type_map` へ統一した。回帰は `python3 test/unit/test_code_emitter.py`、`python3 test/unit/test_py2rs_smoke.py`、`python3 tools/check_py2cpp_transpile.py`、`python3 tools/check_py2rs_transpile.py`、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認し、`checked=131 ok=131 fail=0 skipped=6` / `mismatches=0` を維持した。
- 2026-02-24: [ID: P1-CED-B-02] `Call` 前処理結果の共通利用を `CodeEmitter.prepare_call_context()`（`_prepare_call_parts` + `unpack_prepared_call_parts`）へ集約した。`py2cpp` / `JsEmitter` / `CSharpEmitter` / `RustEmitter` の call 描画入口を同 helper へ揃え、各 emitter 側の重複前処理を縮退した。回帰は `python3 test/unit/test_code_emitter.py`、`python3 tools/check_py2cpp_transpile.py`、`python3 tools/check_py2rs_transpile.py`、`python3 tools/check_py2js_transpile.py`、`python3 tools/check_py2cs_transpile.py`、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認し、`checked=131 ok=131 fail=0 skipped=6` / `mismatches=0` を維持した。
- 2026-02-24: [ID: P1-CED-B-03] 2要素 `Tuple` 代入の一時変数 lower を `CodeEmitter.emit_tuple_assign_with_tmp()` へ抽出し、`JsEmitter` / `CSharpEmitter` / `RustEmitter` の `_emit_assign` から共通 helper を利用する形へ統一した（言語差分は `tmp` 宣言と要素アクセステンプレートのみ）。`test/unit/test_code_emitter.py` に helper 回帰テストを追加し、`python3 tools/check_py2{cpp,rs,js,cs}_transpile.py` と `python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で `checked=131 ok=131 fail=0 skipped=6` / `mismatches=0` を確認した。
- 2026-02-24: [ID: P1-CED-C-02] 文字列/配列 truthy 最適化と括弧削減ロジック（`render_cond`）を `CodeEmitter.render_truthy_cond_common()` へ抽出した。`JsEmitter` / `CSharpEmitter` / `RustEmitter` の `render_cond` は言語差分パターンだけを渡す薄い委譲へ変更し、重複していた `str/list/dict/set/tuple` 判定と `_strip_outer_parens` 適用を共通化した。`test/unit/test_code_emitter.py` に helper テストを追加し、`python3 test/unit/test_py2{js,cs,rs}_smoke.py`、`python3 tools/check_py2{cpp,rs,js,cs}_transpile.py`、`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で回帰なし（`checked=131 ok=131 fail=0 skipped=6`, `mismatches=0`）を確認した。
