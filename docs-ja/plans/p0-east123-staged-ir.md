# TASK GROUP: TG-P0-EAST123

最終更新: 2026-02-23

関連 TODO:
- `docs-ja/todo/index.md` の `ID: P0-EAST123-*`

背景:
- 単一 EAST + backend hooks 運用では、意味論 lowering が backend 側へ漏れやすく、hooks が肥大化する。
- `Any/object` 境界、`dispatch mode`、iterable 契約の責務境界を backend 非依存で固定する必要がある。
- `docs-ja/spec/spec-east123.md` に三段構成（EAST1/EAST2/EAST3）の設計ドラフトを追加済みであり、これを実装計画へ落とし込む段階に入った。

目的:
- `spec-east123` を最優先仕様として実装へ接続し、EAST3 を意味論の単一正本にする。
- `EAST2 -> EAST3` で `--object-dispatch-mode` を一括適用し、後段再判断を禁止する。
- hooks を「構文差分の最終調整」に限定し、意味論実装を core lowering 側へ回収する。

対象:
- EAST ルートスキーマ（`east_stage`, `schema_version`, `meta.dispatch_mode`）の導入
- 現行 `EAST2`（`EAST1 + EAST2` 混在）の段階分離（`EAST1`: parser 直後、`EAST2`: normalize 専任）
- `ForCore` / `RuntimeIterForPlan` / `Any/object` 境界命令の段階導入
- `type_id` 関連 lower を EAST3 命令化し、backend 側は命令写像に限定する
- `type_id` 以外の言語非依存意味論（boxing/unboxing, iterable, truthy/len/str, 主要 built-in lower）も EAST3 命令化へ段階移行する
- backend の意味論再解釈禁止（hooks 責務境界の明確化）
- hooks 縮退の定量管理（意味論 hook の撤去数、構文差分 hook の残存数）
- schema/例外契約/回帰テストの整備

非対象:
- 全ノード一括置換
- 新規最適化器の全面導入
- 既存 backend の全面 rewrite

受け入れ基準:
1. `docs-ja/spec/spec-east123.md` の契約（stage/scheme/dispatch 固定点）と実装仕様の差分が解消されている。
2. `EAST3.meta.dispatch_mode` と `RuntimeIterForPlan.dispatch_mode` が導入され、後段で mode 再判定しない。
3. hooks での意味論変更（dispatch 再判断、boxing/iterable 再実装）が段階的に撤去される。
4. `EAST3` 契約を unit/codegen/selfhost 回帰で検証できる。
5. hooks の責務が「構文差分のみ」に収束し、意味論 hook の残存箇所が一覧化・縮退管理されている。
6. `EAST1` と `EAST2` の責務が分離され、`EAST1` から normalize なしの parser 出力を取得できる。
7. `type_id` 判定 lower は EAST3 経由へ統一され、backend での C++ 直書き判定生成が原則なくなる。
8. `type_id` 以外の言語非依存意味論でも、backend/hook 側の直接実装が段階的に縮退し、EAST3 命令写像へ集約される。

確認コマンド（最低）:
- `python3 tools/check_py2cpp_transpile.py`
- `python3 tools/check_py2js_transpile.py`
- `python3 tools/check_py2ts_transpile.py`
- `python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented`

サブタスク実行順（todo 同期）:
1. `P0-EAST123-01-S1`: ルートスキーマ（`east_stage`, `schema_version`, `meta.dispatch_mode`）の仕様統一。
2. `P0-EAST123-01-S2`: `dispatch mode` 適用点と後段再判断禁止の仕様固定。
3. `P0-EAST123-01-S3`: `spec-east` / `spec-type_id` / `spec-boxing` / `spec-iterable` / `spec-dev` の整合調整。
4. `P0-EAST123-01-S4`: `spec-east123` を上位仕様、`spec-linker` を下位仕様として確定し、参照順を明文化。
5. `P0-EAST123-02-S1`: `For` / `ForRange` の `ForCore + iter_plan` lower 実装。
6. `P0-EAST123-02-S2`: `Any/object` 境界命令の EAST3 lower 実装。
7. `P0-EAST123-02-S3`: `--object-dispatch-mode` の単一点適用実装。
8. `P0-EAST123-06-S1`: parser 直後 `EAST1` 出力 API 追加。
9. `P0-EAST123-06-S2`: `EAST1 -> EAST2` normalize pass 分離 + `load_east(...)` 互換維持。
10. `P0-EAST123-07-S1`: `type_id` 判定（`isinstance` / `issubclass` / subtype）の EAST3 命令化。
11. `P0-EAST123-07-S2`: backend 側 `type_id` 直書き判定生成の撤去（runtime API 写像へ統一）。
12. `P0-EAST123-08-S1`: IR-first 移行対象（boxing/unboxing, iterable, truthy/len/str, built-in lower）の優先度確定。
13. `P0-EAST123-08-S2`: 第1陣（boxing/unboxing, iterable, truthy/len/str）の EAST3 移行。
14. `P0-EAST123-08-S3`: 第2陣（主要 built-in lower）の EAST3 移行。
15. `P0-EAST123-03-S1`: C++ hooks / `py2cpp.py` の意味論実装経路棚卸し。
16. `P0-EAST123-03-S2-S1`: CppEmitter 側で EAST3 命令ノード受理（`ForCore`, `Box/Unbox`, `Obj*`）を追加。
17. `P0-EAST123-03-S2-S2`: `For` / `iter_mode` / Any 境界の backend 再判断を EAST3 命令入力へ置換。
18. `P0-EAST123-03-S2-S3`: `py2cpp.py` と `hooks/cpp` の `runtime_call` / built-in 分岐重複を撤去。
19. `P0-EAST123-05-S1`: hooks 分類と縮退メトリクス基線を確定。
20. `P0-EAST123-05-S2`: 意味論 hook 新規流入を防ぐ CI ルール追加。
21. `P0-EAST123-04-S1`: schema テスト整備（必須項目、`iter_plan` 形状、`dispatch_mode`）。
22. `P0-EAST123-04-S2`: lowering 契約テスト（`EAST2 -> EAST3`）整備。
23. `P0-EAST123-04-S3`: selfhost + クロスターゲット回帰導線へ統合。

## P0-EAST123-08-S1 IR-first 移行順（確定）

目的:
- `type_id` 以外の言語非依存意味論を、backend/hook 実装から `EAST3` 命令へ順次移す実行順を固定する。

移行優先度（高 -> 低）:
1. `truthy/len/str`（`ObjBool` / `ObjLen` / `ObjStr`）
   - 理由: 分岐条件・ループ条件・標準ライブラリでの使用頻度が高く、誤差分が全体挙動へ波及しやすい。
   - 完了条件: backend 側の bool/len/str 判定分岐が `EAST3` 命令写像のみに収束する。
2. `iterable`（`ObjIterInit` / `ObjIterNext` + `ForCore.iter_plan`）
   - 理由: `for` 系の再判断が backend 側へ残りやすく、hooks 肥大化の主因になっている。
   - 完了条件: `iter_mode`/`iter_plan` の意味論再判断を backend/hook で行わない。
3. `boxing/unboxing`（`Box` / `Unbox` / `CastOrRaise`）
   - 理由: 代入・引数・戻り値の境界処理が広範囲に分散しており、段階導入の影響面が大きい。
   - 完了条件: Any 境界の注入/解除ロジックが `EAST3` 命令入力へ統一される。
4. 主要 built-in lower（list/set/dict/str/special）
   - 理由: API 数が多く差分面積が大きいため、前段の境界命令が安定してから移行する。
   - 完了条件: `runtime_call` 直分岐の新規追加を停止し、既存分岐を EAST3 命令写像へ段階置換する。

分割実行規約:
- `P0-EAST123-08-S2`: 上記 1〜3（truthy/len/str + iterable + boxing/unboxing）を第1陣として実装する。
- `P0-EAST123-08-S3`: 上記 4（主要 built-in lower）を第2陣として実装する。
- `P0-EAST123-08-S3-S1`: `list/set` 系 built-in lower を IR-first へ移行する。
- `P0-EAST123-08-S3-S2`: `dict` 系 built-in lower を IR-first へ移行する。
- `P0-EAST123-08-S3-S3`: `str/special` 系 built-in lower を IR-first へ移行する。
- `P0-EAST123-08-S3-S4`: backend 直分岐を整理し、EAST3 命令写像 + 構文差分 hook のみに収束させる。

## P0-EAST123-03-S1 棚卸し（C++ hooks / py2cpp）

目的:
- `dispatch/boxing/iterable/built-in` の意味論実装がどこに残っているかを列挙し、`P0-EAST123-03-S2` の撤去対象を固定する。

### dispatch（type_id / isinstance）

- `src/py2cpp.py:3500` `_render_isinstance_name_call`
- `src/py2cpp.py:3528` `_render_isinstance_type_check`
- `src/py2cpp.py:3702` `Call(Name="isinstance")` の直接分岐
- `src/py2cpp.py:4061` `render_call_expr` 系の `isinstance` 補助分岐

現状:
- `type_id` 判定式生成が `py2cpp.py` に直書きされている（`PYTRA_TID_*`, `Class::PYTRA_TYPE_ID`）。

### boxing / unboxing（Any 境界）

- `src/py2cpp.py:722` `_coerce_py_assert_args`（`make_object(...)` 注入）
- `src/py2cpp.py:1504` `_box_expr_if_needed`
- `src/py2cpp.py:1726`, `src/py2cpp.py:2354`, `src/py2cpp.py:2380` 代入系での `make_object(...)`
- `src/py2cpp.py:3823`, `src/py2cpp.py:3921`, `src/py2cpp.py:4370` 呼び出し/式評価時の boxing
- `src/hooks/cpp/hooks/cpp_hooks.py:207`, `src/hooks/cpp/hooks/cpp_hooks.py:214`, `src/hooks/cpp/hooks/cpp_hooks.py:237` dict 系 default での `make_object(...)`

現状:
- Any 境界の boxing 判断が emitter/hooks の両方に分散している。

### iterable（for / runtime protocol）

- `src/py2cpp.py:2700` `_resolve_for_iter_mode`（`static_fastpath/runtime_protocol` 決定）
- `src/py2cpp.py:2742` `_emit_for_each_runtime`（`py_dyn_range(...)`）
- `src/py2cpp.py:2723` `_emit_target_unpack_runtime`（`py_at(...)`）
- `src/py2cpp.py:2611` `_emit_for_each`（通常 for / range 系）

現状:
- iterable 意味論（mode 決定、runtime 反復、unpack）が backend 側で決定・実装されている。

### built-in lower（runtime_call 分岐）

- `src/py2cpp.py` `_render_builtin_call`
- `src/py2cpp.py` `_render_builtin_runtime_list_ops`
- `src/py2cpp.py` `_render_builtin_runtime_set_ops`
- `src/py2cpp.py` `_render_builtin_runtime_dict_ops`
- `src/py2cpp.py` `_render_builtin_runtime_str_ops`
- `src/py2cpp.py` `_render_builtin_runtime_special_ops`
- `src/py2cpp.py` `_render_builtin_runtime_fallback`
- `src/hooks/cpp/hooks/cpp_hooks.py` `on_render_call`（no-op）

現状:
- `runtime_call` / built-in 分岐は `py2cpp.py` 側へ集約し、`hooks/cpp` の `on_render_call` は構文差分専任の no-op へ縮退した。

`P0-EAST123-03-S2` での置換方針（本棚卸しからの確定）:
- 上記カテゴリを `EAST3` 命令写像へ段階移行し、hooks は構文差分専任へ縮退する。

## P0-EAST123-05-S1 hooks 分類・基線（2026-02-23）

実行コマンド:
- `python3 tools/check_cpp_hooks_semantic_budget.py`

計測結果:
- `total=11`
- `semantic=4`（`on_for_range_mode`, `on_render_binop`, `on_render_expr_kind`, `on_render_object_method`）
- `syntax=6`（`on_emit_stmt_kind`, `on_render_class_method`, `on_render_expr_complex`, `on_render_expr_leaf`, `on_render_module_method`, `on_stmt_omit_braces`）
- `noop=1`（`on_render_call`）
- `unknown=0`

記録方針:
- `tools/check_cpp_hooks_semantic_budget.py` を基線計測コマンドとして扱う。
- 次段 (`P0-EAST123-05-S2`) でこの基線を上限とする流入防止チェックを追加する。

決定ログ:
- 2026-02-23: 初版作成。`docs-ja/spec/spec-east123.md` を最優先事項として `todo` の `P0` へ昇格し、実装導入の作業枠を定義した。
- 2026-02-23: `EAST3` 導入効果を明示するため、`ID: P0-EAST123-05`（hooks 縮退の定量管理）を TODO/plan に追加した。
- 2026-02-23: 現行 `EAST2` が `EAST1 + EAST2` 相当である課題を反映し、`ID: P0-EAST123-06`（EAST1/EAST2 分離）を TODO/plan に追加した。
- 2026-02-23: `type_id` 関連 lower を backend 直書きではなく EAST3 命令化へ統一する方針を反映し、`ID: P0-EAST123-07` を TODO/plan に追加した。
- 2026-02-23: `type_id` に限らず IR-first を徹底するため、`ID: P0-EAST123-08`（言語非依存意味論の EAST3 命令化と C++ hooks 縮退）を TODO/plan に追加した。
- 2026-02-23: 実行単位を小さく保つため、`P0-EAST123-01-S1` を起点に `-S1/-S2/...` 形式で約20サブタスクへ再分割した。
- 2026-02-23: `spec-east123` を上位仕様、`spec-linker` を下位仕様として扱う順序を `P0-EAST123-01-S4` として TODO/plan へ追加した。
- 2026-02-23: [ID: P0-EAST123-01-S4] `spec-east123` と `spec-linker` に仕様優先順位（`east123` 上位 / `linker` 下位）を明記した。
- 2026-02-23: `P0-EAST123-01-S1` / `P0-EAST123-01-S2` / `P0-EAST123-01-S3` として、`spec-east123` のルート契約（`east_stage`/`schema_version`/`meta.dispatch_mode`）、dispatch mode 単一点適用（`EAST2 -> EAST3`）、および `spec-east`/`spec-dev`/`spec-type_id`/`spec-boxing`/`spec-iterable` の参照整合を同期した。
- 2026-02-23: [ID: P0-EAST123-02-S1] `src/pytra/compiler/east_parts/east3_lowering.py` に最小 `EAST2 -> EAST3` pass を追加し、`For` / `ForRange` を `ForCore + iter_plan`（`RuntimeIterForPlan` / `StaticRangeForPlan`）へ lower する契約を `test/unit/test_east3_lowering.py` で固定した。
- 2026-02-23: [ID: P0-EAST123-02-S2] `east3_lowering` で `Any/object` 境界命令 lower（`Box`/`Unbox`/`ObjBool`/`ObjLen`/`ObjStr`/`ObjIterInit`/`ObjIterNext`）を追加し、`test/unit/test_east3_lowering.py` に境界命令化テストを拡張した。
- 2026-02-23: [ID: P0-EAST123-02-S3] `lower_east2_to_east3(..., object_dispatch_mode=...)` と `load_east3_document(..., object_dispatch_mode=...)` を追加し、dispatch mode を `EAST2 -> EAST3` エントリで一度だけ確定して `EAST3.meta.dispatch_mode` と `RuntimeIterForPlan.dispatch_mode` へ反映するテストを追加した。
- 2026-02-23: [ID: P0-EAST123-03-S1] `py2cpp.py` と `hooks/cpp` の意味論実装経路（dispatch/boxing/iterable/built-in）を棚卸しし、`P0-EAST123-03-S2` の置換対象として固定した。
- 2026-02-23: [ID: P0-EAST123-03-S2-S1] `py2cpp.py` に `ForCore` / `Box` / `Unbox` / `Obj*` 受理を追加し、`test/unit/test_east3_cpp_bridge.py` で C++ 写像と `ForCore` のシンボル収集（`transpile_cli` 側）を固定した。
- 2026-02-23: [ID: P0-EAST123-03-S2-S2] `py2cpp` に `--east-stage {2,3}` / `--object-dispatch-mode` を追加し、`load_east(..., east_stage=\"3\")` で `EAST2 -> EAST3` を通す経路を導入して `ForCore` / Any 境界を backend 再判断なしで受理できるようにした。
- 2026-02-23: [ID: P0-EAST123-03-S2-S3] `runtime_call` / built-in の list/set/dict/str/special 分岐を `py2cpp.py` へ移管し、`hooks/cpp` の `on_render_call` は no-op 化した。`test_cpp_hooks.py` / `test_py2cpp_codegen_issues.py` / `test_east3_cpp_bridge.py` で回帰確認済み。
- 2026-02-23: [ID: P0-EAST123-04-S1] `test/unit/test_east3_lowering.py` に schema 契約テストを追加し、`EAST3` ルート必須項目、`ForCore.iter_plan` 形状（`RuntimeIterForPlan` / `StaticRangeForPlan`）、および `meta.dispatch_mode` と runtime plan の一貫性を固定した。
- 2026-02-23: [ID: P0-EAST123-04-S2] `test/unit/test_east3_lowering.py` に lowering 契約テストを追加し、`For -> ForCore` の `iter_mode` 正規化、non-Any builtin call 非変換、同型代入での Box/Unbox 非挿入を固定した。
- 2026-02-23: [ID: P0-EAST123-04-S3] `check_selfhost_cpp_diff.py` / `check_py2js_transpile.py` / `check_py2ts_transpile.py` に EAST3 契約テストの preflight（`test_east3_lowering.py`, `test_east3_cpp_bridge.py`）を組み込み、`run_local_ci.py` に JS/TS クロスターゲットチェックを追加した。
- 2026-02-23: [ID: P0-EAST123-05-S1] `tools/check_cpp_hooks_semantic_budget.py` を追加し、C++ hooks の semantic/syntax/no-op 分類と基線メトリクス（`total=11`, `semantic=4`, `syntax=6`, `noop=1`, `unknown=0`）を記録した。
- 2026-02-23: [ID: P0-EAST123-05-S2] `run_local_ci.py` に `tools/check_cpp_hooks_semantic_budget.py --max-semantic 4` を追加し、semantic hook の新規流入を失敗扱いにするチェック導線を常時実行化した。
- 2026-02-23: [ID: P0-EAST123-06-S1] `load_east1_document(...)` を `transpile_cli` に追加し、既存のエラー分類/ルート契約を維持したまま `east_stage=1` を返す parser 直後 API を導入した。`test_py2cpp_features.py` に helper 契約テストを追加し、`prepare_selfhost_source` の import 行除去を prefix 判定へ更新して回帰を解消した。
- 2026-02-23: [ID: P0-EAST123-06-S2] `normalize_east1_to_east2_document(...)` を `transpile_cli` に追加し、`load_east_document(...)` で `EAST1 -> EAST2` 正規化（stage `1 -> 2`）を通す構成へ分離した。`load_east_document` の既存呼び出し互換を維持するため、stage1 JSON 入力の正規化を `test_py2cpp_features.py` で固定した。
- 2026-02-24: [ID: P0-EAST123-07-S1] `EAST2 -> EAST3` lowering に `ObjTypeId` / `IsInstance` / `IsSubclass` / `IsSubtype` を追加し、`isinstance` / `issubclass` / `py_*subtype` 系 call を EAST3 命令へ正規化した。`py2cpp` で新命令を runtime API（`py_runtime_type_id`, `py_isinstance`, `py_issubclass`, `py_is_subtype`）へ写像し、`test_east3_lowering.py` / `test_east3_cpp_bridge.py` / `test_py2cpp_codegen_issues.py` で回帰確認した。
- 2026-02-24: [ID: P0-EAST123-07-S2] `Call(Name=...)` の `isinstance`/`issubclass`/`py_*type_id` 分岐で EAST3 型判定ノード（`IsInstance`/`IsSubclass`/`IsSubtype`/`ObjTypeId`）を構築して `render_expr` 経由へ統一し、backend の直接判定文字列組み立て経路を縮退した。`_render_repr_expr` の `isinstance` も `py_isinstance + type_id` 経路へ更新し、`test_py2cpp_codegen_issues.py` / `test_east3_cpp_bridge.py` / `test_east3_lowering.py` / `tools/check_py2cpp_transpile.py` で回帰確認した。
- 2026-02-24: [ID: P0-EAST123-08-S1] `type_id` 以外の IR-first 移行順を確定し、優先度を `truthy/len/str -> iterable -> boxing/unboxing -> 主要 built-in` と定義した。実装段は `P0-EAST123-08-S2`（第1陣: 1〜3）/`P0-EAST123-08-S3`（第2陣: 4）に固定した。
- 2026-02-24: [ID: P0-EAST123-08-S2] 第1陣の初回パッチとして、stage2 の `Call(Name=bool/len/str/iter/next)`（Any/object 引数）を EAST3 境界ノード（`ObjBool`/`ObjLen`/`ObjStr`/`ObjIterInit`/`ObjIterNext`）へ寄せ、`render_expr` の命令写像経路へ統一した。`test_py2cpp_codegen_issues.py`（新規ケース追加）/`test_east3_cpp_bridge.py`/`test_east3_lowering.py`/`tools/check_py2cpp_transpile.py` で回帰確認した。
- 2026-02-24: [ID: P0-EAST123-08-S2] 第1陣の2パッチ目として、`_render_builtin_call`（`BuiltinCall/runtime_call` 経路）の Any/object 境界も `Obj*` 命令（`ObjBool`/`ObjLen`/`ObjStr`/`ObjIterInit`/`ObjIterNext`）へ集約した。`test_east3_cpp_bridge.py` に helper 契約テストを追加し、`test_py2cpp_codegen_issues.py` / `test_east3_lowering.py` / `tools/check_py2cpp_transpile.py` で回帰確認した。
- 2026-02-24: [ID: P0-EAST123-08-S2] 第1陣の3パッチ目として、`_coerce_call_arg` の Any 境界を `Box/Unbox` ノード構築 + `render_expr` 経路へ寄せ、call-arg の boxing/unboxing 直組み立てを縮退した。`Unbox.ctx` を導入して既存エラーメッセージ文脈（`call_arg:*`）互換を維持し、`test_east3_cpp_bridge.py` / `test_py2cpp_codegen_issues.py` / `test_east3_lowering.py` / `tools/check_py2cpp_transpile.py` で回帰確認した。
- 2026-02-24: [ID: P0-EAST123-08-S2] 第1陣の4パッチ目として、`_emit_for_each_runtime` / `_emit_target_unpack_runtime` の object->typed 変換を `Unbox` ノード経由へ移し、runtime iterable 経路の型変換直実装を縮退した。`test_east3_cpp_bridge.py` に `For(iter_mode=runtime_protocol)` の typed target 回帰を追加し、`test_py2cpp_codegen_issues.py` / `test_east3_lowering.py` / `tools/check_py2cpp_transpile.py` で回帰確認した。
- 2026-02-24: [ID: P0-EAST123-08-S2] 第1陣の5パッチ目として、`AnnAssign` / `Assign` の Any ターゲット代入 boxing を `Box` ノード経由（`_box_any_target_value`）へ寄せ、`None -> object{}` と既存 `make_object(...)` 互換を維持した。`test_east3_cpp_bridge.py` に helper 回帰（plain/Any/None）を追加し、`test_py2cpp_codegen_issues.py` / `test_east3_lowering.py` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認した（selfhost 差分は既知3件で増加なし）。
- 2026-02-24: [ID: P0-EAST123-08-S2] 第1陣の6パッチ目として、`_coerce_args_for_module_function` / `_coerce_py_assert_args` / `_coerce_dict_key_expr` / `dict.get(default)` の Any 境界 boxing を `Box` ノード経由へ寄せた。`test_east3_cpp_bridge.py` に module 引数・dict[Any,*] key の回帰を追加し、`test_py2cpp_codegen_issues.py` / `test_east3_lowering.py` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認した（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S2] 第1陣の7パッチ目として、`list.append`（`list[Any]`）と `list/set comprehension` の Any boxing を `Box` ノード経由（`_render_append_call_object_method`, `_box_any_target_value`）へ寄せた。`test_east3_cpp_bridge.py` に `list[Any].append` 回帰を追加し、`test_py2cpp_codegen_issues.py` / `test_east3_lowering.py` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認した（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S2] 第1陣の8パッチ目として、`render_cond` の Any/object 条件判定を `ObjBool` 命令経路へ統一し、`if/while` の truthy 評価を backend 直書きから IR-first 写像へ寄せた。`test_east3_cpp_bridge.py` に `render_cond(Any)` 回帰を追加し、`test_py2cpp_codegen_issues.py` / `test_east3_lowering.py` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認した（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S2] 第1陣（boxing/unboxing, iterable, truthy/len/str）の移行が完了したため、`docs-ja/todo/index.md` 側で `P0-EAST123-08-S2` を完了済みに更新した。
- 2026-02-24: [ID: P0-EAST123-08-S3] 第2陣（主要 built-in lower）の着手単位を `S3-S1..S3-S4` へ分割し、`list/set -> dict -> str/special -> backend分岐整理` の順で実装する方針を固定した。
- 2026-02-24: [ID: P0-EAST123-08-S3-S1] `list.append` の BuiltinCall lower に `ListAppend` IR ノード経路を追加し、`render_expr` 側で `list[Any]` の boxing を含む append 生成を命令写像として受理した。`test_east3_cpp_bridge.py` に `ListAppend` ノード単体と BuiltinCall 経路の回帰を追加し、`tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認した（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S1] `list.extend` の BuiltinCall lower に `ListExtend` IR ノード経路を追加し、`render_expr` で `xs.insert(xs.end(), ys.begin(), ys.end())` へ写像する命令経路を受理した。`test_east3_cpp_bridge.py` に `ListExtend` ノード単体と BuiltinCall 経路の回帰を追加し、`tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認した（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S1] `set.add` の BuiltinCall lower に `SetAdd` IR ノード経路を追加し、`render_expr` 側で `set.insert(value)` へ写像する命令経路を受理した。`test_east3_cpp_bridge.py` に `SetAdd` ノード単体と BuiltinCall 経路の回帰を追加し、`tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認した（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S1] `list.pop` / `list.clear` の BuiltinCall lower に `ListPop` / `ListClear` IR ノード経路を追加し、`render_expr` 側で no-index pop と clear を命令写像として受理した。`test_east3_cpp_bridge.py` にノード単体と BuiltinCall 経路の回帰を追加し、`tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認した（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S1] `set.remove/discard` / `set.clear` の BuiltinCall lower に `SetErase` / `SetClear` IR ノード経路を追加し、`render_expr` 側で erase/clear を命令写像として受理した。`test_east3_cpp_bridge.py` にノード単体と BuiltinCall 経路の回帰を追加し、`tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認した（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S1] `list.reverse` / `list.sort` の BuiltinCall lower に `ListReverse` / `ListSort` IR ノード経路を追加し、`render_expr` 側で `std::reverse/sort` へ写像する命令経路を受理した。`test_east3_cpp_bridge.py` にノード単体と BuiltinCall 経路の回帰を追加し、`tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認した（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S1] 現行 `runtime_call` 契約（list: append/extend/pop/clear/reverse/sort, set: add/discard/remove/clear）は IR ノード経路へ移行完了とし、`docs-ja/todo/index.md` 側で `P0-EAST123-08-S3-S1` を完了済みに更新した。
- 2026-02-24: [ID: P0-EAST123-08-S3-S2] `dict.items` / `dict.keys` / `dict.values` の BuiltinCall lower に `DictItems` / `DictKeys` / `DictValues` IR ノード経路を追加し、`render_expr` 側で dict view 系写像を命令経路として受理した。`test_east3_cpp_bridge.py` にノード単体と BuiltinCall 経路の回帰を追加し、`tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認した（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S2] `dict.pop` の default なし経路を `DictPop` IR ノードへ移行し、`render_expr` 側で key 型整形（`_coerce_dict_key_expr`）込みの `pop` 写像を受理した。`test_east3_cpp_bridge.py` にノード単体と BuiltinCall 経路の回帰を追加し、`tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認した（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S2] `dict.get` の default なし経路を `DictGetMaybe` IR ノードへ移行し、`render_expr` 側で key 型整形（`_coerce_dict_key_expr`）込みの `py_dict_get_maybe` 写像を受理した。`test_east3_cpp_bridge.py` にノード単体と BuiltinCall 経路の回帰を追加し、`tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認した（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S2] `dict.get` の default あり経路を `DictGetDefault` IR ノードへ移行し、`render_expr` 側で objectish 判定・key 型整形・default の nullopt 補正を含む既存写像を受理した。`test_east3_cpp_bridge.py` にノード単体と BuiltinCall 経路の回帰を追加し、`tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認した（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S2] `dict.pop` の default あり経路を `DictPopDefault` IR ノードへ移行し、`render_expr` 側で key 型整形（`_coerce_dict_key_expr`）と default nullopt 補正を含む既存写像を受理した。`test_east3_cpp_bridge.py` にノード単体と BuiltinCall 経路の回帰を追加し、`tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認した（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S2] 現行 `dict` runtime_call 契約（`get/pop/items/keys/values`）の IR ノード経路移行が完了したため、`docs-ja/todo/index.md` 側で `P0-EAST123-08-S3-S2` を完了済みに更新した。
- 2026-02-24: [ID: P0-EAST123-08-S3-S3] `py_strip` / `py_lstrip` / `py_rstrip` の BuiltinCall lower に `StrStripOp` IR ノード経路を追加し、`render_expr` 側で mode + optional chars に応じた strip 系写像を受理した。`test_east3_cpp_bridge.py` にノード単体と BuiltinCall 経路の回帰を追加し、`tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認した（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S3] `py_startswith` / `py_endswith` の BuiltinCall lower に `StrStartsEndsWith` IR ノード経路を追加し、`render_expr` 側で start/end 省略時と slice 指定時の写像を受理した。`test_east3_cpp_bridge.py` にノード単体と BuiltinCall 経路の回帰を追加し、`tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認した（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S3] `py_isdigit` / `py_isalpha` の BuiltinCall lower に `StrCharClassOp` IR ノード経路を追加し、`render_expr` 側で `isdigit/isalpha` 写像を受理した。`test_east3_cpp_bridge.py` にノード単体と BuiltinCall 経路の回帰を追加し、`tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認した（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S3] `py_replace` / `py_join` の BuiltinCall lower に `StrReplace` / `StrJoin` IR ノード経路を追加し、`render_expr` 側で replace/join 写像を受理した。`test_east3_cpp_bridge.py` にノード単体と BuiltinCall 経路の回帰を追加し、`tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認した（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S3] `std::filesystem::create_directories/exists` と `py_write_text/py_read_text/path_parent/path_name/path_stem/identity` の BuiltinCall lower を `PathRuntimeOp` IR ノード経路へ移行し、`render_expr` 側で path/special 写像を受理した。`test_east3_cpp_bridge.py` にノード単体と BuiltinCall 経路の回帰を追加し、`python3 -m unittest discover -s test/unit -p 'test_east3_cpp_bridge.py'` / `python3 -m unittest discover -s test/unit -p 'test_py2cpp_codegen_issues.py'` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認した（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S3] `perf_counter/open/Path/std::runtime_error/py_int_to_bytes` の BuiltinCall lower を `RuntimeSpecialOp` IR ノード経路へ移行し、fallback の `runtime_call` 直分岐を縮退した。`test_east3_cpp_bridge.py` にノード単体と BuiltinCall 経路の回帰を追加し、`python3 -m unittest discover -s test/unit -p 'test_east3_cpp_bridge.py'` / `python3 -m unittest discover -s test/unit -p 'test_py2cpp_codegen_issues.py'` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認した（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S3] `py_find/py_rfind` の BuiltinCall lower に `StrFindOp` IR ノード経路を追加し、`render_expr` 側で `find/rfind` 写像を受理した。`test_east3_cpp_bridge.py` にノード単体と BuiltinCall 経路の回帰を追加し、`python3 -m unittest discover -s test/unit -p 'test_east3_cpp_bridge.py'` / `python3 -m unittest discover -s test/unit -p 'test_py2cpp_codegen_issues.py'` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認した（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S3] parser 側 `str_map` に `lstrip/find/rfind` を追加し、`runtime_call=py_lstrip/py_find/py_rfind` の BuiltinCall 生成を有効化した。`test_east_core.py` の `test_builtin_call_lowering_for_common_methods` を拡張し、`python3 -m unittest discover -s test/unit -p 'test_east_core.py'` / `python3 -m unittest discover -s test/unit -p 'test_east3_cpp_bridge.py'` / `python3 -m unittest discover -s test/unit -p 'test_py2cpp_codegen_issues.py'` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認した（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S3] `docs-ja/todo/index.md` 側で S3-S3 を完了済みに更新し、次段の最上位未完了タスクを `P0-EAST123-08-S3-S4`（backend 分岐整理）へ繰り上げた。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] `_render_builtin_call_owner_runtime` の owner 付き `py_*` fallback を汎用化し、`py_replace/py_startswith/py_find` などの個別分岐を削減した。`test_east3_cpp_bridge.py` に helper 回帰（owner 先頭引数）を追加し、`python3 -m unittest discover -s test/unit -p 'test_east3_cpp_bridge.py'` / `python3 -m unittest discover -s test/unit -p 'test_py2cpp_codegen_issues.py'` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認した（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] `py_print/py_len/py_to_string` の BuiltinCall fallback を `RuntimeSpecialOp` ノード経路へ移行し、`_render_builtin_runtime_fallback` の直分岐を縮退した。`test_east3_cpp_bridge.py` の runtime special 回帰を拡張し、`python3 -m unittest discover -s test/unit -p 'test_east3_cpp_bridge.py'` / `python3 -m unittest discover -s test/unit -p 'test_py2cpp_codegen_issues.py'` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認した（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] `py_min/py_max` の BuiltinCall fallback を `RuntimeSpecialOp(op=minmax)` ノード経路へ移行し、`_render_builtin_runtime_fallback` から min/max 直分岐を撤去した。`test_east3_cpp_bridge.py` にノード単体と BuiltinCall 経路の回帰を追加し、`python3 -m unittest discover -s test/unit -p 'test_east3_cpp_bridge.py'` / `python3 -m unittest discover -s test/unit -p 'test_py2cpp_codegen_issues.py'` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認した（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] `_render_builtin_runtime_str_ops` の `py_isdigit/isalpha/strip/lstrip/rstrip` に残っていた到達不能 fallback 分岐を削除し、IR ノード描画経路へ統一した。`python3 -m unittest discover -s test/unit -p 'test_east3_cpp_bridge.py'` / `python3 -m unittest discover -s test/unit -p 'test_py2cpp_codegen_issues.py'` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認した（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] `_render_builtin_runtime_fallback` の未使用パラメータ（`expr`, `fn`, `arg_nodes`, `first_arg`）を除去し、fallback の責務を `runtime_call + args + owner_expr` のみに整理した。`python3 -m unittest discover -s test/unit -p 'test_east3_cpp_bridge.py'` / `python3 -m unittest discover -s test/unit -p 'test_py2cpp_codegen_issues.py'` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認した（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] `_render_builtin_runtime_str_ops` の `startswith/endswith/find/replace/join` で残っていた文字列 fallback を撤去し、`arg_nodes` 起点の IR ノード生成（`StrStartsEndsWith`/`StrFindOp`/`StrReplace`/`StrJoin`）へ統一した。`python3 -m unittest discover -s test/unit -p 'test_east3_cpp_bridge.py'` / `python3 -m unittest discover -s test/unit -p 'test_py2cpp_codegen_issues.py'` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認した（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] `py_join` の fallback 専用分岐と `_render_builtin_join_call` helper を削除し、join 系は `StrJoin` IR ノード経路のみへ収束させた。`python3 -m unittest discover -s test/unit -p 'test_east3_cpp_bridge.py'` / `python3 -m unittest discover -s test/unit -p 'test_py2cpp_codegen_issues.py'` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認した（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] `BuiltinCall` 汎用 fallback（`_render_builtin_runtime_fallback` / `_render_builtin_call_owner_expr` / `_render_builtin_call_owner_runtime`）を削除し、parser が生成する `runtime_call` 契約は list/set/dict/str/special の IR ノード分岐で直接受理する構成へ整理した。`test_east3_cpp_bridge.py` / `test_py2cpp_codegen_issues.py` / `test_east_core.py` と `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で回帰確認した（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] `BuiltinCall` の入力契約を `arg_nodes/kw_nodes` 中心へ寄せ、`_render_builtin_call` と `static_cast/list/set/dict/special` helper から文字列 `args/kw` fallback 分岐を段階撤去した。`dict.get/pop` は IR ノード（`DictGetMaybe/DictGetDefault/DictPop/DictPopDefault`）のみを構築する経路へ整理し、`mkdir` の keyword-only 呼び出しは `keywords` ノード名対応で `PathRuntimeOp` へ lower するよう回帰テストを追加した。`python3 -m unittest discover -s test/unit -p 'test_east3_cpp_bridge.py'` / `python3 -m unittest discover -s test/unit -p 'test_py2cpp_codegen_issues.py'` / `python3 -m unittest discover -s test/unit -p 'test_east_core.py'` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認した（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] `render_expr` 側に残っていた `PathRuntimeOp` / `RuntimeSpecialOp` の `*_expr`・`arg_exprs` 互換分岐（`parents_expr/exist_ok_expr/value_expr/arg_exprs/message_expr/length_expr/byteorder_expr`）を撤去し、IR ノード（`parents/exist_ok/value/args/message/length/byteorder`）のみを受理する契約へ整理した。`test_east3_cpp_bridge.py` の旧互換ノード回帰を契約準拠へ更新し、`python3 -m unittest discover -s test/unit -p 'test_east3_cpp_bridge.py'` / `python3 -m unittest discover -s test/unit -p 'test_py2cpp_codegen_issues.py'` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認した（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] `bytes/bytearray` の BuiltinCall 直描画分岐を撤去し、`RuntimeSpecialOp(op=bytes_ctor/bytearray_ctor)` ノード経路へ統一した。`render_expr` 側に ctor 写像を追加し、`test_east3_cpp_bridge.py` にノード単体・BuiltinCall 経路の回帰を追加した。`python3 -m unittest discover -s test/unit -p 'test_east3_cpp_bridge.py'` / `python3 -m unittest discover -s test/unit -p 'test_py2cpp_codegen_issues.py'` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認した（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] `Call` 描画入口の Builtin 判定を `lowered_kind == BuiltinCall` のみに限定し、`runtime_call` キー有無だけで Builtin 分岐へ入る旧経路を撤去した。`runtime_call` を付与する parser 側は `lowered_kind` も同時設定する契約のため互換性を維持しつつ、backend 再判断経路を1段縮退した。`python3 -m unittest discover -s test/unit -p 'test_east3_cpp_bridge.py'` / `python3 -m unittest discover -s test/unit -p 'test_py2cpp_codegen_issues.py'` / `python3 -m unittest discover -s test/unit -p 'test_east_core.py'` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認した（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] `lowered_kind=BuiltinCall` が未処理のまま一般 `Call` fallback へ流れる経路を停止し、未処理時は `ValueError(unhandled BuiltinCall)` で fail-fast する契約に変更した。これにより BuiltinCall の backend 再判断を実行時に検出可能にし、IR-first 運用を強制した。`python3 -m unittest discover -s test/unit -p 'test_east3_cpp_bridge.py'` / `python3 -m unittest discover -s test/unit -p 'test_py2cpp_codegen_issues.py'` / `python3 -m unittest discover -s test/unit -p 'test_east_core.py'` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認した（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] `StrFindOp` が出力する `py_find/py_rfind` 呼び出し契約に合わせ、C++ runtime（`py_runtime.h`）へ `py_find/py_rfind` の `str/object/any` 各オーバーロード（start/end 範囲付き）を追加した。これにより IR-first 側で導入済みの find/rfind lower と runtime API の欠落を埋め、backend での ad-hoc fallback 追加を回避した。`python3 -m unittest discover -s test/unit -p 'test_east3_cpp_bridge.py'` / `python3 -m unittest discover -s test/unit -p 'test_py2cpp_codegen_issues.py'` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で回帰なし（selfhost 差分は既知3件維持）を確認した。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] `bytes/bytearray` の Builtin lower 契約を parser 側で `runtime_call=bytes_ctor/bytearray_ctor` まで明示する形へ更新し、emitter 側は `runtime_call` 受理のみで `RuntimeSpecialOp` へ写像する構成に整理した（`builtin_name` 特例を縮退）。`test_east_core.py` に runtime_call 生成回帰を追加し、`test_east3_cpp_bridge.py` の BuiltinCall 回帰を新契約へ更新した。`python3 -m unittest discover -s test/unit -p 'test_east3_cpp_bridge.py'` / `python3 -m unittest discover -s test/unit -p 'test_east_core.py'` / `python3 -m unittest discover -s test/unit -p 'test_py2cpp_codegen_issues.py'` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認した（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] parser 側で `iter/next` を `BuiltinCall(runtime_call=py_iter_or_raise/py_next_or_stop)` として明示し、`py2cpp` 側は `RuntimeSpecialOp(op=iter_or_raise/next_or_stop)` 経路で受理するよう統一した。`_build_any_boundary_expr_from_builtin_call` から `iter/next` 特例を外し、BuiltinCall の backend 再判断を 1 段縮退。`test_east_core.py` / `test_east3_cpp_bridge.py` / `test_py2cpp_codegen_issues.py` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で回帰確認（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] parser 側で `bool(object|Any)` を `runtime_call=py_to_bool` として明示し、`py2cpp` の Any 境界判定（`_build_any_boundary_expr_from_builtin_call`）を `builtin_name=bool` 依存から `runtime_call` 依存へ移行した。これにより BuiltinCall の backend 再判断（`builtin_name` 起点）をさらに縮退。`test_east_core.py` / `test_east3_cpp_bridge.py` / `test_py2cpp_codegen_issues.py` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で回帰確認（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] `int(x, base)` の BuiltinCall を parser 側で `runtime_call=py_to_int64_base` へ明示し、`py2cpp` 側は `RuntimeSpecialOp(op=int_base)` 経路で受理するよう統一した。`_render_builtin_static_cast_call` に残っていた `builtin_name=int && len(args)==2` 再判断分岐を撤去し、parser/runtime_call 契約へ一本化。`test_east_core.py` / `test_east3_cpp_bridge.py` / `test_py2cpp_codegen_issues.py` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で回帰確認（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] `runtime_call=static_cast` 経路の helper シグネチャから不要になった `builtin_name` 引数を削除し、BuiltInCall の判定責務を `runtime_call` 中心へ整理した。`test_east3_cpp_bridge.py` / `test_py2cpp_codegen_issues.py` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で回帰確認（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] `_build_any_boundary_expr_from_builtin_call` の入力契約を `runtime_call` のみに絞り、`len/str` の `builtin_name` 再判断分岐と対応シグネチャを撤去した。`_render_builtin_call` 側も `runtime_call` のみで Any 境界ノードへ振り分けるよう整理し、BuiltinCall 判定をさらに IR-first 契約へ寄せた。`test_east_core.py` / `test_east3_cpp_bridge.py` / `test_py2cpp_codegen_issues.py` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で回帰確認（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] hooks 無効時の selfhost 差分要因を減らすため、`_default_stmt_omit_braces` / `_default_for_range_mode` を `py2cpp` core に導入し、`If/For/ForRange` の brace 省略と `ForRange` mode 解決を hook 既定値として内蔵した。`range_mode=dynamic` かつ `step=1/-1` の場合は core 既定で `ascending/descending` へ正規化する。`test_py2cpp_codegen_issues.py` に dynamic hooks 無効回帰を追加し、`test_east_core.py` / `test_east3_cpp_bridge.py` / `test_py2cpp_codegen_issues.py` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] `hooks/cpp` の `on_stmt_omit_braces` / `on_for_range_mode` を core 既定実装（`_default_stmt_omit_braces` / `_default_for_range_mode`）へ委譲する形に整理し、hooks 側の方針重複を縮退した。core 実装がない emitter では既存ロジックへフォールバックする。`test_cpp_hooks.py` に委譲回帰を追加し、`test_py2cpp_codegen_issues.py` / `test_east3_cpp_bridge.py` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] `hooks/cpp` 委譲変更の安全性を固定するため、`test_cpp_hooks.py` にフォールバック経路（core 既定実装が存在しない emitter）回帰を追加した。`on_stmt_omit_braces` / `on_for_range_mode` が従来ロジックへ戻ることを明示的に検証し、委譲追加で互換性が崩れないことを担保した。`test_cpp_hooks.py` / `test_py2cpp_codegen_issues.py` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] `hooks/cpp._can_omit_braces_for_single_stmt` も emitter 側の `_can_omit_braces_for_single_stmt` 実装へ委譲可能にし、brace 判定ロジックの重複をさらに縮退した。`test_cpp_hooks.py` に委譲経路回帰を追加し、`test_py2cpp_codegen_issues.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] hooks 側に残っていた brace/mode 方針ロジックをさらに縮退し、`on_stmt_omit_braces` は `default_value`（core 既定値）を返す薄い委譲、`on_for_range_mode` は `default_mode`（core 既定値）を返す薄い委譲へ整理した。これにより `hooks/cpp` 側の意味論方針重複を削除し、core 実装が唯一の正本になる。`test_cpp_hooks.py` のフォールバック期待値も新契約へ更新し、`test_py2cpp_codegen_issues.py` / `test_east3_cpp_bridge.py` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] `EAST2 -> EAST3` の Any 境界 call lower を `runtime_call` 優先へ更新し、`ObjBool/ObjLen/ObjStr/ObjIter*` 生成を `py_to_bool/py_len/py_to_string/py_iter_or_raise/py_next_or_stop` 契約で受理するよう整理した。`builtin_name`/`func.id` は legacy stage2 入力の互換フォールバックに限定。`test_east3_lowering.py` に runtime_call 契約ケースと legacy 互換ケースの回帰を追加し、`test_east3_cpp_bridge.py` / `test_py2cpp_codegen_issues.py` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] `EAST3` Any 境界 lower の legacy フォールバック適用条件を `lowered_kind == BuiltinCall` に限定し、一般 `Call` を関数名だけで builtin 再解釈しない契約へ整理した。`test_east3_lowering.py` に「plain call は Call のまま維持」回帰を追加し、runtime_call 契約を正本・legacy を限定互換に明確化した。`test_east3_cpp_bridge.py` / `test_py2cpp_codegen_issues.py` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] `py2cpp` の `Call(Name=...)` に残っていた `print/len/int/float/bool/min/max/iter/next/bytes/bytearray/...` の backend 再判断を縮退するため、parser が `BuiltinCall` へ lower 済みであるべき名前は plain `Call` 受理を禁止して `ValueError` で fail-fast する契約へ変更した。`test_east3_cpp_bridge.py` に plain `print(...)` が契約違反になる回帰を追加し、`test_east3_lowering.py` / `test_east3_cpp_bridge.py` / `test_py2cpp_codegen_issues.py` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] 上記 fail-fast 契約に合わせ、`_render_simple_name_builtin_call` と `_render_call_fallback` に残っていた `print/len` の到達不能 fallback 分岐を削除し、BuiltinCall lower 後の backend 再判断経路をさらに縮退した。`test_east3_cpp_bridge.py` / `test_py2cpp_codegen_issues.py` / `test_east3_lowering.py` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] `Call(Name)` の misc fallback から契約上到達不能になった `bytes/bytearray/str/int/min/max/perf_counter/Exception/RuntimeError/Path` 分岐を撤去し、`_render_scalar_cast_builtin_call` helper も削除した。`_render_misc_name_builtin_call` は `ord/chr` のみを担当する構成へ整理し、Name-call 経路の backend 再判断面積を縮小した。`test_east3_cpp_bridge.py` / `test_py2cpp_codegen_issues.py` / `test_east3_lowering.py` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] `Call(Name)` で到達不能になっていた plain-call Any境界 helper（`_build_any_boundary_expr_from_call_name`）と `isinstance` fallback（`_render_isinstance_type_check` / `_render_call_fallback` 内分岐）を削除し、`bool/len/str/iter/next` は BuiltinCall 契約違反として fail-fast、`isinstance` は type_id IR ノード経路へ一本化した。`test_east3_cpp_bridge.py` に plain `len(...)` fail-fast と plain `isinstance(...)` の IR 経路回帰を追加し、`test_east3_lowering.py` / `test_east3_cpp_bridge.py` / `test_py2cpp_codegen_issues.py` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] `reversed/enumerate/any/all` を parser 側で `BuiltinCall(runtime_call=py_reversed/py_enumerate/py_any/py_all)` として明示する契約へ移行し、`py2cpp` 側の plain Name 分岐（`_render_simple_name_builtin_call`）を撤去した。`_requires_builtin_call_lowering` に同4種を追加し、未lower入力は fail-fast させる。`test_east_core.py` と `test_east3_cpp_bridge.py` を拡張し、新 runtime_call 生成・描画と plain `any(...)` 契約違反を固定した。`test_east3_lowering.py` / `test_east3_cpp_bridge.py` / `test_py2cpp_codegen_issues.py` / `test_east_core.py` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] BuiltinCall 契約を `Call(Name)` 分岐だけでなく最終 `_render_call_fallback` にも適用し、`fn_name=print/len/...` が非標準経路で流入した場合も fail-fast で検出できるようにした。`test_east3_cpp_bridge.py` に `_render_call_fallback("print", ...)` の契約テストを追加し、`test_east3_cpp_bridge.py` / `test_east3_lowering.py` / `test_py2cpp_codegen_issues.py` / `test_east_core.py` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] `ord/chr` も parser 側で `BuiltinCall(runtime_call=py_ord/py_chr)` を明示する契約へ移行し、`py2cpp` の plain Name fallback（`_render_misc_name_builtin_call`）を撤去した。`_requires_builtin_call_lowering` に `ord/chr` を追加し、未lower入力は fail-fast。`test_east_core.py` と `test_east3_cpp_bridge.py` を更新し、新 runtime_call 生成・描画と plain `ord(...)` 契約違反を固定した。`test_east_core.py` / `test_east3_cpp_bridge.py` / `test_east3_lowering.py` / `test_py2cpp_codegen_issues.py` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] `list/set/dict` コンストラクタも parser 側で `BuiltinCall(runtime_call=list_ctor/set_ctor/dict_ctor)` を明示する契約へ移行し、`py2cpp` 側は `runtime_call` 受理で既存 `_render_collection_constructor_call` へ写像する構成に整理した。`_requires_builtin_call_lowering` に `list/set/dict` を追加し、plain `list(...)` は fail-fast 化。`test_east_core.py` と `test_east3_cpp_bridge.py` を更新し、新 runtime_call 生成・描画と契約違反検出を固定した。`test_east_core.py` / `test_east3_cpp_bridge.py` / `test_east3_lowering.py` / `test_py2cpp_codegen_issues.py` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] `range` も parser 側で `BuiltinCall(runtime_call=py_range)` を明示する契約へ移行し、`py2cpp` の plain `Call(Name=range)` 特例を撤去した。`_requires_builtin_call_lowering` に `range` を追加し、未lower入力は fail-fast 化。`_render_builtin_runtime_special_ops` で `runtime_call=py_range` を受理して `py_range(start, stop, step)` 正規化へ写像し、`test_east_core.py` / `test_east3_cpp_bridge.py` / `test_east3_lowering.py` / `test_py2cpp_codegen_issues.py` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で回帰確認した（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] `py_range` 契約の回帰を強化するため、parser 側で `range(start=..., stop=..., step=...)` の keyword 保持テスト（`test_east_core.py`）と、emitter 側で `BuiltinCall(runtime_call=py_range)` keyword 経路の `py_range(1, 5, 2)` 正規化テスト（`test_east3_cpp_bridge.py`）を追加した。`test_east_core.py` / `test_east3_cpp_bridge.py` / `test_east3_lowering.py` / `test_py2cpp_codegen_issues.py` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] `zip` も parser 側で `BuiltinCall(runtime_call=zip)` を明示する契約へ移行し、`py2cpp` 側は `runtime_call=zip` 受理で `zip(lhs, rhs)` へ写像する構成へ整理した。`_requires_builtin_call_lowering` に `zip` を追加して plain `zip(...)` は fail-fast 化。`test_east_core.py` / `test_east3_cpp_bridge.py` を更新し、runtime_call 生成・描画と契約違反検出を固定した。`test_east_core.py` / `test_east3_cpp_bridge.py` / `test_east3_lowering.py` / `test_py2cpp_codegen_issues.py` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] `py_reversed/py_enumerate/py_any/py_all/py_ord/py_chr/zip` の BuiltinCall 受理を `RuntimeSpecialOp` ノード経由へ統一し、`_render_builtin_runtime_special_ops` の直接文字列返却分岐を縮退した。`render_expr(kind=RuntimeSpecialOp)` に `reversed/enumerate/any/all/ord/chr/zip` の写像を追加し、`test_east3_cpp_bridge.py` の IR ノード回帰を拡張した。`test_east3_cpp_bridge.py` / `test_east_core.py` / `test_east3_lowering.py` / `test_py2cpp_codegen_issues.py` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] `py_range` の BuiltinCall 受理も `RuntimeSpecialOp(op=range)` ノード経路へ移行し、`_render_builtin_runtime_special_ops` 内の直接 `py_range(...)` 文字列返却を撤去した。`RuntimeSpecialOp` 側で `args + kw_names/kw_values` から `py_range(start, stop, step)` 正規化を行う契約へ統一し、`test_east3_cpp_bridge.py` に range ノード回帰（位置引数/キーワード引数）を追加した。`test_east3_cpp_bridge.py` / `test_east_core.py` / `test_east3_lowering.py` / `test_py2cpp_codegen_issues.py` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] parser 側 BuiltinCall 契約の抜け漏れを防ぐため、`test_east_core.py` に「`lowered_kind=BuiltinCall` ノードは必ず `runtime_call` を持つ」回帰テストを追加した。対象サンプルに `print/len/str/int/bool/range/zip` と `str/path` メソッドを含め、runtime_call 未設定の混入を fail-fast で検出できるよう固定した。`test_east_core.py` / `test_east3_cpp_bridge.py` / `test_east3_lowering.py` / `test_py2cpp_codegen_issues.py` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] `list_ctor/set_ctor/dict_ctor` の BuiltinCall 受理を `RuntimeSpecialOp(op=collection_ctor)` ノード経路へ移行し、`_render_builtin_runtime_special_ops` での直接 `_render_collection_constructor_call` 呼び出しを縮退した。`render_expr(kind=RuntimeSpecialOp)` 側に `collection_ctor` 写像を追加し、`test_east3_cpp_bridge.py` に IR ノード回帰を追加した。`test_east3_cpp_bridge.py` / `test_east_core.py` / `test_east3_lowering.py` / `test_py2cpp_codegen_issues.py` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] `runtime_call=static_cast` の BuiltinCall 受理を `RuntimeSpecialOp(op=static_cast)` ノード経路へ移行し、`_render_builtin_call` での直接 `_render_builtin_static_cast_call` 分岐を縮退した。`render_expr(kind=RuntimeSpecialOp)` 側に `static_cast` 写像を追加し、既存 `_render_builtin_static_cast_call` をノード描画から再利用する形へ整理した。`test_east3_cpp_bridge.py` に `RuntimeSpecialOp(op=static_cast)` 回帰を追加し、`test_east3_cpp_bridge.py` / `test_east_core.py` / `test_east3_lowering.py` / `test_py2cpp_codegen_issues.py` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] `Call(Name)` 側に残っていた `set/list/dict` コンストラクタの非IR fallback（`_render_collection_constructor_call` 直接呼び出し）を削除し、collection ctor は `BuiltinCall(runtime_call=* _ctor)` -> `RuntimeSpecialOp(op=collection_ctor)` 経路のみで受理する契約へ整理した。`test_east3_cpp_bridge.py` / `test_east_core.py` / `test_east3_lowering.py` / `test_py2cpp_codegen_issues.py` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で回帰確認（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] method 系 BuiltinCall の owner 受理を `runtime_owner` 優先へ統一した。parser 側で `Path/int/list/set/dict/unknown` の method lower に `runtime_owner` を付与し、`py2cpp` 側は `_builtin_runtime_owner_node` で `runtime_owner -> func.value` の順に解決する契約へ変更。`list/set/dict/str/path/int_to_bytes` の IR 生成が `func.value` 欠落でも成立するようにした。`test_east_core.py` に `runtime_owner` 付与回帰を追加し、`test_east3_cpp_bridge.py` に `func.value` 欠落時の `runtime_owner` 利用回帰を追加した。`test_east_core.py` / `test_east3_cpp_bridge.py` / `test_east3_lowering.py` / `test_py2cpp_codegen_issues.py` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] BuiltinCall helper 群の `fn` 依存を削減し、`_render_builtin_runtime_list_ops/set_ops/dict_ops/str_ops/special_ops` を `expr` 中心の受理へ統一した。receiver 解決は `_builtin_runtime_owner_node(expr)`（`runtime_owner` -> `expr.func.value`）へ一本化し、`_render_builtin_call` は helper へ `expr` とノード配列のみを渡す構成へ整理した。`test_east_core.py` / `test_east3_cpp_bridge.py` / `test_east3_lowering.py` / `test_py2cpp_codegen_issues.py` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で回帰確認（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] method 系 `BuiltinCall` の owner 受理をさらに厳格化し、`list/set/dict/str/path/int_to_bytes` の `runtime_call` で `runtime_owner` と `func.value` の双方が欠落した場合は `ValueError("builtin runtime owner is required: ...")` で fail-fast する契約へ変更した。同時に `_render_builtin_call` から未使用 `fn` 引数を削除し、`dict` helper も `arg_nodes` 経路へ統一した。`test_east3_cpp_bridge.py` に `list.append` / `std::filesystem::exists` の owner 欠落回帰を追加し、`test_east_core.py` / `test_east3_cpp_bridge.py` / `test_east3_lowering.py` / `test_py2cpp_codegen_issues.py` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] plain `Call(Attribute)` に残っていた built-in method 再判断経路を縮退するため、`_requires_builtin_method_call_lowering(...)` を導入し、parser が `BuiltinCall` へ lower 済みであるべき method（`list/set/dict/str/Path/int.to_bytes` と unknown owner の既定集合）を一般 `Call` で受理しない fail-fast 契約へ統一した。これに合わせて `_render_call_fallback` の `.append` 専用文字列 fallback（`_render_append_fallback_call`）を削除し、non-IR 迂回経路を縮退した。`test_east3_cpp_bridge.py` に plain method call / fallback の契約テストを追加し、`test_east_core.py` / `test_east3_cpp_bridge.py` / `test_east3_lowering.py` / `test_py2cpp_codegen_issues.py` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で確認（selfhost 差分は既知3件維持）。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] `hooks/cpp` の `on_render_object_method` を `build_cpp_hooks()` の登録対象から外し、object method の built-in 意味論を hook 側で補完しない構成へ縮退した（core 側の `BuiltinCall` 契約 + fail-fast を正本化）。`test_cpp_hooks.py` に未登録回帰（`on_render_object_method` 非登録）を追加し、`tools/check_cpp_hooks_semantic_budget.py` で semantic hook 数が `4 -> 3` へ減少したことを確認。加えて `test_cpp_hooks.py` / `test_east3_cpp_bridge.py` / `test_py2cpp_codegen_issues.py` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で回帰なし（selfhost 差分は既知3件維持）を確認した。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] `hooks/cpp` の `on_render_expr_kind` も `build_cpp_hooks()` の登録対象から外し、`RangeExpr` / `Compare(lowered_kind=Contains)` の式意味論は `py2cpp` core 実装を正本化した。`test_cpp_hooks.py` に未登録回帰（`on_render_expr_kind` 非登録）を追加し、`tools/check_cpp_hooks_semantic_budget.py` で semantic hook 数が `3 -> 2` へ減少したことを確認。`test_cpp_hooks.py` / `test_east3_cpp_bridge.py` / `test_py2cpp_codegen_issues.py` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で回帰なし（selfhost 差分は既知3件維持）を確認した。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] `hooks/cpp` の `on_render_binop` も `build_cpp_hooks()` の登録対象から外し、`Div/FloorDiv/Mod/Mult` の式意味論は `py2cpp` core の `_render_binop_expr` を正本化した。`test_cpp_hooks.py` に未登録回帰（`on_render_binop` 非登録）を追加し、`tools/check_cpp_hooks_semantic_budget.py` で semantic hook 数が `2 -> 1`（`on_for_range_mode` のみ）へ減少したことを確認。`test_cpp_hooks.py` / `test_east3_cpp_bridge.py` / `test_py2cpp_codegen_issues.py` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で回帰なし（selfhost 差分は既知3件維持）を確認した。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] `hooks/cpp` の `on_for_range_mode` も `build_cpp_hooks()` の登録対象から外し、ForRange mode 決定は `py2cpp` core 既定値（`_default_for_range_mode`）を唯一の正本にした。`test_cpp_hooks.py` に未登録回帰（`on_for_range_mode` 非登録）を追加し、`tools/check_cpp_hooks_semantic_budget.py` で semantic hook 数が `1 -> 0` へ減少したことを確認。`test_cpp_hooks.py` / `test_east3_cpp_bridge.py` / `test_py2cpp_codegen_issues.py` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で回帰なし（selfhost 差分は既知3件維持）を確認した。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] `BuiltinCall` method fail-fast 強化後、`self_hosted` parser が一部 `str` method call（例: `endswith`）を `BuiltinCall` に lower しきれず selfhost 変換が停止することを確認した。互換維持のため、`parser_backend=self_hosted` に限って plain method の legacy fallback（`_render_legacy_builtin_method_call`）を core 側へ追加し、native parser では従来どおり fail-fast 契約を維持した。`test_east3_cpp_bridge.py` に self_hosted 互換回帰（plain `str.endswith` -> `py_endswith`）を追加し、`test_east3_cpp_bridge.py` / `test_py2cpp_codegen_issues.py` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で回帰なし（selfhost 差分は既知3件維持）を確認した。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] `hooks/cpp` の semantic 登録が `0` になった基線に合わせ、`tools/run_local_ci.py` の budget を `--max-semantic 4` から `--max-semantic 0` へ引き締めた。`tools/check_cpp_hooks_semantic_budget.py --max-semantic 0` で gate 通過を確認し、semantic hook の再流入を CI で即時検知できる状態に更新した。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] C++ hooks の `on_render_call` no-op 登録を `build_cpp_hooks()` から撤去し、hook 面積を `total=7/noop=1` から `total=6/noop=0` へ縮退した。`test_cpp_hooks.py` から no-op 専用回帰を除去し、`python3 -m unittest discover -s test/unit -p 'test_cpp_hooks.py'` / `python3 -m unittest discover -s test/unit -p 'test_east3_cpp_bridge.py'` / `python3 -m unittest discover -s test/unit -p 'test_py2cpp_codegen_issues.py'` / `python3 tools/check_cpp_hooks_semantic_budget.py --max-semantic 0` / `python3 tools/check_py2cpp_transpile.py` で回帰なしを確認した。`python3 tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は既知の `mismatches=3`（`if_else.py`, `sample/py/01_mandelbrot.py`, `sample/py/17_monte_carlo_pi.py`）を維持した。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] selfhost 更新の阻害になっていた `prepare_selfhost_source.py` 抽出漏れを補い、`collect_store_names_from_target_plan` / `normalize_east_root_document` / `normalize_east1_to_east2_document` を selfhost 展開対象へ追加した。あわせて `load_east3_document` は selfhost 互換 stub（`load_east_document` へフォールバック）として内挿し、`transpile_cli.load_east_document` のルート正規化処理を top-level helper 化して selfhost 変換時の入れ子関数依存を減らした。`test_prepare_selfhost_source.py` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` で回帰なし（差分3件維持）を確認。`tools/build_selfhost.py` は引き続き C++ 変換互換エラーで失敗するため、次段で selfhost-safe への段階分解が必要。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] `transpile_cli.load_east_document` の selfhost 互換性をさらに上げるため、`normalize_east_root_document(...)` 呼び出し前の入力を明示 `dict[str, object]` 変数へ受ける形に調整し、生成 C++ の先頭で出ていた rvalue -> 非 const 参照束縛エラーを解消した。`tools/build_selfhost.py` は次段の互換エラー（`Path` 演算/真偽値評価/hook callable 変換など）で引き続き失敗するが、阻害箇所は先頭の import/load 系から後段へ進んだ。`test_prepare_selfhost_source.py` と `tools/check_py2cpp_transpile.py` は通過を維持。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] `src/py2cpp.py` の selfhost-safe 化として、`Path` の `/` 連結依存を `_join_runtime_path(...)` へ集約し、`_runtime_cpp_header_exists_for_module` と runtime C++ 出力先計算（`cpp_out/hdr_out/compat_*`）を文字列連結ベースへ置換した。あわせて `tail/raw/target_ns/runtime_prefix/symbol/import_maps/src_path` などの `str/list/dict` 真偽値判定を明示比較（`!= ""`, `len(...) > 0`）へ揃え、selfhost 生成 C++ の型不整合を削減した。`test_east3_cpp_bridge.py` / `test_py2cpp_codegen_issues.py` / `tools/check_py2cpp_transpile.py` / `tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は回帰なし（差分3件維持）。`tools/build_selfhost.py` は失敗継続だが、先頭阻害は `Path`/真偽値系から `CodeEmitter._call_hook` callable 変換系へ進んだ。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] selfhost C++ 変換失敗点を追加縮退した。`load_cpp_type_map/load_cpp_identifier_rules` の optional 依存を整理し、`_emit_stmt_kind_fallback` を method table から `if/elif` へ置換、`_infer_module_global_decl_type` などの文字列 truthy 判定を明示比較へ統一、`_header_guard_from_path/_header_allows_none_default/_analyze_import_graph` の selfhost 非互換構文（`or`/`dict` append/try 変数スコープ）を修正した。さらに `prepare_selfhost_source.py` の `_call_hook` stub 化と組み合わせて、`tools/build_selfhost.py` は C++ compile エラー段階を通過し、現状はリンク時の重複定義（multiple definition）で停止する段階まで前進した。`test_prepare_selfhost_source.py` / `test_py2cpp_codegen_issues.py` / `test_east3_cpp_bridge.py` / `tools/check_py2cpp_transpile.py` は通過を維持。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] selfhost ビルド導線の次段として、`tools/build_selfhost.py` の runtime 収集から `cpp/pytra/*` forwarder TU を除外し、`pytra-core/pytra-gen` 実体との多重定義リンクエラーを解消した。加えて `src/runtime/cpp/pytra-core/built_in/dict.h` の `operator[]` に `bucket_count()==0` ガード（`rehash(1)`）を追加し、selfhost 起動時の FPE（type_id 初期化）を回避した。`tools/build_selfhost.py` は再び `selfhost/py2cpp.out` 生成まで到達。`tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=6`（`str_join_method`, `comprehension_filter`, `enum_*`, `sample/py/{01,17}`）で未解消のため、次段で絶対パス入力時クラッシュ要因の切り分けが必要。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] `_analyze_import_graph` の隣接リスト更新を `dict_any_get_list(...)` 依存から型付き `list[str]` 更新（`if cur_key in graph_adj: deps = graph_adj[cur_key]`）へ変更し、selfhost 生成 C++ で `list<object>` に崩れる三項演算子経路を排除した。`tools/check_py2cpp_transpile.py` と `tools/build_selfhost.py` は通過を維持。`tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は引き続き `mismatches=6` で、機能回帰ではなく未解決クラッシュ群の継続を確認した。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] `CodeEmitter.declare_in_current_scope` / `CppEmitter.declare_in_current_scope` のスコープ更新を「copy + 再代入」から「`self.scope_stack[-1]` 直接更新」へ統一し、selfhost C++ 実行時の `set<str>` 代入経路由来クラッシュ余地を縮退した。空スコープ時は `set()` を補うガードを追加。`test_east3_cpp_bridge.py` / `test_py2cpp_codegen_issues.py` / `test_cpp_hooks.py` / `test_prepare_selfhost_source.py` / `tools/check_py2cpp_transpile.py` / `tools/build_selfhost.py` を通過、`tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` は `mismatches=6`（`str_join_method`, `comprehension_filter`, `enum_*`, `sample/py/{01,17}`）で据え置きを確認した。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] `BuiltinCall` ノード生成部（`_render_builtin_runtime_{list,set,dict,str}_ops`）の一時 dict に `dict[str, Any]` 型注釈を付与し、selfhost 生成 C++ での `dict<str,str>` への狭まりを抑止した。`str_join_method` / `comprehension_filter` / `enum_basic` / `enum_extended` の `/* none */` 差分が解消し、`tools/check_selfhost_cpp_diff.py --selfhost-driver bridge --mode allow-not-implemented` は `mismatches=0` を達成。
- 2026-02-24: [ID: P0-EAST123-08-S3-S4] direct parser 互換として、`runtime_call` 欠落の legacy `BuiltinCall`（`builtin_name=bytearray/bytes`）を `bytearray_ctor/bytes_ctor` へ補完し、`self_hosted` 文書の statement trivia は directive のみ反映するよう `CppEmitter.emit_leading_comments` を調整した。これにより `sample/py/01_mandelbrot.py` の internal error（`unhandled BuiltinCall: runtime_call=, builtin_name=bytearray`）と `sample/py/17_monte_carlo_pi.py` の空行差分を解消し、`tools/check_selfhost_cpp_diff.py --mode allow-not-implemented` / `--selfhost-driver bridge --mode allow-not-implemented` の双方で `mismatches=0` を確認。`docs-ja/todo/index.md` の `P0-EAST123-08` / `P0-EAST123-08-S3` / `P0-EAST123-08-S3-S4` を完了へ更新した。
