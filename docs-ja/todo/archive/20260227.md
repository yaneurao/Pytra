# TODO履歴（2026-02-27）

<a href="../../../docs/todo/archive/20260227.md">
  <img alt="Read in English" src="https://img.shields.io/badge/docs-English-2563EB?style=flat-square">
</a>

## 2026-02-27 移管: `P3: Java backend の EAST3 直生成移行（sidecar 撤去）（低優先）`

以下を `docs-ja/todo/index.md` から `todo/archive` へ移管。


文脈: [docs-ja/plans/p3-java-native-rollout.md](../plans/p3-java-native-rollout.md)

1. [x] [ID: P3-JAVA-NATIVE-01] Java backend を `EAST3 -> Java native emitter` 直生成経路へ移行し、sidecar JS 依存を既定経路から除去する。
2. [x] [ID: P3-JAVA-NATIVE-01-S1-01] Java backend 契約（入力 EAST3 ノード責務、未対応時 fail-closed、runtime 境界）を文書化し、preview 出力との差分を明示する。
3. [x] [ID: P3-JAVA-NATIVE-01-S1-02] `src/hooks/java/emitter` に native emitter 骨格を追加し、module/function/class の最小実行経路を通す。
4. [x] [ID: P3-JAVA-NATIVE-01-S1-03] `py2java.py` に backend 切替配線を追加し、既定を native、旧 sidecar を互換モードへ隔離する。
5. [x] [ID: P3-JAVA-NATIVE-01-S2-01] 式/文（算術、条件、ループ、関数呼び出し、組み込み基本型）を native emitter へ実装し、`sample/py` 前半ケースを通す。
6. [x] [ID: P3-JAVA-NATIVE-01-S2-02] class/instance/isinstance 系と runtime フックを native 経路へ接続し、OOP 系ケースを通す。
7. [x] [ID: P3-JAVA-NATIVE-01-S2-03] `import math` と画像系ランタイム呼び出し（`png`/`gif`）の最小互換を整備し、sample 実運用ケースへ対応する。
8. [x] [ID: P3-JAVA-NATIVE-01-S3-01] `check_py2java_transpile` / unit smoke / parity を native 既定で通し、回帰検出を固定する。
9. [x] [ID: P3-JAVA-NATIVE-01-S3-02] `sample/java` を再生成し、preview 要約出力を native 実装出力へ置換する。
10. [x] [ID: P3-JAVA-NATIVE-01-S3-03] `docs-ja/how-to-use.md` / `docs-ja/spec/spec-import.md` の Java 記述を sidecar 前提から更新し、運用手順を同期する。
- `P3-JAVA-NATIVE-01-S1-01` `docs-ja/spec/spec-java-native-backend.md`（英訳: `docs/spec/spec-java-native-backend.md`）を追加し、入力 EAST3 契約・fail-closed・runtime 境界と preview 差分を文書化。
- `P3-JAVA-NATIVE-01-S1-02` `src/hooks/java/emitter/java_native_emitter.py` を追加し、`Module/FunctionDef/ClassDef` の native 骨格出力を実装。`test_py2java_smoke.py` へ最小経路テストを追加。
- `P3-JAVA-NATIVE-01-S1-03` `py2java.py` に `--java-backend {native,sidecar}` を追加し、既定を native 化。sidecar は明示指定時のみ生成する互換経路へ隔離。
- `P3-JAVA-NATIVE-01-S2-01` `java_native_emitter` に本文 lower を追加し、`Return/Expr/AnnAssign/Assign/AugAssign/If/ForCore` と主要式（定数・算術・比較・print/通常 call）を Java 生成へ接続。
- `P3-JAVA-NATIVE-01-S2-01` class 型の注釈を `Object` へ潰さず保持し、`self -> this` と `Dog() -> new Dog()` 変換を追加して OOP 基本経路の生成整合を改善。
- `P3-JAVA-NATIVE-01-S2-01` `if/else` 両分岐 `return` 時の到達不能 `return` 追加を抑止する簡易 return-flow 判定を導入し、`if_else` 生成の compile failure を解消。
- `P3-JAVA-NATIVE-01-S2-01` `main_guard_body` を `main()` へ反映し、`py_assert_*` と `perf_counter` の最小 lower、再代入の再宣言抑止（declared set）を追加。`runtime_parity_check --targets java` で `fixture: add/if_else/for_range/inheritance` と `sample:17_monte_carlo_pi` の pass を確認。
- `P3-JAVA-NATIVE-01-S2-01` `bytearray`/`append`/`int()` などの基本 lower と画像 runtime 呼び出し no-op を追加し、`03_julia_set` 生成で `ArrayList<Long>` / `.add()` / `((long)(...))` / `__pytra_noop(...)` が出力されることを smoke で固定。
- `P3-JAVA-NATIVE-01-S2-01` `unknown` 型推定・`len()`・`List/Subscript`・Subscript 代入 lower を拡張し、`sample/py` 前半 9件（01〜09）の `py2java -> javac` が `compile_ok 9/9` になることを確認。
- `P3-JAVA-NATIVE-01-S2-02` `super().__init__` / `IsInstance` / `isinstance(...)` の native lower を補強し、`((Object)(lhs)) instanceof ...` で Java 静的型制約を回避。`runtime_parity_check --case-root fixture --targets java class_instance class_member inheritance inheritance_polymorphic_dispatch is_instance instance_member super_init stateless_value` で `pass=8/8` を確認。
- `P3-JAVA-NATIVE-01-S2-03` `bytearray(n)` を 0 埋め配列へ lower する `__pytra_bytearray(Object)` を追加し、`Import/ImportFrom` を no-op 化。`runtime_parity_check --case-root sample --targets java 01_mandelbrot 02_raytrace_spheres 03_julia_set 04_orbit_trap_julia 05_mandelbrot_zoom 06_julia_parameter_sweep 10_plasma_effect --ignore-unstable-stdout` で `pass=7/7` を確認。
- `P3-JAVA-NATIVE-01-S3-01` native parity を強化。`listcomp(range)` 代入、`min/max`、`tuple` 分解/swap 代入、list truthy、negative index、`IfExp` lower を追加し、`runtime_parity_check --case-root sample --targets java --all-samples --ignore-unstable-stdout` が `pass=16/18`（残: `16_glass_sculpture_chaos`, `18_mini_language_interpreter`）まで改善。
- `P3-JAVA-NATIVE-01-S3-01` 型追跡（`ctx.types`）と loop scope の宣言漏れ調整を追加し、`16_glass_sculpture_chaos` を解消。`runtime_parity_check --case-root sample --targets java --all-samples --ignore-unstable-stdout` は `pass=17/18`（残: `18_mini_language_interpreter`）まで改善。
- `P3-JAVA-NATIVE-01-S3-01` `int/len`・`ObjLen`・`str` スライス・`isdigit/isalpha` の native lower を追加し、`check_py2java_transpile`（`132/132`）/ `test_py2java_*.py`（`21/21`）/ `runtime_parity_check --case-root sample --targets java --all-samples --ignore-unstable-stdout`（`pass=18/18`）を確認。
- `P3-JAVA-NATIVE-01-S3-02` `tools/regenerate_samples.py --langs java --force` で `sample/java` を全再生成し、旧 sidecar `.js` と `sample/java/pytra/*.js` を削除して native `.java` 出力のみに置換。

## 2026-02-27 移管: `P0: EAST3 共通最適化層の実装導入（最優先）`

以下を `docs-ja/todo/index.md` から `todo/archive` へ移管。


文脈: [docs-ja/plans/p0-east3-optimizer-rollout.md](../plans/p0-east3-optimizer-rollout.md)

1. [x] [ID: P0-EAST3-OPT-01] `EAST3 -> EAST3` 共通最適化層を導入し、pass manager / opt level / fail-closed 契約を実装へ反映する。
2. [x] [ID: P0-EAST3-OPT-01-S1-01] optimizer エントリ (`east3_optimizer.py`) と pass manager 骨格（`PassContext`/`PassResult`）を追加する。
3. [x] [ID: P0-EAST3-OPT-01-S1-02] CLI オプション（`--east3-opt-level`, `--east3-opt-pass`, dump/trace）を実装し、`O0/O1/O2` 契約を固定する。
4. [x] [ID: P0-EAST3-OPT-01-S2-01] `NoOpCastCleanupPass` / `LiteralCastFoldPass` を実装し、`O1` 既定セットを確立する。
5. [x] [ID: P0-EAST3-OPT-01-S2-02] `RangeForCanonicalizationPass` / `UnusedLoopVarElisionPass` を実装し、`for ... in range(...)` の責務境界を反映する。
6. [x] [ID: P0-EAST3-OPT-01-S2-03] `LoopInvariantHoistLitePass` / `StrengthReductionFloatLoopPass` を `O2` 限定で導入する。
7. [x] [ID: P0-EAST3-OPT-01-S3-01] pass 単体テスト（入力/出力EAST3差分、非適用ガード、意味保存）を追加する。
8. [x] [ID: P0-EAST3-OPT-01-S3-02] `sample` 回帰 + parity 検証を実行し、`O0`/`O1`/`O2` 切替時の互換を確認する。
9. [x] [ID: P0-EAST3-OPT-01-S3-03] 実装差分を `spec-east3-optimizer` と同期し、運用手順（トレース確認/切り分け）を文書化する。
- `P0-EAST3-OPT-01-S1-01` `east3_optimizer.py` / `east3_opt_passes/noop_pass.py` / `test_east3_optimizer.py` を追加し、pass manager 骨格と trace 出力の最小経路を固定。
- `P0-EAST3-OPT-01-S1-02` 共通 CLI + `py2cpp`/非C++ 8本へ optimizer オプションを配線し、`test_east3_optimizer_cli.py` と parse wrapper テストで入出力導線を固定。
- `P0-EAST3-OPT-01-S2-01` `NoOpCastCleanupPass` / `LiteralCastFoldPass` を実装し、`build_default_passes()` を `O1` 既定セットへ更新、pass 単体テストと CLI トレース期待値を同期。
- `P0-EAST3-OPT-01-S2-02` `RangeForCanonicalizationPass` / `UnusedLoopVarElisionPass` を追加し、定数 `range(...)` ループの `StaticRangeForPlan` 正規化と未使用ループ変数 `_` 化を fail-closed 条件で導入。
- `P0-EAST3-OPT-01-S2-03` `LoopInvariantHoistLitePass` / `StrengthReductionFloatLoopPass` を追加し、`O2` でのみ有効化。非空静的 range の先頭不変代入 hoist と、2冪除算の逆数乗算化を保守的ガード付きで導入。
- `P0-EAST3-OPT-01-S3-01` pass 単体テストを 21 ケースへ拡張し、O2 ゲーティング、動的名前解決ガード、非適用（zero-step / 非2冪除算 / ループ後参照）を固定。
- `P0-EAST3-OPT-01-S3-02` `runtime_parity_check.py --east3-opt-level` を追加し、`sample/py` 18件 × `cpp,rs,cs,js,ts` を `O0/O1/O2` で再実行。各レベルとも `17 pass / 1 fail`（既知の `18_mini_language_interpreter:cpp` コンパイル失敗）でレベル間差分なしを確認（`work/logs/east3_opt_parity_o{0,1,2}.json`）。
- `P0-EAST3-OPT-01-S3-03` `docs-ja/spec/spec-east3-optimizer.md` / `docs/spec/spec-east3-optimizer.md` を実装同期し、pass 実装状況表・fail-closed ガード・`trace`/`--east3-opt-pass`/`runtime_parity_check --east3-opt-level` の運用手順を追記。

## 2026-02-27 移管: `P0: C++ backend 後段最適化層（CppOptimizer）導入（最優先）`

以下を `docs-ja/todo/index.md` から `todo/archive` へ移管。


文脈: [docs-ja/plans/p0-cpp-optimizer-rollout.md](../plans/p0-cpp-optimizer-rollout.md)

1. [x] [ID: P0-CPP-OPT-01] `EAST3 -> C++ lowering` 後段に `CppOptimizer` 層を導入し、`CppEmitter` から最適化責務を分離する。
2. [x] [ID: P0-CPP-OPT-01-S1-01] `src/hooks/cpp/optimizer/` の骨格（optimizer/context/trace/passes）と no-op 配線を追加する。
3. [x] [ID: P0-CPP-OPT-01-S1-02] `py2cpp` 実行経路へ `CppOptimizer` 呼び出しを追加し、`--cpp-opt-level` / `--cpp-opt-pass` / dump オプションを配線する。
4. [x] [ID: P0-CPP-OPT-01-S2-01] `CppDeadTempPass` / `CppNoOpCastPass` を実装し、emitter 内の同等ロジックを移設する。
5. [x] [ID: P0-CPP-OPT-01-S2-02] `CppConstConditionPass` / `CppRangeForShapePass` を導入し、C++ 構文化前の IR 正規化を固定する。
6. [x] [ID: P0-CPP-OPT-01-S2-03] `CppRuntimeFastPathPass` を限定導入し、runtime 契約同値の範囲で最適化する。
7. [x] [ID: P0-CPP-OPT-01-S3-01] `CppEmitter` 側の最適化分岐を削減し、責務境界を `spec-cpp-optimizer` に合わせて整理する。
8. [x] [ID: P0-CPP-OPT-01-S3-02] C++ 回帰（`test_py2cpp_*` / `check_py2cpp_transpile.py` / `runtime_parity_check --targets cpp`）を固定する。
9. [x] [ID: P0-CPP-OPT-01-S3-03] 速度/サイズ/生成差分のベースラインを計測し、導入効果を文脈ファイルへ記録する。
- `P0-CPP-OPT-01-S1-01` `src/hooks/cpp/optimizer/` 骨格（context/trace/passes/cpp_optimizer）と `emit_cpp_from_east` no-op 配線、`test_cpp_optimizer.py` による骨組み回帰を追加。
- `P0-CPP-OPT-01-S1-02` `py2cpp` に `--cpp-opt-level/--cpp-opt-pass/--dump-cpp-*` を追加し、single/multi-file 経路へ配線。`test_cpp_optimizer_cli.py` と `test_east3_cpp_bridge.py` で CLI 受理と dump 出力を固定。
- `P0-CPP-OPT-01-S2-01` `CppDeadTempPass`/`CppNoOpCastPass` を追加し、unused temp 代入削除と no-op cast（`casts`/`static_cast`）除去を導入。`build_default_cpp_passes()` へ組み込み、`test_cpp_optimizer.py` を拡張。
- `P0-CPP-OPT-01-S2-02` `CppConstConditionPass`/`CppRangeForShapePass` を追加し、定数条件分岐の枝削減と `range(...)` runtime loop の `StaticRangeForPlan` 正規化を実装。既定 pass 列と `test_cpp_optimizer.py` に反映。
- `P0-CPP-OPT-01-S2-03` `CppRuntimeFastPathPass`（O2限定）を追加し、`Unbox` 同型除去・`Box(object)` 除去・`ObjBool(bool)` 直結を導入。default pass 列と `test_cpp_optimizer.py`（O1/O2差分確認）へ反映。
- `P0-CPP-OPT-01-S3-01` `CppEmitter._render_compare_expr` の char-compare 最適化分岐（`_try_optimize_char_compare`）を削除し、比較最適化責務を optimizer 側へ寄せた。`test_py2cpp_features::test_str_index_char_compare_optimized_and_runtime` で回帰確認。

## 2026-02-27 移管: `P3: Go/Swift/Kotlin backend の EAST3 直生成移行（sidecar 撤去）（低優先）`

以下を `docs-ja/todo/index.md` から `todo/archive` へ移管。


文脈: [docs-ja/plans/p3-go-swift-kotlin-native-rollout.md](../plans/p3-go-swift-kotlin-native-rollout.md)

1. [x] [ID: P3-GSK-NATIVE-01] Go/Swift/Kotlin backend を `EAST3 -> <lang> native emitter` 直生成経路へ移行し、sidecar JS 依存を既定経路から除去する。
2. [x] [ID: P3-GSK-NATIVE-01-S1-01] 共通移行契約（EAST3 ノード対応範囲、未対応時 fail-closed、runtime 境界）を定義する。
3. [x] [ID: P3-GSK-NATIVE-01-S1-02] 3言語共通で sidecar 互換モードの隔離方針（既定 native / opt-in legacy）を確定する。
4. [x] [ID: P3-GSK-NATIVE-01-S2-01] Go native emitter 骨格と `py2go.py` 既定切替を実装する。
5. [x] [ID: P3-GSK-NATIVE-01-S2-02] Go の式/文/class 基本対応を実装し、`sample/py` 前半ケースを通す。
6. [x] [ID: P3-GSK-NATIVE-01-S3-01] Swift native emitter 骨格と `py2swift.py` 既定切替を実装する。
7. [x] [ID: P3-GSK-NATIVE-01-S3-02] Swift の式/文/class 基本対応を実装し、`sample/py` 前半ケースを通す。
8. [x] [ID: P3-GSK-NATIVE-01-S4-01] Kotlin native emitter 骨格と `py2kotlin.py` 既定切替を実装する。
9. [x] [ID: P3-GSK-NATIVE-01-S4-02] Kotlin の式/文/class 基本対応を実装し、`sample/py` 前半ケースを通す。
10. [x] [ID: P3-GSK-NATIVE-01-S5-01] 3言語の transpile/smoke/parity 回帰を native 既定で通し、CI 導線を更新する。
11. [x] [ID: P3-GSK-NATIVE-01-S5-02] `sample/go` / `sample/swift` / `sample/kotlin` 再生成とドキュメント同期を行う。
- `P3-GSK-NATIVE-01-S1-01` 共通契約 spec を追加（`docs-ja/spec/spec-gsk-native-backend.md` / `docs/spec/spec-gsk-native-backend.md`）。EAST3 入力責務・fail-closed・runtime 境界・sidecar 隔離方針を固定。
- `P3-GSK-NATIVE-01-S1-02` 同 spec に互換モード隔離ポリシーを追記し、`--go-backend/--swift-backend/--kotlin-backend sidecar` の明示 opt-in と「既定 native + 自動フォールバック禁止」を固定。
- `P3-GSK-NATIVE-01-S2-01` `go_native_emitter.py` を追加し、`py2go.py` 既定を native 化（`--go-backend sidecar` 互換維持）。`test_py2go_smoke.py`（`10/10`）と `check_py2go_transpile`（`132/132`）を確認。
- `P3-GSK-NATIVE-01-S2-02` Go native emitter の本文 lower（式/文/for/while/subscript/listcomp/class）を実装し、`runtime_parity_check --case-root fixture --targets go add if_else for_range inheritance instance_member super_init`（`pass=6/6`）と `sample/py` 前半9件（`01〜09`, `pass=9/9`）を確認。
- `P3-GSK-NATIVE-01-S3-01` `swift_native_emitter.py` を追加し、`py2swift.py` へ `--swift-backend {native,sidecar}` を配線して既定を native 化。`test_py2swift_smoke.py`（`10/10`）と `check_py2swift_transpile`（`132/132`）の通過を確認。
- `P3-GSK-NATIVE-01-S3-02` Swift native emitter の本文 lower（`Return/Assign/If/ForCore/While`、主要式、`math` 呼び出し、`list/subscript/listcomp`、class/init、isinstance）を実装し、`test_py2swift_smoke.py`（`10/10`）/ `check_py2swift_transpile`（`132/132`）と `sample/py` 前半ケース（`01/06/09`）の native 生成確認を完了。
- `P3-GSK-NATIVE-01-S4-01` `kotlin_native_emitter.py` を追加し、`py2kotlin.py` へ `--kotlin-backend {native,sidecar}` を配線して既定を native 化。`test_py2kotlin_smoke.py`（`10/10`）と `check_py2kotlin_transpile`（`132/132`）の通過を確認。
- `P3-GSK-NATIVE-01-S4-02` Kotlin native emitter の本文 lower（`Return/Assign/If/ForCore/While`、主要式、`math` 呼び出し、`list/subscript/listcomp`、class/init、isinstance）を実装し、`test_py2kotlin_smoke.py`（`10/10`）/ `check_py2kotlin_transpile`（`132/132`）と `sample/py` 前半ケース（`01/06/09`）の native 生成確認を完了。
- `P3-GSK-NATIVE-01-S5-01` 回帰導線 `tools/check_gsk_native_regression.py` を追加し、`test_py2{go,swift,kotlin}_smoke` / `check_py2{go,swift,kotlin}_transpile` / `runtime_parity_check --targets go,kotlin`（fixture + sample前半9件）を統合実行して通過を確認。`runtime_parity_check` に `--swift-backend` / `--kotlin-backend` を追加し、Swift は runner 制約により parity 対象から除外（native 既定は smoke/transpile で監視）。
- `P3-GSK-NATIVE-01-S5-02` `tools/regenerate_samples.py --langs go,swift,kotlin --force` で `sample/{go,swift,kotlin}` 全54件を再生成し、`docs-ja/how-to-use.md` / `docs/how-to-use.md` と `docs-ja/spec/spec-import.md` / `docs/spec/spec-import.md` の Go/Swift/Kotlin 記述を native 既定へ同期。

