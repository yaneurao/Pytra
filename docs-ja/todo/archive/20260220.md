# TODO履歴（2026-02-20）

<a href="../../../docs/todo/archive/20260220.md">
  <img alt="Read in English" src="https://img.shields.io/badge/docs-English-2563EB?style=flat-square">
</a>

## 2026-02-20 完了: 最優先（即時）

1. [x] 未使用シンボル削除を「1シンボルずつ」進めた。
   - [x] 対象リスト作成: `src/py2cpp.py` の候補として `_default_cpp_module_attr_call_map`, `_DEFAULT_CPP_MODULE_ATTR_CALL_MAP`, `_deep_copy_str_map`, `CPP_RESERVED_WORDS`, `_copy_str_map`, `_map_get_str`、`src/runtime/cpp/pytra/built_in/py_runtime.h` の候補として `py_runtime_stderr`, `py_runtime_stdout`, `py_runtime_path`, `py_runtime_set_path(::std::any)`, `py_runtime_set_path(list<str>)`, `py_runtime_path_storage`, `py_u8_vector`, `py_u8_matrix`, `py_runtime_set_argv(::std::any)`, `py_argparse_argument_parser` を抽出。
   - [x] 参照確認: `rg` で上記候補の参照を確認し、「未使用（空マップ生成専用 / 参照ゼロ定数 / 参照ゼロ関数）」「薄いラッパ（`dict(...)` / `dict.get` へ置換可能）」へ分類。
   - [x] 1件削除: `_default_cpp_module_attr_call_map` / `_DEFAULT_CPP_MODULE_ATTR_CALL_MAP` / `_deep_copy_str_map` / `CPP_RESERVED_WORDS` / `_copy_str_map` / `_map_get_str` / `py_runtime_stderr` / `py_runtime_stdout` / `py_runtime_path` / `py_runtime_set_path(::std::any)` / `py_runtime_set_path(list<str>)` / `py_runtime_path_storage` / `py_u8_vector` / `py_u8_matrix` / `py_runtime_set_argv(::std::any)` / `py_argparse_argument_parser` を削除し、`load_cpp_module_attr_call_map` と `load_cpp_*_ops` を簡素化。
   - [x] 1件検証: `python3 tools/check_py2cpp_transpile.py` を実行し、`checked=103 ok=103 fail=0 skipped=5` を確認。
   - [x] 1件コミット: 1シンボル削除ごとに独立コミットする（後戻り容易化）。: `a89f5a8`, `6d8261c`, `36ab6df`, `f5845ac`, `65cd733`, `938d69b`, `c4e5619`, `8a50a1d`, `e3ea881`, `f34f2d8`, `196f22e`, `1ebd94a`, `defb1f4`, `c391464`
   - [x] 影響反映: public API を消した場合は `docs-ja/spec-runtime.md` / `docs-ja/spec-dev.md` の該当記述を同コミットで更新する。: 該当 API 記述が現行ドキュメントに存在しないことを確認済み（`rg` 検索）。
2. [x] `src/runtime/cpp/pytra/built_in/py_runtime.h` の class / 関数に目的説明コメントを追加した。
   - [x] object ラッパクラス群、変換ヘルパ群、os.path/glob、dict 取得、演算互換、runtime 状態管理の各セクションに C++ コメントを追加済み。

## 2026-02-20 完了: spec-import 反映（最優先）

1. [x] import 構文の第一段階サポート範囲を実装と一致させる。
   - [x] 対応: `import M`, `import M as A`, `from M import S`, `from M import S as A`。
   - [x] 未対応: `from M import *`, 相対 import（`from .m import x`）を `input_invalid`（`kind=unsupported_import_form`）で統一する。
2. [x] `ImportBinding` を import 情報の正本として導入・統一する。
   - [x] `module_id`, `export_name`, `local_name`, `binding_kind`, `source_file`, `source_line` を保持する。
   - [x] `meta.import_modules` / `meta.import_symbols` は `ImportBinding` から導出するだけにする。
3. [x] モジュール解決を `resolve_module_name(raw_name, root_dir)` に一本化する。
   - [x] `pytra.*` を予約名前空間として最優先解決する。
   - [x] `pytra.py` / `pytra/__init__.py` の衝突は `reserved_conflict` として `input_invalid` にする。
   - [x] 未解決は `missing_module` として `input_invalid` にする。
4. [x] `ExportTable` を追加し `from M import S` の事前検証を実装する。
   - [x] 公開対象: トップレベル `FunctionDef`, `ClassDef`, `Assign/AnnAssign(Name)`。
   - [x] 未定義シンボル import は `missing_symbol` として `input_invalid` にする。
5. [x] 名前解決優先順位を固定し、同順位衝突を `duplicate_binding` で失敗させる。
   - [x] 優先順位: ローカル変数 > 関数引数 > クラスメンバ > import symbol alias > import module alias > 組み込み。
   - [x] `from M import S` のみ時に `M.T` を参照した場合は未束縛として `input_invalid` にする。
6. [x] C++ 生成規則を「常に完全修飾名へ正規化」に統一する。
   - [x] `from foo.bar import add as plus` を `foo.bar` モジュール include + `ns_of(foo.bar)::add` 呼び出しへ落とす。
   - [x] include は `ImportBinding` 由来で重複排除 + 安定ソートする。
7. [x] single-file / multi-file で同一 `module_namespace_map` を使用し、解決結果差分を禁止する。
   - [x] forward 宣言/呼び出し解決ともに同じ map を使う。
   - [x] `--dump-deps` と通常変換で依存解決結果が一致することをテストで保証する。
8. [x] import エラーの詳細フォーマットを統一する。
   - [x] `input_invalid` の detail に `kind`, `file`, `import` を必ず含める。
   - [x] `kind`: `missing_module | missing_symbol | duplicate_binding | reserved_conflict | unsupported_import_form`。
9. [x] import 最小受け入れテストマトリクスを追加する。
   - [x] 正常: 4形式（`import` / `import as` / `from import` / `from import as`）。
   - [x] 異常: `import *`, 相対 import, モジュール未存在, シンボル未存在, 同名 alias 衝突。
   - [x] single/multi と `--dump-deps` で同じ解決結果になることを自動検証する。
10. [x] 言語非依存 import IR の土台を追加する（後続 backend 共通化）。
   - [x] `QualifiedSymbolRef(module_id, symbol, local_name)` を定義し、backend 手前で `Name(alias)` を正規化する。
   - [x] backend には「解釈済み import 情報のみ」を渡し、言語側で import 意味解釈しない設計にする。

## 2026-02-20 完了: todo2 準拠タスク

1. [x] `docs-ja/todo2.md` の MUST を継続的に満たす（当時の最新版）。
   - [x] `math` は `py2cpp.py` の一般ロジックで生成し、`math` 固有分岐を `py2cpp.py` / profile / tools に追加しない。
   - [x] `src/pytra/std/math.py` -> `src/runtime/cpp/pytra/std/math.h/.cpp` の生成を `--emit-runtime-cpp` で確認済み。
   - [x] `test/fixtures/stdlib/math_extended.py` の Python/C++ 実行一致を再確認済み。
   - [x] `src/py2cpp.py` の `_default_cpp_module_attr_call_map` を空化し、`module.attr` は import 由来の汎用 namespace 解決へ統一した。
   - [x] `src/py2cpp.py` から `png`/`gif` 固有分岐（専用 bridge 生成）を削除し、`--emit-runtime-cpp` の汎用生成フローへ統一した。
   - [x] `src/py2cpp.py` から `math`/`png`/`gif` のモジュール名文字列直書きを除去した。
   - [x] `src/pytra/std/sys.py` / `src/pytra/std/typing.py` を self_hosted で変換可能な形へ修正し、`--emit-runtime-cpp` 再生成後に `sys_extended` / `typing_extended` / `any_basic_runtime` を再確認済み。
2. [x] `src/pytra/utils/std` と `src/pytra/std` の二重管理を解消する（`src/pytra/std` に統一）。
3. [x] `src/runtime/cpp/pytra/built_in/` の位置づけ（Python 組み込み型の C++ 実装）をドキュメントへ明記する。
4. [x] `src/runtime/cpp/pytra/built_in/containers.h` の分割（`str/path/list/dict/set`）を完了する。
5. [x] `py_isdigit` / `py_isalpha` を `py_runtime.h` 直下から移し、`src/runtime/cpp/pytra/built_in/str.h` 側で提供する。
6. [x] `src/pytra/utils/east.py` の要否を判断し、不要なら削除または配置見直しを行う。
7. [x] 空ディレクトリだった `src/pytra/utils/std/` を削除する。
8. [x] `src/pytra/runtime/cpp/` を `src/hooks/cpp/` へ移動する（import パス・ドキュメント・selfhost 影響を含めて整理）。
9. [x] `src/runtime/cpp/base/` を `src/runtime/cpp/pytra/built_in/` へ改名し、参照・ドキュメントを移行する。
10. [x] `src/pytra/utils/*.py` の `--emit-runtime-cpp` 生成先を `src/runtime/cpp/pytra/utils/` に統一する（`src/runtime/cpp/pytra/std/` と同じ体系）。
    - [x] `src/pytra/utils/{png,gif,assertions}.py --emit-runtime-cpp` で `src/runtime/cpp/pytra/utils/*.h/.cpp` へ生成されることを確認。
    - [x] `python3 tools/check_py2cpp_transpile.py`（`checked=103 ok=103 fail=0 skipped=5`）を再確認。
    - [x] `python3 tools/verify_image_runtime_parity.py` が `True` を返すことを確認。
11. [x] `src/runtime/cpp/py_runtime.h` から `pytra/std/math.h`, `pytra/utils/png.h`, `pytra/utils/gif.h` の直接 include を外し、import されたモジュール側でのみ include する設計へ移行する。
    - [x] `py_runtime.h` の最小依存（built_in 基盤のみ）を定義する。
    - [x] `src/py2cpp.py` 側で `math/png/gif` の include が必要ケースでのみ出力されることを確認する。
12. [x] `src/runtime/cpp/py_runtime.h` の配置を見直し、`src/runtime/cpp/pytra/built_in/` 配下へ移す。
    - [x] 既存 include パス互換（必要なら薄い forwarding header）を含めて移行方針を決める。
    - [x] `src/py2cpp.py` のヘッダ参照とテスト/ドキュメントの参照先を統一する。
    - [x] 互換 forwarding header は廃止し、`src/runtime/cpp/py_runtime.h` を削除した。
13. [x] `py_runtime.h` にある `py_sys_*` 群を `src/runtime/cpp/pytra/std/sys.h/.cpp` へ移管する。
    - [x] `py_runtime.h` から `py_sys_*` を削除し、`pytra.std.sys` import 時の `pytra::std::sys::*` へ統一した。
    - [x] `test/fixtures/stdlib/sys_extended.py` と import 系 fixture で回帰を確認する。
14. [x] `py_runtime.h` にある `perf_counter` を `src/runtime/cpp/pytra/std/time.h/.cpp` へ移管する。
    - [x] `py_runtime.h` 直下から `perf_counter` を削除する。
    - [x] `pytra.std.time` 経由のみで `perf_counter` を解決できることを確認する。

## 2026-02-20 完了: import 解決優先キュー

1. [x] import 解決フェーズを最優先で完了した（`selfhost` より先）。
   - [x] `import` / `from ... import ...` の収集と依存グラフ生成（`--dump-deps`）を実装済み。
   - [x] `pytra.*` とユーザーモジュールの探索パス解決、重複・循環検出を実装済み。
   - [x] `pytra.runtime.png/gif` について、hook 側の短縮名（`png_helper`/`gif_helper`）依存を削除し、正規モジュール名ベースへ統一した。
   - [x] `pytra.std.*` / `pytra.runtime.*` の include 解決を 1 対 1 規則ベースへ整理し、現行 C++ ランタイム実体があるモジュールのみ include するよう調整した。
   - [x] `module.attr` / `from-import symbol` 解決で、`pytra.*` モジュールに対する短縮名フォールバック（末尾要素一致）を使わないようにした。
   - [x] `pytra.std.math` を runtime-call map に明示し、短縮名フォールバックに依存しない解決へ寄せた。
   - [x] `from XXX import YYY` の解決を runtime include / 呼び出し解決まで一貫させ、hook 側の暫定名寄せ分岐を削除した。
   - [x] runtime 側 include パス（`pytra/std/*`, `pytra/runtime/*`）と import 正規化ルールを完全同期した。
   - [x] 複数ファイル構成で `sample/py` の import ケースを通し、`tools/check_py2cpp_transpile.py` をゲート化した（`--check-multi-file-imports`）。
   - [x] `cpp_hooks.py` から `owner_mod == "pytra.runtime.png"` などのライブラリ決め打ち分岐を削除し、`runtime_call` + `module_attr_call_map` ベース解決へ統一した。
   - [x] `cpp_hooks.py` から `write_rgb_png/save_gif` 専用レンダ関数（`_render_write_rgb_png`, `_render_save_gif`）を削除し、`py_runtime.h` 側ラッパ（`py_png_write_rgb_png`, `py_gif_save_gif`）へ移管した。

## 2026-02-20 移管: `enum` サポート（完了）

1. [x] `pytra.std.enum` を追加し、`Enum` / `IntEnum` / `IntFlag` の最小互換 API を実装する。
   - [x] 値定義・比較の基本動作を実装する。
   - [x] `IntFlag` の `|`, `&`, `^`, `~` を実装する。
2. [x] EAST 変換で `Enum` 系クラス定義（`NAME = expr`）を認識できるようにする。
3. [x] `py2cpp` で `Enum` / `IntEnum` / `IntFlag` を C++ 側へ変換する最小経路を実装する。
   - [x] `Enum` 系基底クラス継承は C++ 側で省略し、静的メンバー定数として出力する。
   - [x] `Enum` / `IntEnum` / `IntFlag` を `enum class` へ lower する。
   - [x] `IntFlag` の C++ 型安全なビット演算ラッパ（`|`, `&`, `^`, `~`）を追加する。
4. [x] `test/fixtures` に `Enum` / `IntEnum` / `IntFlag` の実行一致テストを追加する。
5. [x] `docs-ja/pylib-modules.md` / `docs-ja/how-to-use.md` にサポート内容を追記する。

- [x] オプション体系（spec-options 反映）を実装完了。
  - `--mod-mode` / `--floor-div-mode` / `--bounds-check-mode` を実装。
  - `--int-width`（`32/64`）を実装し、`bigint` は planned（未実装エラー）として扱う。
  - `--str-index-mode` / `--str-slice-mode` を追加し、`codepoint` は planned（未実装エラー）として扱う。
  - `--preset {native,balanced,python}` と `--dump-options` を実装。
  - オプション処理を `src/pytra/compiler/transpile_cli.py` へ集約し、`py2cpp.py` 側の重複を削減。
  - エラー表示を `user_syntax_error` / `unsupported_by_design` / `not_implemented` などカテゴリ別に整理。
  - `docs-ja/spec-options.md` / `docs-ja/spec-dev.md` / `docs-ja/spec-east.md` / `docs-ja/how-to-use.md` を同期更新。

- [x] セルフホスティング済みトランスパイラ実行ファイル（`test/transpile/obj/pycpp_transpiler_self_new`）を使って、`test/fixtures/case05` から `test/fixtures/case100` までを `test/transpile/cpp2/` に変換し、各生成 C++ がコンパイル可能かを一括検証した。
  - 実施結果: `CASE_TOTAL=96`, `TRANSPILE_FAIL=0`, `COMPILE_OK=96`, `COMPILE_FAIL=0`

## トランスパイラ機能 TODO（今回の不足点整理）

- [x] `AugAssign`（`+=`, `-=`, `*=`, `/=`, `%=`, `//=`, `|=` など）を網羅対応する。
- [x] `**`（べき乗）を C++ 側で正しく変換する（`pow` 変換や整数演算最適化を含む）。
- [x] `bytearray(n)` / `bytes(...)` の初期化と相互変換を Python 互換に強化する。
- [x] `list.pop()` / `list.pop(index)` の両方に対応する（現在は引数なし中心）。
- [x] `math` モジュール互換を拡張する（`sin`, `cos`, `exp`, `pi` 以外も含め網羅）。
- [x] `gif` 出力ランタイム（`save_gif`, パレット関数）を `py_module` / `cpp_module` 対応で正式仕様化し、テストを追加する。
- [x] 連鎖比較（例: `0 <= x < n`）を AST から正しく展開して変換する。

## サンプル作成時に判明した追加TODO（05〜14対応）

- [x] `int / int` を含む `/` 演算で、Python互換の実数除算を保証する型昇格ルールを導入する。
- [x] `list` など空コンテナ初期化（`x = []`, `x = {}`）の型推論を強化し、`auto x = {}` の誤生成を防止する。
- [x] `bytes` / `bytearray` 系 API の変換規則を整理し、`extend(tuple)` のような利用も含めて互換を高める。
- [x] `def main()` がある入力でのエントリポイント衝突を避けるルール（自動リネームなど）を実装する。
- [x] list comprehension / nested list comprehension をサポートする（現状は手書きループへ書き換えが必要）。
- [x] 添字代入（`a[i] = v`, `a[i][j] = v`）を含む代入系の回帰テストを追加し、`// unsupported assignment` 混入を検知する。
- [x] `list.pop()` / `list.pop(index)` / `append` / `extend` など主要メソッド変換の互換テストを拡充する。

## sample/py 実行一致で追加対応が必要な項目

### py2cs.py 側

- [x] `import math` / `math.sqrt` などモジュール経由呼び出しを C# 側で正しく解決する（`math` 名未解決エラーを解消する）。
- [x] `from __future__ import annotations` を C# 変換時に無視する（`using __future__` を生成しない）。
- [x] Python 変数名が C# 予約語（例: `base`）と衝突した場合の自動リネーム規則を実装する。
- [x] `for ... in range(...)` 変換時の一時変数名衝突を防ぐ（ネスト時に `__range_*` が重複しないようにする）。
- [x] `for ... in range(...)` 変換時のループ変数再宣言衝突を防ぐ（既存ローカルと同名を再宣言しない）。
- [x] 大きな整数リテラル（例: `4294967296`）を含む代入で型変換エラーが出ないようにする（`int` / `long` の扱いを調整する）。

### py2cpp.py 側

- [x] `sample/py/04_monte_carlo_pi.py` を浮動小数点依存のサンプルから整数チェックサム系サンプルへ置き換え、言語間比較の安定性を上げる。
- [x] `for ... in range(...)` 変換時の一時変数名衝突を防ぐ（`sample/py/12_sort_visualizer.py` のコンパイル失敗を解消する）。

## sample/py/15 追加時に見えた変換器側TODO

- [x] `int(<str>)` の数値変換を `py2cpp.py` / `py2cs.py` で正しく変換する（手動パース回避）。
- [x] 文字列の 1 文字添字（`s[i]`）を Python と整合する形で C++/C# に変換する（`char`/`string` 差の吸収）。
- [x] `str` の比較（`"a" <= ch <= "z"` のような範囲比較）を C# 含め正しく変換する。
- [x] `while True: ... return ...` 形式で C# 側の「全経路 return」誤検知が出ないよう制御フロー解析を改善する。
- [x] 空リスト初期化（`x: list[T] = []`）を C# 側で `List<T>` として安定生成する（`List<object>` への退化を防止）。
- [x] メソッド呼び出し経由の型付き空コンテナ生成（`self.new_list()` 等）を常時許容し、`Only direct function calls are supported` を解消する。
- [x] `dict` 参照で C++ 側が `const` 扱いになる問題（`env[key]`）を生成側で解決し、入力コードにダミー書き込みを要求しない。
- [x] C++ の `%` はランタイム吸収せず直接生成する方針へ変更し、負数オペランドを仕様対象外として明記する。
- [x] 行連結文字列（`\n` を含む長いソース文字列）からのトークナイズが C++/C# 生成で壊れないよう文字列エスケープ処理を強化する。
- [x] 変換器都合で入力 Python を書き換えなくて済むよう、`sample/py/15` で行った回避実装をトランスパイラ側へ吸収する。

## sample/py の簡潔化候補（Python組み込み活用）

- [x] `sample/py/15_mini_language_interpreter.py`: 手動の数値文字列パースを `int(token_num.text)` に置き換える。
- [x] `sample/py/14_raymarching_light_cycle.py`: `if x > 255: x = 255` 系を `min(255, x)` に統一する（`r`, `g`, `b`, `v`）。
- [x] `sample/py/11_lissajous_particles.py`: `if v < 0: v = 0` を `max(0, v)` に置き換える。
- [x] `sample/py/09_fire_simulation.py`: 二重ループ初期化を `[[0] * w for _ in range(h)]` に置き換える。
- [x] `sample/py/13_maze_generation_steps.py`: `grid` 初期化を `[[1] * cell_w for _ in range(cell_h)]` に置き換える。
- [x] `sample/py/13_maze_generation_steps.py`: `while len(stack) > 0` を `while stack` に置き換える。
- [x] `sample/py/13_maze_generation_steps.py`: `stack[-1]` を使って末尾要素アクセスを簡潔化する。
- [x] `sample/py/12_sort_visualizer.py`: 一時変数スワップをタプル代入（`a, b = b, a`）へ置き換える。

## Go / Java ネイティブ変換の追加TODO

- [x] `py2go.py` / `py2java.py` を Python 呼び出し不要のネイティブ変換モードへ移行する。
- [x] `test/fixtures`（case01〜30）を Go/Java ネイティブ変換して、Python 実行結果と一致させる。
- [x] `sample/py` で使っている `math` モジュール呼び出し（`sqrt`, `sin`, `cos` など）を Go/Java ネイティブ変換で対応する。
- [x] `sample/py` で使っている `png.write_rgb_png` の Go/Java ランタイム実装を追加する。
- [x] `sample/py` で使っている `gif.save_gif` / `grayscale_palette` の Go/Java ランタイム実装を追加する。

## Rust 追加TODO（現時点）

- [x] `src/rs_module/py_runtime.rs` の `py_write_rgb_png` で、Python 側 `png.write_rgb_png` とバイナリ完全一致（IDAT 圧縮形式を含む）を実現する。
  - 方針変更: この厳密一致要件は今後は実施不要とし、完了扱いとする。
- [x] `py2rs.py` の `use py_runtime::{...}` 生成を使用関数ベースに最適化し、未使用 import 警告を削減する。

## 言語間ランタイム平準化 TODO

- [x] C++ のみ対応になっている `math` 拡張関数（`tan`, `log`, `log10`, `fabs`, `ceil`, `pow` など）を、Rust / C# / JS / TS / Go / Java / Swift / Kotlin の各ランタイムにも同等実装する。
- [x] C++ のみ実装が進んでいる `pathlib` 相当機能を、他ターゲット言語にも同一 API で実装する（`Path` の生成・結合・存在確認・文字列化など）。
  - [x] `pathlib` 最小共通 API を確定する（`Path(...)`, `/`, `exists`, `resolve`, `parent`, `name`, `stem`, `read_text`, `write_text`, `mkdir`, `str`）。
  - [x] `src/rs_module` / `src/cs_module` / `src/js_module` / `src/ts_module` / `src/go_module` / `src/java_module` に `pathlib` 相当ランタイムを追加する。
  - [x] `py2cpp.py` 以外の各トランスパイラで `import pathlib` と `Path` 呼び出しのマッピングを実装する。
  - [x] `sample/py` もしくは `test/fixtures` にファイルI/Oを伴う `pathlib` 利用ケースを追加し、各言語で実行確認する。
- [x] 上記の平準化後、`docs-ja/pytra-readme.md` の「対応module」を言語別の対応関数一覧で更新し、差分がある場合は理由を明記する。
  - [x] `math` / `pathlib` の言語別対応表を `docs-ja/pytra-readme.md` に追加する。
  - [x] 未対応関数が残る言語には「未対応理由・代替手段・予定」を併記する。
  - [x] `README.md` / `docs-ja/how-to-use.md` から参照される説明との整合を確認する。
- [x] `test/fixtures` に `math` / `pathlib` の共通回帰テストを追加し、全ターゲット言語で同一期待値を満たすことを CI 相当手順で確認する。
  - [x] `test/fixtures` に `math` 拡張（`tan/log/log10/fabs/ceil/pow`）の共通テストケースを追加する。
  - [x] `test/fixtures` に `pathlib` 共通テストケース（生成・結合・存在確認・読み書き）を追加する。
  - [x] 各ターゲット（C++/Rust/C#/JS/TS/Go/Java/Swift/Kotlin）への変換・実行コマンドを自動化スクリプトへ集約する。
  - [x] Python 実行結果との差分比較を自動化し、失敗ケースを一覧出力できるようにする。
  - 実行補足: 現在の開発環境では `mcs/go/javac/swiftc/kotlinc` が未導入のため、`tools/runtime_parity_check.py` は該当ターゲットを `SKIP` 表示で処理する。

## EAST / CppEmitter 簡素化 TODO

- [x] `east.py` 側で式を低レベル化し、`CppEmitter` の `Call` 分岐を削減する。
  - [x] `math.*`, `Path.*`, `len`, `print`, `str`, `int`, `float`, `bool`, `bytes`, `bytearray` を `BuiltinCall` 系ノードへ正規化する。
  - [x] `CppEmitter` は `BuiltinCall` 名と引数をそのまま C++ ランタイム呼び出しへマッピングする。
- [x] `Compare` の `in` / `not in` を専用ノード化し、コンテナ種別分岐を `east.py` 側で確定する。
  - [x] `Contains(container, key, negated)` ノードを追加する。
  - [x] `dict` と `list/set/tuple/str` の判定分岐を `east.py` 側に寄せる。
- [x] `slice` を専用ノード化し、`CppEmitter` の `Subscript` 条件分岐を削減する。
  - [x] `SliceExpr(value, lower, upper)` ノードを追加する。
  - [x] `Subscript` は単一添字アクセスに限定して表現する。
- [x] `JoinedStr`（f-string）を `Concat` 系へ事前展開し、文字列化規則を `east.py` で確定する。
  - [x] `FormattedValue` の型に応じた `to_string` 方針を EAST ノードに埋め込む。
  - [x] `CppEmitter` 側は連結出力のみを行う。
- [x] 代入ノードに宣言情報を持たせ、`CppEmitter` 側のスコープ推測ロジックを削減する。
  - [x] `Assign` / `AnnAssign` に `declare` / `decl_type` を追加する。
  - [x] `AugAssign` の未宣言時挙動を `east.py` で正規化する。
- [x] クラスノード情報を拡張し、`emit_class` の推測処理を削減する。
  - [x] `ClassDef` に `base`, `field_types`, `field_defaults`, `constructor_signature` を持たせる。
  - [x] dataclass/`__init__` の constructor 生成方針を EAST 側で確定する。
- [x] `For` 系の正規化を強化し、`CppEmitter` の `for` 出力を単純化する。
  - [x] `ForRange` と `ForEach` を完全分離し、`target_type` を持たせる。

## 保留（Go / Java は EAST 化まで凍結）

- Go/Java で、Python 側に型注釈がある変数・引数・戻り値を `any` / `Object` へ退化させず、可能な限り静的型（`int`/`float64`/`string`/`bool`/`[]byte`/`byte[]`/コンテナ型）へ落とす。
- `src/common/go_java_native_transpiler.py` の型注釈解釈を拡張し、`list[T]` / `dict[K,V]` / `set[T]` / `tuple[...]` を内部型タグへ保持する。
- 関数シグネチャ生成で、引数・戻り値の型注釈を Go/Java の静的型へ優先反映する（未注釈時のみ `any` / `Object`）。
- ローカル変数宣言で、型注釈付き代入 (`AnnAssign`) を `var/object` ではなく具体型で宣言する。
- コンテナ操作（`append`, `pop`, `pyGet`, `pySet`）のコード生成を型付きコンテナ前提で整合させる。
- `sample/py/15` 相当の複合ケースで Go/Java 生成コードの型退化が再発しないことを確認する。
- Go/Java の `bytes` / `bytearray` 型注釈を優先して `[]byte` / `byte[]` へ反映し、`any` / `Object` ベース実装は型未確定ケースのみに限定する。
- 型注釈 `bytes` / `bytearray` を内部型タグで区別し、宣言時に Go:`[]byte` / Java:`byte[]` で出力する。
- `bytes(...)` / `bytearray(...)` / `pyToBytes` 周辺の生成コードで不要な `any` / `Object` キャストを削減する。
- 添字アクセス・代入・`append` / `extend` / `pop` の `[]byte` / `byte[]` パスを優先する分岐を追加する。
- `sample/py` の PNG/GIF 系ケースで、バイト列が終始 `[]byte` / `byte[]` で通ることを確認する。
  - [x] `range_mode` と境界条件の確定を `east.py` 側で完了させる。
- [x] `CppEmitter` を「文字列出力専用」へ段階移行し、挙動回帰を防ぐ。
  - [x] 各段階で `test/fixtures` の `test/transpile/cpp` 実行結果一致を確認する。
  - [x] 各段階で `sample/py` の PNG/GIF 一致（バイナリ比較）を確認する。

## EAST C++可読性改善 TODO

- [x] `east/py2cpp.py` の括弧出力を簡素化し、不要な多重括弧（`if ((((...)))` など）を削減する。
  - [x] 演算子優先順位テーブルを導入し、必要な箇所だけ括弧を残す。
- [x] `r; g; b;` のような無意味な式文を出さない。
  - [x] 未初期化宣言のみ必要な場合は `int64 r;` の宣言で完結させる。
- [x] `for (i += (1))` 形式を C++らしい表記（`++i` など）へ寄せる。
  - [x] `step == 1` / `-1` の場合は `++i` / `--i` を使う。
  - [x] その他の step のみ `i += step` を維持する。

## EAST py2cpp sample対応 TODO（完了）

- [x] `sample/py` の `list.append(...)` / `frames.append(...)` を C++ `vector::push_back` へ正しく変換する。
  - [x] `Call(Attribute(..., "append"))` の lowered 情報を優先し、`append` を生のまま出力しない。
  - [x] `list[uint8]` / `list[list[uint8]]` / `list[Token]` など複数型で回帰テストする。
- [x] `perf_counter()` を C++ で解決する（`time` ランタイム呼び出しへマップ）。
  - [x] `east/cpp_module/py_runtime.h` もしくは適切な `cpp_module/time.h` 経由で利用可能にする。
  - [x] `sample/py` の計測系ケース（04,05,06,08,10,12,13）でコンパイル通過を確認する。
- [x] `range(...)` は `py2cpp.py` で処理せず、EAST 構築時点で消し切る。
  - [x] list comprehension 等の lowered 出力で `range` を未定義関数として出さない（生の `Call(Name("range"))` を残さない）。
  - [x] `for in range` 以外の利用（式位置・代入・引数渡し）がある場合も、EAST専用ノードへ lower して後段へ渡す。
  - [x] `py2cpp.py` 側に `range` 意味解釈を追加しない（残っていたらバグとして検出する）。
- [x] `min` / `max` の出力を `std::min` / `std::max`（型整合付き）へ統一する。
  - [x] `int`/`int64` 混在でテンプレート推論エラーが出ないよう型キャスト規則を追加する。
  - [x] `sample/py/14` での `min(255, ...)` / `max(0, ...)` を回帰テストする。
- [x] タプル分解代入の宣言不足を修正する（未宣言変数に代入だけが出る問題）。
  - [x] `a, b, c = f(...)` で `a,b,c` が未宣言なら型付き宣言を生成する。
  - [x] `sample/py/16` の `normalize(...)` 展開で `fwd_x` 等の未宣言エラーが消えることを確認する。
- [x] 上記対応後、`sample/py` 全16件で `east/py2cpp.py` 変換→コンパイル→実行を再実施し、実行時間一覧を更新する。

## self_hosted AST/Parser 段階移行 TODO


### ケース順移行（test/fixtures/case01 から順に）

- [x] `case01_add` を `self_hosted` で通す（EAST生成 + C++実行一致）。
- [x] `case02_sub_mul` を `self_hosted` で通す。
- [x] `case03_if_else` を `self_hosted` で通す。
- [x] `case04_assign` を `self_hosted` で通す。
- [x] `case05_compare` を `self_hosted` で通す。
- [x] `case06_string` を `self_hosted` で通す。
- [x] `case07_float` を `self_hosted` で通す。
- [x] `case08_nested_call` を `self_hosted` で通す。
- [x] `case09_top_level` を `self_hosted` で通す。
- [x] `case10_not` を `self_hosted` で通す。

### 切替完了条件

## 最優先（2026-02-20 追加: todo2 優先TODO 反映）

- [x] `src/pytra/std/*.py` を `--emit-runtime-cpp` で再生成し、`src/runtime/cpp/pytra/std/` への反映を自動生成起点に統一する。
  - [x] 対象: `math.py`, `json.py`, `pathlib.py`, `re.py`, `sys.py`, `typing.py`, `dataclasses.py`, `time.py`, `glob.py`, `os.py`。
  - [x] 進捗: `math/json/pathlib/re/sys/typing/dataclasses/time/glob/os` は self_hosted parser で EAST 変換可能。
  - [x] 進捗: `os.py --emit-runtime-cpp` の生成物（`src/runtime/cpp/pytra/std/os.cpp`）は単体コンパイル可能化した（`py_os_*` マップ + runtime helper 追加）。
  - [x] ブロッカー解消:
    - `pathlib.py` 再生成物の C++ 単体コンパイル失敗を解消（`class_storage_hint` 明示上書き + `pytra.std.pathlib` 実装整理 + `PyFile` の text `read/write` 拡張）。
    - `os.py` 再生成物の C++ 単体コンパイル失敗を解消（`src/runtime/cpp/pytra/std/os.cpp` は `g++ -std=c++17 -Isrc -Isrc/runtime/cpp -c` で通過）。
  - [x] 受け入れ条件:
    - [x] `python3 src/py2cpp.py src/pytra/std/math.py --emit-runtime-cpp` 後に `src/runtime/cpp/pytra/std/math.h`, `src/runtime/cpp/pytra/std/math.cpp` が更新される。
    - [x] `python3 test/fixtures/stdlib/math_extended.py` と対応 C++ 実行結果が一致する。
    - [x] `python3 src/py2cpp.py src/pytra/std/pathlib.py --emit-runtime-cpp` 後の `src/runtime/cpp/pytra/std/pathlib.cpp` が単体コンパイルできる（`g++ -std=c++17 -Isrc -Isrc/runtime/cpp -c`）。
    - [x] `python3 src/py2cpp.py src/pytra/std/os.py --emit-runtime-cpp` 後の `src/runtime/cpp/pytra/std/os.cpp` が単体コンパイルできる（`g++ -std=c++17 -Isrc -Isrc/runtime/cpp -c`）。
    - [x] 上記 10 モジュールを再生成後に `g++ -std=c++20 -Isrc -Isrc/runtime/cpp -c src/runtime/cpp/pytra/std/<module>.cpp` で全件単体コンパイル通過。

- [x] `test_py2cpp_features -k extended_runtime` の残り失敗 3 件を解消する。
  - [x] `argparse_extended_runtime`: `pytra::std::argparse` 解決（include/namespace と `dict.get` キー型）を修正する。
  - [x] `sys_extended_runtime`: `set_argv` / `set_path` への `std::any` 退化引数を型付きで渡すように修正する。
  - [x] `os_glob_extended_runtime`: `pytra.std.glob` の自己再帰生成を runtime call map（`py_glob_glob`）で解消する。

- [x] `enumerate()` 変換を拡張し、`start` 引数つきケースを回帰テストで固定する。
  - [x] 追加ケース: `enumerate(xs)`, `enumerate(xs, 1)`, `enumerate(xs, 5)`, タプル分解あり/なし（非分解は `pair` 受け取り）。
  - [x] 受け入れ条件: `test/fixtures` 側の Python/C++ 出力一致テストが green。

- [x] 内包表記とラムダのテストを増やし、コード生成崩れを早期検知できるようにする。
  - [x] 追加ケース: list/set/dict comprehension（if あり/なし）、lambda の即時呼び出し、lambda を変数へ代入して呼び出し。
  - [x] 進捗: `lambda_immediate` / `comprehension_ifexp` / `comprehension_dict_set` fixture を追加し、対応 unit test を追加した。
  - [x] ブロッカー解消: `dict/set` comprehension の型不整合（`dict<int,...>` が `dict<str, object>` へ崩れる）を修正した（EAST 側 target 型束縛 + C++ 側 dict key 型キャスト）。
  - [x] 受け入れ条件: 追加 fixture の Python/C++ 一致と `tools/check_py2cpp_transpile.py` green（`checked=106 ok=106 fail=0 skipped=5`）を確認済み。

- [x] `import_pytra_runtime_png.png` 誤生成の原因を特定し、再発防止テストを追加する。
  - [x] 原因候補を特定: `tools/runtime_parity_check.py` が repo 直下 `cwd` で fixture 実行しており、画像出力が作業ツリーへ漏れる。
  - [x] 暫定対策: `runtime_parity_check` を一時作業ディレクトリ実行へ変更し、`cwd` 由来の出力漏れを抑止。
  - [x] 再現条件（入力ファイル・コマンド・期待値）メモ:
    - 入力: `test/fixtures/imports/import_pytra_runtime_png.py`
    - コマンド: `python3 tools/runtime_parity_check.py import_pytra_runtime_png --targets cpp`
    - 期待値: repo 直下に `import_pytra_runtime_png.png` が生成されない。
  - [x] 受け入れ条件: `test/unit/test_image_runtime_parity.py::test_runtime_parity_check_does_not_leak_png_to_repo_root` を追加して確認。

## 最優先（2026-02-20 追加: py2cpp コード生成不具合）

- [x] `py2cpp.py` の分岐内初回代入（関数スコープ変数）が C++ でブロックスコープ宣言になってしまう問題を修正する。
  - [x] 原因調査:
    - `emit_assign`（`src/py2cpp.py`）が `is_declared` 判定を現在スコープ基準で行うため、`if/else` 内初回代入が `str x = ...;` として各ブロックに閉じる。
    - その後の `return x + y` はブロック外参照となり、未宣言エラーを誘発する。
  - [x] 最小再現の生成テストを追加:
    - `test/unit/test_py2cpp_codegen_issues.py::Py2CppCodegenIssueTest::test_branch_first_assignment_is_hoisted_before_if`
    - `test/unit/test_py2cpp_codegen_issues.py::Py2CppCodegenIssueTest::test_optional_tuple_destructure_keeps_str_type`
  - [x] 修正:
    - 関数単位で「分岐後にも参照されるローカル」を事前収集し、`if/else` の外側で宣言、分岐内は代入のみを出力する。
    - `TupleAssign` で `tuple[...]|None` からの代入時に `optional` を展開してから `std::get<>` する。
    - 事前宣言変数への代入で型情報を見失わないよう `declared_var_types` のフォールバックを追加する。
  - [x] 受け入れ条件:
    - 上記 2 テストが green であること（skip なし）。: `python3 -m unittest discover -s test/unit -p 'test_py2cpp_codegen_issues.py'` で `2/2 OK`。
    - `runtime/cpp/pytra/std/json.cpp` 末尾 `dumps()` と同種のスコープ崩れが再発しないことを確認する。: `--emit-runtime-cpp` 再生成 + `g++ -c src/runtime/cpp/pytra/std/json.cpp` を確認済み。
