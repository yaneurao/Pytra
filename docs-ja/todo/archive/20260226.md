# TODO履歴（2026-02-26）

<a href="../../../docs/todo/archive/20260226.md">
  <img alt="Read in English" src="https://img.shields.io/badge/docs-English-2563EB?style=flat-square">
</a>

## 2026-02-26 移管: `P0: isinstance 判定を type_id 区間判定へ統一（最優先）`

以下を `docs-ja/todo/index.md` から `todo/archive` へ移管。

文脈: `docs-ja/plans/p0-isinstance-single-inheritance.md`（`P0-ISINSTANCE-01`）

1. [x] [ID: P0-ISINSTANCE-01] 単一継承前提の `type_id_min/type_id_max` で `isinstance` を統一し、全対象言語で文字列名比較・多重継承推論・ハイブリッド分岐を排除する。
2. [x] [ID: P0-ISINSTANCE-01-S1] C++/JS/TS/RS/CS の `isinstance` lower を `py_isinstance`/`py_is_subtype` 系 API に置換する。
3. [x] [ID: P0-ISINSTANCE-01-S2] 多重継承を要求する入力（複数基底）を compile-time で検出し、明示エラーへ統一する。
4. [x] [ID: P0-ISINSTANCE-01-S3] runtime 側 `type_id` 範囲テーブルを検証し、`expected.min <= actual <= expected.max` 判定の観測不変性を回帰テスト化する。
5. [x] [ID: P0-ISINSTANCE-01-S4] 既存 `isinstance` テストを更新・追加し、`tools/check_*_transpile.py` と `test/unit` の回帰条件を全言語で再固定化する。
6. [x] [ID: P0-ISINSTANCE-01-S5] `docs-ja/spec/spec-type_id.md`（必要なら `docs-ja/spec/spec-linker.md`）への最終整合を確認したうえで、関連タスクの完了条件を反映する。
- `P0-ISINSTANCE-01`: `self_hosted` パーサで複数基底クラスを明示エラー化し、C++/JS/TS/RS/CS の `isinstance` lower/runtime 棚卸し結果を `docs-ja/plans/p0-isinstance-single-inheritance.md` へ記録した。
- `P0-ISINSTANCE-01`: `src/pytra/built_in/type_id.py` と JS/TS runtime を `type_id` 範囲テーブル（order/min/max）判定へ移行し、`test_pytra_built_in_type_id.py` と `test_js_ts_runtime_dispatch.py` へ sibling 非包含の回帰を追加した。
- `P0-ISINSTANCE-01`: C# emitter の `isinstance` lower を `py_isinstance` API 呼び出しへ統一し、`runtime/cs` に `PYTRA_TID_*` / `py_runtime_type_id` / `py_is_subtype` / `py_isinstance` を追加、`test_py2cs_smoke.py` で回帰固定した。
- `P0-ISINSTANCE-01`: Rust emitter を `py_isinstance(&x, <type_id>)` lower + `type_id` 範囲テーブル出力へ移行し、`test_py2rs_smoke.py`（22件）/`tools/check_py2rs_transpile.py`（`checked=130 ok=130`）と `tools/check_py2{cpp,cs,js,ts}_transpile.py`（JS/TS は `--skip-east3-contract-tests` で `checked=130 ok=130`）で回帰を確認した。
- `P0-ISINSTANCE-01`: CppEmitter の EAST3 bridge 互換経路（legacy `isinstance`/builtin call/method、`dict[str,*]` key coercion、`render_cond(Any)`）を修正し、`tools/check_py2{cpp,rs,cs,js,ts}_transpile.py` と `isinstance` 関連 unit を通常モードで再固定化した。
- `P0-ISINSTANCE-01-S5`: `docs-ja/spec/spec-type_id.md` の Codegen 規約へ `east_stage=3` strict 拒否条件と `east_stage=2 + self_hosted` 互換層の位置づけを追記し、実装との最終整合を反映した。

## 2026-02-26 移管: `P0: サンプル全言語のゴールデン一致パイプライン（最優先）`

以下を `docs-ja/todo/index.md` から `todo/archive` へ移管。

文脈: `docs-ja/plans/p0-sample-all-languages-golden-pipeline.md`（`P0-SAMPLE-GOLDEN-ALL-01`）

1. [x] [ID: P0-SAMPLE-GOLDEN-ALL-01] `sample/py` の 18 件を `cpp/rs/cs/js/ts/go/java/swift/kotlin` 全言語でコンパイル→実行→`sample/golden/manifest.json` との一致まで到達する（失敗カテゴリ別に順次修正する）。
2. [x] [ID: P0-SAMPLE-GOLDEN-ALL-01-S1] 検証対象の固定化（サンプル18件・言語9件・比較ルール）を行い、再現可能な共通実行手順を文書化する。
3. [x] [ID: P0-SAMPLE-GOLDEN-ALL-01-S2] runtime parity 実行フローを全言語対応に整備し、`tools/runtime_parity_check.py` の到達条件（toolchain、入出力、失敗分類）を実運用で安定化する。
4. [x] [ID: P0-SAMPLE-GOLDEN-ALL-01-S3] C++ 18件の compile/run/compare を完全一致状態へ戻す。
5. [x] [ID: P0-SAMPLE-GOLDEN-ALL-01-S4] Rust 18件を compile/run/compare 完全一致へ。
6. [x] [ID: P0-SAMPLE-GOLDEN-ALL-01-S5] C# 18件を compile/run/compare 完全一致へ。
7. [x] [ID: P0-SAMPLE-GOLDEN-ALL-01-S6] JS/TS 18件を transpile/run/compare 完全一致へ。
8. [x] [ID: P0-SAMPLE-GOLDEN-ALL-01-S7] Go/Java/Swift/Kotlin 18件を transpile/run/compare 完全一致へ。
9. [x] [ID: P0-SAMPLE-GOLDEN-ALL-01-S8] 全言語最終結果を `readme-ja.md` / `readme.md` のサンプル実行結果へ反映し、`golden` 差分が発生しない運用を維持する。
- `P0-SAMPLE-GOLDEN-ALL-01-S1`: 検証スコープ（`sample/py` 18件・9言語）と比較ルール（stdout 正規化/artefact hash-size/source hash）、再現コマンド（`runtime_parity_check.py` / `verify_sample_outputs.py`）を文脈ファイルへ固定した。
- `P0-SAMPLE-GOLDEN-ALL-01-S2`: `runtime_parity_check.py` に `--all-samples`/`--summary-json` と失敗カテゴリ集計を追加し、`test_runtime_parity_check_cli.py` + `test_image_runtime_parity.py` で CLI 解決規約と C++ 到達性を回帰固定した。
- `P0-SAMPLE-GOLDEN-ALL-01-S3`: C++ emitter の module namespace/include 解決（`math/time` と `pytra.runtime -> pytra.utils`）と runtime tuple boxing/type_id 初期化順序を修正し、`runtime_parity_check.py --case-root sample --targets cpp --ignore-unstable-stdout` で 18/18 pass を固定した。
- `P0-SAMPLE-GOLDEN-ALL-01-S4`: Rust emitter の call/subscript/dict/class mutability lower を修正し、`runtime_parity_check.py --case-root sample --targets rs --all-samples --ignore-unstable-stdout` で `SUMMARY cases=18 pass=18 fail=0 targets=rs` を確認した。
- `P0-SAMPLE-GOLDEN-ALL-01-S5`: C# emitter/runtime（import解決、listcomp/range、bytes/tuple/slice lower、dataclass ctor、math/time/pathlib runtime）を修正し、`runtime_parity_check.py --case-root sample --targets cs --all-samples --ignore-unstable-stdout` で `SUMMARY cases=18 pass=18 fail=0 targets=cs` を確認した。
- `P0-SAMPLE-GOLDEN-ALL-01-S6`: JS emitter の import/runtime shim・list/listcomp/range/compare/builtin lower を修正し、`runtime_parity_check.py --case-root sample --targets js,ts --all-samples --ignore-unstable-stdout` で `SUMMARY cases=18 pass=18 fail=0 targets=js,ts` を確認した。
- `P0-SAMPLE-GOLDEN-ALL-01-S7`: `go/java/swift/kotlin` を JS sidecar bridge + `swiftc` shim（`.chain/swift/usr/bin/swiftc`）へ揃え、`runtime_parity_check.py --case-root sample --targets go,java,swift,kotlin --all-samples --ignore-unstable-stdout` で `SUMMARY cases=18 pass=18 fail=0` / `ok: 72` を確認した。
- `P0-SAMPLE-GOLDEN-ALL-01-S8`: `readme-ja.md` / `readme.md` の実行結果注記を更新し、全9言語の parity 完走（S3〜S7）を反映した。

## 2026-02-26 移管: `P1: CppEmitter の pylib 互換名正規化除去（中優先）`

以下を `docs-ja/todo/index.md` から `todo/archive` へ移管。

文脈: `docs-ja/plans/p1-cpp-emitter-remove-pylib-compat.md`（`P1-CPP-EMIT-NORM-01`）

1. [x] [ID: P1-CPP-EMIT-NORM-01] `src/hooks/cpp/emitter/cpp_emitter.py` の `_normalize_runtime_module_name` を削除し、`pylib.*` 互換名を前提としない runtime module 解決へ切り替える（`P1-CPP-EMIT-NORM-01-S1` 〜 `S3` の完了でクローズ）。
2. [x] [ID: P1-CPP-EMIT-NORM-01-S1] `src/hooks/cpp/emitter/cpp_emitter.py` と `src/hooks/cpp/emitter/call.py` の該当呼び出しを洗い出し、`module_name` 正規化なしでの解決パスへ置換する。
3. [x] [ID: P1-CPP-EMIT-NORM-01-S2] `src/pytra/compiler/east_parts/code_emitter.py` の同名的な正規化利用有無を確認し、必要なら `pylib` 前提経路を削減する。
4. [x] [ID: P1-CPP-EMIT-NORM-01-S3] 回帰テスト/ドキュメントを整備し、`pylib.*` 互換を求めるケースが存在しないことを明文化する（`docs-ja/spec/spec-dev.md` 追記含む）。

## 2026-02-26 移管: `P1: CppEmitter 多重継承廃止（中優先）`

以下を `docs-ja/todo/index.md` から `todo/archive` へ移管。

文脈: `docs-ja/plans/p1-cpp-emitter-no-multiple-inheritance.md`（`P1-CPP-EMIT-NOMI-01`）

1. [x] [ID: P1-CPP-EMIT-NOMI-01] `src/hooks/cpp/emitter/cpp_emitter.py` の多重継承を廃止し、単一継承 + 明示的委譲へ切り替える。
2. [x] [ID: P1-CPP-EMIT-NOMI-01-S1] `cpp_emitter.py` の状態管理を維持しつつ、`CppCallEmitter`/`CppStatementEmitter`/`CppExpressionEmitter`/`CppBinaryOperatorEmitter`/`CppTriviaEmitter`/`CppTemporaryEmitter` のメソッドを `CppEmitter` へデリゲーション注入し、単一継承化を実現する。
3. [x] [ID: P1-CPP-EMIT-NOMI-01-S2] `CppEmitter` 単一継承移行中の `isinstance()`/型チェック関連の条件分岐を簡素化し、分岐経路を明示フラグ化する。

## 2026-02-26 移管: `P1: C++ runtime 変換ヘルパのテンプレ化（中優先）`

以下を `docs-ja/todo/index.md` から `todo/archive` へ移管。

文脈: `docs-ja/plans/p1-cpp-py_to-template.md`（`P1-CPP-PYTO-01`）

1. [x] [ID: P1-CPP-PYTO-01] `py_to_int64 / py_to_float64 / py_to_bool` を中核に、型パラメータ化された `py_to<T>()` API を追加し、`object`/`std::any` の変換経路を破綻なく吸収しつつ呼び出しを統一する。
2. [x] [ID: P1-CPP-PYTO-01-S1] `src/runtime/cpp/pytra-core/built_in/py_runtime.h` に `template <class T, ...> static inline T py_to(T)` 系を導入し、既存 `py_to_*` API は後方互換ラッパとして残す。
3. [x] [ID: P1-CPP-PYTO-01-S2] `src/hooks/cpp/emitter/cpp_emitter.py` と `src/hooks/cpp/emitter/expr.py` の `py_to_int64(...)` 直接呼び出しを新 API 準拠へ段階移行する（`expr` の cast、runtime 呼び出し系で挙動差分がないことを確認）。
4. [x] [ID: P1-CPP-PYTO-01-S3] `py_to_int64(object/any)` の例外・既定値挙動を検証し、`sample` や回帰テストで再生成差分が許容範囲かを確認して `readme-ja.md` の該当方針へ反映する。
- `P1-CPP-PYTO-01-S1`: `py_runtime.h` に `py_to<T>`（`object`/`std::any`/値型）テンプレートを追加し、`py_to_int64`/`py_to_float64`/`py_to_bool` の主要ラッパ経路を新 API 呼び出しへ寄せた。
- `P1-CPP-PYTO-01-S2`: `cpp_emitter.py` / `expr.py` の cast・dict default・subscript index・truthy 判定で出力する `py_to_*` 呼び出しを `py_to<int64/float64/bool>` 形式へ段階置換し、`check_py2cpp_transpile` と `runtime_parity_check --targets cpp` で回帰なしを確認した。
- `P1-CPP-PYTO-01-S3`: `test_cpp_runtime_boxing.py` に `py_to_int64(object/any)` の既定値/strict 判定（`obj_to_int64_or_raise`）を追加し、`readme-ja.md` / `readme.md` へ「非変換値は 0、strict は `_or_raise`」方針を追記した。

## 2026-02-26 移管: `P2: C++ selfhost の virtual ディスパッチ簡略化（完了済み子タスク）`

以下を `docs-ja/todo/index.md` から `todo/archive` へ移管。

文脈: `docs-ja/plans/p2-cpp-virtual-selfhost-dispatch.md`（`P2-CPP-SELFHOST-VIRTUAL-01`）

1. [x] [ID: P2-CPP-SELFHOST-VIRTUAL-01-S1-01] `rg` と AST で、`sample`/`selfhost` の class method 生成に含まれる `type_id` ベース分岐を抽出する。
2. [x] [ID: P2-CPP-SELFHOST-VIRTUAL-01-S1-02] 抽出結果を「基底クラス呼び出し」「再帰呼び出し」「ユーティリティ呼び出し」に分類し、非対象を明文化する。
3. [x] [ID: P2-CPP-SELFHOST-VIRTUAL-01-S1-03] `virtual` 置換候補を安全性（既存テスト影響）順で優先順位付けし、実施順を確定する。
- `P2-CPP-SELFHOST-VIRTUAL-01-S1-01`: `sample/cpp` + `src/runtime/cpp/pytra-gen/{compiler,std,utils}` を `rg`/簡易 AST 走査し、class method 生成由来の `type_id` 条件分岐（`if/switch`）は 0 件、残存 `type_id` 分岐は `pytra-gen/built_in/type_id.cpp` の registry 管理のみと確認した。
- `P2-CPP-SELFHOST-VIRTUAL-01-S1-02`: S1-01 の抽出結果を分類し、`基底クラス呼び出し=0` / `再帰呼び出し=0` / `ユーティリティ呼び出し=0`、非対象は `pytra-gen/built_in/type_id.cpp` の `type_id` registry 管理（dispatch ではない）に限定されると整理した。
- `P2-CPP-SELFHOST-VIRTUAL-01-S1-03`: S1 の分類結果が全カテゴリ 0 件だったため、`virtual` 置換候補の優先順は「対象なし」で確定し、以降は非対象理由の固定化（S2-03）と回帰ドキュメント整備を優先する。

## 2026-02-26 移管: `P0: sample C++/Rust 実行時間乖離の是正（最優先）`

以下を `docs-ja/todo/index.md` から `todo/archive` へ移管。

## P0: sample C++/Rust 実行時間乖離の是正（最優先）

文脈: `docs-ja/plans/p0-sample-cpp-rs-perf-gap.md`（`P0-SAMPLE-CPP-RS-PERF-01`）

1. [x] [ID: P0-SAMPLE-CPP-RS-PERF-01] sample の C++/Rust 実行時間乖離を外れ値なしの状態へ是正し、再計測手順と結果を文書化する。
2. [x] [ID: P0-SAMPLE-CPP-RS-PERF-01-S1-01] 現行 README 値の C++/Rust 差分表（比率順）を自動抽出し、外れ値ケースを固定する。
3. [x] [ID: P0-SAMPLE-CPP-RS-PERF-01-S1-02] 再現可能な計測プロトコル（warmup/repeat/中央値、コンパイル時間の扱い）を文書化する。
4. [x] [ID: P0-SAMPLE-CPP-RS-PERF-01-S2-01] Rust emitter の `save_gif`/`write_rgb_png` 呼び出しで不要 clone を除去する。
5. [x] [ID: P0-SAMPLE-CPP-RS-PERF-01-S2-02] Rust emitter の list subscript read でコピー不要型の clone を抑止する。
6. [x] [ID: P0-SAMPLE-CPP-RS-PERF-01-S2-03] Rust emitter の文字列比較/トークナイズ経路で `to_string()` 連鎖を削減する。
7. [x] [ID: P0-SAMPLE-CPP-RS-PERF-01-S2-04] `01/09/18` を再計測し、Rust 側改善の寄与をケース別に記録する。
8. [x] [ID: P0-SAMPLE-CPP-RS-PERF-01-S3-01] C++ GIF runtime に `py_slice`/`py_len`/`py_to_int64` 依存を減らす fast-path を追加する。
9. [x] [ID: P0-SAMPLE-CPP-RS-PERF-01-S3-02] C++ PNG runtime の scanline/chunk 処理を typed 操作中心へ寄せる。
10. [x] [ID: P0-SAMPLE-CPP-RS-PERF-01-S3-03] `11/12/13/16` を再計測し、C++ 側改善の寄与をケース別に記録する。
11. [x] [ID: P0-SAMPLE-CPP-RS-PERF-01-S4-01] `sample` 生成コードのフレーム二重コピー（例: `bytes(bytes(frame))`）を削減する。
12. [x] [ID: P0-SAMPLE-CPP-RS-PERF-01-S4-02] 出力 parity を維持したまま高速化できることを `runtime_parity_check`/`verify_sample_outputs` で確認する。
13. [x] [ID: P0-SAMPLE-CPP-RS-PERF-01-S5-01] C++/Rust 18 件の再計測結果を `readme.md` / `readme-ja.md` へ反映する。
14. [x] [ID: P0-SAMPLE-CPP-RS-PERF-01-S5-02] 乖離が残るケースは未解消要因と次の打ち手を文書へ追記する。
15. [x] [ID: P0-SAMPLE-CPP-RS-PERF-01-S6-01] C++ runtime の `list/bytearray` 拡張処理を range insert 化し、GIF/PNG の byte コピー hot path を短縮する。
16. [x] [ID: P0-SAMPLE-CPP-RS-PERF-01-S6-02] 主要乖離ケース（`01/03/04/09/11/12/13/14/15/16/18`）を再計測し、寄与を記録する。
17. [x] [ID: P0-SAMPLE-CPP-RS-PERF-01-S7-01] Rust emitter の nested subscript 読み取りで中間 list clone を抑止し、`enumerate` ループの二重 clone を削減する。
18. [x] [ID: P0-SAMPLE-CPP-RS-PERF-01-S7-02] `01/04/09/18` を再計測し、clone 抑止の寄与と未解消乖離を記録する。
19. [x] [ID: P0-SAMPLE-CPP-RS-PERF-01-S8-01] Rust emitter の subscript->attribute 二重 clone と文字列比較 `to_string()` を削減し、`18` の hot path を軽量化する。
20. [x] [ID: P0-SAMPLE-CPP-RS-PERF-01-S8-02] `01/04/09/18` を再計測し、`18` 改善量と残課題（`01/04/09`）を記録する。
21. [x] [ID: P0-SAMPLE-CPP-RS-PERF-01-S9-01] Rust emitter で `bytearray()/bytes()` の空初期化に容量推定 (`with_capacity`) を導入し、`pixels` 系ホットパスの再確保を抑止する。
22. [x] [ID: P0-SAMPLE-CPP-RS-PERF-01-S9-02] `01/04/09/18` を再計測し、`with_capacity` 導入の寄与と未解消外れ値を更新する。
23. [x] [ID: P0-SAMPLE-CPP-RS-PERF-01-S10-01] C++ emitter の `/` 数値演算を `py_div`（Python互換 true division）へ統一し、`01/04` の整数除算寄り経路を解消する。
24. [x] [ID: P0-SAMPLE-CPP-RS-PERF-01-S10-02] `01/04/09/18` を再計測し、`/` セマンティクス修正の寄与と残外れ値（`09/18`）を記録する。
25. [x] [ID: P0-SAMPLE-CPP-RS-PERF-01-S11-01] Rust emitter の list/enumerate 反復で list 全体 clone を削減し、`18` のトークナイズ/文実行 hot path を軽量化する。
26. [x] [ID: P0-SAMPLE-CPP-RS-PERF-01-S11-02] `01/04/09/18` を再計測し、反復 clone 削減の寄与と残外れ値（`09/18`）を更新する。
27. [x] [ID: P0-SAMPLE-CPP-RS-PERF-01-S12-01] Rust emitter の class method 引数で `str` を `&str` 受けへ縮退し、`py_match/expect` 系の文字列一時確保を削減する。
28. [x] [ID: P0-SAMPLE-CPP-RS-PERF-01-S12-02] `01/04/09/18` を再計測し、`&str` 化の寄与と残外れ値（`09/18`）を更新する。
29. [x] [ID: P0-SAMPLE-CPP-RS-PERF-01-S13-01] C++ GIF runtime の `to_bytes` 多用箇所を little-endian 直書きと `reserve` へ置換し、`09` の encode/write 常用コストを削減する。
30. [x] [ID: P0-SAMPLE-CPP-RS-PERF-01-S13-02] 影響ケース parity と `01/04/09/18` 再計測を実行し、`S13-01` の寄与と残外れ値（`09/18`）を更新する。
31. [x] [ID: P0-SAMPLE-CPP-RS-PERF-01-S14-01] Rust runtime helper `py_str_at/py_slice_str` の `Vec<char>` 常時構築を撤去し、ASCII fast-path + 非ASCII fallback へ置換する。
32. [x] [ID: P0-SAMPLE-CPP-RS-PERF-01-S14-02] `01/04/09/18` と `18` 単体の再計測で `S14-01` 寄与を確認し、残外れ値を `09` へ収束させる。
33. [x] [ID: P0-SAMPLE-CPP-RS-PERF-01-S15-01] C++ runtime `PyFile::write(bytes)` を 1byte `put` ループから一括 `write` へ切替え、PNG/GIF 出力の I/O hot path を短縮する。
34. [x] [ID: P0-SAMPLE-CPP-RS-PERF-01-S15-02] `01/04/09/18` と `01/09/18` 再計測で `S15-01` の再現性を確認し、`09` の外れ値解消を記録する。
35. [x] [ID: P0-SAMPLE-CPP-RS-PERF-01-S16-01] 全18サンプルを再計測し、最新版の C++/Rust 実測値を `readme.md` / `readme-ja.md` に反映する。
36. [x] [ID: P0-SAMPLE-CPP-RS-PERF-01-S16-02] 外れ値判定を更新し、残課題を `16_glass_sculpture_chaos` 単体へ絞り込んだことを計画文書へ記録する。
37. [x] [ID: P0-SAMPLE-CPP-RS-PERF-01-S17-01] C++ emitter の if-join 名宣言で数値型推論を補強し、`16` の hot loop で `object` 退化していた局所変数（`hx/lxv/glow` など）を型付き値へ復帰させる。
38. [x] [ID: P0-SAMPLE-CPP-RS-PERF-01-S17-02] `16` 再計測と全18件再計測を実行し、`>1.5x` 外れ値が解消した最新版を `readme.md` / `readme-ja.md` と計画文書へ反映する。


## 2026-02-26 移管: `P2: C++ selfhost の virtual ディスパッチ簡略化（低優先）`

以下を `docs-ja/todo/index.md` から `todo/archive` へ移管。

## P2: C++ selfhost の virtual ディスパッチ簡略化（低優先）

文脈: `docs-ja/plans/p2-cpp-virtual-selfhost-dispatch.md`（`P2-CPP-SELFHOST-VIRTUAL-01`）

1. [x] [ID: P2-CPP-SELFHOST-VIRTUAL-01] `virtual/override` ベースの selfhost クラス呼び出し経路へ縮退できる箇所を洗い出し、`type_id` 分岐を低優先で簡素化する。
2. [x] [ID: P2-CPP-SELFHOST-VIRTUAL-01-S2-01] `py2cpp.py` 側 emit を切り出しして、`virtual` へ寄せる対象経路と fallback 経路を分離する。
3. [x] [ID: P2-CPP-SELFHOST-VIRTUAL-01-S2-02] `CppEmitter` の class method 呼び出し描画で、`virtual`/`override` 有無に応じた分岐を明示化する。
4. [x] [ID: P2-CPP-SELFHOST-VIRTUAL-01-S2-03] 置換できない `type_id` 分岐は理由付きで残し、非対象リストへ接続する。
5. [x] [ID: P2-CPP-SELFHOST-VIRTUAL-01-S3-01] `sample` の 2〜3 件から `type_id` 分岐を `virtual` 呼び出しに移行する。
6. [x] [ID: P2-CPP-SELFHOST-VIRTUAL-01-S3-02] 移行対象を段階的に拡大し、selfhost 再変換（`sample`/`test`）の成功率を評価する。
7. [x] [ID: P2-CPP-SELFHOST-VIRTUAL-01-S3-03] 移行不能ケースは判定ロジックで固定し、次回に回す明細を更新する。
8. [x] [ID: P2-CPP-SELFHOST-VIRTUAL-01-S4-01] `test/unit` と `sample` 再生成の回帰ケースを追加・更新して diff を固定する。
9. [x] [ID: P2-CPP-SELFHOST-VIRTUAL-01-S4-02] `tools/check_selfhost_cpp_diff.py` と `tools/verify_selfhost_end_to_end.py` を再実行し、回帰条件が満たされることを確認する。
10. [x] [ID: P2-CPP-SELFHOST-VIRTUAL-01-S4-03] `docs-ja/spec/spec-dev.md`（必要なら `spec-type_id`）へ簡潔に反映する。
11. [x] [ID: P2-CPP-SELFHOST-VIRTUAL-01-S5-01] `test/unit` へ `Base`/`Child` の `virtual/override` 呼び出しケース（`Base.f` 明示呼び出し、`super().f`、`virtual` 期待差分）を追加し、`type_id` 分岐除去を固定する。
12. [x] [ID: P2-CPP-SELFHOST-VIRTUAL-01-S5-02] `sample` 再変換で `type_id` 分岐が残る境界 (`staticmethod`/`class` method/`object` receiver) を明文化した回帰ケースを追加する。
13. [x] [ID: P2-CPP-SELFHOST-VIRTUAL-01-S5-03] `tools/verify_selfhost_end_to_end.py` を使う selfhost 回帰（最低2ケース）に virtual 化前後の差分検証を追加し、再変換可能性を固定する。

## 2026-02-26 移管: `P3: 非C++ emitter の EAST3 直結化と EAST2 互換撤去（低優先）`

以下を `docs-ja/todo/index.md` から `todo/archive` へ移管。

## P3: 非C++ emitter の EAST3 直結化と EAST2 互換撤去（低優先）

文脈: `docs-ja/plans/p3-east3-only-emitters.md`（`P3-EAST3-ONLY-01`）

1. [x] [ID: P3-EAST3-ONLY-01] 非C++ 8ターゲット（`rs/cs/js/ts/go/java/swift/kotlin`）を `EAST3` 直結に統一し、`EAST2` 互換経路（`--east-stage 2` / `load_east_document_compat` / `east3_legacy_compat`）を撤去する。
2. [x] [ID: P3-EAST3-ONLY-01-S1-01] 8本 CLI の `--east-stage 2` 入力を非対応エラーへ統一し、互換警告文言依存テストをエラー期待へ更新する。
3. [x] [ID: P3-EAST3-ONLY-01-S1-02] 8本 CLI から `load_east_document_compat` の import/call を撤去し、`load_east3_document` 単一路線へ固定する。
4. [x] [ID: P3-EAST3-ONLY-01-S2-01] `js_emitter` で `ForCore(iter_plan=StaticRangeForPlan/RuntimeIterForPlan)` を直接処理する。
5. [x] [ID: P3-EAST3-ONLY-01-S2-02] `js_emitter` で `ObjBool/ObjLen/ObjStr/ObjIterInit/ObjIterNext/ObjTypeId` を直接処理する。
6. [x] [ID: P3-EAST3-ONLY-01-S2-03] `js_emitter` で `IsInstance/IsSubtype/IsSubclass` を直接処理する。
7. [x] [ID: P3-EAST3-ONLY-01-S2-04] `js_emitter` で `Box/Unbox` の legacy 前提を撤去し、EAST3 ノードを直接受理する。
8. [x] [ID: P3-EAST3-ONLY-01-S2-05] JS/TS smoke + `check_py2{js,ts}_transpile.py` を通し、`js_emitter` 直処理化の回帰を固定する。
9. [x] [ID: P3-EAST3-ONLY-01-S2-06] Go/Java/Swift/Kotlin sidecar bridge 経路（`py2{go,java,swift,kotlin}`）で `check_py2*_transpile.py` + smoke を通し、JS直処理化の波及回帰を固定する。
10. [x] [ID: P3-EAST3-ONLY-01-S3-01] `rs_emitter` の `ForCore` 直接処理（range/runtime iter）を実装する。
11. [x] [ID: P3-EAST3-ONLY-01-S3-02] `rs_emitter` の `Obj*` / `Is*` / `Box/Unbox` 直接処理を実装する。
12. [x] [ID: P3-EAST3-ONLY-01-S3-03] Rust smoke + `check_py2rs_transpile.py` で回帰を固定する。
13. [x] [ID: P3-EAST3-ONLY-01-S4-01] `cs_emitter` の `ForCore` 直接処理（range/runtime iter）を実装する。
14. [x] [ID: P3-EAST3-ONLY-01-S4-02] `cs_emitter` の `Obj*` / `Is*` / `Box/Unbox` 直接処理を実装する。
15. [x] [ID: P3-EAST3-ONLY-01-S4-03] C# smoke + `check_py2cs_transpile.py` で回帰を固定する。
16. [x] [ID: P3-EAST3-ONLY-01-S5-01] 8本 CLI から `normalize_east3_to_legacy` 呼び出しを撤去する。
17. [x] [ID: P3-EAST3-ONLY-01-S5-02] `src/pytra/compiler/east_parts/east3_legacy_compat.py` を削除し、参照ゼロを `rg` で確認する。
18. [x] [ID: P3-EAST3-ONLY-01-S6-01] `docs-ja/plans/plan-east123-migration.md` ほか関連文書から `stage=2` 互換前提を撤去し、`EAST3 only` へ更新する。
19. [x] [ID: P3-EAST3-ONLY-01-S6-02] 必要な `docs/` 翻訳同期を反映し、日英の不整合をなくす。
20. [x] [ID: P3-EAST3-ONLY-01-S7-01] 非C++ 8本の smoke/check（`test_py2*` + `check_py2*`）を全通しする。
21. [x] [ID: P3-EAST3-ONLY-01-S7-02] `runtime_parity_check --case-root sample --targets rs,cs,js,ts,go,java,swift,kotlin --all-samples --ignore-unstable-stdout` を実行し、整合を最終確認する。


## 2026-02-26 移管: `P0: C++ emitter 肥大化の段階縮退（最優先）`

以下を `docs-ja/todo/index.md` から `todo/archive` へ移管。

## P0: C++ emitter 肥大化の段階縮退（最優先）

文脈: `docs-ja/plans/p0-cpp-emitter-slimming.md`（`P0-CPP-EMITTER-SLIM-01`）

1. [x] [ID: P0-CPP-EMITTER-SLIM-01] `cpp_emitter.py` の肥大要因（互換層/責務集中/巨大 `render_expr`）を段階分割で解消し、EAST3 単一契約へ寄せる。
2. [x] [ID: P0-CPP-EMITTER-SLIM-01-S1-01] `cpp_emitter.py` の行数・メソッド数・長大メソッドを計測し、基準値を `docs-ja/plans/p0-cpp-emitter-slimming.md` に固定する。
3. [x] [ID: P0-CPP-EMITTER-SLIM-01-S1-02] `sample` と `test/unit` の C++ 生成差分基線（golden 比較）を更新し、以後の分割作業の回帰判定点を固定する。
4. [x] [ID: P0-CPP-EMITTER-SLIM-01-S2-01] `stage2/self_hosted` 前提の legacy builtin compat（`_render_legacy_builtin_call_compat` / `_render_legacy_builtin_method_call_compat`）を撤去する。
5. [x] [ID: P0-CPP-EMITTER-SLIM-01-S2-02] `For`/`ForRange` から `ForCore` への bridge と逆写像を撤去し、`ForCore` 直接受理へ統一する。
6. [x] [ID: P0-CPP-EMITTER-SLIM-01-S2-03] legacy `isinstance/issubclass` Name-call 許容経路を撤去し、type_id 系は EAST3 ノード前提へ統一する。
7. [x] [ID: P0-CPP-EMITTER-SLIM-01-S3-01] import/include/namespace/module-init 生成責務を `src/hooks/cpp/emitter/` 配下の専用モジュールへ分離する。
8. [x] [ID: P0-CPP-EMITTER-SLIM-01-S3-02] class emit（`virtual/override`・`PYTRA_TYPE_ID`・基底継承処理）を専用モジュールへ分離する。
9. [x] [ID: P0-CPP-EMITTER-SLIM-01-S3-03] 型変換 (`_cpp_type_text`) と Any 境界補正 helper を専用モジュールへ分離する。
10. [x] [ID: P0-CPP-EMITTER-SLIM-01-S3-04] built-in runtime_call（list/set/dict/str/path/special）分岐をディスパッチモジュールへ分離する。
11. [x] [ID: P0-CPP-EMITTER-SLIM-01-S4-01] `render_expr` の kind 分岐を `kind -> handler` テーブル駆動へ置換する骨格を導入する。
12. [x] [ID: P0-CPP-EMITTER-SLIM-01-S4-02] collection literal/comprehension 系ハンドラを `render_expr` から分離し、独立テストを追加する。
13. [x] [ID: P0-CPP-EMITTER-SLIM-01-S4-03] runtime/type_id/path 系ハンドラを `render_expr` から分離し、`render_expr` をディスパッチ専任へ縮退する。
14. [x] [ID: P0-CPP-EMITTER-SLIM-01-S5-01] `repr` 依存ノードを parser/lowerer 側で構造化ノードへ落とす前提を整理し、対象ノード一覧を確定する。
15. [x] [ID: P0-CPP-EMITTER-SLIM-01-S5-02] `_render_repr_expr` の利用箇所を段階削減し、必要な最終 fallback 以外を除去する。
16. [x] [ID: P0-CPP-EMITTER-SLIM-01-S5-03] `_render_repr_expr` を撤去（または no-op 化）し、`repr` 文字列依存経路が残らないことを `rg` で確認する。
17. [x] [ID: P0-CPP-EMITTER-SLIM-01-S6-01] Rust/C++ で共通化可能な helper（条件式・cast 補助・ループ骨格）を棚卸しし、`CodeEmitter` へ移管候補を確定する。
18. [x] [ID: P0-CPP-EMITTER-SLIM-01-S6-02] 共通化候補のうち 1〜2 系統を `CodeEmitter` へ移管し、C++/Rust 両 emitter の重複を削減する。
19. [x] [ID: P0-CPP-EMITTER-SLIM-01-S7-01] `test/unit/test_py2cpp_*.py` と `tools/check_py2cpp_transpile.py` を通し、分割後の回帰を固定する。
20. [x] [ID: P0-CPP-EMITTER-SLIM-01-S7-02] `tools/check_selfhost_cpp_diff.py` / `tools/verify_selfhost_end_to_end.py` を再実行し、selfhost 再変換可能性を確認する。
21. [x] [ID: P0-CPP-EMITTER-SLIM-01-S7-03] `cpp_emitter.py` の最終メトリクス（行数・`render_expr` 行数・legacy 関数残数）を更新し、完了判定を記録する。
22. [x] [ID: P0-CPP-EMITTER-SLIM-01-S8-01] `emit_assign` / `_emit_annassign_stmt` / `_emit_augassign_stmt`（+ AugAssign 左辺 helper）を `stmt.py` へ移設し、statement 責務を縮退する。
23. [x] [ID: P0-CPP-EMITTER-SLIM-01-S8-02] `emit_for_core` / `emit_function` など残存する長大 statement メソッドを段階移設し、`cpp_emitter.py` 行数を `<=2500` 目標へ近づける。
24. [x] [ID: P0-CPP-EMITTER-SLIM-01-S8-03] `_collect_assigned_name_types` / `_collect_mutated_params_from_stmt` など解析系 helper を専用モジュールへ分離し、`cpp_emitter.py` 行数をさらに圧縮する。
25. [x] [ID: P0-CPP-EMITTER-SLIM-01-S8-04] `transpile` / call-attribute 系の残存長大メソッドを段階移設し、`cpp_emitter.py` 行数 `<=2500` へ収束させる。
