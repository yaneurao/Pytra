# TODO履歴（2026-02-26）

<a href="../../../docs/todo/archive/20260226.md">
  <img alt="Read in English" src="https://img.shields.io/badge/docs-English-2563EB?style=flat-square">
</a>

## 2026-02-26 移管: `P0: isinstance 判定を type_id 区間判定へ統一（最優先）`

以下を `docs-ja/todo/index.md` から `todo/archive` へ移管。

文脈: `docs-ja/plans/p0-isinstance-single-inheritance.md`（`P0-ISINSTANCE-01`）

1. [x] [ID: P0-ISINSTANCE-01] 単一継承前提の `type_id_min/type_id_max` で `isinstance` を統一し、全対象言語で文字列名比較・多重継承推論・ハイブリッド分岐を排除する。
2. [x] [ID: P0-ISINSTANCE-01-S1] C++/JS/TS/RS/CS の `isinstance` lower を `py_isinstance`/`py_is_subtype` 系 API に置換する。
3. [x] [ID: P0-ISINSTANCE-01-S2] 多重継承を要求する入力（複数基底）を compile-time で検出し、明示エラーへ統一する。
4. [x] [ID: P0-ISINSTANCE-01-S3] runtime 側 `type_id` 範囲テーブルを検証し、`expected.min <= actual <= expected.max` 判定の観測不変性を回帰テスト化する。
5. [x] [ID: P0-ISINSTANCE-01-S4] 既存 `isinstance` テストを更新・追加し、`tools/check_*_transpile.py` と `test/unit` の回帰条件を全言語で再固定化する。
6. [x] [ID: P0-ISINSTANCE-01-S5] `docs-ja/spec/spec-type_id.md`（必要なら `docs-ja/spec/spec-linker.md`）への最終整合を確認したうえで、関連タスクの完了条件を反映する。
- `P0-ISINSTANCE-01`: `self_hosted` パーサで複数基底クラスを明示エラー化し、C++/JS/TS/RS/CS の `isinstance` lower/runtime 棚卸し結果を `docs-ja/plans/p0-isinstance-single-inheritance.md` へ記録した。
- `P0-ISINSTANCE-01`: `src/pytra/built_in/type_id.py` と JS/TS runtime を `type_id` 範囲テーブル（order/min/max）判定へ移行し、`test_pytra_built_in_type_id.py` と `test_js_ts_runtime_dispatch.py` へ sibling 非包含の回帰を追加した。
- `P0-ISINSTANCE-01`: C# emitter の `isinstance` lower を `py_isinstance` API 呼び出しへ統一し、`runtime/cs` に `PYTRA_TID_*` / `py_runtime_type_id` / `py_is_subtype` / `py_isinstance` を追加、`test_py2cs_smoke.py` で回帰固定した。
- `P0-ISINSTANCE-01`: Rust emitter を `py_isinstance(&x, <type_id>)` lower + `type_id` 範囲テーブル出力へ移行し、`test_py2rs_smoke.py`（22件）/`tools/check_py2rs_transpile.py`（`checked=130 ok=130`）と `tools/check_py2{cpp,cs,js,ts}_transpile.py`（JS/TS は `--skip-east3-contract-tests` で `checked=130 ok=130`）で回帰を確認した。
- `P0-ISINSTANCE-01`: CppEmitter の EAST3 bridge 互換経路（legacy `isinstance`/builtin call/method、`dict[str,*]` key coercion、`render_cond(Any)`）を修正し、`tools/check_py2{cpp,rs,cs,js,ts}_transpile.py` と `isinstance` 関連 unit を通常モードで再固定化した。
- `P0-ISINSTANCE-01-S5`: `docs-ja/spec/spec-type_id.md` の Codegen 規約へ `east_stage=3` strict 拒否条件と `east_stage=2 + self_hosted` 互換層の位置づけを追記し、実装との最終整合を反映した。

## 2026-02-26 移管: `P0: サンプル全言語のゴールデン一致パイプライン（最優先）`

以下を `docs-ja/todo/index.md` から `todo/archive` へ移管。

文脈: `docs-ja/plans/p0-sample-all-languages-golden-pipeline.md`（`P0-SAMPLE-GOLDEN-ALL-01`）

1. [x] [ID: P0-SAMPLE-GOLDEN-ALL-01] `sample/py` の 18 件を `cpp/rs/cs/js/ts/go/java/swift/kotlin` 全言語でコンパイル→実行→`sample/golden/manifest.json` との一致まで到達する（失敗カテゴリ別に順次修正する）。
2. [x] [ID: P0-SAMPLE-GOLDEN-ALL-01-S1] 検証対象の固定化（サンプル18件・言語9件・比較ルール）を行い、再現可能な共通実行手順を文書化する。
3. [x] [ID: P0-SAMPLE-GOLDEN-ALL-01-S2] runtime parity 実行フローを全言語対応に整備し、`tools/runtime_parity_check.py` の到達条件（toolchain、入出力、失敗分類）を実運用で安定化する。
4. [x] [ID: P0-SAMPLE-GOLDEN-ALL-01-S3] C++ 18件の compile/run/compare を完全一致状態へ戻す。
5. [x] [ID: P0-SAMPLE-GOLDEN-ALL-01-S4] Rust 18件を compile/run/compare 完全一致へ。
6. [x] [ID: P0-SAMPLE-GOLDEN-ALL-01-S5] C# 18件を compile/run/compare 完全一致へ。
7. [x] [ID: P0-SAMPLE-GOLDEN-ALL-01-S6] JS/TS 18件を transpile/run/compare 完全一致へ。
8. [x] [ID: P0-SAMPLE-GOLDEN-ALL-01-S7] Go/Java/Swift/Kotlin 18件を transpile/run/compare 完全一致へ。
9. [x] [ID: P0-SAMPLE-GOLDEN-ALL-01-S8] 全言語最終結果を `readme-ja.md` / `readme.md` のサンプル実行結果へ反映し、`golden` 差分が発生しない運用を維持する。
- `P0-SAMPLE-GOLDEN-ALL-01-S1`: 検証スコープ（`sample/py` 18件・9言語）と比較ルール（stdout 正規化/artefact hash-size/source hash）、再現コマンド（`runtime_parity_check.py` / `verify_sample_outputs.py`）を文脈ファイルへ固定した。
- `P0-SAMPLE-GOLDEN-ALL-01-S2`: `runtime_parity_check.py` に `--all-samples`/`--summary-json` と失敗カテゴリ集計を追加し、`test_runtime_parity_check_cli.py` + `test_image_runtime_parity.py` で CLI 解決規約と C++ 到達性を回帰固定した。
- `P0-SAMPLE-GOLDEN-ALL-01-S3`: C++ emitter の module namespace/include 解決（`math/time` と `pytra.runtime -> pytra.utils`）と runtime tuple boxing/type_id 初期化順序を修正し、`runtime_parity_check.py --case-root sample --targets cpp --ignore-unstable-stdout` で 18/18 pass を固定した。
- `P0-SAMPLE-GOLDEN-ALL-01-S4`: Rust emitter の call/subscript/dict/class mutability lower を修正し、`runtime_parity_check.py --case-root sample --targets rs --all-samples --ignore-unstable-stdout` で `SUMMARY cases=18 pass=18 fail=0 targets=rs` を確認した。
- `P0-SAMPLE-GOLDEN-ALL-01-S5`: C# emitter/runtime（import解決、listcomp/range、bytes/tuple/slice lower、dataclass ctor、math/time/pathlib runtime）を修正し、`runtime_parity_check.py --case-root sample --targets cs --all-samples --ignore-unstable-stdout` で `SUMMARY cases=18 pass=18 fail=0 targets=cs` を確認した。
- `P0-SAMPLE-GOLDEN-ALL-01-S6`: JS emitter の import/runtime shim・list/listcomp/range/compare/builtin lower を修正し、`runtime_parity_check.py --case-root sample --targets js,ts --all-samples --ignore-unstable-stdout` で `SUMMARY cases=18 pass=18 fail=0 targets=js,ts` を確認した。
- `P0-SAMPLE-GOLDEN-ALL-01-S7`: `go/java/swift/kotlin` を JS sidecar bridge + `swiftc` shim（`.chain/swift/usr/bin/swiftc`）へ揃え、`runtime_parity_check.py --case-root sample --targets go,java,swift,kotlin --all-samples --ignore-unstable-stdout` で `SUMMARY cases=18 pass=18 fail=0` / `ok: 72` を確認した。
- `P0-SAMPLE-GOLDEN-ALL-01-S8`: `readme-ja.md` / `readme.md` の実行結果注記を更新し、全9言語の parity 完走（S3〜S7）を反映した。

## 2026-02-26 移管: `P1: CppEmitter の pylib 互換名正規化除去（中優先）`

以下を `docs-ja/todo/index.md` から `todo/archive` へ移管。

文脈: `docs-ja/plans/p1-cpp-emitter-remove-pylib-compat.md`（`P1-CPP-EMIT-NORM-01`）

1. [x] [ID: P1-CPP-EMIT-NORM-01] `src/hooks/cpp/emitter/cpp_emitter.py` の `_normalize_runtime_module_name` を削除し、`pylib.*` 互換名を前提としない runtime module 解決へ切り替える（`P1-CPP-EMIT-NORM-01-S1` 〜 `S3` の完了でクローズ）。
2. [x] [ID: P1-CPP-EMIT-NORM-01-S1] `src/hooks/cpp/emitter/cpp_emitter.py` と `src/hooks/cpp/emitter/call.py` の該当呼び出しを洗い出し、`module_name` 正規化なしでの解決パスへ置換する。
3. [x] [ID: P1-CPP-EMIT-NORM-01-S2] `src/pytra/compiler/east_parts/code_emitter.py` の同名的な正規化利用有無を確認し、必要なら `pylib` 前提経路を削減する。
4. [x] [ID: P1-CPP-EMIT-NORM-01-S3] 回帰テスト/ドキュメントを整備し、`pylib.*` 互換を求めるケースが存在しないことを明文化する（`docs-ja/spec/spec-dev.md` 追記含む）。

## 2026-02-26 移管: `P1: CppEmitter 多重継承廃止（中優先）`

以下を `docs-ja/todo/index.md` から `todo/archive` へ移管。

文脈: `docs-ja/plans/p1-cpp-emitter-no-multiple-inheritance.md`（`P1-CPP-EMIT-NOMI-01`）

1. [x] [ID: P1-CPP-EMIT-NOMI-01] `src/hooks/cpp/emitter/cpp_emitter.py` の多重継承を廃止し、単一継承 + 明示的委譲へ切り替える。
2. [x] [ID: P1-CPP-EMIT-NOMI-01-S1] `cpp_emitter.py` の状態管理を維持しつつ、`CppCallEmitter`/`CppStatementEmitter`/`CppExpressionEmitter`/`CppBinaryOperatorEmitter`/`CppTriviaEmitter`/`CppTemporaryEmitter` のメソッドを `CppEmitter` へデリゲーション注入し、単一継承化を実現する。
3. [x] [ID: P1-CPP-EMIT-NOMI-01-S2] `CppEmitter` 単一継承移行中の `isinstance()`/型チェック関連の条件分岐を簡素化し、分岐経路を明示フラグ化する。

## 2026-02-26 移管: `P1: C++ runtime 変換ヘルパのテンプレ化（中優先）`

以下を `docs-ja/todo/index.md` から `todo/archive` へ移管。

文脈: `docs-ja/plans/p1-cpp-py_to-template.md`（`P1-CPP-PYTO-01`）

1. [x] [ID: P1-CPP-PYTO-01] `py_to_int64 / py_to_float64 / py_to_bool` を中核に、型パラメータ化された `py_to<T>()` API を追加し、`object`/`std::any` の変換経路を破綻なく吸収しつつ呼び出しを統一する。
2. [x] [ID: P1-CPP-PYTO-01-S1] `src/runtime/cpp/pytra-core/built_in/py_runtime.h` に `template <class T, ...> static inline T py_to(T)` 系を導入し、既存 `py_to_*` API は後方互換ラッパとして残す。
3. [x] [ID: P1-CPP-PYTO-01-S2] `src/hooks/cpp/emitter/cpp_emitter.py` と `src/hooks/cpp/emitter/expr.py` の `py_to_int64(...)` 直接呼び出しを新 API 準拠へ段階移行する（`expr` の cast、runtime 呼び出し系で挙動差分がないことを確認）。
4. [x] [ID: P1-CPP-PYTO-01-S3] `py_to_int64(object/any)` の例外・既定値挙動を検証し、`sample` や回帰テストで再生成差分が許容範囲かを確認して `readme-ja.md` の該当方針へ反映する。
- `P1-CPP-PYTO-01-S1`: `py_runtime.h` に `py_to<T>`（`object`/`std::any`/値型）テンプレートを追加し、`py_to_int64`/`py_to_float64`/`py_to_bool` の主要ラッパ経路を新 API 呼び出しへ寄せた。
- `P1-CPP-PYTO-01-S2`: `cpp_emitter.py` / `expr.py` の cast・dict default・subscript index・truthy 判定で出力する `py_to_*` 呼び出しを `py_to<int64/float64/bool>` 形式へ段階置換し、`check_py2cpp_transpile` と `runtime_parity_check --targets cpp` で回帰なしを確認した。
- `P1-CPP-PYTO-01-S3`: `test_cpp_runtime_boxing.py` に `py_to_int64(object/any)` の既定値/strict 判定（`obj_to_int64_or_raise`）を追加し、`readme-ja.md` / `readme.md` へ「非変換値は 0、strict は `_or_raise`」方針を追記した。

## 2026-02-26 移管: `P2: C++ selfhost の virtual ディスパッチ簡略化（完了済み子タスク）`

以下を `docs-ja/todo/index.md` から `todo/archive` へ移管。

文脈: `docs-ja/plans/p2-cpp-virtual-selfhost-dispatch.md`（`P2-CPP-SELFHOST-VIRTUAL-01`）

1. [x] [ID: P2-CPP-SELFHOST-VIRTUAL-01-S1-01] `rg` と AST で、`sample`/`selfhost` の class method 生成に含まれる `type_id` ベース分岐を抽出する。
2. [x] [ID: P2-CPP-SELFHOST-VIRTUAL-01-S1-02] 抽出結果を「基底クラス呼び出し」「再帰呼び出し」「ユーティリティ呼び出し」に分類し、非対象を明文化する。
3. [x] [ID: P2-CPP-SELFHOST-VIRTUAL-01-S1-03] `virtual` 置換候補を安全性（既存テスト影響）順で優先順位付けし、実施順を確定する。
- `P2-CPP-SELFHOST-VIRTUAL-01-S1-01`: `sample/cpp` + `src/runtime/cpp/pytra-gen/{compiler,std,utils}` を `rg`/簡易 AST 走査し、class method 生成由来の `type_id` 条件分岐（`if/switch`）は 0 件、残存 `type_id` 分岐は `pytra-gen/built_in/type_id.cpp` の registry 管理のみと確認した。
- `P2-CPP-SELFHOST-VIRTUAL-01-S1-02`: S1-01 の抽出結果を分類し、`基底クラス呼び出し=0` / `再帰呼び出し=0` / `ユーティリティ呼び出し=0`、非対象は `pytra-gen/built_in/type_id.cpp` の `type_id` registry 管理（dispatch ではない）に限定されると整理した。
- `P2-CPP-SELFHOST-VIRTUAL-01-S1-03`: S1 の分類結果が全カテゴリ 0 件だったため、`virtual` 置換候補の優先順は「対象なし」で確定し、以降は非対象理由の固定化（S2-03）と回帰ドキュメント整備を優先する。
