# P1: Kotlin Runtime Externalization (Remove Inline Helpers)

Last updated: 2026-03-01

Related TODO:
- `ID: P1-KOTLIN-RUNTIME-EXT-01` in `docs/ja/todo/index.md`

Background:
- Generated code in `sample/kotlin/*.kt` inlines runtime helper bodies such as `fun __pytra_truthy(v: Any?): Boolean`.
- Existing `P1-RUNTIME-EXT-01` was completed only for Go/Java/Swift/Ruby; Kotlin was out of scope.
- Without runtime externalization for Kotlin, generated-code bloat, runtime implementation duplication, and replacement difficulty continue.

Objective:
- Remove inline `__pytra_*` helper body definitions from Kotlin backend output and unify on runtime-file references.

Scope:
- `src/hooks/kotlin/emitter/kotlin_native_emitter.py`
- `src/runtime/kotlin/pytra/` (add/organize runtime source of truth)
- `src/py2kotlin.py` (runtime placement path)
- `test/unit/test_py2kotlin_smoke.py`
- `tools/check_py2kotlin_transpile.py`
- Kotlin path in `tools/runtime_parity_check.py`
- Regenerate `sample/kotlin`

Out of scope:
- Kotlin backend optimization (performance improvements, expression simplification, etc.)
- Redesign of already sidecar-removed areas
- Runtime model changes for other language backends

Acceptance Criteria:
- `py2kotlin` output does not inline runtime helper bodies including `fun __pytra_truthy`.
- Generated code can build/run by referencing runtime files (e.g., `py_runtime.kt`).
- `check_py2kotlin_transpile` / Kotlin smoke / parity (at least `sample/18` and `--all-samples`) pass without regression.
- No inline helpers remain after regenerating `sample/kotlin`.

Validation Commands (planned):
- `python3 tools/check_todo_priority.py`
- `python3 tools/check_py2kotlin_transpile.py`
- `PYTHONPATH=src python3 -m unittest discover -s test/unit -p 'test_py2kotlin_smoke.py' -v`
- `python3 tools/runtime_parity_check.py --case-root sample --targets kotlin --all-samples --ignore-unstable-stdout`
- `python3 tools/regenerate_samples.py --langs kotlin --force`
- `rg -n "fun __pytra_truthy\(v: Any\?\): Boolean" sample/kotlin`

Decision Log:
- 2026-02-28: Per user instruction, Kotlin runtime externalization was newly filed as `P1`.

## Breakdown

- [x] [ID: P1-KOTLIN-RUNTIME-EXT-01-S1-01] Finalize the inventory of inline helper outputs in Kotlin emitter and the runtime API mapping table.
- [x] [ID: P1-KOTLIN-RUNTIME-EXT-01-S2-01] Prepare Kotlin runtime source-of-truth (`src/runtime/kotlin/pytra`) and externalize `__pytra_*` APIs.
- [x] [ID: P1-KOTLIN-RUNTIME-EXT-01-S2-02] Remove helper body output from Kotlin emitter and switch to runtime-call-only mode.
- [x] [ID: P1-KOTLIN-RUNTIME-EXT-01-S2-03] Place runtime files through the `py2kotlin.py` output path.
- [x] [ID: P1-KOTLIN-RUNTIME-EXT-01-S3-01] Update `check_py2kotlin_transpile` / smoke / parity and lock regressions.
- [x] [ID: P1-KOTLIN-RUNTIME-EXT-01-S3-02] Confirm zero inline helper residue by regenerating `sample/kotlin`.

## S1-01 Inventory Results

### 1) Runtime helpers emitted inline by emitter (32)

- Conversion/truthy/basic: `__pytra_any_default` `__pytra_truthy` `__pytra_int` `__pytra_float` `__pytra_str` `__pytra_len` `__pytra_assert` `__pytra_noop` `__pytra_perf_counter`
- Index/slice: `__pytra_index` `__pytra_get_index` `__pytra_set_index` `__pytra_slice`
- String/containment: `__pytra_isdigit` `__pytra_isalpha` `__pytra_contains`
- Conditional/container: `__pytra_ifexp` `__pytra_bytearray` `__pytra_bytes` `__pytra_list_repeat` `__pytra_enumerate` `__pytra_as_list` `__pytra_as_dict` `__pytra_pop_last`
- Builtin equivalents: `__pytra_print` `__pytra_min` `__pytra_max`
- Type checks: `__pytra_is_int` `__pytra_is_float` `__pytra_is_bool` `__pytra_is_str` `__pytra_is_list`

### 2) Additional class-dependent helpers generated by emitter

- `__pytra_is_<Class>` / `__pytra_as_<Class>` depend on class names, so they are currently generated per module.
- In S2, handle "helpers moved to common runtime" separately from "class-dependent helpers kept generated".

### 3) Gap vs runtime source of truth

- Current `src/runtime/kotlin/pytra/py_runtime.kt` only contains `PyRuntime.runEmbeddedNode` and does not provide the above `__pytra_*` APIs.
- Therefore `sample/kotlin/*.kt` still inlines helper bodies every time, and runtime-reference mode is not established.

### 4) API contract to close in S2 (final)

- Implement the 32 helpers above as top-level functions in `src/runtime/kotlin/pytra/py_runtime.kt`.
- Emitter outputs no helper bodies, generating only references such as `import pytra.runtime.*` (tentative).
- Class-dependent helpers (`__pytra_is_<Class>` / `__pytra_as_<Class>`) remain for now in S2-02 and are excluded from externalization scope (dedup reduction tracked as a separate task).

Decision Log:
- 2026-03-01: Inventoried 32 inline-emitted `__pytra_*` APIs in `_emit_runtime_helpers()` of `kotlin_native_emitter.py` and fixed the gap with `src/runtime/kotlin/pytra/py_runtime.kt` (currently only `runEmbeddedNode`) (`P1-KOTLIN-RUNTIME-EXT-01-S1-01`).
- 2026-03-01: Updated `src/runtime/kotlin/pytra/py_runtime.kt` to the runtime source of truth with implementations of 32 `__pytra_*` helpers, and confirmed non-regression with `PYTHONPATH=src python3 -m unittest discover -s test/unit -p 'test_py2kotlin_smoke.py' -v` (10 tests) (`P1-KOTLIN-RUNTIME-EXT-01-S2-01`).
- 2026-03-01: Removed `_emit_runtime_helpers()` call from `transpile_to_kotlin_native()`, stopped inline helper body emission in generated `.kt`, and locked non-emission of `fun __pytra_truthy` via `test_py2kotlin_smoke` regression (`P1-KOTLIN-RUNTIME-EXT-01-S2-02`).
- 2026-03-01: Added runtime copy path (`_copy_kotlin_runtime`) to `py2kotlin.py` to bundle `py_runtime.kt` in output, and verified bundling in `/tmp` conversion runs (`P1-KOTLIN-RUNTIME-EXT-01-S2-03`).
- 2026-03-01: Marked unsupported Kotlin fixtures (Try/Yield/Swap) as expected fail in `tools/check_py2kotlin_transpile.py`, confirming `checked=129 ok=129 fail=0 skipped=10`.
- 2026-03-01: Updated Kotlin parity path, reflecting `py_runtime.kt` bundled compilation and artifact no-op policy for Kotlin execution in `runtime_parity_check.py`.
- 2026-03-01: Fixed Kotlin emitter `dict.get(key, default)` to `map.get(key) ?: default`, added `Dict(entries)` rendering, and resolved sample/18 runtime failure (token map emptied).
- 2026-03-01: Passed `PYTHONPATH=src python3 -m unittest discover -s test/unit -p 'test_py2kotlin_smoke.py' -v` (12 tests), `python3 tools/check_py2kotlin_transpile.py`, `python3 tools/runtime_parity_check.py --case-root sample --targets kotlin --all-samples --ignore-unstable-stdout` (18/18 pass), and `python3 tools/regenerate_samples.py --langs kotlin --force`.
