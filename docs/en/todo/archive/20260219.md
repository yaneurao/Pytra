<a href="../../../ja/todo/archive/20260219.md">
  <img alt="Read in Japanese" src="https://img.shields.io/badge/docs-日本語-2563EB?style=flat-square">
</a>

# TODO History (2026-02-19)

## 2026-02-19 Completed: Multi-file (import enhancement) lead queue

1. Started dependency-resolution phase for the final multi-file goal.
2. Implemented dependency graph generation for `import` and `from ... import ...`.
3. Implemented `pytra.*` and user-module path resolution plus conflict rules.
4. Migrated to module-level EAST and multi-file output (`.h/.cpp`).

## 2026-02-19 Completed: Compatibility options (output shape)

1. Made multi-file output default.
2. Added `--single-file` for legacy single `.cpp` bundling.
3. Documented migration steps in `docs/en/how-to-use.md`.

## 2026-02-19 Completed: C++ multi-file output

1. Generate `.h/.cpp` per module with declaration/definition separation.
2. Main module can include/link dependent modules.
3. Removed duplicated runtime include/namespace setup.

## 2026-02-19 Completed: Multi-file output build/run verification

1. Added `tools/build_multi_cpp.py`.
2. Added `tools/verify_multi_file_outputs.py` and confirmed `sample/py` 16/16 (`OK=16 NG=0`).
3. Added binary-equality verification for image outputs.

## 2026-02-19 Completed: Module-level EAST preparation

1. Added per-module EAST conversion for entry + dependencies.
2. Added module metadata for exported symbols/import aliases.
3. Added minimal shared schema for cross-module type information.

## 2026-02-19 Completed: Auto-generation migration for `runtime/cpp/pytra/std/*`

1. Migrated `runtime/cpp/pytra/std/*` (including `math`) to generated artifacts.
2. Replaced handwritten `math.h/.cpp` and aligned `pathlib/time/dataclasses/sys` to generated flow.
3. Passed stale checks and regressions (`check_py2cpp_transpile`, `verify_sample_outputs`).

## 2026-02-19-20 Completed: `py2cpp` import + runtime placement sync

1. Implemented one-to-one mapping of import and include generation.
2. Aligned C++ runtime layout with include rules.
3. Added/strengthened import regression tests.
4. Synchronized docs and implementation.

## 2026-02-19 Migration: TODO reorganization (completed sections)

Completed historical migration section retained for traceability.

## 2026-02-19 Migration: CodeEmitter conversion (completed subsections)

Completed:
- Incremental `CodeEmitter` migration with fixture checks each step
- Sample-wide conversion checks
- Regression-first fix policy
- Rename `BaseEmitter` -> `CodeEmitter`
- JSON profile split for language differences
- Hook/profile injection model integration
- Regression checks around code-emitter boundaries
- Staged selfhost path recovery
- Runtime auto-generation migration completion
- Local-CI equivalent flow stabilization (`tools/run_local_ci.py`)
- Unit + stdlib fixture parity synchronization

## Priority policy (updated 2026-02-19)

Historical policy at that point:
- Finish import resolution first.
- Resume selfhost work after import-resolution stabilization.

## Near-term execution queue (detailed)

At that snapshot, queue items and progress were tracked in detail, including:
- Staged recovery of selfhost `.py` path
- Bridge route (`tools/selfhost_transpile.py`) and parity checks
- Recovery of representative sample conversions
- Runtime module path expansion for `pytra.compiler.*`
- Selfhost direct conversion + compile/run parity checks
- Hook migration under selfhost-safe constraints

## CodeEmitter conversion (JSON + hooks)

At that snapshot:
- Hook injection surfaces were defined and implemented incrementally.
- Many `render_expr` / `emit_stmt` paths were split into helper/template flows.
- C++ hooks were separated into `src/hooks/cpp/hooks/cpp_hooks.py`.

## `py2cpp` reduction (line-count reduction)

At that snapshot:
- Ongoing staged migration from `src/py2cpp.py` to `CodeEmitter` helpers.
- `Call` path split into helper-centric flow completed.
- Additional branch/template migration and cleanup remained in progress.

## selfhost recovery (later stage)

At that snapshot:
- Any/dict boundary hardening was progressing.
- Object fallback minimization and `std::any` path reductions were ongoing.
- Full-path selfhost zero-regression remained an active target.

## Multi-file structure (final goal)

Completed milestone:
- Added dependency-resolution phase and graph visualization (`--dump-deps`), with unified cycle errors as `input_invalid`.

## Recent notes

Historical notes preserved from this period include:
- Major issue clusters around Any/object/optional-dict boundaries
- Hotspot reductions through helper normalization
- Build/diff tooling additions (`summarize_selfhost_errors`, `selfhost_error_hotspots`, `run_local_ci`)
- Transition from temporary `.py` bridge flow to direct selfhost `.py`/`.json` handling
