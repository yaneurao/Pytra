# TODO History (2026-02-28)

<a href="../../../ja/todo/archive/20260228.md">
  <img alt="Read in Japanese" src="https://img.shields.io/badge/docs-日本語-2563EB?style=flat-square">
</a>

## 2026-02-28 Migration: `P0: C++ \`float64\` Division Reduction for Same-Type Operands (Direct \`/\` Output)`

The following items were moved from `docs/ja/todo/index.md` to `todo/archive`.

Context: [docs/ja/plans/p0-cpp-float-div-direct-slash.md](../plans/p0-cpp-float-div-direct-slash.md)

1. [x] [ID: P0-CPP-DIV-FLOAT-FASTPATH-01] In C++ backend `Div` lowering, output direct `/` for `float64`/`float64` without `py_div`.
2. [x] [ID: P0-CPP-DIV-FLOAT-FASTPATH-01-S1-01] Document `Div` type conditions (`float64/float64` prioritized, keep `py_div` for Any/object/int).
3. [x] [ID: P0-CPP-DIV-FLOAT-FASTPATH-01-S2-01] Implement typed fastpath (direct `/` output) in `Div` branch of `operator.py`.
4. [x] [ID: P0-CPP-DIV-FLOAT-FASTPATH-01-S2-02] Lock boundary cases (`float32` / mixed float / int / Any/object) with regression tests.
5. [x] [ID: P0-CPP-DIV-FLOAT-FASTPATH-01-S3-01] Pass `check_py2cpp_transpile` and C++ smoke; confirm non-regression.
6. [x] [ID: P0-CPP-DIV-FLOAT-FASTPATH-01-S3-02] Regenerate `sample/cpp` and verify `py_div` reduction in `01_mandelbrot.cpp`.
- `P0-CPP-DIV-FLOAT-FASTPATH-01-S1-01` reflected judgment contract in the plan: prioritize effective types after cast application (`float32/float64`) while preserving `Path` special case and unknown fail-closed behavior.
- `P0-CPP-DIV-FLOAT-FASTPATH-01-S2-01` updated `Div` branch in `src/hooks/cpp/emitter/operator.py` to emit direct `/` instead of `py_div(...)` when effective type is float.
- `P0-CPP-DIV-FLOAT-FASTPATH-01-S2-02` added `Div` regressions (float/mixed/int/unknown) to `test_py2cpp_codegen_issues.py` and fixed both fastpath and fail-closed behavior.
- `P0-CPP-DIV-FLOAT-FASTPATH-01-S3-01` re-ran `check_py2cpp_transpile` (`ok=134 fail=0 skipped=6`) plus `test_py2cpp_smoke.py` / `test_east3_cpp_bridge.py` / `test_py2cpp_codegen_issues.py` to confirm non-regression.
- `P0-CPP-DIV-FLOAT-FASTPATH-01-S3-02` regenerated `sample/cpp/01_mandelbrot.cpp` and confirmed reduction from `py_div(py_to<float64>(...), ...)` to `py_to<float64>(...) / ...`.

## 2026-02-28 Migration: `P0: EAST3 Cross-Module non-escape Analysis (Including Imported Module Bodies)`

The following items were moved from `docs/ja/todo/index.md` to `todo/archive`.

Context: [docs/ja/plans/p0-east3-cross-module-nonescape-ipa.md](../plans/p0-east3-cross-module-nonescape-ipa.md)

1. [x] [ID: P0-EAST3-XMOD-NONESCAPE-01] Extend non-escape analysis from same-module scope to cross-module analysis including import closure.
2. [x] [ID: P0-EAST3-XMOD-NONESCAPE-01-S1-01] Finalize import-closure collection spec (target module scope, cyclic behavior, fail-closed on unresolved imports).
3. [x] [ID: P0-EAST3-XMOD-NONESCAPE-01-S1-02] Uniquify function symbols as `module_id::symbol` and implement cross-module call-target resolution.
4. [x] [ID: P0-EAST3-XMOD-NONESCAPE-01-S2-01] Extend `NonEscapeInterproceduralPass` to cross-module summary computation while keeping SCC fixed-point determinism.
5. [x] [ID: P0-EAST3-XMOD-NONESCAPE-01-S2-02] Update callsite `meta.non_escape_callsite` / module `meta.non_escape_summary` using cross-module analysis results.
6. [x] [ID: P0-EAST3-XMOD-NONESCAPE-01-S3-01] Reduce C++ emitter dependence on safe-call fixed whitelists and prioritize `non_escape_callsite` annotations for stack-list decisions.
7. [x] [ID: P0-EAST3-XMOD-NONESCAPE-01-S3-02] Confirm `frames` in `sample/05` does not degrade to `object` and reduce implicit conversions at `save_gif` calls.
8. [x] [ID: P0-EAST3-XMOD-NONESCAPE-01-S4-01] Add regressions for module-cross / unresolved-import / recursive-import and lock fail-closed behavior and determinism.
9. [x] [ID: P0-EAST3-XMOD-NONESCAPE-01-S4-02] Run `check_py2cpp_transpile` and C++ regressions; confirm non-regression.
- `P0-EAST3-XMOD-NONESCAPE-01-S3-02` regenerated `sample/cpp/05_mandelbrot_zoom.cpp` and confirmed reduction from `object frames` to `list<bytes> frames`.
- `P0-EAST3-XMOD-NONESCAPE-01-S4-01` added regressions for re-export aliases / unresolved-import / recursive-import to `test_east3_non_escape_interprocedural_pass.py`.
- `P0-EAST3-XMOD-NONESCAPE-01-S4-02` re-ran `check_py2cpp_transpile` (`ok=134 fail=0 skipped=6`) and C++ regressions (`test_py2cpp_codegen_issues`, `test_cpp_non_escape_bridge`, `test_py2cpp_smoke`) and confirmed non-regression.

## 2026-02-28 Migration: `P0: Strengthening EAST3 Optimization Layer (Improve sample C++ Output)`

The following items were moved from `docs/ja/todo/index.md` to `todo/archive`.

Context: [docs/ja/plans/p0-east3-optimizer-sample-cpp-strengthening.md](../plans/p0-east3-optimizer-sample-cpp-strengthening.md)

1. [x] [ID: P0-EAST3-OPT-SAMPLE-CPP-01] Strengthen EAST3 optimization layer in 7 stages to reduce redundant syntax/type-conversion noise visible in `sample/cpp` output.
2. [x] [ID: P0-EAST3-OPT-SAMPLE-CPP-01-S1-01] Extend `RangeForCanonicalizationPass` so non-constant `stop` cases are normalized to `StaticRangeForPlan` when `step` is constant and valid.
3. [x] [ID: P0-EAST3-OPT-SAMPLE-CPP-01-S1-02] Add EAST3 normalization treating `enumerate(list[T])` as typed iterable to suppress `object + py_at + py_to` chains.
4. [x] [ID: P0-EAST3-OPT-SAMPLE-CPP-01-S1-03] Add cast-chain reduction pass for numeric expressions to remove redundant `py_to<T>` on type-known paths.
5. [x] [ID: P0-EAST3-OPT-SAMPLE-CPP-01-S1-04] Add preheader hoist for loop-invariant denominators/type conversions (`py_to<float64>(width)` etc.) to reduce inner-loop conversion cost.
6. [x] [ID: P0-EAST3-OPT-SAMPLE-CPP-01-S1-05] Normalize typed `py_repeat` initialization such as `list[list[int64]]` into typed materialization and reduce `make_object(py_repeat(...))` paths.
7. [x] [ID: P0-EAST3-OPT-SAMPLE-CPP-01-S1-06] Add EAST3 normalization to remove unnecessary `py_to_string` in key access/assignment on `dict<str, V>`.
8. [x] [ID: P0-EAST3-OPT-SAMPLE-CPP-01-S1-07] Add optimization to suppress temporary tuple variables in tuple unpacking and move toward direct `TupleTarget` expansion.
- `P0-EAST3-OPT-SAMPLE-CPP-01-S1-01` extended `RangeForCanonicalizationPass` and regression-locked in `test_east3_optimizer.py` that non-constant `stop` case in `range(n)` (`n: int64`) is normalized to `StaticRangeForPlan`.
- `P0-EAST3-OPT-SAMPLE-CPP-01-S1-02` added `TypedEnumerateNormalizationPass`, supplemented typed loop header selection by filling `iter_item_type` / `iter_element_type` / `target_plan` for `enumerate(list[T])`, and regression-locked in `test_east3_optimizer.py` / `test_east3_cpp_bridge.py`.
- `P0-EAST3-OPT-SAMPLE-CPP-01-S1-03` added `NumericCastChainReductionPass`, and regression-locked in `test_east3_optimizer.py` that redundant same-type `static_cast` / `Unbox` chains can be reduced fail-closed.
- `P0-EAST3-OPT-SAMPLE-CPP-01-S1-04` added `LoopInvariantCastHoistPass` to hoist RHS numeric-promotion casts in `BinOp` to preheader, and regression-locked moving `height-1`/`width-1`/`frames_n` conversions outside loops in `sample/06`.
- `P0-EAST3-OPT-SAMPLE-CPP-01-S1-05` added `TypedRepeatMaterializationPass`, filled `[0] * w`-style `ListComp` type to `list[list[int64]]`, and reduced `make_object(py_repeat(...))` count to zero in `sample/py` retranspile.
- `P0-EAST3-OPT-SAMPLE-CPP-01-S1-06` added `DictStrKeyNormalizationPass`, normalized `dict[str, V]` keys with `dict_key_verified`, removed unnecessary `py_to_string` from `env[...]` path in `sample/18`, and passed `check_py2cpp_transpile.py`.

## 2026-02-28 Migration: `P0: Fix Ruby \`/\` to True-Division Semantics (Highest Priority)`

The following items were moved from `docs/ja/todo/index.md` to `todo/archive`.

Context: [docs/ja/plans/p0-ruby-true-division-parity.md](../plans/p0-ruby-true-division-parity.md)

1. [x] [ID: P0-RUBY-DIV-SEMANTICS-01] Fix Ruby backend `/` lowering to Python-compatible true division and eliminate semantic gaps from `int/int`.
2. [x] [ID: P0-RUBY-DIV-SEMANTICS-01-S1-01] Lock reproducibility in regressions including `sample/06`, and add tests in unit/smoke that detect `/` semantic gaps.
3. [x] [ID: P0-RUBY-DIV-SEMANTICS-01-S1-02] Fix Ruby emitter binary-op lowering so Python `/` is always output as true division (add type-conversion helpers as needed).
4. [x] [ID: P0-RUBY-DIV-SEMANTICS-01-S1-03] Regenerate `sample/ruby` and re-verify parity (especially `sample/06`), and reflect README measurement-validity checks in docs.

## 2026-02-28 Migration: `P1: Readability Reduction for sample/18 C++ Generated Code (Selected: #2,#7,#8,#5,#1)`

The following items were moved from `docs/ja/todo/index.md` to `todo/archive`.

Context: [docs/ja/plans/p1-cpp-sample18-readability-slimming.md](../plans/p1-cpp-sample18-readability-slimming.md)

1. [x] [ID: P1-CPP-S18-READ-01] Apply selected improvement items (#2,#7,#8,#5,#1) in stages to C++ generated code for `sample/18`, improving readability while keeping behavioral compatibility.
2. [x] [ID: P1-CPP-S18-READ-01-S1-02] Improvement #2: remove redundant casts (`py_cast` / `py_to_*`) around tuple unpacking/temp variables, and move to direct emit on type-known paths.
3. [x] [ID: P1-CPP-S18-READ-01-S1-07] Improvement #7: reduce unnecessary key conversions (`py_to_string` chains, etc.) on map key access and prefer direct access for same key types.
4. [x] [ID: P1-CPP-S18-READ-01-S1-08] Improvement #8: simplify conversion code around timing/time-diff and reduce redundant numeric conversion chains.
5. [x] [ID: P1-CPP-S18-READ-01-S1-05] Improvement #5: suppress excessive default initialization/type decay from `unknown` sources and stabilize declared types where possible.
6. [x] [ID: P1-CPP-S18-READ-01-S1-01] Improvement #1: integrate typed loop-header conversion for `ForCore(RuntimeIterForPlan)` (consistent with `P0-FORCORE-TYPE-01-S3-01`) into readability improvements.
- `P1-CPP-S18-READ-01-S1-02` added typed-iterable-priority emit for `ForCore(RuntimeIterForPlan)+NameTarget` and removed `object __itobj + obj_to_rc_or_raise` from `for stmt in stmts` in `sample/18`.
- `P1-CPP-S18-READ-01-S1-07` added regression tests for load/store with `dict_key_verified` keys and fixed in regenerated `sample/18` that `env[stmt->name]` remains instead of `env[py_to_string(...)]`.
- `P1-CPP-S18-READ-01-S1-08` fixed `resolved_type=float64` for `perf_counter` and reduced unnecessary `Unbox`, removing `py_to<float64>` chains around `start/elapsed` in `sample/18`.
- `P1-CPP-S18-READ-01-S1-05` added correction that steers empty collection literals on return paths to known return types, stabilizing `new_expr_nodes()` in `sample/18` to `list<rc<ExprNode>>{}`.

## 2026-02-28 Migration: `P0: Make stdlib Type Spec the Source of Truth (Remove core Hardcoding)`

The following items were moved from `docs/ja/todo/index.md` to `todo/archive`.

Context: [docs/ja/plans/p0-stdlib-signature-source-of-truth.md](../plans/p0-stdlib-signature-source-of-truth.md)

1. [x] [ID: P0-STDLIB-SOT-01] Make `pytra/std` the single source of truth for stdlib type specs and remove hardcoded per-stdlib knowledge in `core.py` in stages.
2. [x] [ID: P0-STDLIB-SOT-01-S1-01] Inventory hardcoded stdlib knowledge in `core.py` (`perf_counter` / `Path` / `str.*` / `dict.*`, etc.) and lock replacement targets.
3. [x] [ID: P0-STDLIB-SOT-01-S1-02] Document signature-reference spec using `pytra/std` as source of truth (lookup unit/type representation/fail-closed when undefined).
4. [x] [ID: P0-STDLIB-SOT-01-S2-01] Add a stdlib signature reference layer in compiler and switch `core.py` away from direct maps.
5. [x] [ID: P0-STDLIB-SOT-01-S2-02] Move representative cases including `perf_counter` through the reference layer and remove hardcoded return types.
6. [x] [ID: P0-STDLIB-SOT-01-S2-03] Migrate method mappings such as `Path` / `str.*` in stages and limit `core.py` responsibility to parsing + EAST shaping.
7. [x] [ID: P0-STDLIB-SOT-01-S3-01] Add regressions (type inference/lowering/sample representative cases) and lock detection when `pytra/std` specs change.
- `P0-STDLIB-SOT-01-S1-01` inventoried stdlib hardcoding in `core.py`, categorized into function map / owner-type method map / `perf_counter` return-type hardcoding, and fixed in context docs.
- `P0-STDLIB-SOT-01-S1-02` added `docs/ja/spec/spec-stdlib-signature-source-of-truth.md`, defining source-of-truth (`pytra/std`) and compiler reference boundary.
- `P0-STDLIB-SOT-01-S2-01` added `src/pytra/compiler/stdlib/signature_registry.py`, introducing a reference layer that resolves function/method return types from annotations in `pytra/std/*.py`.
- `P0-STDLIB-SOT-01-S2-02` replaced `perf_counter` type hardcoding in `core.py` with registry reference and confirmed regressions in `test_stdlib_signature_registry.py` / `test_east_core.py` / `test_py2cpp_codegen_issues.py`.
- `P0-STDLIB-SOT-01-S2-03` migrated method maps for `str/Path/int/list/set/dict/unknown` and `Path` attribute-type maps into registry and removed direct maps from `core.py`.
- `P0-STDLIB-SOT-01-S3-01` added regression tests in `test_stdlib_signature_registry.py`, `test_east_core.py`, and `test_py2cpp_codegen_issues.py` (`sample/18`), fixing type inference/lowering/representative cases.

## 2026-02-28 Migration: `P0: Remove Same-Type Casts in C++ and Advance Type Inference (Highest Priority)`

The following items were moved from `docs/ja/todo/index.md` to `todo/archive`.

Context: [docs/ja/plans/p0-cpp-redundant-same-type-cast-elimination.md](../plans/p0-cpp-redundant-same-type-cast-elimination.md)

1. [x] [ID: P0-CPP-SAMECAST-01] Unify C++ cast policy to "no conversion for same type" and avoid outputting unnecessary `str(...)` / `py_to_*` on type-known paths.
2. [x] [ID: P0-CPP-SAMECAST-01-S1-01] Fix same-type cast-elimination contract as a common C++ emitter policy (no conversion when source/target are same type and not Any/object/unknown).
3. [x] [ID: P0-CPP-SAMECAST-01-S1-02] Extend `get_expr_type()` inference for `Subscript`, enabling `Subscript(str, int) -> str`.
4. [x] [ID: P0-CPP-SAMECAST-01-S1-03] Fix string-related lowering including `StrCharClassOp` so type-known `str` paths do not insert `str(...)`.
5. [x] [ID: P0-CPP-SAMECAST-01-S2-01] Add same-type no-op checks to `apply_cast` / `Unbox` / builtin-runtime conversion paths to suppress redundant `py_to_*` chains.
6. [x] [ID: P0-CPP-SAMECAST-01-S2-02] Add regressions for no same-type cast output (fixture + `sample/18` fragment verification).
7. [x] [ID: P0-CPP-SAMECAST-01-S3-01] Regenerate `sample/cpp`, recheck compile/run/parity for `sample/18`, and lock results.
- `P0-CPP-SAMECAST-01-S1-02` updated `CppEmitter.get_expr_type()` to infer `Subscript(str, int) -> str`, suppressing type drop in string indexing.
- `P0-CPP-SAMECAST-01-S1-03` changed `StrCharClassOp` to emit direct `receiver.isdigit()/isalpha()` for type-known `str`, while keeping `str(...)` only on unknown/object paths.
- `P0-CPP-SAMECAST-01-S2-01` added same-type no-op checks in `apply_cast` and `_render_unbox_target_cast`, skipping inferable same-type casts.
- `P0-CPP-SAMECAST-01-S2-02` added sample/18 regression (`test_sample18_charclass_avoids_redundant_str_cast`) to `test_py2cpp_codegen_issues.py` and updated expectations in `test_east3_cpp_bridge.py` to type-known no-cast behavior.

## 2026-02-28 Migration: `P0: Add Lua Backend (Highest Priority)`

The following items were moved from `docs/ja/todo/index.md` to `todo/archive`.

Context: [docs/ja/plans/p0-lua-backend-rollout.md](../plans/p0-lua-backend-rollout.md)

1. [x] [ID: P0-LUA-BACKEND-01] Add Lua native direct-generation path from EAST3 with `py2lua.py` as entry point and make major `sample/py` cases executable in Lua.
2. [x] [ID: P0-LUA-BACKEND-01-S1-01] Document Lua backend contract (input EAST3, fail-closed behavior, runtime boundary, out of scope) in `docs/ja/spec`.
3. [x] [ID: P0-LUA-BACKEND-01-S1-02] Add skeletons of `src/py2lua.py` and `src/hooks/lua/emitter/`, and pass minimal fixtures (`add` / `if_else` / `for_range`).
4. [x] [ID: P0-LUA-BACKEND-01-S2-01] Implement basic lowerings of expressions/statements (assignment, branch, loop, call, minimum builtins).
5. [x] [ID: P0-LUA-BACKEND-01-S2-02] Implement class/instance/isinstance/import (including `math` and image runtime) in stages.
6. [x] [ID: P0-LUA-BACKEND-01-S3-01] Add `tools/check_py2lua_transpile.py`, `test_py2lua_smoke.py`, and `runtime_parity_check --targets lua` path; lock regressions.
7. [x] [ID: P0-LUA-BACKEND-01-S3-02] Regenerate `sample/lua` and sync usage/support docs under `docs/ja`.
- `P0-LUA-BACKEND-01-S1-01` added `docs/ja/spec/spec-lua-native-backend.md`, explicitly documenting EAST3-only / fail-closed / runtime boundary / out-of-scope as contracts.
- `P0-LUA-BACKEND-01-S1-02` added skeletons of `src/py2lua.py` and `src/hooks/lua/emitter/`, fixing a minimal native path passing `add/if_else/for_range` in `test_py2lua_smoke.py`.
- `P0-LUA-BACKEND-01-S2-01` added basic lowerings (`Assign/While/Dict/Subscript/IfExp/JoinedStr/Attribute`, etc.), expanded `test_py2lua_smoke.py` to 12 tests, and improved fixture-wide `ok` from 22 to 57.
- `P0-LUA-BACKEND-01-S2-02` added class/instance/isinstance/import (`math`, image stubs), expanded `test_py2lua_smoke.py` to 15 tests, and improved fixture-wide `ok` from 57 to 81.
- `P0-LUA-BACKEND-01-S3-01` added `check_py2lua_transpile.py` and confirmed `checked=86 ok=86 fail=0 skipped=53`; added `runtime_parity_check --targets lua` path and confirmed PASS even in environment without toolchain.
- `P0-LUA-BACKEND-01-S3-02` regenerated `sample/lua` for `02/03/04/17` (`summary: total=4 skip=0 regen=4 fail=0`) and synchronized Lua paths in `docs/ja/how-to-use.md` / `docs/ja/spec/spec-user.md` / `docs/ja/spec/spec-import.md` / `sample/readme-ja.md`.

## 2026-02-28 Migration: `P1: Runtime Externalization for Go/Java/Swift/Ruby (Remove Inline Helpers)`

The following items were moved from `docs/ja/todo/index.md` to `todo/archive`.

Context: [docs/ja/plans/p1-runtime-externalization-gjsr.md](../plans/p1-runtime-externalization-gjsr.md)

1. [x] [ID: P1-RUNTIME-EXT-01] Remove inline definitions of `__pytra_*` runtime helpers from Go/Java/Swift/Ruby generated code and unify on per-language runtime-file references.
2. [x] [ID: P1-RUNTIME-EXT-01-S1-01] Inventory helper groups currently inlined by emitters by language and fix mapping to runtime-side APIs (source of truth).
3. [x] [ID: P1-RUNTIME-EXT-01-S2-01] Migrate Go backend to external-runtime reference mode and remove helper bodies from `py2go` output.
4. [x] [ID: P1-RUNTIME-EXT-01-S2-02] Migrate Java backend to external-runtime reference mode and remove helper bodies from `py2java` output.
5. [x] [ID: P1-RUNTIME-EXT-01-S2-03] Prepare native runtime file for Swift backend and remove helper bodies from `py2swift` output.
6. [x] [ID: P1-RUNTIME-EXT-01-S2-04] Add runtime file for Ruby backend and remove helper bodies from `py2rb` output.
7. [x] [ID: P1-RUNTIME-EXT-01-S3-01] Update `runtime_parity_check` / smoke tests / sample regeneration paths for external-runtime references and lock regressions.
- `P1-RUNTIME-EXT-01-S1-01` fixed mapping between inline helper groups and runtime source APIs for Go/Java/Swift/Ruby in `docs/ja/plans/p1-runtime-externalization-gjsr.md`, organizing that Go/Java mainly need naming-gap adaptation and Swift/Ruby mainly need new runtime source implementations.
- `P1-RUNTIME-EXT-01-S2-01` removed inline `func __pytra_*` definitions from Go native emitter and moved to `py2go.py` path that places `py_runtime.go` in output target. Confirmed execution path with `test_py2go_smoke.py` and `runtime_parity_check --targets go` (`sample/18`).
- `P1-RUNTIME-EXT-01-S2-02` removed helper body definitions from Java native emitter and consolidated calls to `PyRuntime.__pytra_*`. Placed `PyRuntime.java` in output target via `py2java.py`, and confirmed execution path with `test_py2java_smoke.py` and `runtime_parity_check --targets java` (`sample/18`).
- `P1-RUNTIME-EXT-01-S2-03` removed helper body definitions from Swift native emitter and moved them to `src/runtime/swift/pytra/py_runtime.swift`. Placed `py_runtime.swift` in output target via `py2swift.py` and passed `test_py2swift_smoke.py`. For `runtime_parity_check --targets swift`, confirmed `toolchain_missing` due to no `swiftc` in environment.
- `P1-RUNTIME-EXT-01-S2-04` removed inline helper body definitions from Ruby native emitter and added `src/runtime/ruby/pytra/py_runtime.rb`. Switched to path where `py2rb.py` places `py_runtime.rb` in output target, and confirmed execution path with `test_py2rb_smoke.py` and `runtime_parity_check --targets ruby` (`sample/18`).
- `P1-RUNTIME-EXT-01-S3-01` re-ran `test_py2{go,java,swift,rb}_smoke.py` and confirmed all pass. `runtime_parity_check --case-root sample --targets go,java,swift,ruby --all-samples --ignore-unstable-stdout` confirmed `cases=18 pass=18 fail=0` (`swift` is `toolchain_missing`), and added `ruby` to `tools/regenerate_samples.py`, fixing through `--langs go,java,swift,ruby --force` (`total=72 regen=72 fail=0`).

## 2026-02-28 Migration: `P1: Add Rust target to unified CLI ./pytra`

The following items were moved from `docs/ja/todo/index.md` to `todo/archive`.

Context: [docs/ja/plans/p1-pytra-cli-rs-target.md](../plans/p1-pytra-cli-rs-target.md)

1. [x] [ID: P1-PYTRA-CLI-RS-01] Add `--target rs` to unified CLI `./pytra` so Rust transpilation can run from the same entry point as C++.
2. [x] [ID: P1-PYTRA-CLI-RS-01-S1-01] Extend target dispatch in `src/pytra/cli.py` so `--target rs` can call `py2rs.py`.
3. [x] [ID: P1-PYTRA-CLI-RS-01-S1-02] Finalize behavior of `--output` / `--output-dir` for Rust output and organize extension/output-destination conflicts.
4. [x] [ID: P1-PYTRA-CLI-RS-01-S1-03] Add Rust examples to unified CLI section in `docs/ja/how-to-use.md` and document temporary-output operations for `out/` / `/tmp`.
- `P1-PYTRA-CLI-RS-01-S1-01` implemented `--target {cpp,rs}` in `src/pytra/cli.py`, wiring `rs` to `py2rs.py`; kept `--build` limited to `cpp`.
- `P1-PYTRA-CLI-RS-01-S1-02` fixed Rust output spec to prefer `--output`, or default to `--output-dir/<input_stem>.rs` (default `out/`) when omitted, and fail fast when output destination is a directory.
- `P1-PYTRA-CLI-RS-01-S1-03` added Rust examples (`--output` / `--output-dir`) to unified CLI section in `docs/ja/how-to-use.md`, documenting `out/` consolidation and `/tmp` exception operations.

## 2026-02-28 Migration: Completed Sections (6 items)

The following items were moved from `docs/ja/todo/index.md` to `todo/archive`.

### P0: Remove redundant same-type cast around C++ `rc_new` (Highest Priority)

Context: [docs/ja/plans/p0-cpp-rcnew-samecast-elimination.md](../plans/p0-cpp-rcnew-samecast-elimination.md)

1. [x] [ID: P0-CPP-RCNEW-SAMECAST-01] Remove `rc<T>(::rc_new<T>(...))` from C++ output by same-type cast judgment and simplify to `::rc_new<T>(...)`.
2. [x] [ID: P0-CPP-RCNEW-SAMECAST-01-S1-01] Enable inference of `::rc_new<T>(...) -> rc<T>` in `infer_rendered_arg_type()`.
3. [x] [ID: P0-CPP-RCNEW-SAMECAST-01-S1-02] Make `should_skip_same_type_cast` treat same-type casts originating from `rc_new` as no-op.
4. [x] [ID: P0-CPP-RCNEW-SAMECAST-01-S2-01] Add regression tests for C++ cast-application path to prevent recurrence of `rc<T>(::rc_new<T>(...))`.
5. [x] [ID: P0-CPP-RCNEW-SAMECAST-01-S2-02] Verify regenerated `sample/cpp` simplifies corresponding fragment in `sample/18` to `::rc_new<Token>(...)`.
6. [x] [ID: P0-CPP-RCNEW-SAMECAST-01-S3-01] Confirm non-regression via `check_py2cpp_transpile` / smoke and record in decision log.

### P0: Ruby image-output runtime implementation and byte parity recovery (Highest Priority)

Context: [docs/ja/plans/p0-ruby-image-runtime-parity.md](../plans/p0-ruby-image-runtime-parity.md)

1. [x] [ID: P0-RUBY-IMAGE-PARITY-01] Move Ruby backend image output from no-op to real runtime implementation and recover image artifact parity including PNG for `sample/01`.
2. [x] [ID: P0-RUBY-IMAGE-PARITY-01-S1-01] Inventory current Ruby image-output path (emitter/runtime) and fix `__pytra_noop` dependency locations.
3. [x] [ID: P0-RUBY-IMAGE-PARITY-01-S2-01] Implement real PNG write path in Ruby runtime (Python-runtime compatible).
4. [x] [ID: P0-RUBY-IMAGE-PARITY-01-S2-02] Implement real GIF write path in Ruby runtime (Python-runtime compatible).
5. [x] [ID: P0-RUBY-IMAGE-PARITY-01-S2-03] Switch Ruby emitter image-save lowering from `__pytra_noop` to real runtime calls.
6. [x] [ID: P0-RUBY-IMAGE-PARITY-01-S3-01] Automate byte-equality verification for PNG in `sample/01` and integrate into regression tests.
7. [x] [ID: P0-RUBY-IMAGE-PARITY-01-S3-02] Verify byte equality for representative GIF cases and confirm non-regression in `sample/ruby` regeneration and parity.

### P0: Introduce stdout parity for sample image artifact_size (Highest Priority)

Context: [docs/ja/plans/p0-sample-artifact-size-stdout-parity.md](../plans/p0-sample-artifact-size-stdout-parity.md)

1. [x] [ID: P0-SAMPLE-ARTIFACT-SIZE-01] Add image artifact-size equality checks to `runtime_parity_check` so regressions invisible in stdout-only checks can be detected.
2. [x] [ID: P0-SAMPLE-ARTIFACT-SIZE-01-S1-01] Inventory image-output cases and fix artifact comparison targets starting from `output:` lines.
3. [x] [ID: P0-SAMPLE-ARTIFACT-SIZE-01-S2-01] Add Python baseline artifact-size collection to `runtime_parity_check`.
4. [x] [ID: P0-SAMPLE-ARTIFACT-SIZE-01-S2-02] Add target runtime artifact presence/size comparison (including stale-file guards).
5. [x] [ID: P0-SAMPLE-ARTIFACT-SIZE-01-S3-01] Update `runtime_parity_check` regression tests and lock `artifact_size_mismatch` detection.
6. [x] [ID: P0-SAMPLE-ARTIFACT-SIZE-01-S3-02] Re-run sample parity and confirm non-regression with size comparison enabled.

### P1: Introduce EAST3 interprocedural non-escape analysis (RAII candidate annotations)

Context: [docs/ja/plans/p1-east3-interprocedural-nonescape-analysis.md](../plans/p1-east3-interprocedural-nonescape-analysis.md)

1. [x] [ID: P1-EAST3-NONESCAPE-IPA-01] Introduce interprocedural non-escape analysis (SCC + fixed point) to EAST3 optimization layer and store RAII-conversion candidate annotations in `meta`.
2. [x] [ID: P1-EAST3-NONESCAPE-IPA-01-S1-01] Specify escape-judgment domain (arg escape / return escape / unknown-call policy) and keep it in `PassContext`.
3. [x] [ID: P1-EAST3-NONESCAPE-IPA-01-S1-02] Extract call graph from EAST3 and add SCC decomposition utilities.
4. [x] [ID: P1-EAST3-NONESCAPE-IPA-01-S2-01] Implement `NonEscapeInterproceduralPass` and establish summary fixed-point updates.
5. [x] [ID: P1-EAST3-NONESCAPE-IPA-01-S2-02] Annotate converged summaries into function/expression-node `meta`.
6. [x] [ID: P1-EAST3-NONESCAPE-IPA-01-S3-01] Add unit tests for recursive/mutually-recursive/external-call mixed cases, locking fail-closed behavior and determinism.
7. [x] [ID: P1-EAST3-NONESCAPE-IPA-01-S3-02] Re-run EAST3 optimizer regressions and `check_py2cpp_transpile`, confirming non-regression.

### P1: C++ `list` migration to PyObj/RC model (phased rollout)

Context: [docs/ja/plans/p1-list-pyobj-migration.md](../plans/p1-list-pyobj-migration.md)

1. [x] [ID: P1-LIST-PYOBJ-MIG-01] Migrate `list` to the PyObj/RC-managed model in stages, enabling RAII reduction only on non-escape paths.
2. [x] [ID: P1-LIST-PYOBJ-MIG-01-S0-01] Document `list` reference-semantics contract (alias/share/destructive update) in docs/spec.
3. [x] [ID: P1-LIST-PYOBJ-MIG-01-S0-02] Add alias-expected fixture (shared `append/pop` after `a=b`) and visualize current gap.
4. [x] [ID: P1-LIST-PYOBJ-MIG-01-S0-03] Inventory sample/fixture locations depending on list value-copy and lock in decision log.
5. [x] [ID: P1-LIST-PYOBJ-MIG-01-S1-01] Add new list PyObj model in runtime (type/lifetime/iter/len/truthy contract).
6. [x] [ID: P1-LIST-PYOBJ-MIG-01-S1-02] Extend `make_object` / `obj_to_*` / `py_iter_or_raise` to support the new list model.
7. [x] [ID: P1-LIST-PYOBJ-MIG-01-S1-03] Add minimal compatibility bridge with old value model to suppress compile breaks during staged migration.
8. [x] [ID: P1-LIST-PYOBJ-MIG-01-S1-04] Add runtime unit tests (construction/alias/iter/boundary conversion).
9. [x] [ID: P1-LIST-PYOBJ-MIG-01-S2-01] Consolidate C++ emitter list-type rendering through model switch (`value|pyobj`).
10. [x] [ID: P1-LIST-PYOBJ-MIG-01-S2-02] Update list literal/ctor/append/extend/pop/index/slice output for `pyobj` model.
11. [x] [ID: P1-LIST-PYOBJ-MIG-01-S2-03] Make for/enumerate/comprehension list iteration lowering work with `pyobj` list.
12. [x] [ID: P1-LIST-PYOBJ-MIG-01-S2-04] Pass compile/run/parity for representative fixtures including `sample/18` under `pyobj` model.
13. [x] [ID: P1-LIST-PYOBJ-MIG-01-S3-01] Add path to hand off annotations from `P1-EAST3-NONESCAPE-IPA-01` to C++ side.
14. [x] [ID: P1-LIST-PYOBJ-MIG-01-S3-02] Add Cpp pass that reduces only non-escape local lists to stack/RAII.
15. [x] [ID: P1-LIST-PYOBJ-MIG-01-S3-03] Add fail-closed regressions that avoid reduction when mixed with unknown/external/dynamic calls.
16. [x] [ID: P1-LIST-PYOBJ-MIG-01-S4-01] Compare `value` vs `pyobj` performance/size/diffs on samples and record default-switch decision.
17. [x] [ID: P1-LIST-PYOBJ-MIG-01-S4-02] Switch default model to `pyobj` and establish rollback procedure (`value` via flag).
18. [x] [ID: P1-LIST-PYOBJ-MIG-01-S4-02-S1] Add `--cpp-list-model {value,pyobj}` to `py2cpp` for rollback preparation and reflect to single/multi-file output.
19. [x] [ID: P1-LIST-PYOBJ-MIG-01-S4-02-S2] Resolve compile/runtime blockers in 12 failing sample cases (`05..16`) in stages and expand executable coverage under `pyobj` model.
20. [x] [ID: P1-LIST-PYOBJ-MIG-01-S4-02-S2-S1] Resolve compile blocker where `grid[y][x] = ...` falls into `object[...]` under pyobj via `py_set_at(...)` lowering.
21. [x] [ID: P1-LIST-PYOBJ-MIG-01-S4-02-S2-S2] Identify cause of runtime failures in `07/08/09` (`setitem on non-list object`) and fix lowering/runtime so `py_set_at` input is list object.
22. [x] [ID: P1-LIST-PYOBJ-MIG-01-S4-02-S2-S3] Resolve `12_sort_visualizer` compile blocker (list-annotated arg mismatching `object` signature) with callsite boxing correction.
23. [x] [ID: P1-LIST-PYOBJ-MIG-01-S4-02-S2-S4] Resolve tuple/list runtime blocker in `13_maze_generation_steps` (missing tuple boxing and tuple-subscript unboxing).
24. [x] [ID: P1-LIST-PYOBJ-MIG-01-S4-02-S3] Switch default model to `pyobj` and reflect `--cpp-list-model value` as rollback procedure in operation docs.
25. [x] [ID: P1-LIST-PYOBJ-MIG-01-S4-03] Finalize old value-model compatibility-code removal plan (including criteria for filing separate IDs).
26. [x] [ID: P1-LIST-PYOBJ-MIG-01-S4-04] Sync operation docs in how-to-use/spec/todo and satisfy final acceptance criteria.

### P1: All-language comment fidelity policy (forbid generated comments)

Context: [docs/ja/plans/p1-comment-fidelity-all-backends.md](../plans/p1-comment-fidelity-all-backends.md)

1. [x] [ID: P1-COMMENT-FIDELITY-01] Fix the contract and tests for all backends: "forbid comments not present in source, and reflect all source comments without loss."
2. [x] [ID: P1-COMMENT-FIDELITY-01-S1-01] Inventory fixed comment/`TODO`/`pass` comment-output locations in all emitters and fix prohibited pattern list.
3. [x] [ID: P1-COMMENT-FIDELITY-01-S1-02] Specify comment output contract (only `module_leading_trivia` / `leading_trivia` allowed) and fail-closed policy.
4. [x] [ID: P1-COMMENT-FIDELITY-01-S2-01] Remove fixed-comment outputs in `ts/go/java/swift/kotlin/ruby/lua` and unify to source-comment propagation only.
5. [x] [ID: P1-COMMENT-FIDELITY-01-S2-02] Replace `pass` / unsupported-comment paths in `cpp/rs/cs/js` with no-op or exceptions.
6. [x] [ID: P1-COMMENT-FIDELITY-01-S3-01] Add prohibited-comment checks and source-comment propagation tests to all `test_py2*smoke.py` files and lock regressions.
7. [x] [ID: P1-COMMENT-FIDELITY-01-S3-02] Regenerate `sample/*`, verify zero fixed-comment residue.
