<a href="../../docs-jp/todo-history/20260222.md">
  <img alt="Read in Japanese" src="https://img.shields.io/badge/docs-日本語-2563EB?style=flat-square">
</a>

# TODO History (2026-02-22)

## 2026-02-22 Completed: `P0-SH-01` / `P0-SH-03` recovery of selfhost `.py` direct-input path

1. Marked `ID: P0-SH-01` and `ID: P0-SH-03` complete in `docs-jp/todo.md`.
2. Fixed root cause.
- Removed reinitialization of `import_modules` / `import_symbols` / `import_symbol_modules` in `src/py2cpp.py` `CppEmitter.__init__`, eliminating the path where selfhost-generated C++ base helpers referenced empty tables.
3. Performed regression checks.
- Confirmed `python3 tools/build_selfhost.py` succeeds.
- Confirmed `failures=0` on representative `verify_selfhost_end_to_end.py --skip-build` case sets.

## 2026-02-22 Completed: reflected completion of `render_expr` Call-branch split (builtin/module/method)

1. Marked completion of the `docs/todo.md` task: split `render_expr` Call branches by feature and migrate to `CodeEmitter` helpers.
2. Confirmed evidence.
- `Call` path in `src/py2cpp.py` is separated into feature helpers.
- Call preprocessing/owner resolution now goes through common `CodeEmitter` helpers.
- Unit tests and selfhost build passed.

## 2026-02-22 Completed: reflected completion of `render_expr` arithmetic/comparison/type-conversion split

1. Marked completion of the corresponding `docs/todo.md` reduction task.
2. Confirmed evidence.
- Arithmetic/comparison branches are split into dedicated helper paths.
- `hook_on_render_expr_kind(...)` / `hook_on_render_binop(...)` hook routes are in place.
- Type-cast builtin path is isolated.
- Unit tests and selfhost checks passed.

## 2026-02-22 Completed: reflected completion of continued unused/duplicate-function cleanup (`P1-8`)

1. Marked completion of the cleanup task in `docs/todo.md`.
2. Confirmed duplicate local helpers were removed and unified to shared helpers without changing behavior.

## 2026-02-22 Completed: reflected completion of `emit_stmt` control-structure template migration (`syntax_*`)

1. Marked completion of the corresponding `docs/todo.md` task.
2. Confirmed control-structure emission moved to `syntax_line(...)` / `syntax_text(...)` paths and hook-side brace/range behavior remained intact.

## 2026-02-22 Completed: reflected completion of shared template migration for `FunctionDef/ClassDef`

1. Marked completion of the corresponding `docs/todo.md` task.
2. Confirmed shared open/close/scoped helpers are implemented in `CodeEmitter` and duplicated C++-side copies were removed.

## 2026-02-22 Completed: reflected completion of `render_expr(Call/BinOp/Compare)` split task

1. Marked completion of the corresponding hooks/helpers split task.
2. Confirmed helper routes and hook-first dispatch, with unit tests passing.

## 2026-02-22 Completed: reflected completion of hook migration for C++-specific differences (brace/range-mode)

1. Marked completion of the corresponding reduction task.
2. Confirmed `hook_on_stmt_omit_braces(...)` and `hook_on_for_range_mode(...)` usage and C++ hook registration.

## 2026-02-22 Completed: reflected completion of common rendering for `Constant/Name/Attribute`

1. Marked completion of the corresponding reduction task.
2. Confirmed `render_name_ref`, `render_constant_expr_common`, `render_attribute_expr_common` shared helpers are used.

## 2026-02-22 Completed: `EmitterHooks` implementation batch

1. Marked completion of `Implement hook injection (EmitterHooks)` in `docs/todo.md`.
2. Confirmed `EmitterHooks` and major hook entry points in `code_emitter.py`, plus C++ hook registrations.

## 2026-02-22 Completed: reduce selfhost `CodeEmitter` classmethod stubs

1. Shifted `CodeEmitter` main implementation toward selfhost-safe form (`quote_string_literal`, `load_profile_with_includes` static methods and loop-shape adjustments).
2. Removed one layer of selfhost-only replacement logic in `tools/prepare_selfhost_source.py`.
3. Performed regression checks.

## 2026-02-22 Completed: reduce selfhost `dump_codegen_options_text` stub

1. Replaced minimal fixed stub with selfhost-safe equivalent implementation that emits detailed option lines.
2. Revalidated with selfhost build and option-dump checks.

## 2026-02-22 Completed: P4 `py2cs.py` EAST migration

1. Replaced `src/py2cs.py` with EAST-based thin CLI.
2. Split C#-specific behavior into hooks/profile (`src/hooks/cs/`, `src/profiles/cs/`).
3. Added smoke/regression path (`test/unit/test_py2cs_smoke.py`).

## 2026-02-22 Completed: consumed P3/P4 batch in `docs-jp/todo.md`

1. Completed P3 (`py2rs` EAST-centered redesign).
2. Completed P4 (EAST migration for additional language transpilers).
3. Added cross-language regression checks.

## 2026-02-22 Completed: shortest path to pass Yanesdk (library + game) via py2cpp

1. Finalized preprocessing policy (`from yanesdk import *`, `# type:ignore`).
2. Finalized handling of duplicated `Yanesdk/docs/*/yanesdk.py` copies (canonical-source-first policy).
3. Met success conditions for canonical conversion path.

## 2026-02-22 Completed: added P2 acceptance tests (from Yanesdk)

1. Added minimal fixtures (BOM from-import, type-ignore from-import, class-body pass, etc.).
2. Closed acceptance criteria for fixture-level regressions.

## 2026-02-22 Completed: P1-B import/module resolution (required for Yanesdk)

1. Unified handling policy for `math` / `random` / `timeit` / `traceback` / `enum` / `typing`.
2. Added browser-related shim modules and confirmed canonical smoke (`checked=8 ok=8 fail=0`).
3. Documented duplicate-layout exclusion rule in import spec.

## 2026-02-22 Completed: P0-URGENT fix for selfhost stage2 ternary corruption (`(? : )`)

1. Standardized full-regeneration verification using `tools/build_selfhost.py` + `tools/build_selfhost_stage2.py`.
2. Added minimal reproduction fixture.
3. Traced root cause and fixed if-expression generation path.
4. Added regression tests.

## 2026-02-22 Completed: P1-A self_hosted parser/tokenizer expansion (required for Yanesdk)

Completed parser-side support for:
- UTF-8 BOM
- Backslash line continuation
- Exponent operator `**`
- Top-level expression statements
- `pass` in class body
- Minimal `yield`/generator acceptance

## 2026-02-22 Completed: DOCS-SYNC-01 `todo-history` translation-sync workflow

1. Marked `ID: DOCS-SYNC-01` complete in `docs-jp/todo.md`.
2. Added operational path for `docs/todo-history/`.
- Added `tools/sync_todo_history_translation.py` for missing-file stub sync.
- Added index auto-refresh with `pending` / `done` visibility.
- Added `--check` detection for missing/extra/index gaps.
3. Synced documentation rules.

## 2026-02-22 Completed: switch `P1-MQ-08` to golden-comparison workflow

1. Marked `ID: P1-MQ-08` complete.
2. Switched `tools/verify_sample_outputs.py` to golden-based operation.
3. Added `sample/golden/manifest.json` as baseline metadata store.

## 2026-02-22 Completed: clarify responsibility boundaries (`P1-COMP-06` / `P1-COMP-07`)

1. Marked both IDs complete.
2. Documented boundaries among `CodeEmitter`, EAST parser, and compiler shared layer in spec.
3. Reflected decision in the related plan document.

## 2026-02-22 Completed: created migration plan for shared analysis API in other language CLIs (`P1-COMP-08`)

1. Marked `ID: P1-COMP-08` complete.
2. Added phased plan (Phase 0-4) to `docs-jp/plans/p1-compiler-shared-extraction.md`.

## 2026-02-22 Completed: prepared plan/rules for runtime layout unification (`P1-RUNTIME-04` / `P1-RUNTIME-06`)

1. Marked both IDs complete.
2. Added non-Rust migration plan (`src/*_module/` -> `src/runtime/<lang>/pytra/`).
3. Added operational rule: no new runtime bodies under `src/*_module/`.

## 2026-02-22 Completed: stabilize minimal selfhost execution path for `P0-SH-02` (fix nested-body omission)

1. Marked `ID: P0-SH-02` complete.
2. Identified static-binding root cause and added `CppEmitter` overrides for scoped-statement emission.
3. Revalidated with selfhost build and targeted diff checks.
