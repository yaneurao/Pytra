# TODO履歴（2026-02-18）

<a href="../../../en/todo/archive/20260218.md">
  <img alt="Read in English" src="https://img.shields.io/badge/docs-English-2563EB?style=flat-square">
</a>

## 移管済み（docs/ja/todo/index.md から） 2026-02-18

- [x] 比較・論理・算術の混在式で意味が変わらないことを `test/fixtures` で回帰確認する。
- [x] Python docstring を C++ の裸文字列文として出さず、コメントへ変換するか出力しない。
- [x] 関数先頭の単独文字列式（docstring）を `east.py` 側で専用メタ情報へ分離する。
- [x] `py2cpp.py` は `//` コメント出力に統一する（必要時のみ）。
- [x] 式文としての識別子単体出力を禁止するガードを `py2cpp.py` に追加する。
- [x] API 由来が追えるように、必要箇所に薄いコメントを付ける（例: `png.write_rgb_png` 対応）。
- [x] `write_rgb_png` / `save_gif` / `grayscale_palette` などランタイムブリッジ関数に限定して付与する。
- [x] コメントが過剰にならないよう最小限に制御する。
- [x] 生成コードのレイアウトを「意味単位」（初期化・計算・出力）で整える。
- [x] 連続宣言ブロック、連続代入ブロック、I/O 呼び出しブロックの間にのみ空行を入れる。
- [x] `sample/01` を可読性改善のゴールデンとして差分レビュー可能な形にする。
- [x] 方針変更: `python_ast` backend は廃止し、`self_hosted` 単独運用とする。
- [x] `src/common/east.py` に `parser_backend` 切替インターフェースを導入する。
- [x] CLI 引数で `--parser-backend` を受け付ける。
- [x] デフォルトは `self_hosted` とする。
- [x] 変換結果メタに backend 名を記録する。
- [x] `self_hosted` の最小字句解析器を追加する（コメント/改行/インデント含む）。
- [x] `INDENT` / `DEDENT` / `NEWLINE` / `NAME` / `NUMBER` / `STRING` / 記号をトークン化する。
- [x] `#` コメントを収集し、行番号つきで保持する。
- [x] tokenize 失敗時のエラー位置・ヒントを EAST エラー形式で返す。
- [x] `self_hosted` の最小構文木（内部ノード）を定義する。
- [x] まず `Module`, `FunctionDef`, `Assign`, `AnnAssign`, `Return`, `Expr`, `If`, `For`, `Call`, `Name`, `Constant`, `BinOp`, `Compare` を対象にする。
- [x] 各ノードに `lineno/col/end_lineno/end_col` を持たせる。
- [x] `self_hosted` 用パーサ本体（再帰下降）を追加する。
- [x] 式の優先順位テーブルを実装する（`* / %`, `+ -`, 比較, `and/or`）。
- [x] `for ... in range(...)` と通常 `for ... in iterable` を識別する。
- [x] 関数定義と型注釈（`x: int` / `-> int`）を解釈する。
- [x] 既存 EAST ビルド処理に `self_hosted` ノード経路を追加する。
- [x] 既存の型推論・lowering（`ForRange`, `Contains`, `SliceExpr` など）を共通で再利用できる形にする。
- [x] `self_hosted` 単独運用で EAST の形が安定するように正規化する。
- [x] コメント引き継ぎを実装する（`#` / docstring）。
- [x] `#` コメントを `leading_comments` として関数/文に紐づける。
- [x] `Expr(Constant(str))` の docstring と重複しないよう統合規則を決める。
- [x] `src/py2cpp.py` で `leading_comments` を `// ...` 出力する。
- [x] `case11_fib` を `self_hosted` で通す。
- [x] `case12_string_ops` を `self_hosted` で通す。
- [x] `case13_class` 〜 `case16_instance_member`（クラス系）を `self_hosted` で通す。
- [x] `case17_loop` 〜 `case24_ifexp_bool`（ループ/例外/内包/ifexp）を `self_hosted` で通す。
- [x] `case25_class_static` 〜 `case33_pathlib_extended`（拡張ケース）を `self_hosted` で通す。
- [x] `test/fixtures` 全ケースで `self_hosted` EAST が意味的に安定していることを確認する。
- [x] `src/py2cpp.py` で `--parser-backend self_hosted` 時に `test/fixtures` 全ケースが実行一致する。
- [x] デフォルト backend を `self_hosted` に変更する。
- [x] `save_gif(..., delay_cs=..., loop=...)` の keyword 引数を `py2cpp.py` の非lowered `Call` 経路でも確実に反映する。
- [x] 現状 `sample/cpp/*` で `save_gif(..., palette)` のみになり `delay_cs` が既定値 `4` に落ちる問題を修正する。
- [x] `sample/05,06,08,10,11,14` で GIF の GCE delay 値が Python 実行結果と一致することを確認する。
- [x] 浮動小数点式の再結合（演算順序変更）を抑制し、Python と同じ評価順を優先する。
- [x] `a * (b / c)` が `a * b / c` に変わらないように、`render_expr` の括弧方針を見直す。
- [x] `sample/01_mandelbrot` と `sample/03_julia_set` で PNG の raw scanline が一致することを確認する。
- [x] PNG 出力の差分を「画素差」と「圧縮差」に切り分けた上で、仕様として扱いを明文化する。
- [x] `sample/02_raytrace_spheres` は画素一致・IDAT 圧縮差のみであることを docs に追記する。
- [x] 必要なら C++ 側 `src/cpp_module/png.cpp` を zlib 圧縮実装へ寄せ、IDAT 近似一致または完全一致方針を決める。
- [x] GIF の `sample/12_sort_visualizer` / `sample/16_glass_sculpture_chaos` のフレーム画素差を解消する。
- [x] `render()` 内の float→int 変換境界（bar幅/補間/正規化）の評価順を Python と一致させる。
- [x] フレームデータ（LZW 展開後）が全フレーム一致することを確認する。
- [x] 画像一致検証を自動化する。
- [x] `sample/py` 全件について、`stdout` 比較に加えて PNG raw / GIF フレーム一致を検証するスクリプトを追加する。
- [x] 差分時は「最初の不一致座標・チャネル・元式」を出力できるようにする。
- [x] 方針を明文化する: Pythonのユーザー定義クラスは参照セマンティクスを原則とし、値型化は「意味保存が証明できる場合のみ」許可する。
- [x] `case34_gc_reassign` を回帰ゴールデンに設定し、`a = b` 後に同一オブジェクト共有（コピーで2個化しない）を必須条件にする。
- [x] 値型化の適用条件を仕様化する（例: インスタンスフィールドなし、`__del__` なし、インスタンス同一性に依存する操作なし、代入/引数渡しで共有観測されない）。
- [x] EAST 解析段階で「値型化候補クラス」と「参照必須クラス」を分類するメタ情報を追加する。
- [x] `src/py2cpp.py` にクラスごとのストレージ戦略選択（`rc<T>` / `T`）を実装し、混在ケースで正しく `.` と `->` を切り替える。
- [x] `case15_class_member` は以前どおり `Counter c = Counter();` へ戻す（最適化適用例）。
- [x] `case34_gc_reassign` は `rc<Tracked>` のまま維持する（最適化非適用例）。
- [x] 新規テストを追加する: 同一性依存ケース（代入共有、関数引数経由の更新共有、コンテナ格納後の共有）では必ず参照型を選ぶことを検証する。
- [x] 新規テストを追加する: 値型化候補（実質 stateless クラス）では出力C++が値型になり、実行結果がPython一致することを検証する。
- [x] selfhost一次ゴールを固定する: `python3 src/py2cpp.py selfhost/py2cpp.py -o selfhost/py2cpp.cpp` が成功する。
- [x] self-hosted parser で関数定義シグネチャの `*`（keyword-only 引数マーカー）を解釈可能にする。
- [x] `*` 対応後、`selfhost/py2cpp.py` の EAST 生成が最後まで通ることを確認する。
- [x] 関数定義シグネチャでの未対応要素（`/`, `*args`, `**kwargs`）の扱いを仕様化する（受理/拒否とエラーメッセージ）。
- [x] `src/common/east.py` の対応箇所へ最小コメントを追加し、どのシグネチャ構文をサポートするか明記する。
- [x] self_hosted parser の `STR` 解析で prefix 付き文字列（`f/r/b/u/rf/fr`）を正しく扱えるようにする。
- [x] self_hosted parser の `f-string` を `JoinedStr/FormattedValue` に落とす（最低限 `{expr}` と `{{` `}}`）。

## 移管: 2026-02-18（docs/ja/todo/index.md から完了済みを移動）

### Any/object 方針への移行（完了）

- [x] `src/cpp_module/py_runtime.h` に `using object = rc<PyObj>;` を導入する。
- [x] `Any -> object` 変換のためのボックス型を実装する。
- [x] `PyIntObj` / `PyFloatObj` / `PyBoolObj` / `PyStrObj`
- [x] `PyListObj` / `PyDictObj`（`list<object>` / `dict<str, object>` ベース）
- [x] `make_object(...)` / `obj_to_int64` / `obj_to_float64` / `obj_to_bool` / `obj_to_str` を実装する。
- [x] `py_is_none(object)` を実装し、null `object` 判定を統一する。
- [x] `py_to_string(object)` を実装する。

### py2cpp 側 Any lowering（完了）

- [x] `src/py2cpp.py` の `cpp_type()` で `Any` / `object` を `object` 型へ解決する。
- [x] `dict[str, Any]` を `dict<str, object>` に変換する。
- [x] `list[Any]` を `list<object>` に変換する。
- [x] `Any` 代入時に `make_object(...)` を生成する。
- [x] `Any` 利用演算時に明示的 unbox (`obj_to_*`) を生成する。
- [x] `Any is None` / `Any is not None` を `py_is_none` ベースへ統一する。

### selfhost 回復（部分完了）

- [x] `selfhost/py2cpp.cpp` を再生成し、現時点のコンパイルエラー件数を計測する。
  - 計測値: `305` errors（`g++ -std=c++20 -O2 -I src selfhost/py2cpp.cpp ...`）

### 内包表現・lambda 追加回帰（完了）

- [x] `test/fixtures/collections` に内包表現の追加ケースを増やす。
- [x] 二重内包（nested comprehension）
- [x] `if` 句を複数持つ内包
- [x] `range(start, stop, step)` を使う内包
- [x] `test/fixtures/core` に lambda の追加ケースを増やす。
- [x] `lambda` 本体が `ifexp` を含むケース
- [x] 外側変数 capture + 複数引数
- [x] 関数引数として lambda を渡すケース
- [x] 上記を `test/unit/test_py2cpp_features.py` の C++ 実行回帰に追加する。

### ドキュメント更新（完了）

- [x] `docs/ja/spec-east.md` に `Any -> object(rc<PyObj>)` 方針を明記する。
- [x] `docs/ja/spec.md` に `Any` の制約（boxing/unboxing, None 表現）を追記する。
- [x] `readme.md` に `Any` 実装状況（移行中）を明記する。

## 移管: 2026-02-18（todo.md から完了済みを移動・2）

### selfhost 回復（完了分）

- [x] `selfhost/py2cpp.py` のパース失敗を最小再現ケースへ分離する（`except ValueError:` 近傍）。
- [x] `src/common/east.py` self_hosted parser に不足構文を追加する。
- [x] 2. の再発防止として unit test を追加する。
- [x] `PYTHONPATH=src python3 src/py2cpp.py selfhost/py2cpp.py -o selfhost/py2cpp.cpp` を成功させる。
- [x] `selfhost/py2cpp.cpp` をコンパイルし、エラー件数を再計測する。
- [x] コンパイルエラー上位カテゴリを3分類し、順に削減する。
- [x] `src/py2cpp.py` 実行結果との一致条件を定義し、比較確認する。
- [x] `selfhost/` には `src` 最新をコピーしてよい前提で、`selfhost/py2cpp.py` と `selfhost/cpp_module/*` を同期する（`cp -f src/py2cpp.py selfhost/py2cpp.py` / `cp -f src/cpp_module/* selfhost/cpp_module/`）。
- [x] `g++` ログ取得を `> selfhost/build.all.log 2>&1` に統一し、`stderr` 空でも原因追跡できるようにする。

### object 制約の実装反映（汎用）

- [x] EAST で `object` レシーバの属性アクセス・メソッド呼び出しを検出し、`unsupported_syntax` を返す。
- [x] `py2cpp.py` の emit 時にもガードを追加し、`object` レシーバの呼び出し漏れを最終防止する。
- [x] `test/fixtures/signature/` に `object` レシーバ呼び出し禁止の NG ケースを追加する。
- [x] `test/unit` に NG ケースが失敗することを確認する回帰テストを追加する。

### 追加回帰（super）

- [x] `super()` の回帰 fixture を追加する（`test/fixtures/oop/super_init.py`）。
- [x] EAST parser 側で `super().__init__()` を含むコードが parse できる unit test を追加する。
- [x] C++ 変換して実行まで通る runtime test を追加する（`test/unit/test_py2cpp_features.py`）。

### EAST へ移譲（py2cpp 簡素化・第2段）

- [x] `src/common/east_parts/core.py` で `Call(Name(...))` の `len/str/int/float/bool/min/max/Path/Exception` を全て `BuiltinCall` 化し、`py2cpp` の生分岐を削減する。
- [x] `src/common/east_parts/core.py` で `Attribute` 呼び出しの `owner_t == "unknown"` フォールバック依存を減らし、型確定時は EAST で runtime_call を確定させる。
- [x] `src/py2cpp.py` の `render_expr(kind=="Call")` から、EAST で吸収済みの `raw == ...` / `owner_t.startswith(...)` 分岐を段階削除する。
- [x] `test/unit/test_py2cpp_features.py` に `BuiltinCall` 正規化の回帰（`dict.get/items/keys/values`, `str` メソッド, `Path` メソッド）を追加する。
- [x] `test/unit` 一式を再実行し、`test/fixtures` 一括実行で退行がないことを確認する。

### BaseEmitter 共通化（言語非依存 EAST ユーティリティ）

- [x] `src/common/base_emitter.py` に言語非依存ヘルパ（`any_dict_get`, union型分解、`Any` 判定）を移し、`CppEmitter` の重複を削減する。
- [x] ノード補助（`is_name/is_call/is_attr` などの軽量判定）を `BaseEmitter` に追加し、各エミッタの分岐可読性を上げる。
- [x] 型文字列ユーティリティ（`is_list_type/is_dict_type/is_set_type`）を `BaseEmitter` へ寄せる。
- [x] `py2cpp.py` で `BaseEmitter` の新規ユーティリティ利用へ置換し、挙動差分がないことを回帰テストで確認する。
- [x] 次段として `py2rs.py` / `py2cs.py` でも流用可能な API 形に揃え、適用候補箇所を `todo.md` に追記する。

## 移管: 2026-02-18（todo.md から完了済みを移動・3）

### selfhost 回復（完了分）

- [x] self_hosted parser で `return`（値なし）を文として受理する。
- [x] `return`（値なし）の再発防止 unit test（`test/unit/test_east_core.py`）を追加する。
- [x] `BaseEmitter` に `any_to_dict/any_to_list/any_to_str` ヘルパを追加する（自己変換時の型崩れ分析の土台）。
- [x] `py_runtime.h` に `optional<dict<...>>` 向け `py_dict_get/py_dict_get_default` 補助オーバーロードを追加する。

## 移管: 2026-02-18（C++ runtime wrapper 方針の整合）

- [x] `py_runtime.h` の `str/list/dict/set` を STL 継承ベースから「非継承 wrapper（composition）」へ移行する。
- [x] 非継承 `str` で range-for が自然に書けるよう、`begin()/end()`（必要なら iterator wrapper）を整理する。
- [x] `py2cpp.py` の生成コードから STL 依存の前提（継承由来の暗黙利用）を除去し、wrapper API のみで成立させる。
- [x] `test/fixtures/strings/str_for_each.py` を含む文字列走査ケースで、生成 C++ が簡潔な `for (str c : s)` を維持することを回帰確認する。
- [x] `docs/ja/spec-dev.md` / `docs/ja/how-to-use.md` / `docs/ja/spec-east.md` の wrapper 記述を実装実態と一致させる（移行完了時に再更新）。

## 移管: 2026-02-18（selfhost 回復 1-3）

- [x] `selfhost/py2cpp.cpp` で `object -> optional<dict<...>> / list<object> / str` 代入が失敗している箇所を、`any_to_dict/any_to_list/any_to_str` を通る形へ統一する。
- [x] `py_dict_get_default(...)` 呼び出しの曖昧解決（`bool` 既定値など）を解消するため、`dict_get_bool/str/list/node` など型付き helper 呼び出しへ置換する。
- [x] `emit_stmt` / `emit_assign` / `render_expr` の `dict|None` 固定引数を段階的に `Any` 受け + 内部 `dict` 化へ寄せ、selfhost 生成コードの `std::any` 入力と整合させる。

## 移管: 2026-02-18（todo.md から完了済みを移動・4）

### 画像ランタイム統一（Python正本）

- [x] `src/pylib/png.py` を正本として、`py2cpp` 向け C++ 画像ランタイム（`src/runtime/cpp/pylib`）を段階的にトランスパイル生成へ置換する。
  - [x] `py2cpp` に `--no-main` を追加し、ライブラリ変換（`main` なし）を可能にする。
  - [x] self-hosted parser で `0x...` 整数リテラルと `^=` など拡張代入を受理する。
  - [x] self-hosted parser で `with expr as name:` を `Assign + Try(finally close)` へ lower する。
  - [x] `pylib/png.py` 変換結果で残るランタイム依存（`open`, `ValueError`, `to_bytes` など）を C++ ランタイム API へ接続する。
  - [x] 生成結果を `src/runtime/cpp/pylib/png.cpp` へ置換し、既存出力と一致確認する。
- [x] `src/pylib/gif.py` を正本として、`py2cpp` 向け C++ 画像ランタイム（`src/runtime/cpp/pylib`）を段階的にトランスパイル生成へ置換する。
  - [x] `_lzw_encode` のネスト関数を除去し、self-hosted parser で変換可能な形へ整理する。
  - [x] `py2cpp --no-main src/pylib/gif.py` で C++ ソース生成できるところまで到達する。
  - [x] 生成結果で残るランタイム依存（`open`, `ValueError`, `to_bytes` など）を C++ ランタイム API へ接続する。
  - [x] 生成結果を `src/runtime/cpp/pylib/gif.cpp` へ置換し、既存出力と一致確認する。
- [x] 画像一致判定の既定手順を「バイナリ完全一致」へ統一し、`py2cpp` 向けの検証スクリプトを整理する。
  - [x] `pylib` と `runtime/cpp/pylib` の PNG/GIF 出力一致を確認する自動テスト（最小ケース）を追加する。
  - [x] 置換作業中の受け入れ基準を「Python正本と同じ入力で同一出力」へ固定する。
- [x] 速度がボトルネックになる箇所のみ、`py2cpp` 向け最適化の許容範囲を文書化する。

### import 強化

- [x] `from XXX import YYY` / `as` を EAST メタデータと `py2cpp` の両方で解決し、呼び出し先ランタイムへ正しく接続する。
- [x] `import module as alias` の `module.attr(...)` を alias 解決できるようにする。
- [x] `from pytra.runtime.png import write_rgb_png` / `from pytra.runtime.gif import save_gif` / `from math import sqrt` の回帰テストを追加する。
- [x] `import` 関連の仕様追記（対応範囲・`*` 非対応）を `docs/ja/spec-east.md` / `docs/ja/spec-user.md` / `docs/ja/spec-dev.md` に反映する。

### selfhost 回復（完了済み分）

- [x] `py2cpp.py` の `BaseEmitter` 共通化後、selfhost 生成時に `common.base_emitter` の内容を C++ へ取り込む手順（または inline 展開）を実装する。
  - [x] `tools/prepare_selfhost_source.py` を追加して、`selfhost/py2cpp.py` を自己完結化する。
  - [x] `python3 src/py2cpp.py selfhost/py2cpp.py -o selfhost/py2cpp.cpp` が通る状態に戻す。
