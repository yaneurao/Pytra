# TODO履歴（2026-03-01）

<a href="../../../en/todo/archive/20260301.md">
  <img alt="Read in English" src="https://img.shields.io/badge/docs-English-2563EB?style=flat-square">
</a>

## 2026-03-01 移管: `P0: core.py の perf_counter 特化分岐の完全撤去（回帰修正）`

以下を `docs/ja/todo/index.md` から `todo/archive` へ移管。

文脈: [docs/ja/plans/p0-stdlib-signature-source-of-truth.md](../plans/p0-stdlib-signature-source-of-truth.md)

1. [x] [ID: P0-STDLIB-SOT-02] `core.py` の `fn_name == "perf_counter"` 直分岐を撤去し、stdlib シグネチャ参照層経由へ一本化する。
2. [x] [ID: P0-STDLIB-SOT-02-S1-01] `core.py` から `perf_counter` 文字列依存を削除し、`BuiltinCall` 判定は import 解決情報または共通 resolver 経由へ移行する。
3. [x] [ID: P0-STDLIB-SOT-02-S1-02] `test_east_core.py` に「`core.py` へ `perf_counter` 直書きが再混入しない」回帰を追加する。
4. [x] [ID: P0-STDLIB-SOT-02-S2-01] `test_py2cpp_codegen_issues.py` / `check_py2cpp_transpile.py` を再実行し、`perf_counter` 型推論と C++ 出力非退行を確認する。

## 2026-03-01 移管: `P0: sample/18 C++ 出力最適化の強化（実行系ホットパス）`

以下を `docs/ja/todo/index.md` から `todo/archive` へ移管。

文脈: [docs/ja/plans/p0-sample18-cpp-optimization-strengthening.md](../plans/p0-sample18-cpp-optimization-strengthening.md)

1. [x] [ID: P0-CPP-S18-OPT-01] sample/18 C++ のホットパス6項目（typed enumerate / typed container / parser access / enum tag / number predecode / typed execute loop）を段階実装する。
2. [x] [ID: P0-CPP-S18-OPT-01-S1-01] `enumerate(lines)` の typed tuple 反復条件を設計し、EAST3->C++ 出力契約を固定する。
3. [x] [ID: P0-CPP-S18-OPT-01-S1-02] tokenize ループで `object` + `py_at` を使わない typed loop header 出力を回帰固定する。
4. [x] [ID: P0-CPP-S18-OPT-01-S2-01] `tokens` が `object(list<object>)` へ退化する条件を特定し、型情報保持経路を定義する。
5. [x] [ID: P0-CPP-S18-OPT-01-S2-02] `tokenize`/`Parser` の tokens を typed container 出力へ移行し、boxing を削減する。
6. [x] [ID: P0-CPP-S18-OPT-01-S3-01] `Parser` の repeated token access を棚卸しし、共通 token cache 方針を確定する。
7. [x] [ID: P0-CPP-S18-OPT-01-S3-02] `peek_kind/expect/parse_primary` で同一 index の重複 `py_at + obj_to_rc_or_raise` を削減する。
8. [x] [ID: P0-CPP-S18-OPT-01-S4-01] `ExprNode.kind` / `StmtNode.kind` / `op` の文字列比較箇所を enum/整数タグ化方針へ落とし込む。
9. [x] [ID: P0-CPP-S18-OPT-01-S4-02] C++ 出力をタグ分岐へ移行し、`if (node->kind == \"...\")` 連鎖を縮退する。
10. [x] [ID: P0-CPP-S18-OPT-01-S5-01] `NUMBER` token の parse 時 `py_to_int64` 経路を字句段 predecode へ移行する仕様を確定する。
11. [x] [ID: P0-CPP-S18-OPT-01-S5-02] `Token` 数値フィールドを利用して `parse_primary` の文字列->数値変換を削減する。
12. [x] [ID: P0-CPP-S18-OPT-01-S6-01] `execute` の stmt 反復を typed loop 化するため、`parse_program` 戻り値型の整合を確定する。
13. [x] [ID: P0-CPP-S18-OPT-01-S6-02] `for (object ... : py_dyn_range(stmts))` を typed 反復へ置換し、ループ内 `obj_to_rc_or_raise` を削減する。
14. [x] [ID: P0-CPP-S18-OPT-01-S7-01] `sample/18` 再生成差分（6項目）を golden 回帰で固定する。
15. [x] [ID: P0-CPP-S18-OPT-01-S7-02] `check_py2cpp_transpile.py` / unit test / sample 実行で非退行を確認する。
- `P0-CPP-S18-OPT-01-S1-01` `pyobj` モードでも `enumerate(list[str])` は `py_to_str_list_from_object(...)` を介して typed enumerate へ戻す契約を `CppStatementEmitter` に実装した。
- `P0-CPP-S18-OPT-01-S1-02` `test_py2cpp_codegen_issues.py` に sample/18 回帰（`for (const auto& [line_index, source] : ... )`）を追加し、`sample/cpp/18_mini_language_interpreter.cpp` 再生成で `object + py_at` 連鎖が消えることを確認した。
- `P0-CPP-S18-OPT-01-S2-01` `cpp_list_model=pyobj` 時に `list[T] -> object` へ型写像される境界（`_cpp_type_text`）と、`tokens` が「関数戻り値+クラスフィールド」に乗るため stack list 縮退対象外であることを計画書に固定した。
- `P0-CPP-S18-OPT-01-S3-01` `Parser` で `py_at(this->tokens, this->pos)` が `peek_kind/expect/parse_primary` に重複する箇所を棚卸しし、`_current_token()` / `_previous_token()` 相当 helper を emitter が合成する方式を実装方針として固定した。
- `P0-CPP-S18-OPT-01-S3-02` sample/18 の `Parser` を `current_token()/previous_token()` 参照へ寄せ、C++ 出力の `expect` で token 取得を1回化し、`peek_kind` / `parse_primary` も helper 経由へ統一した。
- `P0-CPP-S18-OPT-01-S4-01` 文字列比較の現状（`node->kind` 4箇所、`node->op` 4箇所、`stmt->kind` 2箇所）を棚卸しし、`kind/op` を `uint8` タグへ併置して比較を整数化する段階移行方針を確定した。
- `P0-CPP-S18-OPT-01-S5-01` `NUMBER` は tokenize 時点で `int64 number_value` を predecode し、`parse_primary` では `token_num->number_value` を優先利用する仕様（非 NUMBER は既定値0）を確定した。
- `P0-CPP-S18-OPT-01-S6-01` `parse_program` 戻り値を `list<rc<StmtNode>>`（必要境界のみ boxing）へ寄せる整合方針を固定し、`execute` 側 typed loop への接続契約を定義した。
- `P0-CPP-S18-OPT-01-S6-02` `py_to_rc_list_from_object<T>()` runtime helper と ForCore emitter fastpath を追加し、sample/18 の `execute` ループを `for (rc<StmtNode> stmt : ...)` へ置換した（`obj_to_rc_or_raise` のループ内呼び出しを削減）。
- `P0-CPP-S18-OPT-01-S7-02` `test_py2cpp_codegen_issues.py`（76件）/`test_east3_cpp_bridge.py`（90件）/`check_py2cpp_transpile.py`（`ok=134`）に加え、`runtime_parity_check --case-root sample --targets cpp 18_mini_language_interpreter`（PASS）で非退行を確認した。
- `P0-CPP-S18-OPT-01-S5-02` `Token.number_value` を追加し tokenize で NUMBER のみ predecode、`parse_primary` は `token_num.number_value` を直接利用するよう更新した（`py_to_int64(token_num->text)` を除去）。
- `P0-CPP-S18-OPT-01-S4-02` `ExprNode/StmtNode` に `kind_tag/op_tag` を追加して eval/execute 分岐を整数比較へ置換し、文字列比較連鎖を削減した（parity PASS、`test_py2cpp_codegen_issues.py` で回帰固定）。
- `P0-CPP-S18-OPT-01-S2-02` `cpp_list_model=pyobj` でも `list[RefClass]` は typed container として扱う経路を emitter に追加し、sample/18 の `tokenize` 戻り値・`Parser.tokens`・`parse_program`/`execute` 引数を `list<rc<...>>` へ縮退した（`object + py_append/py_at` 連鎖を削減）。
- `P0-CPP-S18-OPT-01-S7-01` `test_py2cpp_codegen_issues.py` に sample/18 の typed token container 回帰（`tokenize`/`Parser.tokens`/`current_token`）を追加し、`sample/cpp/18_mini_language_interpreter.cpp` 再生成差分を固定した。
- `P0-CPP-S18-OPT-01` 80件 unit / `test_east3_cpp_bridge.py` 90件 / `check_py2cpp_transpile.py`（`ok=134`）/ `runtime_parity_check`（sample/18 cpp PASS）で6項目の非退行を確認し、親タスクを完了扱いにした。

## 2026-03-01 移管: 完了済みセクション（3件）

以下を `docs/ja/todo/index.md` から `todo/archive` へ移管。

### P1: Rust runtime 外出し（inline helper / `mod pytra` 埋め込み撤去）

文脈: [docs/ja/plans/p1-rs-runtime-externalization.md](../plans/p1-rs-runtime-externalization.md)

1. [x] [ID: P1-RS-RUNTIME-EXT-01] Rust backend の生成コードから runtime/helper 本体の inline 出力を撤去し、runtime 外部参照方式へ統一する。
2. [x] [ID: P1-RS-RUNTIME-EXT-01-S1-01] Rust emitter の inline helper 出力一覧と `src/runtime/rs/pytra` 正本 API 対応表を確定する。
3. [x] [ID: P1-RS-RUNTIME-EXT-01-S1-02] Rust 生成物の runtime 参照方式（`mod/use` 構成と出力ディレクトリ配置契約）を確定し、fail-closed 条件を文書化する。
4. [x] [ID: P1-RS-RUNTIME-EXT-01-S2-01] `src/runtime/rs/pytra` 側へ不足 helper/API を補完し、inline 実装と同等の意味を提供する。
5. [x] [ID: P1-RS-RUNTIME-EXT-01-S2-02] `py2rs.py` に runtime ファイル配置導線を追加し、生成コードが外部 runtime を解決できる状態へ移行する。
6. [x] [ID: P1-RS-RUNTIME-EXT-01-S2-03] `rs_emitter.py` から runtime/helper 本体出力を撤去し、runtime API 呼び出し専用へ切り替える。
7. [x] [ID: P1-RS-RUNTIME-EXT-01-S3-01] `check_py2rs_transpile` / Rust smoke / parity を更新して回帰を固定する。
8. [x] [ID: P1-RS-RUNTIME-EXT-01-S3-02] `sample/rs` を再生成し、inline helper 残存ゼロを確認する。
- `P1-RS-RUNTIME-EXT-01-S1-01` `RUST_RUNTIME_SUPPORT` / `_emit_pyany_runtime` / `_emit_isinstance_runtime_helpers` の inline 出力を棚卸しし、`src/runtime/rs/pytra/built_in/py_runtime.rs` との API 対応差分（不足: `py_str_at`/`py_slice_str`/`mod time|math|pytra`/`PyAny`/`isinstance` 群）を計画書へ固定した。
- `P1-RS-RUNTIME-EXT-01-S1-02` Rust runtime 参照契約（`py_runtime.rs` 同梱配置、`mod py_runtime;` + `pub use` + `use crate::py_runtime::*;`）と fail-closed 条件（正本未検出/配置失敗/inline残存検知で失敗）を計画書へ明記した。
- `P1-RS-RUNTIME-EXT-01-S2-01` `py_runtime.rs` に不足 API（`py_str_at`/`py_slice_str`、`PyAny` 変換群、`PYTRA_TID_*` + `py_isinstance` 基盤、`pub mod time/math/pytra`）を追加し、`rustc --crate-type lib src/runtime/rs/pytra/built_in/py_runtime.rs` で構文確認を通した。
- `P1-RS-RUNTIME-EXT-01-S2-02` `py2rs.py` に runtime コピー導線を追加し、`test_py2rs_smoke` の CLI ケースで `py_runtime.rs` 同梱出力を確認した（`check_py2rs_transpile` の失敗4件は `Try/Yield/Swap` 未対応の既存差分として `S3-01` で扱う）。
- `P1-RS-RUNTIME-EXT-01-S2-03` `rs_emitter.py` から runtime/helper 本体の inline 出力を撤去し、`mod py_runtime;` + `pub use` + `use crate::py_runtime::*;` 参照へ切替えた。`isinstance` は `py_register_generated_type_info()`（`Once` ガード）で runtime 側 type table を初期化する方式へ移行した。
- `P1-RS-RUNTIME-EXT-01-S3-01` `test_py2rs_smoke`（28件）、`check_py2rs_transpile.py`（`checked=129 ok=129 fail=0 skipped=10`）、`runtime_parity_check --targets rs --all-samples`（18/18 PASS）を通し、回帰なしを確認した。
- `P1-RS-RUNTIME-EXT-01-S3-02` `tools/regenerate_samples.py --langs rs --force` で `sample/rs` 18件を再生成し、`py_runtime.rs` 以外に `fn py_perf_counter|fn py_isdigit|mod pytra {` が残っていないことを確認した。

### P1: Ruby 計測値の再計測・parity確認・README反映フロー固定

文脈: [docs/ja/plans/p1-ruby-benchmark-readme-fix.md](../plans/p1-ruby-benchmark-readme-fix.md)

1. [x] [ID: P1-RUBY-BENCH-FIX-01] Ruby 計測値更新時に「fresh transpile → parity確認 → README反映」を必須化する。
2. [x] [ID: P1-RUBY-BENCH-FIX-01-S1-01] `sample/01` を `ruby --yjit`（`warmup=1`, `repeat=5`）で再計測し、ログを保存する。
3. [x] [ID: P1-RUBY-BENCH-FIX-01-S1-02] `runtime_parity_check` で `sample/01` の Ruby parity を確認する。
4. [x] [ID: P1-RUBY-BENCH-FIX-01-S1-03] `docs/ja/README.md` の Ruby 列へ測定値を反映し、差分を確定する。
- `P1-RUBY-BENCH-FIX-01-S1-01` `ruby --yjit`（warmup=1 / repeat=5）で `sample/ruby/01_mandelbrot.rb` を再計測し、`work/logs/bench_ruby_yjit_01_mandelbrot_20260301.json` に実測5回と中央値 `18.954643653007224` 秒を保存した。
- `P1-RUBY-BENCH-FIX-01-S1-02` `runtime_parity_check --case-root sample --targets ruby 01_mandelbrot --ignore-unstable-stdout` を実行し、`SUMMARY cases=1 pass=1 fail=0` を確認した。
- `P1-RUBY-BENCH-FIX-01-S1-03` `docs/ja/README.md` の実行速度比較表で `01_mandelbrot` の Ruby 値を `18.682 -> 18.955`（中央値の小数第3位丸め）へ更新した。

### P1: `core.py` の `Path` 直分岐撤去（stdlib 正本化）

文脈: [docs/ja/plans/p1-core-path-direct-branch-removal.md](../plans/p1-core-path-direct-branch-removal.md)

1. [x] [ID: P1-CORE-PATH-SOT-01] `core.py` の `Path` 直分岐を撤去し、stdlib 参照層 + import 解決情報へ一本化する。
2. [x] [ID: P1-CORE-PATH-SOT-01-S1-01] `Path` 依存分岐（戻り値推論 / BuiltinCall lower / 属性推論）を棚卸しし、置換先 API を固定する。
3. [x] [ID: P1-CORE-PATH-SOT-01-S2-01] `Path` 判定を名前直書きから resolver 経由へ置換し、`core.py` から `fn_name == "Path"` を削除する。
4. [x] [ID: P1-CORE-PATH-SOT-01-S2-02] `Path` constructor/method/attribute の戻り値推論を stdlib 参照層で補完する。
5. [x] [ID: P1-CORE-PATH-SOT-01-S3-01] 再混入防止回帰を `test_east_core.py` に追加する。
6. [x] [ID: P1-CORE-PATH-SOT-01-S3-02] `check_py2cpp_transpile.py` を再実行し、非退行を確認する。
- `P1-CORE-PATH-SOT-01-S1-01` `core.py` の `Path` 直依存4箇所（`fn_name == "Path"` の戻り値推論/BuiltinCall、`owner_t == "Path"` の属性戻り値推論、`BinOp "/"` の `lt == "Path"`）を棚卸しし、`signature_registry` と import 解決情報へ寄せる置換方針を計画書に固定した。
- `P1-CORE-PATH-SOT-01-S2-01` `lookup_stdlib_imported_symbol_return_type` / `lookup_stdlib_imported_symbol_runtime_call` を追加して `Path` constructor 判定を import resolver 経由へ移行し、`core.py` から `fn_name == "Path"` 分岐を撤去した。
- `P1-CORE-PATH-SOT-01-S2-02` `lookup_stdlib_method_return_type` に `Path` メソッド戻り値推論を移管し、`test_east_core.py` に alias import (`Path as P/PP`) 回帰を追加して `python3 -m unittest discover -s test/unit -p 'test_east_core.py' -v` を通した。
- `P1-CORE-PATH-SOT-01-S3-01` `test_east_core.py` に `Path` 直分岐再混入検知（`fn_name/owner_t` 直比較禁止）を追加し、alias import 経路の constructor/type 推論回帰を固定した。
- `P1-CORE-PATH-SOT-01-S3-02` `python3 tools/check_py2cpp_transpile.py` を再実行し、`checked=134 ok=134 fail=0 skipped=6` で非退行を確認した。

## 2026-03-01 移管: 完了済みセクション（P0/P1/P2 と P4 完了子タスク）

以下を `docs/ja/todo/index.md` から `todo/archive` へ移管。

### P0: 完了済みセクション（14件）

1. [x] [ID: P0-CPP-S18-TOKENIZE-TYPED-IN-01] sample/18 `tokenize` 入力の typed 化（`object` 退化撤去）。
2. [x] [ID: P0-CPP-S18-ENUM-DIRECT-TYPED-01] sample/18 `enumerate(lines)` の direct typed unpack 化。
3. [x] [ID: P0-CPP-S18-STR-IDENTITY-CAST-01] sample/18 `str -> str` 同型変換の撤去。
4. [x] [ID: P0-CPP-S18-TOKEN-DISPATCH-TAG-01] sample/18 tokenizer の文字列分岐 tag 化。
5. [x] [ID: P0-CPP-S18-BENCH-TYPED-LIST-01] sample/18 benchmark ソース構築の typed list 化。
6. [x] [ID: P0-CPP-S13-TYPED-LIST-EXPAND-01] sample/13 向け `cpp_list_model=pyobj` typed list 拡張。
7. [x] [ID: P0-CPP-S13-CANDIDATE-CSE-01] sample/13 `candidates` 選択式の CSE/hoist。
8. [x] [ID: P0-CPP-S13-SAMECAST-CUT-01] sample/13 同型 cast 連鎖の縮退。
9. [x] [ID: P0-CPP-S13-GRID-ROW-HOIST-01] sample/13 `grid` 行アクセス hoist。
10. [x] [ID: P0-CPP-S13-WHILE-EMPTY-FASTPATH-01] sample/13 `while stack` の `.empty()` fastpath。
11. [x] [ID: P0-CPP-MODULE-KW-COERCE-01] C++ module import 関数の keyword 引数型伝播修正。
12. [x] [ID: P0-CPP-ENUM-LIST-AS-01] C++ `py_enumerate_list_as<T>()` 導入。
13. [x] [ID: P0-CPP-FLOAT-CAST-STYLE-01] C++ `float64` cast 表記統一。
14. [x] [ID: P0-EAST3-PYTO-IDENTITY-01] EAST3 同型 `py_to<T>` 縮退。

### P1: 完了済みセクション（2件）

1. [x] [ID: P1-KOTLIN-RUNTIME-EXT-01] Kotlin runtime 外出し（inline helper 撤去）。
2. [x] [ID: P1-LUA-SAMPLE-FULL-01] Lua sample 全18件対応。

### P2: 完了済みセクション（2件）

1. [x] [ID: P2-JAVA-PARENS-01] Java 出力の過剰括弧削減（可読性）。
2. [x] [ID: P2-EAST-IMPORT-RESOLUTION-01] EAST 解決情報 + CodeEmitter 依存収集による最小 import 生成。

### P4: 完了済み子タスク（`P4-MULTILANG-SH-01` 配下）

1. [x] [ID: P4-MULTILANG-SH-01-S1-01] stage1/stage2/stage3 未達要因の言語別固定化。
2. [x] [ID: P4-MULTILANG-SH-01-S1-02] runner 未定義言語の契約定義。
3. [x] [ID: P4-MULTILANG-SH-01-S2-01] Rust selfhost stage1 失敗解消。
4. [x] [ID: P4-MULTILANG-SH-01-S2-02] C# selfhost stage2 compile 失敗解消。
5. [x] [ID: P4-MULTILANG-SH-01-S2-02-S1] C# emitter selfhost 互換ギャップ解消。
6. [x] [ID: P4-MULTILANG-SH-01-S2-02-S2] C# selfhost import 依存閉包方式確定。
7. [x] [ID: P4-MULTILANG-SH-01-S2-02-S2-S1] C# selfhost 先頭エラー足切り。
8. [x] [ID: P4-MULTILANG-SH-01-S2-02-S2-S2] import 依存閉包実装。
9. [x] [ID: P4-MULTILANG-SH-01-S2-02-S2-S2-S1] 単体 selfhost source PoC。
10. [x] [ID: P4-MULTILANG-SH-01-S2-02-S2-S2-S2] PoC 失敗要因の解消/方針転換。
11. [x] [ID: P4-MULTILANG-SH-01-S2-02-S2-S2-S2-S1] parse 制約解消。
12. [x] [ID: P4-MULTILANG-SH-01-S2-02-S2-S2-S2-S2] compile 失敗分類と段階解消。
13. [x] [ID: P4-MULTILANG-SH-01-S2-02-S2-S2-S2-S2-S1] compile 失敗機械分類ツール追加。
14. [x] [ID: P4-MULTILANG-SH-01-S2-02-S2-S2-S2-S2-S2] `CS1525/CS1002` クラス解消。
15. [x] [ID: P4-MULTILANG-SH-01-S2-02-S2-S2-S2-S2-S3] `tuples > 7` 内部例外回避。
16. [x] [ID: P4-MULTILANG-SH-01-S2-02-S2-S2-S2-S2-S4] `CS1061/CS0103/CS1503` 上位群縮退。
17. [x] [ID: P4-MULTILANG-SH-01-S2-02-S2-S2-S2-S2-S5] `set/list/json` / `char/string` 失敗縮退。
18. [x] [ID: P4-MULTILANG-SH-01-S2-02-S2-S2-S2-S2-S6] `json` / `dict.get/items` / static参照不整合の解消。
19. [x] [ID: P4-MULTILANG-SH-01-S2-02-S2-S2-S2-S2-S7] nested helper/型縮約補強。
20. [x] [ID: P4-MULTILANG-SH-01-S2-02-S3] C# selfhost stage2/stage3 pass 到達。
- `docs/ja/todo/index.md` には未完了項目のみを残し、上記完了タスクの進捗メモ行は archive 側へ集約した。
