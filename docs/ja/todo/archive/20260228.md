# TODO履歴（2026-02-28）

<a href="../../../en/todo/archive/20260228.md">
  <img alt="Read in English" src="https://img.shields.io/badge/docs-English-2563EB?style=flat-square">
</a>

## 2026-02-28 移管: `P0: EAST3最適化層の強化（sample C++ 出力改善）`

以下を `docs/ja/todo/index.md` から `todo/archive` へ移管。

文脈: [docs/ja/plans/p0-east3-optimizer-sample-cpp-strengthening.md](../plans/p0-east3-optimizer-sample-cpp-strengthening.md)

1. [x] [ID: P0-EAST3-OPT-SAMPLE-CPP-01] `sample/cpp` 出力で目立つ冗長構文・型変換ノイズを削減するため、EAST3最適化層を7項目で段階強化する。
2. [x] [ID: P0-EAST3-OPT-SAMPLE-CPP-01-S1-01] `RangeForCanonicalizationPass` を拡張し、`step` 定数かつ有効範囲で `stop` 非定数ケースも `StaticRangeForPlan` へ正規化する。
3. [x] [ID: P0-EAST3-OPT-SAMPLE-CPP-01-S1-02] `enumerate(list[T])` を typed iterable として扱う EAST3 正規化を追加し、`object + py_at + py_to` 連鎖の発生を抑制する。
4. [x] [ID: P0-EAST3-OPT-SAMPLE-CPP-01-S1-03] 数値式の cast-chain 縮退 pass を追加し、型既知式での冗長 `py_to<T>` を削減する。
5. [x] [ID: P0-EAST3-OPT-SAMPLE-CPP-01-S1-04] ループ不変な分母・型変換（`py_to<float64>(width)` 等）の preheader hoist を追加し、内側ループの変換負荷を削減する。
6. [x] [ID: P0-EAST3-OPT-SAMPLE-CPP-01-S1-05] `list[list[int64]]` など型既知 `py_repeat` 初期化を typed materialization へ正規化し、`make_object(py_repeat(...))` 経路を縮退する。
7. [x] [ID: P0-EAST3-OPT-SAMPLE-CPP-01-S1-06] `dict<str, V>` の key アクセス/代入で不要な `py_to_string` を削減する EAST3 正規化を追加する。
8. [x] [ID: P0-EAST3-OPT-SAMPLE-CPP-01-S1-07] tuple unpack に対する一時 tuple 変数の生成を抑制し、`TupleTarget` 直接展開へ寄せる最適化を追加する。
- `P0-EAST3-OPT-SAMPLE-CPP-01-S1-01` `RangeForCanonicalizationPass` を拡張し、`range(n)`（`n: int64`）の `stop` 非定数ケースを `StaticRangeForPlan` へ正規化できることを `test_east3_optimizer.py` で回帰固定した。
- `P0-EAST3-OPT-SAMPLE-CPP-01-S1-02` `TypedEnumerateNormalizationPass` を追加し、`enumerate(list[T])` の `iter_item_type` / `iter_element_type` / `target_plan` 型情報を補完して typed loop header を選べることを `test_east3_optimizer.py` / `test_east3_cpp_bridge.py` で回帰固定した。
- `P0-EAST3-OPT-SAMPLE-CPP-01-S1-03` `NumericCastChainReductionPass` を追加し、同型 `static_cast` / `Unbox` の冗長連鎖を fail-closed で縮退できることを `test_east3_optimizer.py` で回帰固定した。
- `P0-EAST3-OPT-SAMPLE-CPP-01-S1-04` `LoopInvariantCastHoistPass` を追加し、`BinOp` の右辺数値昇格 cast を preheader へ hoist して `sample/06` の `height-1`/`width-1`/`frames_n` 変換をループ外へ移動できることを回帰固定した。
- `P0-EAST3-OPT-SAMPLE-CPP-01-S1-05` `TypedRepeatMaterializationPass` を追加し、`[0] * w` 系 `ListComp` の型を `list[list[int64]]` へ補完して `sample/py` 再変換で `make_object(py_repeat(...))` を 0 件化した。
- `P0-EAST3-OPT-SAMPLE-CPP-01-S1-06` `DictStrKeyNormalizationPass` を追加し、`dict[str, V]` キーを `dict_key_verified` 付きで正規化して `sample/18` の `env[...]` 経路から不要な `py_to_string` を除去しつつ `check_py2cpp_transpile.py` を通過させた。

## 2026-02-28 移管: `P0: Ruby \`/\` 演算の真の除算互換修正（最優先）`

以下を `docs/ja/todo/index.md` から `todo/archive` へ移管。

文脈: [docs/ja/plans/p0-ruby-true-division-parity.md](../plans/p0-ruby-true-division-parity.md)

1. [x] [ID: P0-RUBY-DIV-SEMANTICS-01] Ruby backend の `/` lowering を Python 互換（true division）へ修正し、`int/int` 由来の意味差を解消する。
2. [x] [ID: P0-RUBY-DIV-SEMANTICS-01-S1-01] `sample/06` を含む回帰ケースで現象再現を固定化し、ユニット/スモークで `/` の意味差を検知できるテストを追加する。
3. [x] [ID: P0-RUBY-DIV-SEMANTICS-01-S1-02] Ruby emitter の二項演算 lower を修正し、Python の `/` を常に真の除算として出力する（必要に応じて型変換 helper を追加）。
4. [x] [ID: P0-RUBY-DIV-SEMANTICS-01-S1-03] `sample/ruby` 再生成と parity 再検証（特に `sample/06`）を実施し、README 計測値の妥当性確認手順を文書へ反映する。

## 2026-02-28 移管: `P1: sample/18 C++ 生成コードの可読性縮退（選定: #2,#7,#8,#5,#1）`

以下を `docs/ja/todo/index.md` から `todo/archive` へ移管。

文脈: [docs/ja/plans/p1-cpp-sample18-readability-slimming.md](../plans/p1-cpp-sample18-readability-slimming.md)

1. [x] [ID: P1-CPP-S18-READ-01] `sample/18` の C++ 生成コードについて、選定改善項目（#2,#7,#8,#5,#1）を段階適用し、可読性を上げつつ挙動互換を維持する。
2. [x] [ID: P1-CPP-S18-READ-01-S1-02] 改善項目 #2: tuple unpack / 一時変数周辺の冗長 cast (`py_cast` / `py_to_*`) を削減し、型既知経路で直接利用できる emit に寄せる。
3. [x] [ID: P1-CPP-S18-READ-01-S1-07] 改善項目 #7: `map` キーアクセス時の不要な key 変換（`py_to_string` 連鎖など）を縮退し、同一キー型では直接アクセスを優先する。
4. [x] [ID: P1-CPP-S18-READ-01-S1-08] 改善項目 #8: 計測/時刻差分まわりの変換コードを簡約し、冗長な数値変換チェーンを減らす。
5. [x] [ID: P1-CPP-S18-READ-01-S1-05] 改善項目 #5: `unknown` 起点の過剰な default 初期化・型減衰を抑え、可能な範囲で宣言型を安定化する。
6. [x] [ID: P1-CPP-S18-READ-01-S1-01] 改善項目 #1: `ForCore(RuntimeIterForPlan)` の typed loop header 化（`P0-FORCORE-TYPE-01-S3-01` と整合）を可読性改善セットへ統合する。
- `P1-CPP-S18-READ-01-S1-02` `ForCore(RuntimeIterForPlan)+NameTarget` で typed iterable を優先する emit を追加し、`sample/18` の `for stmt in stmts` から `object __itobj + obj_to_rc_or_raise` を除去した。
- `P1-CPP-S18-READ-01-S1-07` `dict_key_verified` key の load/store 回帰テストを追加し、`sample/18` 再生成で `env[py_to_string(...)]` ではなく `env[stmt->name]` を維持できることを固定した。
- `P1-CPP-S18-READ-01-S1-08` `perf_counter` の `resolved_type=float64` を固定して不要 `Unbox` を縮退し、`sample/18` の `start/elapsed` で `py_to<float64>` 連鎖を除去した。
- `P1-CPP-S18-READ-01-S1-05` return 経路で空 collection literal を既知戻り値型へ寄せる補正を追加し、`sample/18` の `new_expr_nodes()` を `list<rc<ExprNode>>{}` へ安定化した。

## 2026-02-28 移管: `P0: stdlib 型仕様の正本化（core 直書き撤去）`

以下を `docs/ja/todo/index.md` から `todo/archive` へ移管。

文脈: [docs/ja/plans/p0-stdlib-signature-source-of-truth.md](../plans/p0-stdlib-signature-source-of-truth.md)

1. [x] [ID: P0-STDLIB-SOT-01] `pytra/std` を標準ライブラリ型仕様の唯一正本にし、`core.py` の標準ライブラリ個別知識直書きを段階撤去する。
2. [x] [ID: P0-STDLIB-SOT-01-S1-01] `core.py` の標準ライブラリ知識直書き箇所（`perf_counter` / `Path` / `str.*` / `dict.*` 等）を棚卸しし、置換対象を固定する。
3. [x] [ID: P0-STDLIB-SOT-01-S1-02] `pytra/std` を正本とするシグネチャ参照仕様（取得単位・型表現・未定義時 fail-closed）を文書化する。
4. [x] [ID: P0-STDLIB-SOT-01-S2-01] compiler 側に stdlib シグネチャ参照層を新設し、`core.py` が直接マップを持たない構成へ切り替える。
5. [x] [ID: P0-STDLIB-SOT-01-S2-02] `perf_counter` を含む代表ケースを参照層経由へ移し、戻り値型直書きを撤去する。
6. [x] [ID: P0-STDLIB-SOT-01-S2-03] `Path` / `str.*` などメソッド系マッピングを段階移行し、`core.py` の責務を構文解析+EAST整形へ限定する。
7. [x] [ID: P0-STDLIB-SOT-01-S3-01] 回帰テスト（型推論・lowering・sample 代表ケース）を追加し、`pytra/std` 仕様変更時の検知を固定する。
- `P0-STDLIB-SOT-01-S1-01` `core.py` の標準ライブラリ直書きを棚卸しし、関数 map / owner 型別 method map / `perf_counter` 戻り値直書きに分類して文脈へ固定した。
- `P0-STDLIB-SOT-01-S1-02` `docs/ja/spec/spec-stdlib-signature-source-of-truth.md` を追加し、正本（`pytra/std`）と compiler 参照境界を仕様化した。
- `P0-STDLIB-SOT-01-S2-01` `src/pytra/compiler/stdlib/signature_registry.py` を新設し、`pytra/std/*.py` の注釈から関数/メソッド戻り値を解決する参照層を追加した。
- `P0-STDLIB-SOT-01-S2-02` `core.py` の `perf_counter` 型直書きをレジストリ参照へ置換し、`test_stdlib_signature_registry.py` / `test_east_core.py` / `test_py2cpp_codegen_issues.py` で回帰確認した。
- `P0-STDLIB-SOT-01-S2-03` `str/Path/int/list/set/dict/unknown` の method map と `Path` 属性型 map を registry に移管し、`core.py` から map 直書きを撤去した。
- `P0-STDLIB-SOT-01-S3-01` `test_stdlib_signature_registry.py`、`test_east_core.py`、`test_py2cpp_codegen_issues.py`（sample/18）へ回帰テストを追加し、型推論・lowering・代表ケースを固定した。

## 2026-02-28 移管: `P0: C++ 同型 cast 除去と型推論前倒し（最優先）`

以下を `docs/ja/todo/index.md` から `todo/archive` へ移管。

文脈: [docs/ja/plans/p0-cpp-redundant-same-type-cast-elimination.md](../plans/p0-cpp-redundant-same-type-cast-elimination.md)

1. [x] [ID: P0-CPP-SAMECAST-01] C++ backend の cast 規約を「同型なら無変換」に統一し、型既知経路で不要な `str(...)` / `py_to_*` を出力しないようにする。
2. [x] [ID: P0-CPP-SAMECAST-01-S1-01] 同型 cast 除去規約（source/target が同型かつ非 Any/object/unknown の場合は無変換）を C++ emitter 共通方針として固定する。
3. [x] [ID: P0-CPP-SAMECAST-01-S1-02] `get_expr_type()` の `Subscript` 推論を拡張し、`Subscript(str, int) -> str` を確定できるようにする。
4. [x] [ID: P0-CPP-SAMECAST-01-S1-03] `StrCharClassOp` を含む文字列系 lowering を修正し、型既知 `str` では `str(...)` を挿入しない。
5. [x] [ID: P0-CPP-SAMECAST-01-S2-01] `apply_cast` / `Unbox` / builtin runtime 変換経路に同型 no-op 判定を導入し、`py_to_*` の冗長連鎖を抑止する。
6. [x] [ID: P0-CPP-SAMECAST-01-S2-02] 同型 cast 非出力の回帰テスト（fixture + `sample/18` 断片検証）を追加する。
7. [x] [ID: P0-CPP-SAMECAST-01-S3-01] `sample/cpp` を再生成し、`sample/18` の compile/run/parity を再確認して結果を固定する。
- `P0-CPP-SAMECAST-01-S1-02` `CppEmitter.get_expr_type()` で `Subscript(str, int) -> str` を推論するようにし、文字列添字の型落ちを抑止した。
- `P0-CPP-SAMECAST-01-S1-03` `StrCharClassOp` で型既知 `str` は直接 `receiver.isdigit()/isalpha()` を出力し、unknown/object 経路のみ `str(...)` を維持した。
- `P0-CPP-SAMECAST-01-S2-01` `apply_cast` と `_render_unbox_target_cast` に同型 no-op 判定を追加し、推論可能な同型 cast を省略するようにした。
- `P0-CPP-SAMECAST-01-S2-02` `test_py2cpp_codegen_issues.py` に `sample/18` 回帰（`test_sample18_charclass_avoids_redundant_str_cast`）を追加し、`test_east3_cpp_bridge.py` の期待値を型既知 no-cast へ更新した。

## 2026-02-28 移管: `P0: Lua backend 追加（最優先）`

以下を `docs/ja/todo/index.md` から `todo/archive` へ移管。

文脈: [docs/ja/plans/p0-lua-backend-rollout.md](../plans/p0-lua-backend-rollout.md)

1. [x] [ID: P0-LUA-BACKEND-01] `py2lua.py` を入口として EAST3 から Lua native 直生成経路を追加し、`sample/py` の主要ケースを Lua 実行可能にする。
2. [x] [ID: P0-LUA-BACKEND-01-S1-01] Lua backend の契約（入力 EAST3、fail-closed、runtime 境界、非対象）を `docs/ja/spec` に文書化する。
3. [x] [ID: P0-LUA-BACKEND-01-S1-02] `src/py2lua.py` と `src/hooks/lua/emitter/` の骨格を追加し、最小 fixture（`add` / `if_else` / `for_range`）を通す。
4. [x] [ID: P0-LUA-BACKEND-01-S2-01] 式/文の基本 lower（代入、分岐、ループ、呼び出し、組み込み最小）を実装する。
5. [x] [ID: P0-LUA-BACKEND-01-S2-02] class/instance/isinstance/import（`math`・画像runtime含む）対応を段階実装する。
6. [x] [ID: P0-LUA-BACKEND-01-S3-01] `tools/check_py2lua_transpile.py` と `test_py2lua_smoke.py`、`runtime_parity_check --targets lua` 導線を追加し回帰を固定する。
7. [x] [ID: P0-LUA-BACKEND-01-S3-02] `sample/lua` 再生成と `docs/ja` 利用手順・対応表の同期を行う。
- `P0-LUA-BACKEND-01-S1-01` `docs/ja/spec/spec-lua-native-backend.md` を追加し、EAST3 only / fail-closed / runtime 境界 / 非対象を契約として明文化した。
- `P0-LUA-BACKEND-01-S1-02` `src/py2lua.py` と `src/hooks/lua/emitter/` の骨格を追加し、`test_py2lua_smoke.py` で `add/if_else/for_range` を通る最小 native 経路を固定した。
- `P0-LUA-BACKEND-01-S2-01` 基本 lower（`Assign/While/Dict/Subscript/IfExp/JoinedStr/Attribute` など）を追加し、`test_py2lua_smoke.py` を 12 件へ拡張。fixture 横断で `ok 22 -> 57` に改善した。
- `P0-LUA-BACKEND-01-S2-02` class/instance/isinstance/import（`math`・画像stub）を追加し、`test_py2lua_smoke.py` を 15 件へ拡張。fixture 横断で `ok 57 -> 81` に改善した。
- `P0-LUA-BACKEND-01-S3-01` `check_py2lua_transpile.py` を追加し `checked=86 ok=86 fail=0 skipped=53` を確認。`runtime_parity_check --targets lua` 導線を追加し、toolchain未導入環境でも PASS まで確認した。
- `P0-LUA-BACKEND-01-S3-02` `sample/lua` を `02/03/04/17` で再生成（`summary: total=4 skip=0 regen=4 fail=0`）し、`docs/ja/how-to-use.md` / `docs/ja/spec/spec-user.md` / `docs/ja/spec/spec-import.md` / `sample/readme-ja.md` を Lua 導線に同期した。

## 2026-02-28 移管: `P1: Go/Java/Swift/Ruby runtime 外出し（inline helper 撤去）`

以下を `docs/ja/todo/index.md` から `todo/archive` へ移管。

文脈: [docs/ja/plans/p1-runtime-externalization-gjsr.md](../plans/p1-runtime-externalization-gjsr.md)

1. [x] [ID: P1-RUNTIME-EXT-01] Go/Java/Swift/Ruby の生成コードから `__pytra_*` runtime helper の inline 定義を撤去し、言語別 runtime ファイル参照へ統一する。
2. [x] [ID: P1-RUNTIME-EXT-01-S1-01] 現行 emitter が inline 出力している helper 群を言語別に棚卸しし、runtime 側 API（正本）との対応表を固定する。
3. [x] [ID: P1-RUNTIME-EXT-01-S2-01] Go backend を runtime 外部参照方式へ移行し、`py2go` 出力から helper 本体を除去する。
4. [x] [ID: P1-RUNTIME-EXT-01-S2-02] Java backend を runtime 外部参照方式へ移行し、`py2java` 出力から helper 本体を除去する。
5. [x] [ID: P1-RUNTIME-EXT-01-S2-03] Swift backend 用の native runtime ファイルを整備し、`py2swift` 出力から helper 本体を除去する。
6. [x] [ID: P1-RUNTIME-EXT-01-S2-04] Ruby backend 用 runtime ファイルを新設し、`py2rb` 出力から helper 本体を除去する。
7. [x] [ID: P1-RUNTIME-EXT-01-S3-01] `runtime_parity_check` / smoke テスト / sample 再生成導線を runtime 外部参照前提に更新し、回帰を固定する。
- `P1-RUNTIME-EXT-01-S1-01` Go/Java/Swift/Ruby の inline helper 群と runtime 正本 API の対応表を `docs/ja/plans/p1-runtime-externalization-gjsr.md` に固定し、Go/Java は命名差吸収、Swift/Ruby は runtime 正本新設が主要ギャップと整理した。
- `P1-RUNTIME-EXT-01-S2-01` Go native emitter から `func __pytra_*` inline 定義を撤去し、`py2go.py` で `py_runtime.go` を出力先へ配置する導線へ移行した。`test_py2go_smoke.py` と `runtime_parity_check --targets go`（`sample/18`）で実行導線を確認した。
- `P1-RUNTIME-EXT-01-S2-02` Java native emitter から helper 本体定義を撤去し、呼び出しを `PyRuntime.__pytra_*` へ集約した。`py2java.py` で `PyRuntime.java` を出力先へ配置し、`test_py2java_smoke.py` と `runtime_parity_check --targets java`（`sample/18`）で実行導線を確認した。
- `P1-RUNTIME-EXT-01-S2-03` Swift native emitter から helper 本体定義を撤去し、`src/runtime/swift/pytra/py_runtime.swift` へ移管した。`py2swift.py` で `py_runtime.swift` を出力先へ配置し、`test_py2swift_smoke.py` を通過。`runtime_parity_check --targets swift` は `swiftc` 未導入環境のため `toolchain_missing` を確認した。
- `P1-RUNTIME-EXT-01-S2-04` Ruby native emitter から inline helper 本体定義を撤去し、`src/runtime/ruby/pytra/py_runtime.rb` を新設。`py2rb.py` が `py_runtime.rb` を出力先へ配置する導線へ移行し、`test_py2rb_smoke.py` と `runtime_parity_check --targets ruby`（`sample/18`）で実行導線を確認した。
- `P1-RUNTIME-EXT-01-S3-01` `test_py2{go,java,swift,rb}_smoke.py` を再実行して全 pass を確認。`runtime_parity_check --case-root sample --targets go,java,swift,ruby --all-samples --ignore-unstable-stdout` は `cases=18 pass=18 fail=0`（`swift` は `toolchain_missing`）を確認し、`tools/regenerate_samples.py` に `ruby` を追加して `--langs go,java,swift,ruby --force`（`total=72 regen=72 fail=0`）まで固定した。

## 2026-02-28 移管: `P1: 統合CLI ./pytra の Rust target 追加`

以下を `docs/ja/todo/index.md` から `todo/archive` へ移管。

文脈: [docs/ja/plans/p1-pytra-cli-rs-target.md](../plans/p1-pytra-cli-rs-target.md)

1. [x] [ID: P1-PYTRA-CLI-RS-01] 統合CLI `./pytra` に `--target rs` を追加し、Rust 変換を C++ と同じ入口で実行可能にする。
2. [x] [ID: P1-PYTRA-CLI-RS-01-S1-01] `src/pytra/cli.py` の target dispatch を拡張し、`--target rs` で `py2rs.py` を呼び出せるようにする。
3. [x] [ID: P1-PYTRA-CLI-RS-01-S1-02] Rust 出力時の `--output` / `--output-dir` の挙動を確定し、拡張子と出力先衝突を整理する。
4. [x] [ID: P1-PYTRA-CLI-RS-01-S1-03] `docs/ja/how-to-use.md` の統合CLI節に Rust 例を追加し、`out/` / `/tmp` の一時出力運用を明記する。
- `P1-PYTRA-CLI-RS-01-S1-01` `src/pytra/cli.py` に `--target {cpp,rs}` を実装し、`rs` は `py2rs.py` 呼び出しへ接続した。`--build` は `cpp` 限定のまま維持した。
- `P1-PYTRA-CLI-RS-01-S1-02` Rust 出力は `--output` 優先、未指定時は `--output-dir/<入力stem>.rs`（既定 `out/`）へ生成する仕様に固定し、出力先がディレクトリの場合は早期エラーにした。
- `P1-PYTRA-CLI-RS-01-S1-03` `docs/ja/how-to-use.md` の統合CLI節へ Rust 例（`--output` / `--output-dir`）を追記し、`out/` 集約と `/tmp` 例外運用を明記した。
