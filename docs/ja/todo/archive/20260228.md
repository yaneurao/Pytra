# TODO履歴（2026-02-28）

<a href="../../../en/todo/archive/20260228.md">
  <img alt="Read in English" src="https://img.shields.io/badge/docs-English-2563EB?style=flat-square">
</a>

## 2026-02-28 移管: `P0: EAST3最適化層の強化（sample C++ 出力改善）`

以下を `docs/ja/todo/index.md` から `todo/archive` へ移管。

文脈: [docs/ja/plans/p0-east3-optimizer-sample-cpp-strengthening.md](../plans/p0-east3-optimizer-sample-cpp-strengthening.md)

1. [x] [ID: P0-EAST3-OPT-SAMPLE-CPP-01] `sample/cpp` 出力で目立つ冗長構文・型変換ノイズを削減するため、EAST3最適化層を7項目で段階強化する。
2. [x] [ID: P0-EAST3-OPT-SAMPLE-CPP-01-S1-01] `RangeForCanonicalizationPass` を拡張し、`step` 定数かつ有効範囲で `stop` 非定数ケースも `StaticRangeForPlan` へ正規化する。
3. [x] [ID: P0-EAST3-OPT-SAMPLE-CPP-01-S1-02] `enumerate(list[T])` を typed iterable として扱う EAST3 正規化を追加し、`object + py_at + py_to` 連鎖の発生を抑制する。
4. [x] [ID: P0-EAST3-OPT-SAMPLE-CPP-01-S1-03] 数値式の cast-chain 縮退 pass を追加し、型既知式での冗長 `py_to<T>` を削減する。
5. [x] [ID: P0-EAST3-OPT-SAMPLE-CPP-01-S1-04] ループ不変な分母・型変換（`py_to<float64>(width)` 等）の preheader hoist を追加し、内側ループの変換負荷を削減する。
6. [x] [ID: P0-EAST3-OPT-SAMPLE-CPP-01-S1-05] `list[list[int64]]` など型既知 `py_repeat` 初期化を typed materialization へ正規化し、`make_object(py_repeat(...))` 経路を縮退する。
7. [x] [ID: P0-EAST3-OPT-SAMPLE-CPP-01-S1-06] `dict<str, V>` の key アクセス/代入で不要な `py_to_string` を削減する EAST3 正規化を追加する。
8. [x] [ID: P0-EAST3-OPT-SAMPLE-CPP-01-S1-07] tuple unpack に対する一時 tuple 変数の生成を抑制し、`TupleTarget` 直接展開へ寄せる最適化を追加する。
- `P0-EAST3-OPT-SAMPLE-CPP-01-S1-01` `RangeForCanonicalizationPass` を拡張し、`range(n)`（`n: int64`）の `stop` 非定数ケースを `StaticRangeForPlan` へ正規化できることを `test_east3_optimizer.py` で回帰固定した。
- `P0-EAST3-OPT-SAMPLE-CPP-01-S1-02` `TypedEnumerateNormalizationPass` を追加し、`enumerate(list[T])` の `iter_item_type` / `iter_element_type` / `target_plan` 型情報を補完して typed loop header を選べることを `test_east3_optimizer.py` / `test_east3_cpp_bridge.py` で回帰固定した。
- `P0-EAST3-OPT-SAMPLE-CPP-01-S1-03` `NumericCastChainReductionPass` を追加し、同型 `static_cast` / `Unbox` の冗長連鎖を fail-closed で縮退できることを `test_east3_optimizer.py` で回帰固定した。
- `P0-EAST3-OPT-SAMPLE-CPP-01-S1-04` `LoopInvariantCastHoistPass` を追加し、`BinOp` の右辺数値昇格 cast を preheader へ hoist して `sample/06` の `height-1`/`width-1`/`frames_n` 変換をループ外へ移動できることを回帰固定した。
- `P0-EAST3-OPT-SAMPLE-CPP-01-S1-05` `TypedRepeatMaterializationPass` を追加し、`[0] * w` 系 `ListComp` の型を `list[list[int64]]` へ補完して `sample/py` 再変換で `make_object(py_repeat(...))` を 0 件化した。
- `P0-EAST3-OPT-SAMPLE-CPP-01-S1-06` `DictStrKeyNormalizationPass` を追加し、`dict[str, V]` キーを `dict_key_verified` 付きで正規化して `sample/18` の `env[...]` 経路から不要な `py_to_string` を除去しつつ `check_py2cpp_transpile.py` を通過させた。

## 2026-02-28 移管: `P0: Ruby \`/\` 演算の真の除算互換修正（最優先）`

以下を `docs/ja/todo/index.md` から `todo/archive` へ移管。

文脈: [docs/ja/plans/p0-ruby-true-division-parity.md](../plans/p0-ruby-true-division-parity.md)

1. [x] [ID: P0-RUBY-DIV-SEMANTICS-01] Ruby backend の `/` lowering を Python 互換（true division）へ修正し、`int/int` 由来の意味差を解消する。
2. [x] [ID: P0-RUBY-DIV-SEMANTICS-01-S1-01] `sample/06` を含む回帰ケースで現象再現を固定化し、ユニット/スモークで `/` の意味差を検知できるテストを追加する。
3. [x] [ID: P0-RUBY-DIV-SEMANTICS-01-S1-02] Ruby emitter の二項演算 lower を修正し、Python の `/` を常に真の除算として出力する（必要に応じて型変換 helper を追加）。
4. [x] [ID: P0-RUBY-DIV-SEMANTICS-01-S1-03] `sample/ruby` 再生成と parity 再検証（特に `sample/06`）を実施し、README 計測値の妥当性確認手順を文書へ反映する。

## 2026-02-28 移管: `P1: sample/18 C++ 生成コードの可読性縮退（選定: #2,#7,#8,#5,#1）`

以下を `docs/ja/todo/index.md` から `todo/archive` へ移管。

文脈: [docs/ja/plans/p1-cpp-sample18-readability-slimming.md](../plans/p1-cpp-sample18-readability-slimming.md)

1. [x] [ID: P1-CPP-S18-READ-01] `sample/18` の C++ 生成コードについて、選定改善項目（#2,#7,#8,#5,#1）を段階適用し、可読性を上げつつ挙動互換を維持する。
2. [x] [ID: P1-CPP-S18-READ-01-S1-02] 改善項目 #2: tuple unpack / 一時変数周辺の冗長 cast (`py_cast` / `py_to_*`) を削減し、型既知経路で直接利用できる emit に寄せる。
3. [x] [ID: P1-CPP-S18-READ-01-S1-07] 改善項目 #7: `map` キーアクセス時の不要な key 変換（`py_to_string` 連鎖など）を縮退し、同一キー型では直接アクセスを優先する。
4. [x] [ID: P1-CPP-S18-READ-01-S1-08] 改善項目 #8: 計測/時刻差分まわりの変換コードを簡約し、冗長な数値変換チェーンを減らす。
5. [x] [ID: P1-CPP-S18-READ-01-S1-05] 改善項目 #5: `unknown` 起点の過剰な default 初期化・型減衰を抑え、可能な範囲で宣言型を安定化する。
6. [x] [ID: P1-CPP-S18-READ-01-S1-01] 改善項目 #1: `ForCore(RuntimeIterForPlan)` の typed loop header 化（`P0-FORCORE-TYPE-01-S3-01` と整合）を可読性改善セットへ統合する。
- `P1-CPP-S18-READ-01-S1-02` `ForCore(RuntimeIterForPlan)+NameTarget` で typed iterable を優先する emit を追加し、`sample/18` の `for stmt in stmts` から `object __itobj + obj_to_rc_or_raise` を除去した。
- `P1-CPP-S18-READ-01-S1-07` `dict_key_verified` key の load/store 回帰テストを追加し、`sample/18` 再生成で `env[py_to_string(...)]` ではなく `env[stmt->name]` を維持できることを固定した。
- `P1-CPP-S18-READ-01-S1-08` `perf_counter` の `resolved_type=float64` を固定して不要 `Unbox` を縮退し、`sample/18` の `start/elapsed` で `py_to<float64>` 連鎖を除去した。
- `P1-CPP-S18-READ-01-S1-05` return 経路で空 collection literal を既知戻り値型へ寄せる補正を追加し、`sample/18` の `new_expr_nodes()` を `list<rc<ExprNode>>{}` へ安定化した。
